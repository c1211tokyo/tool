<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Tokyo Investment Map (Lite)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* === 全局风格定义 (Cyberpunk Flat) === */
    :root {
        --bg-color: #0a0a0a;
        --panel-bg: rgba(18, 18, 24, 0.95);
        --accent-cyan: #00f3ff;
        --accent-purple: #bc13fe;
        --accent-orange: #ff9100;
        --text-main: #e0e0e0;
        --text-dim: #888;
    }

    body { margin: 0; padding: 0; background: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; overflow: hidden; color: var(--text-main); }
    
    #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; background: #0a0a0a; }

    /* 自定义 Leaflet Popup 样式 */
    .leaflet-popup-content-wrapper { background: rgba(0,0,0,0.9); border: 1px solid var(--accent-cyan); color: #fff; border-radius: 4px; }
    .leaflet-popup-tip { background: rgba(0,0,0,0.9); }
    
    /* === 控制面板 (左上) === */
    #control-panel {
        position: absolute; top: 20px; left: 20px; width: 220px;
        background: var(--panel-bg); border-left: 2px solid var(--accent-cyan);
        padding: 15px; border-radius: 0 8px 8px 0;
        z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        transition: transform 0.3s ease;
    }
    
    h2 { margin: 0 0 15px 0; font-size: 14px; letter-spacing: 1px; color: var(--accent-cyan); text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 8px; }

    .metric-btn {
        display: block; width: 100%; padding: 10px; margin-bottom: 8px;
        background: rgba(255,255,255,0.05); border: 1px solid #333; color: #aaa;
        font-size: 12px; cursor: pointer; text-align: left; border-radius: 4px;
        transition: all 0.2s;
    }
    .metric-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .metric-btn.active { border-color: var(--accent-cyan); color: var(--accent-cyan); background: rgba(0, 243, 255, 0.1); font-weight: bold; }

    /* === 详情侧边栏 (右侧) === */
    #sidebar {
        position: absolute; top: 0; right: -100%; bottom: 0; width: 350px;
        background: var(--panel-bg); border-left: 1px solid #333;
        z-index: 1001; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        padding: 25px; overflow-y: auto; display: flex; flex-direction: column;
    }
    #sidebar.open { right: 0; }

    .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #666; }
    .close-btn:hover { color: #fff; }

    #ward-name { font-size: 28px; font-weight: 800; margin: 20px 0 5px 0; color: #fff; letter-spacing: 2px; }
    #ward-rank { display: inline-block; font-size: 11px; background: #333; padding: 2px 6px; border-radius: 3px; color: var(--accent-cyan); margin-bottom: 15px; }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .stat-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 4px; }
    .stat-label { font-size: 11px; color: #777; display: block; }
    .stat-val { font-size: 16px; font-weight: bold; color: #eee; }
    .val-high { color: var(--accent-cyan); text-shadow: 0 0 5px rgba(0,243,255,0.3); }

    .chart-container { position: relative; height: 200px; width: 100%; margin-top: auto; }
    
    .tags { margin: 15px 0; display: flex; flex-wrap: wrap; gap: 5px; }
    .tag { font-size: 10px; padding: 3px 8px; background: #222; border: 1px solid #444; border-radius: 10px; color: #aaa; }

    /* === 移动端适配 === */
    @media (max-width: 768px) {
        #control-panel { top: 10px; left: 10px; width: auto; min-width: 150px; padding: 10px; }
        .metric-btn { padding: 6px; font-size: 11px; }
        
        #sidebar { width: 100%; top: auto; bottom: -100%; height: 60%; right: 0; border-left: none; border-top: 1px solid var(--accent-cyan); border-radius: 16px 16px 0 0; transition: bottom 0.4s ease; }
        #sidebar.open { bottom: 0; right: 0; }
    }

    /* Loading */
    #loader { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; color: var(--accent-cyan); font-family: monospace; transition: opacity 0.5s; }
</style>
</head>
<body>

<div id="loader">SYSTEM INITIALIZING...</div>

<div id="control-panel">
    <h2>数据视图</h2>
    <div id="buttons-container"></div>
</div>

<div id="map"></div>

<div id="sidebar">
    <div class="close-btn" onclick="closeSidebar()">×</div>
    <div id="ward-rank">RANK --</div>
    <h1 id="ward-name">Select Area</h1>
    <div class="tags" id="ward-tags"></div>
    
    <div class="stat-grid" id="ward-stats"></div>
    
    <p id="ward-desc" style="font-size: 13px; line-height: 1.6; color: #999; margin-bottom: 20px;"></p>

    <div class="chart-container">
        <canvas id="radarChart"></canvas>
    </div>
</div>

<script>
    // ================= 配置区域 =================
    
    // 投资数据源 (纯静态模拟)
    const db = {
        "千代田区": { growth: 4.5, airbnb: 6.0, rental: 3.5, future: 9.0, desc: "政治中心，资产极度安全但门槛高。", tags: ["核心", "办公"] },
        "中央区": { growth: 6.8, airbnb: 8.5, rental: 4.2, future: 8.0, desc: "银座商圈，奥运后持续再开发。", tags: ["商业", "观光"] },
        "港区": { growth: 5.5, airbnb: 7.5, rental: 3.5, future: 9.5, desc: "富人区，品牌溢价最高。", tags: ["豪宅", "外企"] },
        "新宿区": { growth: 7.2, airbnb: 9.8, rental: 5.5, future: 7.5, desc: "枢纽站，民宿回报极高。", tags: ["高回报", "人流"] },
        "文京区": { growth: 3.8, airbnb: 5.0, rental: 4.8, future: 6.5, desc: "文教区，治安好，长租稳定。", tags: ["学区", "稳定"] },
        "台东区": { growth: 8.5, airbnb: 9.5, rental: 5.8, future: 7.0, desc: "浅草上野，旅游业支柱。", tags: ["旅游", "补涨"] },
        "墨田区": { growth: 7.9, airbnb: 8.5, rental: 5.6, future: 7.2, desc: "晴空塔周边，性价比高。", tags: ["旅游", "下町"] },
        "江东区": { growth: 6.2, airbnb: 6.0, rental: 5.0, future: 6.8, desc: "湾岸塔楼，家庭流入多。", tags: ["家庭", "奥运"] },
        "品川区": { growth: 5.8, airbnb: 7.0, rental: 4.9, future: 8.5, desc: "新干线门户，商务需求强。", tags: ["商务", "交通"] },
        "目黑区": { growth: 5.2, airbnb: 6.5, rental: 4.2, future: 8.2, desc: "时尚街区，品牌价值高。", tags: ["时尚", "高租金"] },
        "大田区": { growth: 4.1, airbnb: 7.8, rental: 5.5, future: 5.5, desc: "羽田门户，特区民泊优势。", tags: ["机场", "民泊"] },
        "世田谷区": { growth: 3.5, airbnb: 4.5, rental: 4.5, future: 6.0, desc: "最大居住区，环境优美。", tags: ["居住", "家族"] },
        "涩谷区": { growth: 8.8, airbnb: 9.2, rental: 4.0, future: 9.8, desc: "IT与潮流中心，全能型。", tags: ["IT", "再开发"] },
        "中野区": { growth: 5.0, airbnb: 6.5, rental: 5.3, future: 5.8, desc: "单身公寓圣地，租赁旺盛。", tags: ["单身", "次文化"] },
        "杉并区": { growth: 3.9, airbnb: 4.8, rental: 4.7, future: 5.5, desc: "中央线沿线，资产稳定。", tags: ["住宅", "避险"] },
        "丰岛区": { growth: 7.5, airbnb: 8.9, rental: 5.7, future: 7.0, desc: "池袋副都心，动漫文化。", tags: ["动漫", "高利回"] },
        "北区": { growth: 4.5, airbnb: 5.5, rental: 5.8, future: 5.0, desc: "赤羽交通好，房价亲民。", tags: ["性价比", "交通"] },
        "荒川区": { growth: 5.5, airbnb: 6.0, rental: 6.0, future: 5.2, desc: "日暮里枢纽，价格洼地。", tags: ["洼地", "下町"] },
        "板桥区": { growth: 3.8, airbnb: 4.2, rental: 5.5, future: 4.5, desc: "睡城，家庭租赁稳定。", tags: ["睡城", "稳健"] },
        "练马区": { growth: 3.2, airbnb: 3.5, rental: 5.2, future: 4.8, desc: "绿化好，适合自住。", tags: ["绿化", "自住"] },
        "足立区": { growth: 4.2, airbnb: 4.5, rental: 6.5, future: 4.5, desc: "回报率全东京最高。", tags: ["高收益", "门槛低"] },
        "葛饰区": { growth: 3.5, airbnb: 5.5, rental: 6.2, future: 4.2, desc: "老街风情，低价市场。", tags: ["老街", "低价"] },
        "江户川区": { growth: 3.8, airbnb: 4.8, rental: 5.9, future: 4.5, desc: "公园多，育儿福利好。", tags: ["育儿", "公园"] }
    };

    // 指标定义
    const METRICS = {
        growth: { label: '土地增长率', color: '#bc13fe' }, // 紫
        airbnb: { label: '民宿回报率', color: '#00f3ff' }, // 青
        rental: { label: '长租回报率', color: '#ff9100' }, // 橙
        future: { label: '升值潜力', color: '#ff003c' }   // 红
    };

    // 完整的英日映射表 (解决 GeoJSON 名字不匹配问题)
    const NAME_MAP = {
        'Chiyoda': '千代田区', 'Chuo': '中央区', 'Minato': '港区', 'Shinjuku': '新宿区', 'Bunkyo': '文京区',
        'Taito': '台东区', 'Sumida': '墨田区', 'Koto': '江东区', 'Shinagawa': '品川区', 'Meguro': '目黑区',
        'Ota': '大田区', 'Setagaya': '世田谷区', 'Shibuya': '涩谷区', 'Nakano': '中野区', 'Suginami': '杉并区',
        'Toshima': '丰岛区', 'Kita': '北区', 'Arakawa': '荒川区', 'Itabashi': '板桥区', 'Nerima': '练马区',
        'Adachi': '足立区', 'Katsushika': '葛饰区', 'Edogawa': '江户川区'
    };

    let currentMetric = 'growth';
    let geoJsonLayer = null;
    let myChart = null;

    // ================= 1. 初始化地图 =================
    
    // 使用 CartoDB Dark Matter 免费底图
    const map = L.map('map', { 
        zoomControl: false,
        attributionControl: false
    }).setView([35.6895, 139.6917], 11);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        subdomains: 'abcd'
    }).addTo(map);

    // ================= 2. 逻辑处理 =================

    // 生成控制按钮
    const btnContainer = document.getElementById('buttons-container');
    Object.keys(METRICS).forEach(key => {
        const btn = document.createElement('div');
        btn.className = `metric-btn ${key === currentMetric ? 'active' : ''}`;
        btn.innerText = METRICS[key].label;
        btn.onclick = () => switchMetric(key);
        btnContainer.appendChild(btn);
    });

    function switchMetric(key) {
        currentMetric = key;
        // 更新按钮状态
        document.querySelectorAll('.metric-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`.metric-btn`).forEach(b => {
            if(b.innerText === METRICS[key].label) b.classList.add('active');
        });
        
        // 重新渲染地图颜色
        if(geoJsonLayer) geoJsonLayer.setStyle(styleFeature);
    }

    // 颜色计算 (根据数值返回颜色透明度/亮度)
    function getColor(d, metric) {
        // 简单的阈值逻辑，实际可改为插值
        const val = d[metric];
        const baseColor = METRICS[metric].color;
        
        // 这里的透明度决定了颜色的深浅
        if(val >= 8.0) return baseColor;
        if(val >= 5.0) return adjustBrightness(baseColor, -20);
        return '#333';
    }

    function adjustBrightness(col, amt) {
        // 简化的颜色变暗处理，为了保持代码极其精简，这里直接返回原色或灰色
        // 实际生产环境可以使用 tinycolor2 库
        return col; 
    }

    // Leaflet 样式函数
    function styleFeature(feature) {
        const name = resolveName(feature.properties);
        const data = db[name];
        const color = data ? getColor(data, currentMetric) : '#333';
        const opacity = data ? (data[currentMetric] / 10) * 0.7 + 0.3 : 0.1;

        return {
            fillColor: color,
            weight: 1,
            opacity: 1,
            color: '#000', // 边界线黑色
            dashArray: '',
            fillOpacity: opacity
        };
    }

    // 名字解析 helper
    function resolveName(props) {
        const raw = props.N03_004 || props.name || props.nam; // 兼容多种 GeoJSON 格式
        // 1. 直接匹配
        if(db[raw]) return raw;
        // 2. 映射表匹配
        if(NAME_MAP[raw]) return NAME_MAP[raw];
        // 3. 包含匹配 (如 "Chiyoda-ku" -> "Chiyoda")
        for(let key in NAME_MAP) {
            if(raw.includes(key)) return NAME_MAP[key];
        }
        return raw;
    }

    // 交互逻辑
    function onEachFeature(feature, layer) {
        const name = resolveName(feature.properties);
        
        layer.on({
            mouseover: (e) => {
                const layer = e.target;
                layer.setStyle({
                    weight: 3,
                    color: '#fff',
                    fillOpacity: 0.9
                });
                layer.bringToFront();
            },
            mouseout: (e) => {
                geoJsonLayer.resetStyle(e.target);
            },
            click: (e) => {
                const data = db[name];
                if(data) {
                    openSidebar(name, data);
                    // 移动端/桌面端 适配的 FlyTo
                    map.flyToBounds(e.target.getBounds(), { padding: [50, 50], maxZoom: 13 });
                }
            }
        });
    }

    // ================= 3. 数据加载 (GeoJSON) =================
    
    // 使用 fetch 加载远程数据，避免代码过大
    fetch('https://raw.githubusercontent.com/dataofjapan/land/master/tokyo.geojson')
        .then(res => res.json())
        .then(data => {
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').remove(), 500);

            geoJsonLayer = L.geoJson(data, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);
        })
        .catch(err => {
            document.getElementById('loader').innerText = "DATA LOAD FAILED";
            console.error(err);
        });


    // ================= 4. UI & Chart =================

    function openSidebar(name, data) {
        const sb = document.getElementById('sidebar');
        sb.classList.add('open');
        
        document.getElementById('ward-name').innerText = name;
        document.getElementById('ward-desc').innerText = data.desc;
        
        // 填充 tags
        document.getElementById('ward-tags').innerHTML = data.tags.map(t => `<span class="tag">${t}</span>`).join('');

        // 填充数据
        let statsHtml = '';
        Object.keys(METRICS).forEach(k => {
            const val = data[k];
            const cls = val >= 7 ? 'val-high' : '';
            statsHtml += `
                <div class="stat-item">
                    <span class="stat-label">${METRICS[k].label}</span>
                    <span class="stat-val ${cls}">${val}</span>
                </div>
            `;
        });
        document.getElementById('ward-stats').innerHTML = statsHtml;

        updateChart(name, data);
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        map.setView([35.6895, 139.6917], 11);
    }

    function updateChart(name, data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(myChart) myChart.destroy();

        // 动态获取当前主题色
        const themeColor = METRICS[currentMetric].color;

        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: Object.values(METRICS).map(m => m.label),
                datasets: [{
                    label: name,
                    data: Object.keys(METRICS).map(k => data[k]),
                    backgroundColor: themeColor + '33', // 添加透明度
                    borderColor: themeColor,
                    pointBackgroundColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        pointLabels: { color: '#888', font: {size: 10} },
                        ticks: { display: false, max: 10, min: 0 }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

</script>
</body>
</html>
