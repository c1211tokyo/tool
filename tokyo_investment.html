<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Tokyo Investment Map (Japan Local Stable)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root { --bg: #050505; --panel: rgba(20,20,28,0.95); --accent: #00f3ff; --text: #ddd; }
    body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: -apple-system, "Helvetica Neue", "Yu Gothic", sans-serif; overflow: hidden; }
    #map { position: absolute; inset: 0; z-index: 1; background: #111; }
    
    /* ÁéªÁíÉÊãüÊÄÅÈù¢Êùø */
    #control-panel {
        position: absolute; top: 20px; left: 20px; width: 220px;
        background: var(--panel); border-left: 3px solid var(--accent);
        padding: 15px; border-radius: 0 8px 8px 0; z-index: 1000;
        box-shadow: 0 4px 30px rgba(0,0,0,0.6);
    }
    .metric-btn {
        display: block; width: 100%; padding: 12px; margin-bottom: 6px;
        background: rgba(255,255,255,0.05); border: 1px solid #333; color: #aaa;
        font-size: 13px; cursor: pointer; transition: 0.2s; border-radius: 4px;
    }
    .metric-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .metric-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0, 243, 255, 0.15); font-weight: bold; }

    /* ‰æßËæπÊ†è */
    #sidebar {
        position: absolute; top: 0; right: -400px; bottom: 0; width: 360px;
        background: var(--panel); border-left: 1px solid #333; z-index: 1001;
        transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1); padding: 25px; box-sizing: border-box;
        display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.8);
    }
    #sidebar.open { right: 0; }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; opacity: 0.7; }
    
    #ward-header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
    #ward-name { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: 1px; color: #fff; }
    
    .stat-row { display: flex; justify-content: space-between; margin: 12px 0; border-bottom: 1px dashed #333; padding-bottom: 4px; }
    .stat-val { font-weight: bold; font-size: 1.1em; }
    .val-high { color: var(--accent); text-shadow: 0 0 8px rgba(0,243,255,0.4); }

    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
        #sidebar { width: 100%; top: auto; bottom: -100%; height: 65%; right: 0; border-radius: 16px 16px 0 0; transition: bottom 0.3s; }
        #sidebar.open { bottom: 0; right: 0; }
        #control-panel { top: 10px; left: 10px; width: auto; min-width: 160px; }
    }

    /* Âä†ËΩΩÊèêÁ§∫ */
    #loader { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none;}
    .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ÂÖúÂ∫ïÊñá‰ª∂‰∏ä‰º†ÊåâÈíÆ */
    #fallback-upload {
        position: absolute; bottom: 20px; left: 20px; z-index: 999;
        font-size: 11px; color: #555; cursor: pointer;
        background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; border: 1px solid #333;
    }
    #fallback-upload:hover { color: #fff; border-color: #777; }
</style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div id="loader-text" style="color:var(--accent); font-family:monospace;">CONNECTING TO TOKYO LOCAL SERVER...</div>
</div>

<div id="control-panel">
    <h3 style="margin:0 0 15px 0; color:var(--accent); font-size:14px; letter-spacing:1px;">TOKYO RE:VIEW</h3>
    <div id="btn-container"></div>
</div>

<div id="map"></div>

<div id="sidebar">
    <div class="close-btn" onclick="closeSidebar()">√ó</div>
    <div id="ward-header">
        <h1 id="ward-name">--</h1>
        <div id="ward-tags" style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;"></div>
    </div>
    <div id="ward-stats"></div>
    <p id="ward-desc" style="color:#888; font-size:13px; line-height:1.6; margin: 20px 0; flex-grow:1;"></p>
    <div style="height: 220px; margin-top:auto;"><canvas id="radarChart"></canvas></div>
</div>

<label id="fallback-upload">
    üìÅ Á¶ªÁ∫øÊ®°ÂºèÔºöÊâãÂä®Âä†ËΩΩ .geojson
    <input type="file" id="file-input" style="display:none" accept=".json,.geojson">
</label>

<script>
    // 1. Êï∞ÊçÆÈÖçÁΩÆ
    const METRICS = {
        growth: { label: 'ÂúüÂú∞Â¢ûÈïøÁéá', color: '#d600ff' },
        airbnb: { label: 'Ê∞ëÂÆøÂõûÊä•Áéá', color: '#00f3ff' },
        rental: { label: 'ÈïøÁßüÂõûÊä•Áéá', color: '#ff9100' },
        future: { label: 'ÂçáÂÄºÊΩúÂäõ', color: '#ff003c' }
    };
    
    // Ê®°ÊãüÊï∞ÊçÆÂ∫ì (‰øùÊåÅ‰∏çÂèò)
    const db = {
        "ÂçÉ‰ª£Áî∞Âå∫": { growth: 4.5, airbnb: 6.0, rental: 3.5, future: 9.0, desc: "ÁöáÂ±Ö‰∏éÂõΩ‰ºöÊâÄÂú®ÔºåÊó•Êú¨ÂøÉËÑè„ÄÇËµÑ‰∫ßÂÆâÂÖ®ÊÄßÊûÅÈ´òÔºå‰ΩÜÈó®ÊßõÊûÅÈ´ò„ÄÇ", tags: ["ÊîøÊ≤ª‰∏≠ÂøÉ", "ËµÑ‰∫ß‰øùÂÄº"] },
        "‰∏≠Â§ÆÂå∫": { growth: 6.8, airbnb: 8.5, rental: 4.2, future: 8.0, desc: "Èì∂Â∫ß„ÄÅÊó•Êú¨Ê°•„ÄÅÁ≠ëÂú∞„ÄÇÂïÜ‰∏ö‰ª∑ÂÄºÂÖ®Êó•Êú¨ÊúÄÈ´òÔºåÂ••ËøêÊùëÂÜçÂºÄÂèëÊòØÁÉ≠ÁÇπ„ÄÇ", tags: ["ÂïÜ‰∏öÊ†∏ÂøÉ", "ËßÇÂÖâ"] },
        "Ê∏ØÂå∫": { growth: 5.5, airbnb: 7.5, rental: 3.5, future: 9.5, desc: "ÂÖ≠Êú¨Êú®„ÄÅÈ∫ªÂ∏É„ÄÅÁôΩÈáëÂè∞„ÄÇÂØå‰∫∫‰∏éÂ§ñËµÑ‰ºÅ‰∏öËÅöÈõÜÔºåË∫´‰ªΩÁöÑË±°ÂæÅ„ÄÇ", tags: ["Ë∂ÖË±™ÂÆÖ", "ÂõΩÈôÖÂåñ"] },
        "Êñ∞ÂÆøÂå∫": { growth: 7.2, airbnb: 9.8, rental: 5.5, future: 7.5, desc: "ÂêâÂ∞ºÊñØÁ∫™ÂΩïÁöÑÊû¢Á∫ΩÁ´ô„ÄÇ‰∏çÂ§úÂüéÔºåÊ∞ëÂÆøÂõûÊä•ÁéáÊûÅÈ´ò‰ΩÜÁ´û‰∫âÊøÄÁÉà„ÄÇ", tags: ["È´òÂõûÊä•", "‰∫∫ÊµÅ"] },
        "Êñá‰∫¨Âå∫": { growth: 3.8, airbnb: 5.0, rental: 4.8, future: 6.5, desc: "‰∏úÂ§ßÊâÄÂú®ÔºåÊ≤ªÂÆâ‰∏ú‰∫¨Á¨¨‰∏Ä„ÄÇÈÄÇÂêàÈù¢ÂêëÂÆ∂Â∫≠ÁöÑÁ®≥ÂÆöÈïøÁßüÊäïËµÑ„ÄÇ", tags: ["ÊñáÊïô", "Ê≤ªÂÆâ‰ºò"] },
        "Âè∞‰∏úÂå∫": { growth: 8.5, airbnb: 9.5, rental: 5.8, future: 7.0, desc: "ÊµÖËçâ„ÄÅ‰∏äÈáé„ÄÇÊóÖÊ∏∏‰∏öÊòØÁªùÂØπÊîØÊü±ÔºåÂ∞èÊà∑ÂûãÂíåÊ∞ëÂÆøÊäïËµÑÊûÅÂÖ∂Ê¥ªË∑É„ÄÇ", tags: ["ÊóÖÊ∏∏Âú£Âú∞", "‰∏ãÁî∫"] },
        "Â¢®Áî∞Âå∫": { growth: 7.9, airbnb: 8.5, rental: 5.6, future: 7.2, desc: "Êô¥Á©∫Â°îÔºàSkyTreeÔºâËÑö‰∏ã„ÄÇÊàø‰ª∑ËæÉÂè∞‰∏úÂå∫‰∫≤Ê∞ëÔºåÂçáÂÄºÊΩúÂäõÂ§ß„ÄÇ", tags: ["Êñ∞Âú∞Ê†á", "ËßÇÂÖâ"] },
        "Ê±ü‰∏úÂå∫": { growth: 6.2, airbnb: 6.0, rental: 5.0, future: 6.8, desc: "‰∏∞Ê¥≤„ÄÅÊúâÊòéÊπæÂ≤∏Âå∫„ÄÇÂ°îÊ•ºÊûóÁ´ãÔºåÂπ¥ËΩªÈ´òÊî∂ÂÖ•ÂÆ∂Â∫≠ÊµÅÂÖ•ÊúÄÂ§ö„ÄÇ", tags: ["Â°îÊ•º", "ÂÆ∂Â∫≠"] },
        "ÂìÅÂ∑ùÂå∫": { growth: 5.8, airbnb: 7.0, rental: 4.9, future: 8.5, desc: "Êñ∞Âπ≤Á∫øÈó®Êà∑ÔºåÁ£ÅÊÇ¨ÊµÆÂßãÂèëÁ´ôÈ¢ÑÊúü„ÄÇÂïÜÂä°ÈúÄÊ±ÇÊûÅÂÖ∂Âº∫Âä≤„ÄÇ", tags: ["‰∫§ÈÄöÊû¢Á∫Ω", "ÂïÜÂä°"] },
        "ÁõÆÈªëÂå∫": { growth: 5.2, airbnb: 6.5, rental: 4.2, future: 8.2, desc: "‰∏≠ÁõÆÈªë„ÄÅËá™Áî±‰πã‰∏ò„ÄÇÂìÅÁâå‰ª∑ÂÄºÈ´òÔºåÊ∑±ÂèóÂ•≥ÊÄßÂíåÂπ¥ËΩª‰∫∫ÂñúÁà±„ÄÇ", tags: ["Êó∂Â∞ö", "È´òÁßüÈáë"] },
        "Â§ßÁî∞Âå∫": { growth: 4.1, airbnb: 7.8, rental: 5.5, future: 5.5, desc: "ÁæΩÁî∞Êú∫Âú∫ÊâÄÂú®Âú∞„ÄÇÁâπÂå∫Ê∞ëÊ≥äÊîøÁ≠ñ‰ºòÂäø„ÄÇËí≤Áî∞Âë®ËæπÂïÜ‰∏öÂèëËææ„ÄÇ", tags: ["Êú∫Âú∫Èó®Êà∑", "Ê∞ëÊ≥ä"] },
        "‰∏ñÁî∞Ë∞∑Âå∫": { growth: 3.5, airbnb: 4.5, rental: 4.5, future: 6.0, desc: "‰∏ú‰∫¨ÊúÄÂ§ßÂ±Ö‰ΩèÂå∫„ÄÇÁéØÂ¢É‰ºòÁæéÔºåÈÄÇÂêàÂÆ∂ÊóèËµÑ‰∫ßÈïøÊúüÊåÅÊúâ„ÄÇ", tags: ["ÂØåË£ïÂ±Ö‰Ωè", "Á®≥ÂÆö"] },
        "Ê∂©Ë∞∑Âå∫": { growth: 8.8, airbnb: 9.2, rental: 4.0, future: 9.8, desc: "IT‰ºÅ‰∏ö‰∏éÊΩÆÊµÅ‰∏≠ÂøÉ„ÄÇÁôæÂπ¥‰∏ÄÈÅáÁöÑÂÜçÂºÄÂèëËÆ°ÂàíÊ≠£Âú®ËøõË°å‰∏≠„ÄÇ", tags: ["IT", "ÂÜçÂºÄÂèë"] },
        "‰∏≠ÈáéÂå∫": { growth: 5.0, airbnb: 6.5, rental: 5.3, future: 5.8, desc: "Êñ∞ÂÆøÁöÑÂêéËä±Âõ≠ÔºåÊ¨°ÊñáÂåñÂú£Âú∞„ÄÇÂçïË∫´ÂÖ¨ÂØìÁßüËµÅÈúÄÊ±ÇÊûÅÂ§ß„ÄÇ", tags: ["ÂçïË∫´", "È´òÈúÄ"] },
        "ÊùâÂπ∂Âå∫": { growth: 3.9, airbnb: 4.8, rental: 4.7, future: 5.5, desc: "‰∏≠Â§ÆÁ∫øÊ≤øÁ∫øÔºåÂÆâÈùôÁöÑÈ´òÁ∫ß‰ΩèÂÆÖÂå∫„ÄÇËµÑ‰∫ß‰ª∑ÂÄºÊûÅÂÖ∂Á®≥ÂÆö„ÄÇ", tags: ["‰ΩèÂÆÖ", "ÈÅøÈô©"] },
        "‰∏∞Â≤õÂå∫": { growth: 7.5, airbnb: 8.9, rental: 5.7, future: 7.0, desc: "Ê±†Ë¢ãÂâØÈÉΩÂøÉ„ÄÇÂä®Êº´ÊñáÂåñÂê∏ÂºïÂÖ®ÁêÉÂπ¥ËΩª‰∫∫ÔºåÁõÆÂâçÊòØ‰ª∑Ê†ºÊ¥ºÂú∞„ÄÇ", tags: ["Âä®Êº´", "È´òÊî∂Áõä"] },
        "ÂåóÂå∫": { growth: 4.5, airbnb: 5.5, rental: 5.8, future: 5.0, desc: "Ëµ§ÁæΩ‰∫§ÈÄöÊûÅÂÖ∂‰æøÂà©„ÄÇÊàø‰ª∑Áõ∏ÂØπËæÉ‰ΩéÔºåÂÆûÂà©‰∏ª‰πâËÄÖÁöÑÈÄâÊã©„ÄÇ", tags: ["ÊÄß‰ª∑ÊØî", "‰∫§ÈÄö"] },
        "ËçíÂ∑ùÂå∫": { growth: 5.5, airbnb: 6.0, rental: 6.0, future: 5.2, desc: "Êó•ÊöÆÈáåÊû¢Á∫Ω„ÄÇËôΩÊòØ‰∏ãÁî∫Ôºå‰ΩÜ‰∫§ÈÄö‰æøÂà©ÊÄßÊûÅÈ´ò„ÄÇ", tags: ["‰ª∑Ê†ºÊ¥ºÂú∞", "‰∫§ÈÄö"] },
        "ÊùøÊ°•Âå∫": { growth: 3.8, airbnb: 4.2, rental: 5.5, future: 4.5, desc: "ÂÖ∏ÂûãÁù°Âüé„ÄÇ‰∫∫Âè£ÂØÜÂ∫¶È´òÔºåÂÆ∂Â∫≠ÁßüËµÅÈúÄÊ±ÇÂ§ßÔºåÂá†‰πéÊó†Á©∫ÁΩÆÈ£éÈô©„ÄÇ", tags: ["Áù°Âüé", "Á®≥ÂÅ•"] },
        "ÁªÉÈ©¨Âå∫": { growth: 3.2, airbnb: 3.5, rental: 5.2, future: 4.8, desc: "23Âå∫ÁªøÂåñÊúÄÂ•Ω„ÄÇÈÄÇÂêàËá™‰ΩèÔºåÊäïËµÑÂ±ûÊÄßÁõ∏ÂØπËæÉÂº±„ÄÇ", tags: ["ÁªøÂåñ", "Ëá™‰Ωè"] },
        "Ë∂≥Á´ãÂå∫": { growth: 4.2, airbnb: 4.5, rental: 6.5, future: 4.5, desc: "Êàø‰ª∑Âú∞ÊùøÔºåÂõ†Ê≠§Ë°®Èù¢ÂõûÊä•ÁéáÂÖ®‰∏ú‰∫¨ÊúÄÈ´ò„ÄÇÈúÄÁ≤æÈÄâÂú∞ÊÆµ„ÄÇ", tags: ["È´òË°®Èù¢ÂõûÊä•", "Èó®Êßõ‰Ωé"] },
        "ËëõÈ•∞Âå∫": { growth: 3.5, airbnb: 5.5, rental: 6.2, future: 4.2, desc: "Êü¥ÂèàËÄÅË°óÔºåÂØÖÊ¨°ÈÉéÁöÑÊïÖ‰π°„ÄÇ‰Ωé‰ª∑ÈïøÁßüÂ∏ÇÂú∫‰∏∫‰∏ª„ÄÇ", tags: ["ËÄÅË°ó", "‰Ωé‰ª∑"] },
        "Ê±üÊà∑Â∑ùÂå∫": { growth: 3.8, airbnb: 4.8, rental: 5.9, future: 4.5, desc: "ÂÖ¨Âõ≠ÊûÅÂ§öÔºåËÇ≤ÂÑøÁ¶èÂà©Â•Ω„ÄÇÈúÄÊ≥®ÊÑèÈÉ®ÂàÜÂú∞Âå∫ÁöÑÊ¥™Ê∞¥È£éÈô©„ÄÇ", tags: ["ËÇ≤ÂÑø", "ÂÖ¨Âõ≠"] }
    };

    // 2. ÂàùÂßãÂåñÂú∞Âõæ
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([35.685, 139.75], 11);
    
    // CartoDB Dark Matter (CDN ÊûÅÂÖ∂Á®≥ÂÆö)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 18, subdomains: 'abcd'
    }).addTo(map);

    let currentMetric = 'growth';
    let geoLayer = null;
    let myChart = null;

    // 3. UI ÂàùÂßãÂåñ
    const btnContainer = document.getElementById('btn-container');
    Object.keys(METRICS).forEach(key => {
        const div = document.createElement('div');
        div.className = `metric-btn ${key===currentMetric?'active':''}`;
        div.innerText = METRICS[key].label;
        div.onclick = () => switchMetric(key);
        btnContainer.appendChild(div);
    });

    // 4. Êï∞ÊçÆËé∑ÂèñÊ†∏ÂøÉÈÄªËæë (NII Source)
    // ËøôÊòØÊó•Êú¨ÂõΩÁ´ãÊÉÖÊä•Â≠¶Á†îÁ©∂ÊâÄÁöÑÂÆòÊñπÊï∞ÊçÆÊ∫êÔºåÂú®Êó•Êú¨ÂõΩÂÜÖËÆøÈóÆÈÄüÂ∫¶ÊûÅÂø´
    const JAPAN_NII_SOURCE = "https://geoshape.ex.nii.ac.jp/city/geojson/2020/13.geojson";
    
    // Â§áÁî®Ê∫ê (GitHub RawÔºåÂèØËÉΩÊÖ¢)
    const BACKUP_SOURCE = "https://raw.githubusercontent.com/niiyz/JapanCityGeoJson/master/geojson/prefectures/13.json";

    function loadData(url) {
        document.getElementById('loader-text').innerText = "DOWNLOADING GEO DATA...";
        
        fetch(url)
            .then(res => {
                if(!res.ok) throw new Error("Source failed");
                return res.json();
            })
            .then(data => processGeoJSON(data))
            .catch(err => {
                console.warn("Primary source failed, trying backup...", err);
                if (url === JAPAN_NII_SOURCE) {
                    loadData(BACKUP_SOURCE); // Â∞ùËØïÂ§áÁî®
                } else {
                    document.getElementById('loader-text').innerHTML = 
                        "<span style='color:red'>DATA LOAD FAILED.</span><br>PLEASE USE UPLOAD BUTTON BELOW.";
                }
            });
    }

    // Â§ÑÁêÜÂπ∂Ê∏≤ÊüìÊï∞ÊçÆ
    function processGeoJSON(data) {
        // Êô∫ËÉΩÁ≠õÈÄâÔºöÂè™‰øùÁïô 23 Âå∫
        // ‰∏ú‰∫¨23Âå∫ÁöÑË°åÊîø‰ª£Á†ÅÊòØ 13101 ~ 13123
        const features = data.features.filter(f => {
            // N03_007 ÊòØË°åÊîø‰ª£Á†Å
            const code = f.properties.N03_007; 
            if (code) {
                const num = parseInt(code);
                return num >= 13101 && num <= 13123;
            }
            // ÂÖúÂ∫ïÔºöÂ¶ÇÊûúÊ≤°‰ª£Á†ÅÔºåÁî®ÂêçÂ≠óÂåπÈÖç
            const name = f.properties.N03_004 || f.properties.name;
            return db[name] !== undefined;
        });

        if (features.length === 0) {
            alert("Âä†ËΩΩ‰∫ÜÊï∞ÊçÆ‰ΩÜÊ≤°ÊúâÊâæÂà∞23Âå∫‰ø°ÊÅØÔºåÂèØËÉΩÊòØÊï∞ÊçÆÊ†ºÂºè‰∏çÂØπ„ÄÇ");
            return;
        }

        const filteredData = { type: "FeatureCollection", features: features };

        if (geoLayer) map.removeLayer(geoLayer);

        geoLayer = L.geoJson(filteredData, {
            style: styleFeature,
            onEachFeature: onEachFeature
        }).addTo(map);

        // ÊàêÂäüÔºÅ
        map.fitBounds(geoLayer.getBounds(), { padding: [20, 20] });
        document.getElementById('loader').style.opacity = 0;
        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
    }

    // ÂêØÂä®Âä†ËΩΩ
    loadData(JAPAN_NII_SOURCE);

    // --- ËæÖÂä©ÂäüËÉΩ ---

    function styleFeature(feature) {
        const name = resolveName(feature.properties);
        const data = db[name];
        if (!data) return { opacity: 0, fillOpacity: 0 }; // ‰∏çÂú®Â∫ìÈáåÁöÑÂå∫ÈöêËóè

        const val = data[currentMetric];
        const color = METRICS[currentMetric].color;
        
        // Âä®ÊÄÅÈÄèÊòéÂ∫¶ÔºöÊï∞ÂÄºË∂äÈ´òË∂ä‰∫Æ
        let opacity = 0.3;
        if (val >= 8) opacity = 0.7;
        else if (val >= 5) opacity = 0.5;

        return {
            fillColor: color,
            weight: 1,
            opacity: 1,
            color: '#111', // ÈªëËâ≤ËæπÊ°Ü
            fillOpacity: opacity
        };
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: (e) => {
                e.target.setStyle({ weight: 2, color: '#fff', fillOpacity: 0.9 });
                e.target.bringToFront();
            },
            mouseout: (e) => {
                geoLayer.resetStyle(e.target);
            },
            click: (e) => {
                const name = resolveName(feature.properties);
                if (db[name]) openSidebar(name, db[name]);
                L.DomEvent.stopPropagation(e);
            }
        });
    }

    function resolveName(props) {
        // NII Êï∞ÊçÆÁöÑÊ†áÂáÜÂ≠óÊÆµÊòØ N03_004 (Ê±âÂ≠óÂêç)
        return props.N03_004 || props.name || "";
    }

    function switchMetric(key) {
        currentMetric = key;
        document.querySelectorAll('.metric-btn').forEach(b => {
            b.classList.toggle('active', b.innerText === METRICS[key].label);
        });
        if (geoLayer) geoLayer.setStyle(styleFeature);
    }

    // ‰æßËæπÊ†è
    function openSidebar(name, data) {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('ward-name').innerText = name;
        document.getElementById('ward-desc').innerText = data.desc;
        
        // Tags
        document.getElementById('ward-tags').innerHTML = data.tags.map(t => 
            `<span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:11px; border:1px solid #555;">${t}</span>`
        ).join('');

        // Stats
        let html = '';
        Object.keys(METRICS).forEach(k => {
            const val = data[k];
            const isHigh = val >= 7.5;
            html += `<div class="stat-row">
                <span style="color:#888">${METRICS[k].label}</span>
                <span class="stat-val ${isHigh ? 'val-high' : ''}" style="${isHigh ? 'color:'+METRICS[k].color : ''}">${val}</span>
            </div>`;
        });
        document.getElementById('ward-stats').innerHTML = html;

        updateChart(name, data);
    }
    
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }
    map.on('click', closeSidebar);

    function updateChart(name, data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (myChart) myChart.destroy();
        const color = METRICS[currentMetric].color;
        
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: Object.values(METRICS).map(m => m.label),
                datasets: [{
                    label: name,
                    data: Object.keys(METRICS).map(k => data[k]),
                    backgroundColor: color + '33',
                    borderColor: color,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { display: false, max: 10, min: 0 },
                        pointLabels: { color: '#aaa', font: {size:11} }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- Á¶ªÁ∫øÊ®°ÂºèÔºöÊâãÂä®‰∏ä‰º† ---
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                document.getElementById('loader').style.display = 'flex';
                document.getElementById('loader').style.opacity = 1;
                document.getElementById('loader-text').innerText = "PARSING LOCAL FILE...";
                processGeoJSON(json);
            } catch (err) {
                alert("Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øùÊòØÊ†áÂáÜÁöÑ .json Êàñ .geojson Êñá‰ª∂");
            }
        };
        reader.readAsText(file);
    });

</script>
</body>
</html>
