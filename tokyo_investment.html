<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Tokyo Real Estate Analytics Pro</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root { --accent: #00f2ff; --bg: #050505; --panel-bg: rgba(12, 12, 15, 0.9); }
    body { margin: 0; padding: 0; background: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    
    /* 地图容器 */
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    /* 悬停 Tooltip */
    #tooltip {
        position: absolute; display: none; pointer-events: none;
        background: rgba(0, 0, 0, 0.8); border: 1px solid var(--accent);
        padding: 8px 12px; border-radius: 4px; font-weight: bold;
        z-index: 100; transform: translate(-50%, -150%); white-space: nowrap;
        box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
    }

    /* 左侧控制面板 */
    #control-panel {
        position: absolute; top: 20px; left: 20px; width: 260px;
        background: var(--panel-bg); backdrop-filter: blur(10px);
        padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
        z-index: 10;
    }
    .panel-header { color: var(--accent); font-size: 12px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-weight: 800; }
    
    .metric-btn {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.05); border-radius: 4px; cursor: pointer;
        transition: 0.3s; font-size: 13px; color: #aaa;
    }
    .metric-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .metric-btn.active { border-color: var(--color); background: rgba(255,255,255,0.05); color: #fff; box-shadow: inset 3px 0 0 var(--color); }
    .color-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--color); box-shadow: 0 0 8px var(--color); }

    /* 图例条 */
    #legend-bar {
        height: 6px; width: 100%; margin-top: 15px; border-radius: 3px;
        background: linear-gradient(90deg, #333, #666); position: relative;
    }
    .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 5px; }

    /* 右侧详情面板 */
    #sidebar {
        position: absolute; top: 0; right: -420px; bottom: 0; width: 380px;
        background: var(--panel-bg); border-left: 1px solid #333;
        padding: 30px; transition: right 0.4s cubic-bezier(0.2, 1, 0.3, 1);
        z-index: 20; box-shadow: -10px 0 40px rgba(0,0,0,0.8); overflow-y: auto;
    }
    #sidebar.open { right: 0; }
    
    /* 关闭按钮 */
    .close-btn { 
        position: absolute; top: 20px; right: 20px; cursor: pointer; color: #666; font-size: 24px; line-height: 1; transition: 0.2s; 
    }
    .close-btn:hover { color: #fff; }

    .ward-header { font-size: 28px; font-weight: 800; margin: 10px 0 5px; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .rank-badge { display: inline-block; background: #333; color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 10px; border: 1px solid rgba(0, 242, 255, 0.3); }

    .stat-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
    .stat-label { color: #888; font-size: 13px; }
    .stat-val { font-weight: bold; font-size: 16px; }
    .stat-rank { font-size: 10px; color: #555; margin-left: 5px; }

    #chart-wrap { height: 200px; margin: 25px 0; position: relative; }
    
    .tag-cloud { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 15px; }
    .tag { font-size: 11px; padding: 4px 10px; border-radius: 12px; background: #222; border: 1px solid #444; color: #bbb; }

    /* Loading */
    #loading { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; color: var(--accent); font-family: monospace; }
</style>
</head>
<body>

<div id="loading">INITIALIZING SYSTEM...</div>
<div id="tooltip"></div>

<div id="control-panel">
    <div class="panel-header">TOKYO RE:ANALYTICS</div>
    <div id="metric-buttons"></div>
    
    <div style="margin-top: 25px;">
        <div id="legend-bar"></div>
        <div class="legend-labels">
            <span>LOW</span>
            <span>AVG</span>
            <span>HIGH</span>
        </div>
    </div>
</div>

<div id="map"></div>

<div id="sidebar">
    <div class="close-btn" onclick="resetView()">×</div>
    <div class="rank-badge" id="detail-rank">RANKING #--</div>
    <div class="ward-header" id="detail-title">SELECT WARD</div>
    <div class="tag-cloud" id="detail-tags"></div>

    <div style="margin-top: 30px;" id="detail-stats"></div>
    
    <div id="chart-wrap">
        <canvas id="radarChart"></canvas>
    </div>

    <p id="detail-desc" style="color: #999; line-height: 1.6; font-size: 13px; margin-top: 20px;"></p>
</div>

<script>
    // ==========================================
    // 0. 配置与常量 (Configuration)
    // ==========================================
    const MAPBOX_TOKEN = 'pk.eyJ1Ijoic3VwZXJtaWtlIiwiYSI6ImNqZ2d0aWNjZzAwNGEzM21tNGN1Z2t6cW0ifQ.Sg33o3qZ4W7wA5b5xWc03A'; // ⚠️ 请替换为你的 Token
    mapboxgl.accessToken = MAPBOX_TOKEN;

    // 核心映射表：确保 GeoJSON 无论返回什么名字都能找到数据
    // Key: GeoJSON 可能出现的英文名/变体, Value: 数据库里的标准日文名
    const NAME_MAPPING = {
        'Chiyoda': '千代田区', 'Chiyoda-ku': '千代田区',
        'Chuo': '中央区', 'Chuo-ku': '中央区',
        'Minato': '港区', 'Minato-ku': '港区',
        'Shinjuku': '新宿区', 'Shinjuku-ku': '新宿区',
        'Bunkyo': '文京区', 'Bunkyo-ku': '文京区',
        'Taito': '台东区', 'Taito-ku': '台东区',
        'Sumida': '墨田区', 'Sumida-ku': '墨田区',
        'Koto': '江东区', 'Koto-ku': '江东区',
        'Shinagawa': '品川区', 'Shinagawa-ku': '品川区',
        'Meguro': '目黑区', 'Meguro-ku': '目黑区',
        'Ota': '大田区', 'Ota-ku': '大田区',
        'Setagaya': '世田谷区', 'Setagaya-ku': '世田谷区',
        'Shibuya': '涩谷区', 'Shibuya-ku': '涩谷区',
        'Nakano': '中野区', 'Nakano-ku': '中野区',
        'Suginami': '杉并区', 'Suginami-ku': '杉并区',
        'Toshima': '丰岛区', 'Toshima-ku': '丰岛区',
        'Kita': '北区', 'Kita-ku': '北区',
        'Arakawa': '荒川区', 'Arakawa-ku': '荒川区',
        'Itabashi': '板桥区', 'Itabashi-ku': '板桥区',
        'Nerima': '练马区', 'Nerima-ku': '练马区',
        'Adachi': '足立区', 'Adachi-ku': '足立区',
        'Katsushika': '葛饰区', 'Katsushika-ku': '葛饰区',
        'Edogawa': '江户川区', 'Edogawa-ku': '江户川区'
    };

    // 指标配置中心 (Refactored Metrics)
    const METRICS = {
        growth: { 
            label: '土地增长率', 
            unit: '%', 
            min: 3, max: 9, 
            lowColor: '#2c003e', highColor: '#d600ff' // 紫色系
        },
        airbnb: { 
            label: '民宿回报率', 
            unit: 'pt', 
            min: 3, max: 10, 
            lowColor: '#002c3e', highColor: '#00f2ff' // 青色系 (Cyberpunk)
        },
        rental: { 
            label: '长租回报率', 
            unit: '%', 
            min: 3, max: 7, 
            lowColor: '#3e1c00', highColor: '#ff7700' // 橙色系
        },
        future: { 
            label: '升值潜力', 
            unit: 'pt', 
            min: 4, max: 10, 
            lowColor: '#3e000c', highColor: '#ff0044' // 红色系
        }
    };

    let currentMetricKey = 'growth';
    let myChart = null;

    // ==========================================
    // 1. 数据层 (Data Layer & Processing)
    // ==========================================
    const rawDB = {
        "千代田区": { growth: 4.5, airbnb: 6.0, rental: 3.5, future: 9.0, desc: "政治中心，资产极度安全但门槛高。", tags: ["核心", "办公"] },
        "中央区": { growth: 6.8, airbnb: 8.5, rental: 4.2, future: 8.0, desc: "银座商圈，奥运后持续再开发。", tags: ["商业", "观光"] },
        "港区": { growth: 5.5, airbnb: 7.5, rental: 3.5, future: 9.5, desc: "富人区，品牌溢价最高。", tags: ["豪宅", "外企"] },
        "新宿区": { growth: 7.2, airbnb: 9.8, rental: 5.5, future: 7.5, desc: "枢纽站，民宿回报极高。", tags: ["高回报", "人流"] },
        "文京区": { growth: 3.8, airbnb: 5.0, rental: 4.8, future: 6.5, desc: "文教区，治安好，长租稳定。", tags: ["学区", "稳定"] },
        "台东区": { growth: 8.5, airbnb: 9.5, rental: 5.8, future: 7.0, desc: "浅草上野，旅游业支柱。", tags: ["旅游", "补涨"] },
        "墨田区": { growth: 7.9, airbnb: 8.5, rental: 5.6, future: 7.2, desc: "晴空塔周边，性价比高。", tags: ["旅游", "下町"] },
        "江东区": { growth: 6.2, airbnb: 6.0, rental: 5.0, future: 6.8, desc: "湾岸塔楼，家庭流入多。", tags: ["家庭", "奥运"] },
        "品川区": { growth: 5.8, airbnb: 7.0, rental: 4.9, future: 8.5, desc: "新干线门户，商务需求强。", tags: ["商务", "交通"] },
        "目黑区": { growth: 5.2, airbnb: 6.5, rental: 4.2, future: 8.2, desc: "时尚街区，品牌价值高。", tags: ["时尚", "高租金"] },
        "大田区": { growth: 4.1, airbnb: 7.8, rental: 5.5, future: 5.5, desc: "羽田门户，特区民泊优势。", tags: ["机场", "民泊"] },
        "世田谷区": { growth: 3.5, airbnb: 4.5, rental: 4.5, future: 6.0, desc: "最大居住区，环境优美。", tags: ["居住", "家族"] },
        "涩谷区": { growth: 8.8, airbnb: 9.2, rental: 4.0, future: 9.8, desc: "IT与潮流中心，全能型。", tags: ["IT", "再开发"] },
        "中野区": { growth: 5.0, airbnb: 6.5, rental: 5.3, future: 5.8, desc: "单身公寓圣地，租赁旺盛。", tags: ["单身", "次文化"] },
        "杉并区": { growth: 3.9, airbnb: 4.8, rental: 4.7, future: 5.5, desc: "中央线沿线，资产稳定。", tags: ["住宅", "避险"] },
        "丰岛区": { growth: 7.5, airbnb: 8.9, rental: 5.7, future: 7.0, desc: "池袋副都心，动漫文化。", tags: ["动漫", "高利回"] },
        "北区": { growth: 4.5, airbnb: 5.5, rental: 5.8, future: 5.0, desc: "赤羽交通好，房价亲民。", tags: ["性价比", "交通"] },
        "荒川区": { growth: 5.5, airbnb: 6.0, rental: 6.0, future: 5.2, desc: "日暮里枢纽，价格洼地。", tags: ["洼地", "下町"] },
        "板桥区": { growth: 3.8, airbnb: 4.2, rental: 5.5, future: 4.5, desc: "睡城，家庭租赁稳定。", tags: ["睡城", "稳健"] },
        "练马区": { growth: 3.2, airbnb: 3.5, rental: 5.2, future: 4.8, desc: "绿化好，适合自住。", tags: ["绿化", "自住"] },
        "足立区": { growth: 4.2, airbnb: 4.5, rental: 6.5, future: 4.5, desc: "回报率全东京最高。", tags: ["高收益", "门槛低"] },
        "葛饰区": { growth: 3.5, airbnb: 5.5, rental: 6.2, future: 4.2, desc: "老街风情，低价市场。", tags: ["老街", "低价"] },
        "江户川区": { growth: 3.8, airbnb: 4.8, rental: 5.9, future: 4.5, desc: "公园多，育儿福利好。", tags: ["育儿", "公园"] }
    };

    // 预处理：计算排名 (Ranking Calculation)
    const db = JSON.parse(JSON.stringify(rawDB)); // Deep Copy
    Object.keys(METRICS).forEach(metric => {
        // 提取该指标的所有值并排序
        const sorted = Object.entries(db).sort((a, b) => b[1][metric] - a[1][metric]);
        sorted.forEach((item, index) => {
            db[item[0]][metric + '_rank'] = index + 1; // 存储排名 (1-23)
        });
    });

    // ==========================================
    // 2. 视觉逻辑 (Visual Logic)
    // ==========================================
    
    // 初始化控制面板
    const btnContainer = document.getElementById('metric-buttons');
    Object.keys(METRICS).forEach(key => {
        const m = METRICS[key];
        const btn = document.createElement('div');
        btn.className = 'metric-btn ' + (key === currentMetricKey ? 'active' : '');
        btn.style.setProperty('--color', m.highColor);
        btn.dataset.metric = key;
        btn.innerHTML = `<span>${m.label}</span><div class="color-dot"></div>`;
        btn.onclick = () => switchMetric(key);
        btnContainer.appendChild(btn);
    });

    // 真正的 RGB 颜色插值 (RGB Lerp)
    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }
    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
    function lerpColor(c1, c2, factor) {
        const color1 = hexToRgb(c1);
        const color2 = hexToRgb(c2);
        const r = Math.round(color1.r + (color2.r - color1.r) * factor);
        const g = Math.round(color1.g + (color2.g - color1.g) * factor);
        const b = Math.round(color1.b + (color2.b - color1.b) * factor);
        return rgbToHex(r, g, b);
    }

    // 生成 Mapbox Style Expression
    function getStyleExpressions(metricKey) {
        const config = METRICS[metricKey];
        const colorExpr = ['match', ['get', 'N03_004']]; // 默认尝试匹配日文名
        
        // 同时也尝试匹配英文名 (name 属性) - 需要复杂的表达式或确保数据源一致
        // 这里我们采用简单策略：遍历所有区，生成颜色
        
        Object.keys(db).forEach(wardName => {
            const val = db[wardName][metricKey];
            // 计算插值因子 (0.0 - 1.0)
            let factor = (val - config.min) / (config.max - config.min);
            factor = Math.max(0, Math.min(1, factor)); // Clamp
            
            const finalColor = lerpColor(config.lowColor, config.highColor, factor);
            
            colorExpr.push(wardName); // 日文名匹配
            colorExpr.push(finalColor);
            
            // 倒推英文名匹配 (为了容错)
            Object.keys(NAME_MAPPING).forEach(engKey => {
                if(NAME_MAPPING[engKey] === wardName) {
                    colorExpr.push(engKey);
                    colorExpr.push(finalColor);
                }
            });
        });
        
        colorExpr.push('#333'); // Default fallback

        // 高度表达式
        const heightExpr = ['match', ['get', 'N03_004']];
        Object.keys(db).forEach(wardName => {
            const h = (db[wardName][metricKey] - config.min) * 500 + 100;
            heightExpr.push(wardName, h);
            // English mapping
            Object.keys(NAME_MAPPING).forEach(engKey => {
                if(NAME_MAPPING[engKey] === wardName) {
                    heightExpr.push(engKey, h);
                }
            });
        });
        heightExpr.push(50);

        return { color: colorExpr, height: heightExpr };
    }

    // ==========================================
    // 3. 地图初始化 (Map Initialization)
    // ==========================================
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [139.75, 35.68],
        zoom: 10.5,
        pitch: 50,
        bearing: -10,
        antialias: true
    });

    map.on('load', () => {
        document.getElementById('loading').style.opacity = 0;
        setTimeout(() => document.getElementById('loading').remove(), 500);

        // 使用 reliable 的 GeoJSON 源
        map.addSource('tokyo', {
            type: 'geojson',
            data: 'https://raw.githubusercontent.com/dataofjapan/land/master/tokyo.geojson',
            generateId: true
        });

        // 交互层
        map.addLayer({
            'id': 'ward-fill',
            'type': 'fill',
            'source': 'tokyo',
            'paint': { 'fill-opacity': 0, 'fill-color': '#fff' }
        });

        // 3D 表现层
        map.addLayer({
            'id': 'ward-ext',
            'type': 'fill-extrusion',
            'source': 'tokyo',
            'paint': {
                'fill-extrusion-opacity': 0.9,
                'fill-extrusion-base': 0
            }
        });
        
        // 线框层
        map.addLayer({
            'id': 'ward-line',
            'type': 'line',
            'source': 'tokyo',
            'paint': { 'line-color': '#fff', 'line-opacity': 0.2, 'line-width': 1 }
        });

        updateMapVisuals(); // 初始渲染
    });

    // ==========================================
    // 4. 交互逻辑 (Interaction)
    // ==========================================
    const tooltip = document.getElementById('tooltip');

    // Hover
    map.on('mousemove', 'ward-fill', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const props = e.features[0].properties;
        // 尝试获取名字 (兼容不同 GeoJSON 字段)
        const rawName = props.N03_004 || props.name || props.nam;
        const jpName = NAME_MAPPING[rawName] || rawName; // Normalize
        
        if (db[jpName]) {
            tooltip.style.display = 'block';
            tooltip.style.left = e.point.x + 'px';
            tooltip.style.top = e.point.y + 'px';
            tooltip.innerText = jpName;
            
            // Hover Highlight
            map.setPaintProperty('ward-ext', 'fill-extrusion-opacity', [
                'case', ['==', ['id'], e.features[0].id], 1.0, 0.6
            ]);
        }
    });

    map.on('mouseleave', 'ward-fill', () => {
        map.getCanvas().style.cursor = '';
        tooltip.style.display = 'none';
        map.setPaintProperty('ward-ext', 'fill-extrusion-opacity', 0.9);
    });

    // Click
    map.on('click', 'ward-fill', (e) => {
        const props = e.features[0].properties;
        const rawName = props.N03_004 || props.name || props.nam;
        const jpName = NAME_MAPPING[rawName] || rawName;

        if (db[jpName]) {
            openSidebar(jpName, db[jpName]);
            
            // ✈️ FlyTo Animation
            const center = mapboxgl.LngLatBounds.convert(e.features[0].geometry.coordinates[0]).getCenter();
            map.flyTo({ center: center, zoom: 12.5, pitch: 60, speed: 0.8 });
        }
    });

    // ==========================================
    // 5. 状态管理 (State Management)
    // ==========================================
    
    function switchMetric(key) {
        currentMetricKey = key;
        
        // Update Buttons
        document.querySelectorAll('.metric-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.metric-btn[data-metric="${key}"]`).classList.add('active');

        // Update Legend
        const m = METRICS[key];
        document.getElementById('legend-bar').style.background = `linear-gradient(90deg, ${m.lowColor}, ${m.highColor})`;

        updateMapVisuals();
    }

    function updateMapVisuals() {
        const styles = getStyleExpressions(currentMetricKey);
        // 使用 setPaintProperty 实现无缝过渡
        map.setPaintProperty('ward-ext', 'fill-extrusion-color', styles.color);
        // 高度变化需要一定时间过渡，Mapbox 原生支持 transition
        map.setPaintProperty('ward-ext', 'fill-extrusion-height', styles.height);
    }

    // Sidebar Logic
    function openSidebar(name, data) {
        const sb = document.getElementById('sidebar');
        sb.classList.add('open');
        
        document.getElementById('detail-title').innerText = name;
        document.getElementById('detail-desc').innerText = data.desc;
        document.getElementById('detail-rank').innerText = `RANKING #${data[currentMetricKey + '_rank']} / 23`;

        // Tags
        const tagsHtml = data.tags.map(t => `<span class="tag">${t}</span>`).join('');
        document.getElementById('detail-tags').innerHTML = tagsHtml;

        // Stats Rows
        let statsHtml = '';
        Object.keys(METRICS).forEach(k => {
            const m = METRICS[k];
            const isCurrent = k === currentMetricKey;
            const style = isCurrent ? `color: ${m.highColor}` : '';
            statsHtml += `
                <div class="stat-row">
                    <span class="stat-label">${m.label}</span>
                    <div>
                        <span class="stat-val" style="${style}">${data[k]}${m.unit}</span>
                        <span class="stat-rank">#${data[k+'_rank']}</span>
                    </div>
                </div>
            `;
        });
        document.getElementById('detail-stats').innerHTML = statsHtml;

        updateRadar(name, data);
    }

    function resetView() {
        document.getElementById('sidebar').classList.remove('open');
        map.flyTo({ center: [139.75, 35.68], zoom: 10.5, pitch: 50 });
    }

    // Chart.js Radar
    function updateRadar(name, data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(myChart) myChart.destroy();

        const m = METRICS[currentMetricKey];
        
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: Object.values(METRICS).map(x => x.label),
                datasets: [{
                    label: name,
                    data: Object.keys(METRICS).map(k => data[k]),
                    backgroundColor: hexToRgb(m.highColor) ? `rgba(${hexToRgb(m.highColor).r}, ${hexToRgb(m.highColor).g}, ${hexToRgb(m.highColor).b}, 0.3)` : 'rgba(255,255,255,0.2)',
                    borderColor: m.highColor,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        pointLabels: { color: '#888', font: {size: 11} },
                        ticks: { display: false, backdropColor: 'transparent' }
                    }
                },
                plugins: { legend: { display: false } },
                maintainAspectRatio: false
            }
        });
    }

</script>
</body>
</html>
