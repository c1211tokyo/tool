<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>东京23区不动产投资可视化系统 (Tokyo Real Estate Core)</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- 核心布局与赛博朋克风格定义 --- */
    body { margin: 0; padding: 0; background-color: #050505; color: #e0e0e0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    
    /* 玻璃拟态控制面板 */
    #control-panel {
        position: absolute; top: 20px; left: 20px;
        background: rgba(15, 15, 20, 0.85); 
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        padding: 24px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); 
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        z-index: 10; width: 280px;
        transition: transform 0.3s ease;
    }
    #control-panel:hover { border-color: rgba(0, 242, 255, 0.3); }

    h2 { margin-top: 0; font-size: 14px; color: #00f2ff; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 15px; border-bottom: 1px solid rgba(0, 242, 255, 0.2); padding-bottom: 10px;}
    
    .metric-btn {
        display: flex; justify-content: space-between; align-items: center;
        width: 100%; padding: 14px 16px; margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); 
        color: #aaa; border-radius: 6px; cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 13px; font-weight: 500;
    }
    .metric-btn:hover { background: rgba(255, 255, 255, 0.08); color: #fff; transform: translateX(2px); }
    .metric-btn.active { 
        background: rgba(0, 242, 255, 0.15); 
        color: #00f2ff; 
        border-color: #00f2ff; 
        box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
    }

    /* 右侧侧边栏动画 */
    #sidebar {
        position: absolute; top: 0; right: -450px; bottom: 0; width: 400px;
        background: rgba(10, 10, 12, 0.95); 
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        padding: 30px; overflow-y: auto; 
        transition: right 0.5s cubic-bezier(0.19, 1, 0.22, 1); 
        z-index: 20; box-shadow: -10px 0 30px rgba(0,0,0,0.8);
    }
    #sidebar.open { right: 0; }
    
    #ward-title { font-size: 2.4em; margin: 0 0 5px 0; background: linear-gradient(90deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;}
    #ward-subtitle { color: #666; font-size: 0.9em; margin-bottom: 25px; display: block; letter-spacing: 1px; }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .stat-label { font-size: 0.8em; color: #888; display: block; margin-bottom: 5px; }
    .stat-value { font-size: 1.4em; font-weight: bold; color: #fff; }
    
    /* 评分颜色 */
    .val-high { color: #00ff9d; text-shadow: 0 0 10px rgba(0,255,157,0.3); }
    .val-mid { color: #ffbf00; }
    .val-low { color: #ff4d4d; }

    /* 标签 */
    .tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 30px; }
    .tag { font-size: 0.75em; padding: 4px 10px; border-radius: 100px; border: 1px solid #444; color: #ccc; background: #222; }
    .tag-premium { border-color: #ffd700; color: #ffd700; background: rgba(255, 215, 0, 0.1); }
    .tag-tourist { border-color: #00f2ff; color: #00f2ff; background: rgba(0, 242, 255, 0.1); }

    /* 图表容器 */
    #chart-container { position: relative; height: 220px; width: 100%; margin: 20px 0; }

    #analysis-text { line-height: 1.7; color: #bbb; font-size: 0.95em; border-top: 1px solid #333; padding-top: 20px; }

    /* Loading Overlay */
    #loader {
        position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:999;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        transition: opacity 0.5s ease;
    }
    .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid #00f2ff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="color: #666; font-size: 0.8em; letter-spacing: 2px;">INITIALIZING TOKYO DATA...</div>
</div>

<div id="map"></div>

<div id="control-panel">
    <h2>DATA VISUALIZATION</h2>
    <div class="metric-btn active" data-metric="growthRate">
        <span>土地增长率 (Growth)</span>
        <span style="color: #d600ff;">●</span>
    </div>
    <div class="metric-btn" data-metric="airbnbROI">
        <span>民宿回报率 (Airbnb)</span>
        <span style="color: #00f2ff;">●</span>
    </div>
    <div class="metric-btn" data-metric="rentalYield">
        <span>长租回报率 (Rental)</span>
        <span style="color: #ff7700;">●</span>
    </div>
    <div class="metric-btn" data-metric="appreciationPotential">
        <span>升值潜力 (Future)</span>
        <span style="color: #ff0044;">●</span>
    </div>
    <div style="margin-top: 15px; font-size: 0.7em; color: #555; text-align: center;">
        *右键拖动旋转视角 / 点击区域查看详情
    </div>
</div>

<div id="sidebar">
    <span id="ward-subtitle">TOKYO WARD ANALYSIS</span>
    <h1 id="ward-title"></h1>
    <div class="tags" id="ward-tags"></div>
    
    <div class="stat-grid" id="ward-stats"></div>
    
    <div id="chart-container">
        <canvas id="radarChart"></canvas>
    </div>

    <h3>INVESTMENT SUMMARY</h3>
    <p id="analysis-text"></p>
</div>

<script>
    // ================= CONFIGURATION =================
    // 这是一个公共测试 Token，如果失效，请去 mapbox.com 免费申请一个替换下方的字符串
    mapboxgl.accessToken = 'pk.eyJ1Ijoic3VwZXJtaWtlIiwiYSI6ImNqZ2d0aWNjZzAwNGEzM21tNGN1Z2t6cW0ifQ.Sg33o3qZ4W7wA5b5xWc03A';
    // =================================================

    // --- 1. 模拟投资数据库 ---
    const db = {
        "千代田区": { growth: 4.5, airbnb: 6.0, rental: 3.5, future: 9.0, tags: ["premium", "office"], text: "日本政治经济核心。资产安全性最高，但门槛极高。主要针对超高净值人群的资产保值。" },
        "中央区": { growth: 6.8, airbnb: 8.5, rental: 4.2, future: 8.0, tags: ["premium", "tourist"], text: "银座与筑地。商业价值极高，奥运后持续再开发。适合高端商业地产及针对游客的高级民泊。" },
        "港区": { growth: 5.5, airbnb: 7.5, rental: 3.5, future: 9.5, tags: ["premium", "expat"], text: "国际化富人区（六本木/麻布）。外资高管租赁需求旺盛，品牌溢价极高，是身份的象征。" },
        "新宿区": { growth: 7.2, airbnb: 9.8, rental: 5.5, future: 7.5, tags: ["tourist", "hub"], text: "拥有世界最大客流量车站。民宿回报率极高，但也伴随激烈的竞争。适合追求高现金流的投资者。" },
        "文京区": { growth: 3.8, airbnb: 5.0, rental: 4.8, future: 6.5, tags: ["edu", "quiet"], text: "文教地区，治安极好。适合面向家庭的稳定长租公寓，虽然爆发力不足，但空置率风险极低。" },
        "台东区": { growth: 8.5, airbnb: 9.5, rental: 5.8, future: 7.0, tags: ["tourist", "culture"], text: "浅草/上野。旅游业是绝对支柱，小户型公寓和民宿投资性价比极高，土地价格仍在补涨。" },
        "墨田区": { growth: 7.9, airbnb: 8.5, rental: 5.6, future: 7.2, tags: ["tourist"], text: "晴空塔效应。相比一河之隔的台东区，房价更亲民，具有不错的升值潜力和民宿运营空间。" },
        "江东区": { growth: 6.2, airbnb: 6.0, rental: 5.0, future: 6.8, tags: ["family"], text: "丰洲/有明湾岸区。塔楼林立，年轻家庭流入多。需关注奥运场馆后续利用及交通拥堵问题。" },
        "品川区": { growth: 5.8, airbnb: 7.0, rental: 4.9, future: 8.5, tags: ["business"], text: "新干线门户，磁悬浮始发站预期。商务需求强劲，资产升值潜力大，适合单身公寓投资。" },
        "目黑区": { growth: 5.2, airbnb: 6.5, rental: 4.2, future: 8.2, tags: ["premium", "trendy"], text: "中目黑/自由之丘。深受高收入年轻人喜爱，租金抗跌性强，品牌价值仅次于港区。" },
        "大田区": { growth: 4.1, airbnb: 7.8, rental: 5.5, future: 5.5, tags: ["airport"], text: "羽田机场门户。特区民泊政策优势明显。蒲田周边商业配套成熟，实利主义投资者的选择。" },
        "世田谷区": { growth: 3.5, airbnb: 4.5, rental: 4.5, future: 6.0, tags: ["residential"], text: "东京最大的居住区。环境优美，适合长期持有作为家族资产，但租金回报率相对平庸。" },
        "涩谷区": { growth: 8.8, airbnb: 9.2, rental: 4.0, future: 9.8, tags: ["premium", "it", "youth"], text: "IT产业与潮流中心。百年一遇的大规模再开发。全类型资产皆宜，升值潜力全东京顶级。" },
        "中野区": { growth: 5.0, airbnb: 6.5, rental: 5.3, future: 5.8, tags: ["subculture"], text: "新宿的后花园。单身人口密集，租赁需求极大且稳定，非常适合入门级单身公寓投资。" },
        "杉并区": { growth: 3.9, airbnb: 4.8, rental: 4.7, future: 5.5, tags: ["residential"], text: "中央线沿线人气居住区。虽然缺乏爆点，但资产极其稳定，适合避险型资金。" },
        "丰岛区": { growth: 7.5, airbnb: 8.9, rental: 5.7, future: 7.0, tags: ["tourist", "anime"], text: "池袋副都心。动漫文化吸引全球年轻人。实际上是目前性价比极高的商业与民宿投资洼地。" },
        "北区": { growth: 4.5, airbnb: 5.5, rental: 5.8, future: 5.0, tags: ["value"], text: "赤羽等地交通极其便利，但房价相对较低。适合追求高租售比（Yield）的投资者。" },
        "荒川区": { growth: 5.5, airbnb: 6.0, rental: 6.0, future: 5.2, tags: ["value"], text: "下町风情。日暮里交通枢纽加持。在山手线沿线中属于价格洼地，租金回报率表现不错。" },
        "板桥区": { growth: 3.8, airbnb: 4.2, rental: 5.5, future: 4.5, tags: ["bedtown"], text: "典型睡城。人口密度高，家庭租赁需求大。房价波动极小，适合极度保守的收租策略。" },
        "练马区": { growth: 3.2, airbnb: 3.5, rental: 5.2, future: 4.8, tags: ["green"], text: "绿化好，适合育儿。但距离市中心较远，投资属性较弱，更多是自住属性。" },
        "足立区": { growth: 4.2, airbnb: 4.5, rental: 6.5, future: 4.5, tags: ["high-yield"], text: "东京房价地板。表面回报率（表面利回）全东京最高，但需精选地段以规避空置和治安风险。" },
        "葛饰区": { growth: 3.5, airbnb: 5.5, rental: 6.2, future: 4.2, tags: ["old-tokyo"], text: "柴又老街。电影里的老东京。虽然有旅游元素，但整体仍以低价长租市场为主。" },
        "江户川区": { growth: 3.8, airbnb: 4.8, rental: 5.9, future: 4.5, tags: ["family"], text: "公园多，育儿福利好。房价亲民。注意部分低洼地区的洪水风险对资产价值的影响。" }
    };

    // --- 2. 初始化地图 ---
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11', // 深色模式
        center: [139.75, 35.68],
        zoom: 10.8,
        pitch: 50,
        bearing: -15,
        antialias: true,
        projection: 'mercator'
    });

    let currentMetric = 'growthRate';
    let myChart = null;

    // 颜色配置
    const colors = {
        growthRate: ['#240038', '#d600ff'], // 紫
        airbnbROI: ['#002b38', '#00f2ff'], // 青
        rentalYield: ['#381a00', '#ff7700'],// 橙
        appreciationPotential: ['#38000f', '#ff0044'] // 红
    };

    map.on('load', () => {
        // 隐藏 loading
        document.getElementById('loader').style.opacity = 0;
        setTimeout(() => document.getElementById('loader').remove(), 500);

        // 加载东京数据
        map.addSource('wards', {
            type: 'geojson',
            data: 'https://raw.githubusercontent.com/dataofjapan/land/master/tokyo.geojson',
            generateId: true
        });

        // 交互层 (透明)
        map.addLayer({
            'id': 'wards-fill',
            'type': 'fill',
            'source': 'wards',
            'paint': { 'fill-color': 'transparent' }
        });

        // 3D 拉伸层 (核心视觉)
        map.addLayer({
            'id': 'wards-extrusion',
            'type': 'fill-extrusion',
            'source': 'wards',
            'paint': {
                'fill-extrusion-color': getFillColor('growth'),
                'fill-extrusion-height': getHeight('growth'),
                'fill-extrusion-base': 0,
                'fill-extrusion-opacity': 0.9
            }
        });

        // 轮廓线
        map.addLayer({
            'id': 'wards-line',
            'type': 'line',
            'source': 'wards',
            'paint': {
                'line-color': '#fff',
                'line-width': 1.5,
                'line-opacity': 0.2
            }
        });

        // Hover 效果
        map.on('mousemove', 'wards-fill', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'wards-fill', () => map.getCanvas().style.cursor = '');

        // Click 效果
        map.on('click', 'wards-fill', (e) => {
            const feature = e.features[0];
            const name = feature.properties.N03_004 || feature.properties.name; 
            // 简单的名称清洗
            const cleanName = name.replace('Chiyoda', '千代田区').replace('Minato', '港区'); 
            // 注意：实际 GeoJSON 的英文/日文匹配可能需要更完善的映射表
            // 本 Demo 尽量匹配日文名，如果 GeoJSON 是英文需要额外映射逻辑
            // 假设 GeoJSON 包含日文字段，这里直接尝试匹配 DB
            
            // 尝试直接匹配或模糊匹配
            let data = db[name];
            if(!data) {
                // 简单的 Fallback 搜索
                const key = Object.keys(db).find(k => name.includes(k) || k.includes(name));
                if(key) data = db[key];
            }

            if (data) {
                updateSidebar(name, data);
                // 高亮选中区
                map.setPaintProperty('wards-extrusion', 'fill-extrusion-opacity', [
                    'case', ['==', ['id'], feature.id], 1, 0.4
                ]);
            } else {
                console.log("No data for:", name);
            }
        });
        
        // 点击空白重置
        map.on('click', (e) => {
            const f = map.queryRenderedFeatures(e.point, { layers: ['wards-fill']});
            if(!f.length) {
                document.getElementById('sidebar').classList.remove('open');
                map.setPaintProperty('wards-extrusion', 'fill-extrusion-opacity', 0.9);
            }
        });
    });

    // --- 3. 动态样式生成器 ---
    function getFillColor(metricKey) {
        const expression = ['match', ['get', 'N03_004']]; // 匹配 GeoJSON 里的区名
        const theme = metricKey === 'growth' ? colors.growthRate : 
                      metricKey === 'airbnb' ? colors.airbnbROI :
                      metricKey === 'rental' ? colors.rentalYield : colors.appreciationPotential;

        for (const [ward, data] of Object.entries(db)) {
            expression.push(ward);
            // 简单的三阶颜色映射
            const val = data[metricKey];
            if (val >= 8.0) expression.push(theme[1]);
            else if (val >= 5.0) expression.push(lerpColor(theme[0], theme[1], 0.5));
            else expression.push(theme[0]);
        }
        expression.push('#333'); // Default
        return expression;
    }

    function getHeight(metricKey) {
        const expression = ['match', ['get', 'N03_004']];
        for (const [ward, data] of Object.entries(db)) {
            expression.push(ward);
            expression.push(data[metricKey] * 400); // 夸张高度
        }
        expression.push(100);
        return expression;
    }

    // 辅助: 颜色混合 (简化版)
    function lerpColor(a, b, amount) { return amount > 0.5 ? b : a; }

    // --- 4. 界面逻辑 ---
    document.querySelectorAll('.metric-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget;
            document.querySelectorAll('.metric-btn').forEach(b => b.classList.remove('active'));
            target.classList.add('active');
            
            const metric = target.dataset.metric;
            let key = 'growth';
            if(metric === 'airbnbROI') key = 'airbnb';
            if(metric === 'rentalYield') key = 'rental';
            if(metric === 'appreciationPotential') key = 'future';

            map.setPaintProperty('wards-extrusion', 'fill-extrusion-color', getFillColor(key));
            map.setPaintProperty('wards-extrusion', 'fill-extrusion-height', getHeight(key));
        });
    });

    function updateSidebar(name, data) {
        document.getElementById('ward-title').innerText = name;
        
        // 标签
        const tagsHtml = data.tags.map(t => {
            let cls = '';
            if(t==='premium') cls='tag-premium';
            if(t==='tourist') cls='tag-tourist';
            return `<span class="tag ${cls}">#${t.toUpperCase()}</span>`;
        }).join('');
        document.getElementById('ward-tags').innerHTML = tagsHtml;

        // 统计数据
        document.getElementById('ward-stats').innerHTML = `
            <div class="stat-box"><span class="stat-label">土地增长</span><span class="stat-value ${getValClass(data.growth)}">${data.growth}%</span></div>
            <div class="stat-box"><span class="stat-label">民宿回报</span><span class="stat-value ${getValClass(data.airbnb)}">${data.airbnb}</span></div>
            <div class="stat-box"><span class="stat-label">长租回报</span><span class="stat-value ${getValClass(data.rental)}">${data.rental}%</span></div>
            <div class="stat-box"><span class="stat-label">升值潜力</span><span class="stat-value ${getValClass(data.future)}">${data.future}</span></div>
        `;

        document.getElementById('analysis-text').innerText = data.text;
        
        // 图表
        updateChart(data);
        document.getElementById('sidebar').classList.add('open');
    }

    function getValClass(v) { return v>=7 ? 'val-high' : v>=5 ? 'val-mid' : 'val-low'; }

    function updateChart(data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Growth', 'Airbnb', 'Rental', 'Future'],
                datasets: [{
                    label: 'Score',
                    data: [data.growth, data.airbnb, data.rental, data.future],
                    backgroundColor: 'rgba(0, 242, 255, 0.2)',
                    borderColor: '#00f2ff',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        pointLabels: { color: '#888' },
                        suggestedMin: 0, suggestedMax: 10,
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } },
                maintainAspectRatio: false
            }
        });
    }
</script>
</body>
</html>
