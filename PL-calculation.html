<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title> è´­ç§Ÿæµ‹ç®— | è˜‡çš„å·¥å…·ç®± </title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<style>
/* åŸºç¡€é‡ç½®ä¸å¸ƒå±€ */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans SC',system-ui,Arial,sans-serif;background:#f5f5f7;color:#1d1d1f;padding:16px;min-height:100vh;font-size:13px}
.container{max-width:860px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px}

/* å¤´éƒ¨ */
header{text-align:center;padding-bottom:16px;border-bottom:1px solid #e5e5e7;margin-bottom:16px}
h1{font-size:1.4rem;font-weight:600;letter-spacing:1px;color:#1d1d1f;margin-bottom:4px}
.subtitle{color:#86868b;font-size:0.75rem}
.top-bar{display:flex;justify-content:flex-end;margin-bottom:10px}
.top-bar select{padding:4px 10px;border-radius:6px;border:1px solid #d2d2d7;background:#fff;color:#1d1d1f;font-size:0.75rem}

/* é€‰é¡¹å¡ */
.tabs{display:flex;gap:8px;margin-bottom:20px;border-bottom:1px solid #e5e5e7;padding-bottom:12px}
.tab{padding:8px 16px;border-radius:6px;background:#f5f5f7;border:1px solid #e5e5e7;cursor:pointer;font-size:0.85rem;color:#515154;transition:all .2s;font-weight:500}
.tab:hover{background:#e8e8ed;color:#1d1d1f}
.tab.active{background:#0071e3;color:#fff;border-color:#0071e3}
.panel{display:none}
.panel.active{display:block}

/* è¡¨å•åŒºåŸŸ */
.section{border:1px solid #e5e5e7;border-radius:8px;padding:16px;margin-bottom:16px;background:#fff}
.section-title{font-size:0.8rem;color:#86868b;margin-bottom:12px;font-weight:600;display:flex;align-items:center;gap:6px;text-transform:uppercase;letter-spacing:0.5px}
.section-title::before{content:'';width:4px;height:12px;background:#0071e3;border-radius:2px}

/* æ …æ ¼å¸ƒå±€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid.col3{grid-template-columns:1fr 1fr 1fr}

/* è¾“å…¥æ§ä»¶ */
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:0.7rem;color:#515154;font-weight:500}
.field input,.field select{padding:8px 10px;border:1px solid #d2d2d7;border-radius:6px;background:#fafafa;color:#1d1d1f;font-size:0.9rem;transition:border-color .15s,background .15s}
.field input::placeholder {color: #a1a1a6;} 
.field input:focus,.field select:focus{outline:none;border-color:#0071e3;background:#fff;box-shadow:0 0 0 3px rgba(0,113,227,0.1)}
.field-hint{font-size:0.65rem;color:#86868b}

/* æŒ‰é’® */
.btn-row{display:flex;gap:10px;margin-top:20px;align-items: center;}
.btn{padding:10px 20px;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:500;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;white-space: nowrap;}
.btn-primary{background:#0071e3;color:#fff}
.btn-primary:hover{background:#0077ed;box-shadow:0 2px 4px rgba(0,113,227,0.3)}
.btn-secondary{background:#f5f5f7;border:1px solid #d2d2d7;color:#1d1d1f}
.btn-secondary:hover{background:#e8e8ed}

/* å¤–éƒ¨é“¾æ¥æŒ‰é’®æ ·å¼è°ƒæ•´ */
.btn-external-inline {
    background: #fff;
    border: 1px solid #d2d2d7; /* æµ…è‰²æè¾¹ */
    color: #86868b; /* æµ…è‰²æ–‡å­— */
    text-decoration: none;
    font-size: 0.8rem;
    margin-left: auto; /* é å³å¯¹é½ */
}
.btn-external-inline:hover {
    background: #f5f5f7;
    color: #1d1d1f;
    border-color: #86868b;
}

/* ç»“æœå±•ç¤º */
.result{margin-top:20px;padding:16px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;display:none}
.result.show{display:block;animation:fadeIn 0.3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

.result-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #e2e8f0}
.result-title{font-size:0.9rem;font-weight:700;color:#1d1d1f;display:flex;align-items:center;gap:8px;}
.result-total{font-size:1.2rem;color:#0071e3;font-weight:700}

.result-table{width:100%;font-size:0.8rem;border-collapse:collapse}
.result-table td{padding:8px 4px;border-bottom:1px solid #f1f5f9}
.result-table tr:last-child td{border-bottom:none}
.result-table td:last-child{text-align:right;font-weight:500;color:#1d1d1f;font-family:'Menlo',monospace} 
.result-table tr.highlight{background:#e8f4fd}
.result-table tr.highlight td{color:#0055b3;font-weight:700}
.result-table tr.header-row td{font-weight:700;color:#515154;background:#f1f5f9;padding:6px 4px}
.result-table tr.sub td{color:#64748b;font-size:0.75rem;padding-left:16px}
.result-note{font-size:0.7rem;color:#94a3b8;margin-top:12px;text-align:center}

/* å›¾è¡¨å›¾æ ‡ */
.chart-icon {
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px; height: 24px;
    border-radius: 50%;
    background: #fff;
    border: 1px solid #e5e5e7;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.chart-icon:hover { transform: scale(1.1); background: #f0f8ff; border-color: #0071e3; }

/* æŒ‡æ ‡ç½‘æ ¼ */
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.metric{background:#fff;border:1px solid #e2e8f0;border-radius:6px;padding:12px;text-align:center}
.metric .val{font-size:1.2rem;font-weight:700;color:#0071e3;font-family:'Menlo',monospace}
.metric .lbl{font-size:0.7rem;color:#64748b;margin-top:4px}
.metric.warn .val{color:#d97706}
.metric.good .val{color:#059669}

/* å¼¹çª— */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;justify-content:center;align-items:center;z-index:100;backdrop-filter:blur(2px)}
.modal.show{display:flex}
.modal-content{width:92%;max-width:520px;background:#fff;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.15);overflow:hidden;max-height:90vh;display:flex;flex-direction:column}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid #e5e5e7;background:#f8f8fa}
.modal-header h3{font-size:0.95rem;font-weight:600}
.modal-close{width:30px;height:30px;border:none;background:transparent;cursor:pointer;font-size:1.5rem;color:#86868b;line-height:1}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-actions{padding:16px 20px;border-top:1px solid #e5e5e7;display:flex;justify-content:flex-end;gap:10px;background:#f8f8fa}

/* å›¾è¡¨å®¹å™¨ */
#chartContainer { width: 100%; height: 350px; }

.hidden-input{display:none;}
.hidden-input.show{display:flex;}
.info-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:10px;margin-bottom:16px;font-size:0.75rem;color:#1e40af;display:flex;gap:8px;align-items:center}

@media(max-width:600px){.form-grid,.form-grid.col3{grid-template-columns:1fr}.result-grid{grid-template-columns:1fr}.btn-row{flex-wrap:wrap;}.btn-external-inline{width:100%;text-align:center;justify-content:center;margin-top:8px;}}
</style>
</head>
<body>
<div class="container">
<div class="top-bar">
    <select id="lang" onchange="switchLang()">
        <option value="zh">ä¸­æ–‡</option>
        <option value="jp">æ—¥æœ¬èª</option>
    </select>
</div>
<header>
    <h1 id="title">è´­ç§Ÿæµ‹ç®—</h1>
    <p class="subtitle" id="subtitle">è˜‡çš„å·¥å…·ç®± Â· æ—¥æœ¬ä¸åŠ¨äº§è´­ç½®æˆæœ¬ä¸ç§Ÿå”®å›æŠ¥æ¨¡æ‹Ÿ</p>
</header>

<div class="tabs">
    <div class="tab active" data-tab="buy" id="tabBuy">è´­ç½®æˆæœ¬</div>
    <div class="tab" data-tab="rent" id="tabRent">é•¿ç§Ÿæ”¶ç›Š</div>
    <div class="tab" id="openSetting">âš™ ç¨ç‡è®¾å®š</div>
</div>

<section id="buy" class="panel active">
    <div class="section">
        <div class="section-title" id="sec_property">ç‰©ä»¶ä¿¡æ¯</div>
        <div class="form-grid">
            <div class="field">
                <label id="lblPrice">ç‰©ä»¶ä»·æ ¼ (å††)</label>
                <input type="text" inputmode="numeric" id="price" placeholder="40,000,000" oninput="formatCurr(this)">
                <p class="field-hint" id="hintPrice">å¸‚åœºäº¤æ˜“ä»·æ ¼</p>
            </div>
            <div class="field">
                <label id="lblEval">å›ºå®šèµ„äº§è¯„ä¼°ä»· (å††)</label>
                <input type="text" inputmode="numeric" id="evalPrice" placeholder="28,000,000" oninput="formatCurr(this)">
                <p class="field-hint" id="hintEval">é€šå¸¸ä¸ºå¸‚ä»·çš„70%ï¼Œç”¨äºè®¡ç¨</p>
            </div>
            <div class="field">
                <label id="lblType">ç‰©ä»¶ç±»å‹</label>
                <select id="propType"><option value="house">ä¸€æˆ·å»º/æ•´æ ‹</option><option value="mansion">å…¬å¯“ï¼ˆåŒºåˆ†æ‰€æœ‰ï¼‰</option><option value="land">åœŸåœ°</option></select>
            </div>
            <div class="field">
                <label id="lblAge">æˆ¿é¾„</label>
                <select id="propAge"><option value="new">æ–°å»ºï¼ˆ5å¹´å†…ï¼‰</option><option value="used">äºŒæ‰‹æˆ¿</option></select>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title" id="sec_cost">è´­ç½®è´¹ç”¨é¡¹ç›®</div>
        <div class="form-grid col3">
            <div class="field">
                <label id="lblBroker">ä¸­ä»‹æ‰‹ç»­è´¹</label>
                <select id="broker" onchange="toggleBrokerInput()">
                    <option value="3pct">3% (å¸¸è§„)</option>
                    <option value="1.5pct">1.5% (åŠé¢)</option>
                    <option value="custom_amt">è‡ªå®šä¹‰é‡‘é¢</option>
                    <option value="custom_pct">è‡ªå®šä¹‰æ¯”ä¾‹</option>
                    <option value="no">æ—  (æ–°æˆ¿ç›´é”€)</option>
                </select>
            </div>
            <div class="field hidden-input" id="brokerCustomField">
                <label id="lblBrokerVal">è¾“å…¥æ•°å€¼</label>
                <input type="text" inputmode="decimal" id="brokerCustomVal" placeholder="0" oninput="formatCurr(this)">
                <p class="field-hint">é‡‘é¢(å††) æˆ– æ¯”ä¾‹(%)</p>
            </div>

            <div class="field"><label id="lblShiho">å¸æ³•ä¹¦å£«è´¹ (å††)</label><input type="text" inputmode="numeric" id="shiho" placeholder="150,000" oninput="formatCurr(this)"></div>
            <div class="field"><label id="lblFire">ç«ç¾ä¿é™© (å††)</label><input type="text" inputmode="numeric" id="fire" placeholder="100,000" oninput="formatCurr(this)"></div>
        </div>
    </div>

    <div class="btn-row">
        <button class="btn btn-primary" id="btnCalcBuy">è®¡ç®—è´­ç½®æˆæœ¬</button>
        <button class="btn btn-secondary" onclick="resetBuy()">é‡ç½®</button>
    </div>
    <div class="result" id="buyResult"></div>
</section>

<section id="rent" class="panel">
    <div class="info-box" id="infoRent">â„¹ï¸ æ”¶ç›Šæ¨¡æ‹Ÿå°†åŸºäºã€Œè´­ç½®æˆæœ¬ã€é¡µé¢çš„ç‰©ä»¶ä»·æ ¼è¿›è¡Œå…¨æ¬¾å›æŠ¥æµ‹ç®—ã€‚</div>

    <div class="section">
        <div class="section-title" id="sec_rental">é•¿ç§Ÿæ”¶å…¥å‚æ•°</div>
        <div class="form-grid">
            <div class="field"><label id="lblRent">æœˆç§Ÿé‡‘ (å††)</label><input type="text" inputmode="numeric" id="rentInput" placeholder="150,000" oninput="formatCurr(this)"></div>
            <div class="field"><label id="lblOcc">å¹´å¹³å‡å…¥å±…ç‡</label><input type="number" id="occ" step="0.01" placeholder="0.95"><p class="field-hint">ä¸€èˆ¬è®¾ä¸º0.92~0.96</p></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title" id="sec_expense">è¿è¥æˆæœ¬</div>
        <div class="form-grid col3">
            <div class="field"><label id="lblMgmt">ç®¡ç†è´¹/æ‰˜ç®¡è´¹ (%)</label><input type="number" id="mgmt" placeholder="5"><p class="field-hint">é€šå¸¸3-5%</p></div>
            <div class="field"><label id="lblRep">ä¿®ç¹•ç§¯ç«‹é‡‘ (%)</label><input type="number" id="rep" placeholder="5"><p class="field-hint">ç”¨äºæœªæ¥ç¿»ä¿®</p></div>
            <div class="field"><label id="lblOther">å…¶ä»–æ‚è´¹/å¹´ (å††)</label><input type="text" inputmode="numeric" id="otherCost" placeholder="0" oninput="formatCurr(this)"></div>
        </div>
    </div>

    <div class="btn-row">
        <button class="btn btn-primary" id="btnCalcRent">è®¡ç®—é•¿ç§Ÿå›æŠ¥</button>
        <button class="btn btn-secondary" onclick="resetRent()">é‡ç½®</button>
        
        <a href="https://1211.world/count.html" target="_blank" class="btn btn-external-inline">
            ğŸ“Š æ°‘å®¿/æ—…é¦†å›æŠ¥æµ‹ç®— (ç‚¹å‡»è·³è½¬)
        </a>
    </div>

    <div class="result" id="rentResult"></div>
</section>
</div>

<div class="modal" id="settingModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="settingTitle">ç¨ç‡å‚æ•°è®¾å®š</h3>
            <button class="modal-close" onclick="closeModal('settingModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="section-title" id="lblTaxBuy">è´­ç½®æ—¶ç¨è´¹</div>
            <div class="form-grid" style="margin-bottom:14px">
                <div class="field"><label id="lblAcqLand">ä¸åŠ¨äº§å–å¾—ç¨-åœŸåœ° (%)</label><input type="number" id="acqLand" value="1.5" step="0.1"></div>
                <div class="field"><label id="lblAcqBld">ä¸åŠ¨äº§å–å¾—ç¨-å»ºç‰© (%)</label><input type="number" id="acqBld" value="3" step="0.1"></div>
                <div class="field"><label id="lblRegLand">ç™»å½•å…è®¸ç¨-åœŸåœ° (%)</label><input type="number" id="regLand" value="1.5" step="0.1"></div>
                <div class="field"><label id="lblRegBld">ç™»å½•å…è®¸ç¨-å»ºç‰© (%)</label><input type="number" id="regBld" value="2" step="0.1"></div>
            </div>
            <div class="section-title" id="lblTaxHold">æŒæœ‰æ—¶ç¨è´¹ï¼ˆå¹´ï¼‰</div>
            <div class="form-grid" style="margin-bottom:14px">
                <div class="field"><label id="lblFixedTax">å›ºå®šèµ„äº§ç¨ (%)</label><input type="number" id="fixedTax" value="1.4" step="0.1"></div>
                <div class="field"><label id="lblCityTax">éƒ½å¸‚è®¡åˆ’ç¨ (%)</label><input type="number" id="cityTax" value="0.3" step="0.1"></div>
            </div>
            <div class="section-title">å°çº¸ç¨è®¾å®š</div>
            <div class="field"><label id="lblStampCustom">è‡ªå®šä¹‰å°çº¸ç¨ (å††)</label><input type="text" inputmode="numeric" id="customStamp" placeholder="0" oninput="formatCurr(this)"><p class="field-hint">ç•™ç©ºåˆ™è‡ªåŠ¨è®¡ç®—</p></div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('settingModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="saveSetting">ä¿å­˜è®¾å®š</button>
        </div>
    </div>
</div>

<div class="modal" id="chartModal">
    <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
            <h3 id="chartTitle">æˆæœ¬åˆ†æ</h3>
            <button class="modal-close" onclick="closeModal('chartModal')">Ã—</button>
        </div>
        <div class="modal-body" style="overflow:hidden;">
            <div id="chartContainer"></div>
        </div>
    </div>
</div>

<script>
// --- é…ç½®ä¸å¸¸é‡ ---
const TAX={acqLand:1.5,acqBld:3,regLand:1.5,regBld:2,fixedTax:1.4,cityTax:0.3,customStamp:0};
const VAT=1.10; 
const STAMP=[{max:1e6,tax:1000},{max:5e6,tax:2000},{max:1e7,tax:10000},{max:5e7,tax:20000},{max:1e8,tax:60000},{max:5e8,tax:100000},{max:1e9,tax:200000},{max:Infinity,tax:600000}];
const L={
    zh:{title:"è´­ç§Ÿæµ‹ç®—",subtitle:"è˜‡çš„å·¥å…·ç®± Â· æ—¥æœ¬ä¸åŠ¨äº§è´­ç½®æˆæœ¬ä¸ç§Ÿå”®å›æŠ¥æ¨¡æ‹Ÿ",tabBuy:"è´­ç½®æˆæœ¬",tabRent:"é•¿ç§Ÿæ”¶ç›Š",openSetting:"âš™ ç¨ç‡è®¾å®š",sec_property:"ç‰©ä»¶ä¿¡æ¯",lblPrice:"ç‰©ä»¶ä»·æ ¼ (å††)",hintPrice:"å¸‚åœºäº¤æ˜“ä»·æ ¼",lblEval:"å›ºå®šèµ„äº§è¯„ä¼°ä»· (å††)",hintEval:"é€šå¸¸ä¸ºå¸‚ä»·çš„70%ï¼Œç”¨äºè®¡ç¨",lblType:"ç‰©ä»¶ç±»å‹",lblAge:"æˆ¿é¾„",sec_cost:"è´­ç½®è´¹ç”¨é¡¹ç›®",lblBroker:"ä¸­ä»‹æ‰‹ç»­è´¹",lblShiho:"å¸æ³•ä¹¦å£«è´¹ (å††)",lblFire:"ç«ç¾ä¿é™© (å††)",btnCalcBuy:"è®¡ç®—è´­ç½®æˆæœ¬",
    infoRent:"â„¹ï¸ æ”¶ç›Šæ¨¡æ‹Ÿå°†åŸºäºã€Œè´­ç½®æˆæœ¬ã€é¡µé¢çš„ç‰©ä»¶ä»·æ ¼è¿›è¡Œå…¨æ¬¾å›æŠ¥æµ‹ç®—ã€‚",
    sec_rental:"é•¿ç§Ÿæ”¶å…¥å‚æ•°",lblRent:"æœˆç§Ÿé‡‘ (å††)",lblOcc:"å¹´å¹³å‡å…¥å±…ç‡",sec_expense:"è¿è¥æˆæœ¬",lblMgmt:"ç®¡ç†è´¹/æ‰˜ç®¡è´¹ (%)",lblRep:"ä¿®ç¹•ç§¯ç«‹é‡‘ (%)",lblOther:"å…¶ä»–æ‚è´¹/å¹´ (å††)",btnCalcRent:"è®¡ç®—é•¿ç§Ÿå›æŠ¥",settingTitle:"ç¨ç‡å‚æ•°è®¾å®š",resultBuy:"è´­ç½®æˆæœ¬æ˜ç»†",resultRent:"é•¿ç§Ÿæ”¶ç›Šæ¨¡æ‹Ÿç»“æœ",note:"ï¼ˆä¼°ç®—ä»…ä¾›å‚è€ƒï¼Œå®é™…ä»¥å®˜æ–¹ä¸ºå‡†ï¼‰",
    lblBrokerVal:"è‡ªå®šä¹‰æ•°å€¼",opt3pct:"3% (å¸¸è§„)",opt15pct:"1.5% (åŠé¢)",optCustAmt:"è‡ªå®šä¹‰é‡‘é¢",optCustPct:"è‡ªå®šä¹‰æ¯”ä¾‹",optNo:"æ— "},
    jp:{title:"è³¼å…¥ãƒ»åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼",subtitle:"è˜‡ã®ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ Â· æ—¥æœ¬ä¸å‹•ç”£ã®è³¼å…¥è²»ç”¨ã¨åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",tabBuy:"è³¼å…¥è²»ç”¨",tabRent:"å®¶è³ƒåå…¥",openSetting:"âš™ ç¨ç‡è¨­å®š",sec_property:"ç‰©ä»¶æƒ…å ±",lblPrice:"ç‰©ä»¶ä¾¡æ ¼ (å††)",hintPrice:"å¸‚å ´å–å¼•ä¾¡æ ¼",lblEval:"å›ºå®šè³‡ç”£è©•ä¾¡é¡ (å††)",hintEval:"é€šå¸¸å¸‚ä¾¡ã®70%ã€èª²ç¨åŸºæº–",lblType:"ç‰©ä»¶ã‚¿ã‚¤ãƒ—",lblAge:"ç¯‰å¹´æ•°",sec_cost:"è³¼å…¥è«¸è²»ç”¨",lblBroker:"ä»²ä»‹æ‰‹æ•°æ–™",lblShiho:"å¸æ³•æ›¸å£«è²»ç”¨ (å††)",lblFire:"ç«ç½ä¿é™º (å††)",btnCalcBuy:"è²»ç”¨ã‚’è¨ˆç®—",
    infoRent:"â„¹ï¸ åç›Šè©¦ç®—ã¯ã€Œè³¼å…¥è²»ç”¨ã€ãƒšãƒ¼ã‚¸ã®ç‰©ä»¶ä¾¡æ ¼ã«åŸºã¥ãã€ç¾é‡‘ä¸€æ‹¬ã¨ã—ã¦è¨ˆç®—ã—ã¾ã™ã€‚",
    sec_rental:"è³ƒè²¸æ¡ä»¶",lblRent:"æœˆé¡è³ƒæ–™ (å††)",lblOcc:"å…¥å±…ç‡",sec_expense:"é‹å–¶ã‚³ã‚¹ãƒˆ",lblMgmt:"ç®¡ç†è²» (%)",lblRep:"ä¿®ç¹•ç©ç«‹ (%)",lblOther:"ãã®ä»–çµŒè²»/å¹´ (å††)",btnCalcRent:"åç›Šè©¦ç®—",settingTitle:"ç¨ç‡è¨­å®š",resultBuy:"è³¼å…¥è²»ç”¨æ˜ç´°",resultRent:"åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",note:"ï¼ˆæ¦‚ç®—ã§ã™ã€‚å®Ÿéš›ã¯å…¬å¼æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰",
    lblBrokerVal:"ã‚«ã‚¹ã‚¿ãƒ å€¤",opt3pct:"3% (é€šå¸¸)",opt15pct:"1.5% (åŠé¡)",optCustAmt:"é‡‘é¡æŒ‡å®š",optCustPct:"å‰²åˆæŒ‡å®š(%)",optNo:"ãªã—"}
};
let curLang="zh";
// å­˜å‚¨å½“å‰è®¡ç®—çš„å›¾è¡¨æ•°æ®
let globalChartData = {};

const $=id=>document.getElementById(id);
const money=v=>"Â¥"+Math.round(v).toLocaleString();
const pct=v=>(v*100).toFixed(2)+"%";
const i18n=k=>L[curLang][k]||L.zh[k]||k;

// --- æ ¸å¿ƒå·¥å…·å‡½æ•° ---

// æ ¼å¼åŒ–è¾“å…¥æ¡†
function formatCurr(input) {
    let val = input.value.replace(/,/g, '').replace(/[^\d.]/g, ''); 
    if (!val) return;
    let parts = val.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    input.value = parts.join('.');
}

// è·å–æ•°å€¼
function getVal(id) {
    const el = $(id);
    if (!el) return 0;
    let raw = el.value !== "" ? el.value : el.placeholder;
    if(typeof raw === 'string') raw = raw.replace(/,/g, '');
    return Number(raw) || 0;
}

// åˆ‡æ¢è¯­è¨€
function switchLang(){
    curLang=$("lang").value;
    Object.keys(L[curLang]).forEach(k=>{
        const el=$(k);
        if(el && el.tagName!=="INPUT" && el.tagName!=="SELECT") el.textContent=L[curLang][k];
    });
    const brokerOpts = $("broker").options;
    brokerOpts[0].text = i18n("opt3pct");
    brokerOpts[1].text = i18n("opt15pct");
    brokerOpts[2].text = i18n("optCustAmt");
    brokerOpts[3].text = i18n("optCustPct");
    brokerOpts[4].text = i18n("optNo");
}

// Tab åˆ‡æ¢
document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click",()=>{
        if(btn.id==="openSetting"){$("settingModal").classList.add("show");return;}
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
        $(btn.dataset.tab).classList.add("active");
    });
});

function closeModal(id){$(id).classList.remove("show");}
$("saveSetting").addEventListener("click",()=>{
    TAX.acqLand=Number($("acqLand").value);TAX.acqBld=Number($("acqBld").value);
    TAX.regLand=Number($("regLand").value);TAX.regBld=Number($("regBld").value);
    TAX.fixedTax=Number($("fixedTax").value);TAX.cityTax=Number($("cityTax").value);
    TAX.customStamp=getVal("customStamp");
    closeModal('settingModal');
});

// äº¤äº’é€»è¾‘
function toggleBrokerInput() {
    const type = $("broker").value;
    const customField = $("brokerCustomField");
    if(type === "custom_amt" || type === "custom_pct") customField.classList.add("show");
    else customField.classList.remove("show");
}

function calcStamp(amt){
    const c=getVal("customStamp");
    if(c>0)return c;
    for(const r of STAMP)if(amt<=r.max)return r.tax;
    return 0;
}

// --- å›¾è¡¨é€»è¾‘ ---
function showChart(type) {
    const modal = $("chartModal");
    modal.classList.add("show");
    const container = $("chartContainer");
    const myChart = echarts.init(container);
    
    let title = "";
    let data = [];

    if (type === 'total') {
        title = "å–å¾—æˆæœ¬æ„æˆ";
        data = globalChartData.totalBreakdown;
    } else {
        title = "å„é¡¹ç¨è´¹æ˜ç»†";
        data = globalChartData.feeBreakdown;
    }

    $("chartTitle").textContent = title;

    const option = {
        tooltip: { trigger: 'item', formatter: '{b}: {c}å†† ({d}%)' },
        legend: { bottom: '0', left: 'center' },
        series: [
            {
                name: title,
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                label: { show: false, position: 'center' },
                emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
                data: data
            }
        ]
    };

    myChart.setOption(option);
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜
    window.addEventListener('resize', () => { myChart.resize(); });
    // ç¨å¾®å»¶è¿Ÿé‡ç»˜ä»¥ç¡®ä¿ Modal æ¸²æŸ“å®Œæˆ
    setTimeout(() => { myChart.resize(); }, 100);
}

// --- è®¡ç®—é€»è¾‘ï¼šè´­ç½®æˆæœ¬ ---
$("btnCalcBuy").addEventListener("click",()=>{
    const price = getVal("price");
    const evalP = getVal("evalPrice") || price*0.7;
    const evalLand = evalP * 0.4, evalBld = evalP * 0.6;
    const isNew = $("propAge").value === "new";
    const brokerType = $("broker").value;
    const shiho = getVal("shiho");
    const fire = getVal("fire");

    // ä¸­ä»‹è´¹
    let broker = 0;
    if(brokerType === "3pct") broker = price * 0.03 * VAT;
    else if(brokerType === "1.5pct") broker = price * 0.015 * VAT;
    else if(brokerType === "custom_amt") broker = getVal("brokerCustomVal");
    else if(brokerType === "custom_pct") broker = price * (getVal("brokerCustomVal")/100) * VAT;

    const shihoWithTax = shiho * VAT;
    const stamp = calcStamp(price);
    const acqTax = evalLand*(TAX.acqLand/100) + evalBld*(TAX.acqBld/100);
    const regTax = evalLand*(TAX.regLand/100) + evalBld*((isNew?0.4:TAX.regBld)/100);
    
    const totalTax = stamp + acqTax + regTax;
    const totalFee = broker + shihoWithTax + fire; // çº¯è´¹ç”¨
    const totalCost = totalTax + totalFee; // æ€»ç¨è´¹
    const grandTotal = price + totalCost; // ç‰©ä»¶+ç¨è´¹

    // å‡†å¤‡å›¾è¡¨æ•°æ®
    globalChartData.totalBreakdown = [
        { value: Math.round(price), name: 'ç‰©ä»¶ä»·æ ¼', itemStyle: { color: '#0071e3' } },
        { value: Math.round(broker), name: 'ä¸­ä»‹è´¹', itemStyle: { color: '#34c759' } },
        { value: Math.round(totalTax), name: 'å„é¡¹ç¨é‡‘', itemStyle: { color: '#ff9500' } },
        { value: Math.round(shihoWithTax + fire), name: 'å…¶ä»–æ‚è´¹', itemStyle: { color: '#af52de' } }
    ];
    globalChartData.feeBreakdown = [
        { value: Math.round(broker), name: 'ä¸­ä»‹æ‰‹ç»­è´¹' },
        { value: Math.round(acqTax), name: 'ä¸åŠ¨äº§å–å¾—ç¨' },
        { value: Math.round(regTax), name: 'ç™»å½•å…è®¸ç¨' },
        { value: Math.round(stamp), name: 'å°çº¸ç¨' },
        { value: Math.round(shihoWithTax), name: 'å¸æ³•ä¹¦å£«è´¹' },
        { value: Math.round(fire), name: 'ç«ç¾ä¿é™©' }
    ].filter(item => item.value > 0);

    // ç”ŸæˆHTML - æ’å…¥å›¾è¡¨å›¾æ ‡
    let html = `<div class="result-header">
        <span class="result-title">
            ${i18n("resultBuy")} 
            <span class="chart-icon" onclick="showChart('total')" title="æŸ¥çœ‹æ€»æˆæœ¬åˆ†å¸ƒ">ğŸ“Š</span>
        </span>
        <span class="result-total">${money(grandTotal)}</span>
    </div>`;
    
    html += `<table class="result-table">
    <tr class="header-row"><td colspan="2">â–  å–å¾—æˆæœ¬æ„æˆ</td></tr>
    <tr><td>1. ç‰©ä»¶ä»·æ ¼</td><td>${money(price)}</td></tr>
    <tr>
        <td>
            2. è´­ç½®æ€»ç¨è´¹ (è¯¦è§ä¸‹è¡¨) 
            <span class="chart-icon" onclick="showChart('fees')" title="æŸ¥çœ‹ç¨è´¹åˆ†å¸ƒ" style="width:18px;height:18px;font-size:0.75rem;margin-left:4px;vertical-align:middle">ğŸ“Š</span>
        </td>
        <td>${money(totalCost)}</td>
    </tr>
    <tr class="highlight" style="border-top:2px solid #0071e3"><td>å–å¾—æ€»è´¹ç”¨ (1+2)</td><td>${money(grandTotal)}</td></tr>
    <tr><td style="color:#666">æ€»ç¨è´¹å æˆ¿ä»·æ¯”ä¾‹</td><td>${(totalCost/price*100).toFixed(2)}%</td></tr>
    
    <tr class="header-row"><td colspan="2" style="padding-top:12px">â–  ç¨è´¹æ˜ç»†</td></tr>
    <tr><td>å°çº¸ç¨</td><td>${money(stamp)}</td></tr>
    <tr><td>ä¸åŠ¨äº§å–å¾—ç¨</td><td>${money(acqTax)}</td></tr>
    <tr><td>ç™»å½•å…è®¸ç¨</td><td>${money(regTax)}</td></tr>
    <tr><td>ä¸­ä»‹æ‰‹ç»­è´¹ (å«ç¨)</td><td>${money(broker)}</td></tr>
    <tr><td>å¸æ³•ä¹¦å£«è´¹ (å«ç¨)</td><td>${money(shihoWithTax)}</td></tr>
    <tr><td>ç«ç¾ä¿é™©</td><td>${money(fire)}</td></tr>
    </table>`;

    html += `<p class="result-note">${i18n("note")}</p>`;
    $("buyResult").innerHTML = html;
    $("buyResult").classList.add("show");
});

// --- è®¡ç®—é€»è¾‘ï¼šé•¿ç§Ÿæ”¶ç›Š (çº¯å…¨æ¬¾é€»è¾‘) ---
$("btnCalcRent").addEventListener("click",()=>{
    const price = getVal("price");
    const evalP = getVal("evalPrice") || price*0.7;
    
    // æ— è´·æ¬¾é€»è¾‘ï¼Œæœ¬é‡‘å³å…¨æ¬¾
    const principal = price; 
    const annualDebt = 0; 
    
    const rentVal = getVal("rentInput");
    const occ = getVal("occ");
    const mgmtPct = getVal("mgmt") / 100;
    const repPct = getVal("rep") / 100;
    const otherCost = getVal("otherCost");

    // æ”¶å…¥æ”¯å‡ºè®¡ç®—
    const annualIncome = rentVal * 12 * occ;
    const mgmtCost = annualIncome * mgmtPct;
    const repCost = annualIncome * repPct;
    const fixedTax = evalP * (TAX.fixedTax / 100);
    const cityTax = evalP * (TAX.cityTax / 100);
    const annualTax = fixedTax + cityTax;
    const totalExpense = mgmtCost + repCost + annualTax + otherCost;

    const noi = annualIncome - totalExpense; // å‡€è¥ä¸šæ”¶å…¥
    const cashFlow = noi - annualDebt; // ç¨å‰ç°é‡‘æµ (å…¨æ¬¾ä¸‹ç­‰äºNOI)

    // æŒ‡æ ‡
    const grossYield = price > 0 ? annualIncome / price : 0;
    const capRate = price > 0 ? noi / price : 0;
    // ç°é‡‘å›æŠ¥ç‡ (å…¨æ¬¾æ¨¡å¼ä¸‹ = Cap Rate)
    const cashOnCash = capRate; 

    const getClass = v => v >= 0.06 ? "good" : v >= 0.04 ? "" : "warn";

    let html = `<div class="result-header"><span class="result-title">${i18n("resultRent")}</span></div>`;
    
    html += `<div class="result-grid">
    <div class="metric"><div class="val">${pct(grossYield)}</div><div class="lbl">è¡¨é¢åˆ©å› Gross</div></div>
    <div class="metric ${getClass(capRate)}"><div class="val">${pct(capRate)}</div><div class="lbl">å®é™…åˆ©å› NET</div></div>
    <div class="metric"><div class="val">${money(cashFlow)}</div><div class="lbl">å¹´å‡€ç°é‡‘æµ</div></div>
    <div class="metric ${getClass(cashOnCash)}"><div class="val">${pct(cashOnCash)}</div><div class="lbl">ç°é‡‘å›æŠ¥ç‡</div></div>
    </div>`;

    html += `<table class="result-table">
    <tr class="header-row"><td colspan="2">â–  æ”¶å…¥ä¸æ”¯å‡º (å¹´)</td></tr>
    <tr><td>å¹´æ¯›æ”¶å…¥ (æœˆç§ŸÃ—12Ã—å…¥ä½ç‡)</td><td>${money(annualIncome)}</td></tr>
    <tr class="sub"><td>ç®¡ç†è´¹+ä¿®ç¼®é‡‘</td><td>-${money(mgmtCost+repCost)}</td></tr>
    <tr class="sub"><td>æŒæœ‰ç¨ (å›ºéƒ½ç¨)</td><td>-${money(annualTax)}</td></tr>
    <tr class="sub"><td>å…¶ä»–æ‚è´¹</td><td>-${money(otherCost)}</td></tr>
    <tr style="border-top:1px solid #e2e8f0;font-weight:600"><td>NOI (å‡€è¥ä¸šæ”¶å…¥)</td><td>${money(noi)}</td></tr>
    
    <tr class="header-row"><td colspan="2" style="padding-top:10px">â–  ç°é‡‘æµ</td></tr>
    <tr><td>NOI</td><td>${money(noi)}</td></tr>
    <tr><td>é“¶è¡Œè¿˜æ¬¾</td><td>- Â¥0 (å…¨æ¬¾)</td></tr>
    <tr class="highlight"><td>ç¨å‰ç°é‡‘æµ (BTCF)</td><td>${money(cashFlow)}</td></tr>
    </table>`;

    $("rentResult").innerHTML = html;
    $("rentResult").classList.add("show");
});

function resetBuy(){
    $("price").value=""; $("evalPrice").value="";
    $("propType").value="house"; $("propAge").value="used";
    $("broker").value="3pct"; toggleBrokerInput();
    $("shiho").value=""; $("fire").value="";
    $("buyResult").classList.remove("show");
}
function resetRent(){
    $("rentInput").value=""; $("occ").value="";
    $("mgmt").value=""; $("rep").value=""; $("otherCost").value="";
    $("rentResult").classList.remove("show");
}
</script>
</body>
</html>
