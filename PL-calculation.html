<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è´­ç§Ÿæµ‹ç®— | è˜‡çš„å·¥å…·ç®±</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans SC',system-ui,Arial,sans-serif;background:#f5f5f7;color:#1d1d1f;padding:16px;min-height:100vh;font-size:13px}
.container{max-width:860px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08);padding:20px 24px}
header{text-align:center;padding-bottom:14px;border-bottom:1px solid #e5e5e7;margin-bottom:14px}
h1{font-size:1.25rem;font-weight:600;letter-spacing:1px;color:#1d1d1f;margin-bottom:2px}
.subtitle{color:#86868b;font-size:0.72rem}
.top-bar{display:flex;justify-content:flex-end;margin-bottom:10px}
.top-bar select{padding:4px 10px;border-radius:4px;border:1px solid #d2d2d7;background:#fff;color:#1d1d1f;font-size:0.75rem}
.tabs{display:flex;gap:6px;margin-bottom:14px;border-bottom:1px solid #e5e5e7;padding-bottom:10px}
.tab{padding:7px 14px;border-radius:5px;background:#f5f5f7;border:1px solid #e5e5e7;cursor:pointer;font-size:0.78rem;color:#515154;transition:all .15s}
.tab:hover{border-color:#0071e3;color:#0071e3}
.tab.active{background:#0071e3;color:#fff;border-color:#0071e3}
.panel{display:none}
.panel.active{display:block}
.section{border:1px solid #e5e5e7;border-radius:6px;padding:12px;margin-bottom:10px}
.section-title{font-size:0.72rem;color:#86868b;margin-bottom:8px;font-weight:500;display:flex;align-items:center;gap:5px}
.section-title::before{content:'';width:3px;height:10px;background:#0071e3;border-radius:2px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.form-grid.col3{grid-template-columns:1fr 1fr 1fr}
.field{display:flex;flex-direction:column;gap:3px}
.field.full{grid-column:span 2}
.field label{font-size:0.68rem;color:#515154}
/* è¾“å…¥æ¡†æ ·å¼è°ƒæ•´ï¼šplaceholder ä¸ºç°è‰²ï¼Œè¾“å…¥å†…å®¹ä¸ºæ·±è‰² */
.field input,.field select{padding:7px 9px;border:1px solid #d2d2d7;border-radius:4px;background:#fafafa;color:#1d1d1f;font-size:0.82rem}
.field input::placeholder {color: #a1a1a6;} 
.field input:focus,.field select:focus{outline:none;border-color:#0071e3;background:#fff}
.field-hint{font-size:0.62rem;color:#86868b;margin-top:1px}
.btn{padding:9px 18px;border:none;border-radius:5px;font-size:0.82rem;cursor:pointer;font-weight:500;transition:all .15s}
.btn-primary{background:#0071e3;color:#fff}
.btn-primary:hover{background:#0077ed}
.btn-secondary{background:#f5f5f7;border:1px solid #d2d2d7;color:#1d1d1f}
.btn-secondary:hover{background:#e8e8ed}
.btn-row{display:flex;gap:8px;margin-top:12px}
.result{margin-top:12px;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;display:none}
.result.show{display:block}
.result-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #e5e5e7}
.result-title{font-size:0.82rem;font-weight:600;color:#1d1d1f}
.result-total{font-size:1.05rem;color:#0071e3;font-weight:700}
.result-table{width:100%;font-size:0.75rem}
.result-table tr{border-bottom:1px solid #f0f0f2}
.result-table tr:last-child{border-bottom:none}
.result-table td{padding:6px 4px}
.result-table td:last-child{text-align:right;font-weight:500;color:#1d1d1f}
.result-table tr.highlight{background:#e8f4fd}
.result-table tr.highlight td{color:#0055b3;font-weight:600}
.result-table tr.sub td{color:#86868b;font-size:0.7rem;padding:4px 4px 4px 12px}
.result-note{font-size:0.65rem;color:#86868b;margin-top:8px;text-align:center}
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.metric{background:#f5f5f7;border-radius:5px;padding:10px;text-align:center}
.metric .val{font-size:1.1rem;font-weight:700;color:#0071e3}
.metric .lbl{font-size:0.68rem;color:#515154;margin-top:2px}
.metric.warn .val{color:#d97706}
.metric.good .val{color:#059669}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;justify-content:center;align-items:center;z-index:100}
.modal.show{display:flex}
.modal-content{width:92%;max-width:520px;background:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.15);overflow:hidden;max-height:90vh;display:flex;flex-direction:column}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e5e7;background:#f8f8fa}
.modal-header h3{font-size:0.85rem;font-weight:600}
.modal-close{width:26px;height:26px;border:none;background:#e5e5e7;border-radius:50%;cursor:pointer;font-size:1rem;color:#666;display:flex;align-items:center;justify-content:center}
.modal-body{padding:14px 16px;overflow-y:auto;flex:1}
.stamp-table{width:100%;border-collapse:collapse;font-size:0.68rem;margin-bottom:12px}
.stamp-table th,.stamp-table td{padding:4px 6px;border:1px solid #e5e5e7;text-align:center}
.stamp-table th{background:#f5f5f7;color:#515154;font-weight:500}
.modal-actions{padding:12px 16px;border-top:1px solid #e5e5e7;display:flex;justify-content:flex-end;gap:8px}
.info-box{background:#fffbeb;border:1px solid #fde68a;border-radius:5px;padding:8px 10px;margin-bottom:10px;font-size:0.7rem;color:#92400e}
/* æ–°å¢ï¼šè‡ªå®šä¹‰è¾“å…¥æ¡†æ˜¾ç¤ºæ§åˆ¶ */
.hidden-input {display:none;}
.hidden-input.show {display:flex;}
@media(max-width:600px){.form-grid,.form-grid.col3{grid-template-columns:1fr}.field.full{grid-column:span 1}.result-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<div class="top-bar">
<select id="lang" onchange="switchLang()">
<option value="zh">ä¸­æ–‡</option>
<option value="jp">æ—¥æœ¬èª</option>
</select>
</div>
<header>
<h1 id="title">è´­ç§Ÿæµ‹ç®—</h1>
<p class="subtitle" id="subtitle">è˜‡çš„å·¥å…·ç®± Â· æ—¥æœ¬ä¸åŠ¨äº§è´­ç½®æˆæœ¬ä¸ç§Ÿå”®å›æŠ¥æ¨¡æ‹Ÿ</p>
</header>

<div class="tabs">
<div class="tab active" data-tab="buy" id="tabBuy">è´­ç½®æˆæœ¬</div>
<div class="tab" data-tab="rent" id="tabRent">æ”¶ç›Šæ¨¡æ‹Ÿ</div>
<div class="tab" id="openSetting">âš™ ç¨ç‡è®¾å®š</div>
</div>

<section id="buy" class="panel active">
<div class="section">
<div class="section-title" id="sec_property">ç‰©ä»¶ä¿¡æ¯</div>
<div class="form-grid">
<div class="field"><label id="lblPrice">ç‰©ä»¶ä»·æ ¼ (å††)</label><input type="number" id="price" placeholder="40000000"><p class="field-hint" id="hintPrice">å¸‚åœºäº¤æ˜“ä»·æ ¼</p></div>
<div class="field"><label id="lblEval">å›ºå®šèµ„äº§è¯„ä¼°ä»· (å††)</label><input type="number" id="evalPrice" placeholder="28000000"><p class="field-hint" id="hintEval">é€šå¸¸ä¸ºå¸‚ä»·çš„70%ï¼Œç”¨äºè®¡ç¨</p></div>
<div class="field"><label id="lblType">ç‰©ä»¶ç±»å‹</label><select id="propType"><option value="house">ä¸€æˆ·å»º/æ•´æ ‹</option><option value="mansion">å…¬å¯“ï¼ˆåŒºåˆ†æ‰€æœ‰ï¼‰</option><option value="land">åœŸåœ°</option></select></div>
<div class="field"><label id="lblAge">æˆ¿é¾„</label><select id="propAge"><option value="new">æ–°å»ºï¼ˆ5å¹´å†…ï¼‰</option><option value="used">äºŒæ‰‹æˆ¿</option></select></div>
</div>
</div>

<div class="section">
<div class="section-title" id="sec_cost">è´­ç½®è´¹ç”¨é¡¹ç›®</div>
<div class="form-grid col3">
<div class="field">
    <label id="lblBroker">ä¸­ä»‹æ‰‹ç»­è´¹</label>
    <select id="broker" onchange="toggleBrokerInput()">
        <option value="3pct">3% (å¸¸è§„)</option>
        <option value="1.5pct">1.5% (åŠé¢)</option>
        <option value="custom_amt">è‡ªå®šä¹‰é‡‘é¢</option>
        <option value="custom_pct">è‡ªå®šä¹‰æ¯”ä¾‹</option>
        <option value="no">æ—  (æ–°æˆ¿ç›´é”€)</option>
    </select>
</div>
<div class="field hidden-input" id="brokerCustomField">
    <label id="lblBrokerVal">è¾“å…¥æ•°å€¼</label>
    <input type="number" id="brokerCustomVal" placeholder="0">
    <p class="field-hint" id="hintBrokerCustom">é‡‘é¢(å††) æˆ– æ¯”ä¾‹(%)</p>
</div>

<div class="field"><label id="lblShiho">å¸æ³•ä¹¦å£«è´¹ (å††)</label><input type="number" id="shiho" placeholder="150000"><p class="field-hint">ç™»è®°ä»£ç†è´¹ï¼Œé€šå¸¸10-20ä¸‡</p></div>
<div class="field"><label id="lblFire">ç«ç¾ä¿é™© (å††)</label><input type="number" id="fire" placeholder="100000"><p class="field-hint">ä¸€æ¬¡æ€§ï¼Œçº¦5-15ä¸‡</p></div>
</div>
</div>

<div class="section">
<div class="section-title" id="sec_loan">è´·æ¬¾ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰</div>
<div class="form-grid col3">
<div class="field"><label id="lblDown">é¦–ä»˜é‡‘é¢ (å††)</label><input type="number" id="down" placeholder="8000000"></div>
<div class="field"><label id="lblLoanRate">è´·æ¬¾åˆ©ç‡ (%)</label><input type="number" id="loanRate" step="0.01" placeholder="1.5"></div>
<div class="field"><label id="lblYears">è´·æ¬¾å¹´æ•°</label><input type="number" id="years" placeholder="35"></div>
</div>
</div>

<div class="btn-row">
<button class="btn btn-primary" id="btnCalcBuy">è®¡ç®—è´­ç½®æˆæœ¬</button>
<button class="btn btn-secondary" onclick="resetBuy()">é‡ç½®</button>
</div>
<div class="result" id="buyResult"></div>
</section>

<section id="rent" class="panel">
<div class="info-box" id="infoRent">ğŸ’¡ æ”¶ç›Šæ¨¡æ‹Ÿå°†ä½¿ç”¨ã€Œè´­ç½®æˆæœ¬ã€é¡µé¢çš„ç‰©ä»¶ä»·æ ¼å’Œè´·æ¬¾å‚æ•°ï¼Œè¯·å…ˆå¡«å†™å®Œæ•´ã€‚</div>

<div class="section">
<div class="section-title" id="sec_rental">ç§Ÿèµ/æ°‘å®¿å‚æ•°</div>
<div class="form-grid">
<div class="field"><label id="lblOpType">è¿è¥ç±»å‹</label><select id="opType" onchange="toggleOpType()"><option value="rent">æ™®é€šé•¿ç§Ÿ</option><option value="minpaku">æ°‘å®¿/æ—…é¦†</option></select></div>
<div class="field"><label id="lblRent">æœˆç§Ÿé‡‘ / æ—¥å‡æˆ¿ä»· (å††)</label><input type="number" id="rentInput" placeholder="150000"><p class="field-hint" id="hintRent">é•¿ç§Ÿå¡«æœˆç§Ÿé‡‘ï¼Œæ°‘å®¿å¡«ADR</p></div>
</div>
<div class="form-grid col3" id="occRow">
<div class="field"><label id="lblOcc">ç¨¼åƒç‡ / å…¥ä½ç‡</label><input type="number" id="occ" step="0.01" placeholder="0.95"><p class="field-hint">é•¿ç§Ÿçº¦0.95ï¼Œæ°‘å®¿çº¦0.60-0.75</p></div>
<div class="field"><label id="lblRooms">å®¢æˆ¿æ•°é‡</label><input type="number" id="rooms" placeholder="1"><p class="field-hint">æ°‘å®¿/æ—…é¦†å¡«å†™</p></div>
<div class="field"><label id="lblDays">å¹´è¿è¥å¤©æ•°</label><input type="number" id="opDays" placeholder="365"><p class="field-hint">æ°‘å®¿æ–°æ³•ä¸Šé™180å¤©</p></div>
</div>
</div>

<div class="section">
<div class="section-title" id="sec_expense">è¿è¥æˆæœ¬</div>
<div class="form-grid col3">
<div class="field"><label id="lblMgmt">ç®¡ç†è´¹/æ‰˜ç®¡è´¹ (%)</label><input type="number" id="mgmt" placeholder="5"><p class="field-hint">é•¿ç§Ÿ3-5%ï¼Œæ°‘å®¿15-25%</p></div>
<div class="field"><label id="lblRep">ä¿®ç¹•ç§¯ç«‹é‡‘ (%)</label><input type="number" id="rep" placeholder="5"><p class="field-hint">é€šå¸¸5-10%</p></div>
<div class="field"><label id="lblOther">å…¶ä»–æ‚è´¹/å¹´ (å††)</label><input type="number" id="otherCost" placeholder="0"><p class="field-hint">æ¸…æ‰«ã€WIFIã€æ°´ç”µç­‰</p></div>
</div>
</div>

<div class="btn-row">
<button class="btn btn-primary" id="btnCalcRent">æ¨¡æ‹Ÿæ”¶ç›Š</button>
<button class="btn btn-secondary" onclick="resetRent()">é‡ç½®</button>
</div>
<div class="result" id="rentResult"></div>
</section>
</div>

<div class="modal" id="settingModal">
<div class="modal-content">
<div class="modal-header">
<h3 id="settingTitle">ç¨ç‡å‚æ•°è®¾å®š</h3>
<button class="modal-close" onclick="closeModal()">Ã—</button>
</div>
<div class="modal-body">
<div class="section-title" id="lblTaxBuy">è´­ç½®æ—¶ç¨è´¹</div>
<div class="form-grid" style="margin-bottom:14px">
<div class="field"><label id="lblAcqLand">ä¸åŠ¨äº§å–å¾—ç¨-åœŸåœ° (%)</label><input type="number" id="acqLand" value="1.5" step="0.1"><p class="field-hint">è¯„ä¼°ä»·Ã—ç¨ç‡ï¼ŒåœŸåœ°å‡åŠ1.5%</p></div>
<div class="field"><label id="lblAcqBld">ä¸åŠ¨äº§å–å¾—ç¨-å»ºç‰© (%)</label><input type="number" id="acqBld" value="3" step="0.1"><p class="field-hint">ä½å®…3%ï¼Œéä½å®…4%</p></div>
<div class="field"><label id="lblRegLand">ç™»å½•å…è®¸ç¨-åœŸåœ° (%)</label><input type="number" id="regLand" value="1.5" step="0.1"><p class="field-hint">æ‰€æœ‰æƒè½¬ç§»ï¼ŒåœŸåœ°1.5%</p></div>
<div class="field"><label id="lblRegBld">ç™»å½•å…è®¸ç¨-å»ºç‰© (%)</label><input type="number" id="regBld" value="2" step="0.1"><p class="field-hint">æ–°å»º0.4%ï¼ŒäºŒæ‰‹2%</p></div>
</div>
<div class="section-title" id="lblTaxHold">æŒæœ‰æ—¶ç¨è´¹ï¼ˆå¹´ï¼‰</div>
<div class="form-grid" style="margin-bottom:14px">
<div class="field"><label id="lblFixedTax">å›ºå®šèµ„äº§ç¨ (%)</label><input type="number" id="fixedTax" value="1.4" step="0.1"><p class="field-hint">è¯„ä¼°ä»·Ã—1.4%ï¼Œä½å®…ç”¨åœ°å‡è‡³1/6</p></div>
<div class="field"><label id="lblCityTax">éƒ½å¸‚è®¡åˆ’ç¨ (%)</label><input type="number" id="cityTax" value="0.3" step="0.1"><p class="field-hint">è¯„ä¼°ä»·Ã—0.3%</p></div>
</div>
<div class="section-title" id="stampTitle">å°çº¸ç¨é€ŸæŸ¥è¡¨</div>
<table class="stamp-table">
<tr><th>å¥‘çº¦é‡‘é¢</th><th>ç¨é¢</th><th>å¥‘çº¦é‡‘é¢</th><th>ç¨é¢</th></tr>
<tr><td>100ä¸‡~500ä¸‡</td><td>2,000</td><td>500ä¸‡~1000ä¸‡</td><td>10,000</td></tr>
<tr><td>1000ä¸‡~5000ä¸‡</td><td>20,000</td><td>5000ä¸‡~1å„„</td><td>60,000</td></tr>
<tr><td>1å„„~5å„„</td><td>100,000</td><td>5å„„ä»¥ä¸Š</td><td>200,000+</td></tr>
</table>
<div class="field"><label id="lblStampCustom">è‡ªå®šä¹‰å°çº¸ç¨ (å††)</label><input type="number" id="customStamp" value="0"><p class="field-hint">ç•™ç©ºåˆ™è‡ªåŠ¨æŒ‰ä»·æ ¼æ¡£ä½è®¡ç®—</p></div>
</div>
<div class="modal-actions">
<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
<button class="btn btn-primary" id="saveSetting">ä¿å­˜è®¾å®š</button>
</div>
</div>
</div>

<script>
// å¸¸é‡å®šä¹‰
const TAX={acqLand:1.5,acqBld:3,regLand:1.5,regBld:2,fixedTax:1.4,cityTax:0.3,customStamp:0};
// æ¶ˆè´¹ç¨ç‡ (ä¸­ä»‹è´¹å’Œä¹¦å£«è´¹é€šå¸¸éœ€åŠ ç®—æ¶ˆè´¹ç¨)
const VAT = 1.10; 

const STAMP=[{max:1e6,tax:1000},{max:5e6,tax:2000},{max:1e7,tax:10000},{max:5e7,tax:20000},{max:1e8,tax:60000},{max:5e8,tax:100000},{max:1e9,tax:200000},{max:Infinity,tax:600000}];
const L={
zh:{title:"è´­ç§Ÿæµ‹ç®—",subtitle:"è˜‡çš„å·¥å…·ç®± Â· æ—¥æœ¬ä¸åŠ¨äº§è´­ç½®æˆæœ¬ä¸ç§Ÿå”®å›æŠ¥æ¨¡æ‹Ÿ",tabBuy:"è´­ç½®æˆæœ¬",tabRent:"æ”¶ç›Šæ¨¡æ‹Ÿ",openSetting:"âš™ ç¨ç‡è®¾å®š",sec_property:"ç‰©ä»¶ä¿¡æ¯",lblPrice:"ç‰©ä»¶ä»·æ ¼ (å††)",hintPrice:"å¸‚åœºäº¤æ˜“ä»·æ ¼",lblEval:"å›ºå®šèµ„äº§è¯„ä¼°ä»· (å††)",hintEval:"é€šå¸¸ä¸ºå¸‚ä»·çš„70%ï¼Œç”¨äºè®¡ç¨",lblType:"ç‰©ä»¶ç±»å‹",lblAge:"æˆ¿é¾„",sec_cost:"è´­ç½®è´¹ç”¨é¡¹ç›®",lblBroker:"ä¸­ä»‹æ‰‹ç»­è´¹",lblShiho:"å¸æ³•ä¹¦å£«è´¹ (å††)",lblFire:"ç«ç¾ä¿é™© (å††)",sec_loan:"è´·æ¬¾ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰",lblDown:"é¦–ä»˜é‡‘é¢ (å††)",lblLoanRate:"è´·æ¬¾åˆ©ç‡ (%)",lblYears:"è´·æ¬¾å¹´æ•°",btnCalcBuy:"è®¡ç®—è´­ç½®æˆæœ¬",infoRent:"ğŸ’¡ æ”¶ç›Šæ¨¡æ‹Ÿå°†ä½¿ç”¨ã€Œè´­ç½®æˆæœ¬ã€é¡µé¢çš„ç‰©ä»¶ä»·æ ¼å’Œè´·æ¬¾å‚æ•°ï¼Œè¯·å…ˆå¡«å†™å®Œæ•´ã€‚",sec_rental:"ç§Ÿèµ/æ°‘å®¿å‚æ•°",lblOpType:"è¿è¥ç±»å‹",lblRent:"æœˆç§Ÿé‡‘ / æ—¥å‡æˆ¿ä»· (å††)",hintRent:"é•¿ç§Ÿå¡«æœˆç§Ÿé‡‘ï¼Œæ°‘å®¿å¡«ADR",lblOcc:"ç¨¼åƒç‡ / å…¥ä½ç‡",lblRooms:"å®¢æˆ¿æ•°é‡",lblDays:"å¹´è¿è¥å¤©æ•°",sec_expense:"è¿è¥æˆæœ¬",lblMgmt:"ç®¡ç†è´¹/æ‰˜ç®¡è´¹ (%)",lblRep:"ä¿®ç¹•ç§¯ç«‹é‡‘ (%)",lblOther:"å…¶ä»–æ‚è´¹/å¹´ (å††)",btnCalcRent:"æ¨¡æ‹Ÿæ”¶ç›Š",settingTitle:"ç¨ç‡å‚æ•°è®¾å®š",resultBuy:"è´­ç½®æˆæœ¬æ˜ç»†",resultRent:"æ”¶ç›Šæ¨¡æ‹Ÿç»“æœ",note:"ï¼ˆä¼°ç®—ä»…ä¾›å‚è€ƒï¼Œå®é™…ä»¥å®˜æ–¹ä¸ºå‡†ï¼‰",
lblBrokerVal:"è‡ªå®šä¹‰æ•°å€¼",hintBrokerCustom:"è¯·è¾“å…¥å…·ä½“é‡‘é¢æˆ–æ¯”ä¾‹",opt3pct:"3% (å¸¸è§„)",opt15pct:"1.5% (åŠé¢)",optCustAmt:"è‡ªå®šä¹‰é‡‘é¢",optCustPct:"è‡ªå®šä¹‰æ¯”ä¾‹",optNo:"æ— "},
jp:{title:"è³¼å…¥ãƒ»åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼",subtitle:"è˜‡ã®ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ Â· æ—¥æœ¬ä¸å‹•ç”£ã®è³¼å…¥è²»ç”¨ã¨åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",tabBuy:"è³¼å…¥è²»ç”¨",tabRent:"åç›Šè©¦ç®—",openSetting:"âš™ ç¨ç‡è¨­å®š",sec_property:"ç‰©ä»¶æƒ…å ±",lblPrice:"ç‰©ä»¶ä¾¡æ ¼ (å††)",hintPrice:"å¸‚å ´å–å¼•ä¾¡æ ¼",lblEval:"å›ºå®šè³‡ç”£è©•ä¾¡é¡ (å††)",hintEval:"é€šå¸¸å¸‚ä¾¡ã®70%ã€èª²ç¨åŸºæº–",lblType:"ç‰©ä»¶ã‚¿ã‚¤ãƒ—",lblAge:"ç¯‰å¹´æ•°",sec_cost:"è³¼å…¥è«¸è²»ç”¨",lblBroker:"ä»²ä»‹æ‰‹æ•°æ–™",lblShiho:"å¸æ³•æ›¸å£«è²»ç”¨ (å††)",lblFire:"ç«ç½ä¿é™º (å††)",sec_loan:"ãƒ­ãƒ¼ãƒ³æƒ…å ±",lblDown:"é ­é‡‘ (å††)",lblLoanRate:"é‡‘åˆ© (%)",lblYears:"è¿”æ¸ˆå¹´æ•°",btnCalcBuy:"è²»ç”¨ã‚’è¨ˆç®—",infoRent:"ğŸ’¡ åç›Šè©¦ç®—ã¯ã€Œè³¼å…¥è²»ç”¨ã€ã®ç‰©ä»¶ä¾¡æ ¼ã¨ãƒ­ãƒ¼ãƒ³æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚",sec_rental:"è³ƒè²¸ãƒ»æ°‘æ³Šæ¡ä»¶",lblOpType:"é‹å–¶ã‚¿ã‚¤ãƒ—",lblRent:"æœˆé¡è³ƒæ–™ / ADR (å††)",hintRent:"é•·æœŸè³ƒè²¸ã¯æœˆé¡ã€æ°‘æ³Šã¯ADR",lblOcc:"ç¨¼åƒç‡",lblRooms:"å®¢å®¤æ•°",lblDays:"å¹´é–“å–¶æ¥­æ—¥æ•°",sec_expense:"é‹å–¶ã‚³ã‚¹ãƒˆ",lblMgmt:"ç®¡ç†è²» (%)",lblRep:"ä¿®ç¹•ç©ç«‹ (%)",lblOther:"ãã®ä»–çµŒè²»/å¹´ (å††)",btnCalcRent:"åç›Šè©¦ç®—",settingTitle:"ç¨ç‡è¨­å®š",resultBuy:"è³¼å…¥è²»ç”¨æ˜ç´°",resultRent:"åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",note:"ï¼ˆæ¦‚ç®—ã§ã™ã€‚å®Ÿéš›ã¯å…¬å¼æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰",
lblBrokerVal:"ã‚«ã‚¹ã‚¿ãƒ å€¤",hintBrokerCustom:"é‡‘é¡ã¾ãŸã¯å‰²åˆã‚’å…¥åŠ›",opt3pct:"3% (é€šå¸¸)",opt15pct:"1.5% (åŠé¡)",optCustAmt:"é‡‘é¡æŒ‡å®š",optCustPct:"å‰²åˆæŒ‡å®š(%)",optNo:"ãªã—"}
};
let curLang="zh";
const $=id=>document.getElementById(id);
const money=v=>"Â¥"+Math.round(v).toLocaleString();
const pct=v=>(v*100).toFixed(2)+"%";
const i18n=k=>L[curLang][k]||L.zh[k]||k;

// æ ¸å¿ƒä¼˜åŒ–ï¼šè·å–æ•°å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨ placeholder
function getVal(id) {
    const el = $(id);
    if (!el) return 0;
    if (el.value !== "") return Number(el.value);
    return Number(el.placeholder) || 0;
}

function switchLang(){
    curLang=$("lang").value;
    Object.keys(L[curLang]).forEach(k=>{
        const el=$(k);
        if(el){
            if(el.tagName==="INPUT"||el.tagName==="SELECT"){
                // Update options if needed, usually simpler to just update text content elements
            }else{
                el.textContent=L[curLang][k];
            }
        }
    });
    // æ›´æ–°Selectçš„æ–‡æœ¬
    const brokerOpts = $("broker").options;
    brokerOpts[0].text = i18n("opt3pct");
    brokerOpts[1].text = i18n("opt15pct");
    brokerOpts[2].text = i18n("optCustAmt");
    brokerOpts[3].text = i18n("optCustPct");
    brokerOpts[4].text = i18n("optNo");
}

function calcStamp(amt){const c=Number($("customStamp").value)||0;if(c>0)return c;for(const r of STAMP)if(amt<=r.max)return r.tax;return 0;}

document.querySelectorAll(".tab").forEach(btn=>{
btn.addEventListener("click",()=>{
if(btn.id==="openSetting"){$("settingModal").classList.add("show");return;}
document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
$(btn.dataset.tab).classList.add("active");
});
});

function closeModal(){$("settingModal").classList.remove("show");}
$("saveSetting").addEventListener("click",()=>{
TAX.acqLand=Number($("acqLand").value);TAX.acqBld=Number($("acqBld").value);
TAX.regLand=Number($("regLand").value);TAX.regBld=Number($("regBld").value);
TAX.fixedTax=Number($("fixedTax").value);TAX.cityTax=Number($("cityTax").value);
TAX.customStamp=Number($("customStamp").value);
closeModal();
});

// ä¸­ä»‹è´¹è‡ªå®šä¹‰è¾“å…¥æ¡†æ˜¾éš
function toggleBrokerInput() {
    const type = $("broker").value;
    const customField = $("brokerCustomField");
    if(type === "custom_amt" || type === "custom_pct") {
        customField.classList.add("show");
    } else {
        customField.classList.remove("show");
    }
}

function toggleOpType(){
const isMinpaku=$("opType").value==="minpaku";
// ä½¿ç”¨ placeholder é€»è¾‘ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦æ”¹ placeholder å—ï¼Ÿ
// ä¸ºäº†ç”¨æˆ·ä½“éªŒï¼Œåˆ‡æ¢æ¨¡å¼æ—¶ï¼Œå¦‚æœç”¨æˆ·æ²¡å¡«å€¼ï¼Œæˆ‘ä»¬åº”è¯¥æ›´æ–° input çš„ value æˆ–è€… placeholder
// è¿™é‡Œç›´æ¥æ”¹ value æ¯”è¾ƒç›´è§‚ï¼Œå› ä¸ºæ˜¯æ¨¡å¼åˆ‡æ¢çš„â€œé¢„è®¾â€
$("occ").placeholder=isMinpaku?"0.70":"0.95"; $("occ").value = "";
$("mgmt").placeholder=isMinpaku?"20":"5"; $("mgmt").value = "";
$("opDays").placeholder=isMinpaku?"180":"365"; $("opDays").value = "";
$("rooms").placeholder=isMinpaku?"5":"1"; $("rooms").value = "";
$("rentInput").placeholder=isMinpaku?"15000":"150000"; $("rentInput").value = "";
}

// è®¡ç®—è´­ç½®æˆæœ¬
$("btnCalcBuy").addEventListener("click",()=>{
const price=getVal("price");
const evalP=getVal("evalPrice") || price*0.7; // å¦‚æœéƒ½æ²¡å¡«ï¼ŒåŸºäºpriceç®—
const evalLand=evalP*0.4,evalBld=evalP*0.6; 
const isNew=$("propAge").value==="new";
const brokerType=$("broker").value;
const shiho=getVal("shiho");
const fire=getVal("fire");

// ä¸­ä»‹è´¹è®¡ç®— (æ–°é€»è¾‘)
let broker=0;
if(brokerType==="3pct") {
    broker = price * 0.03 * VAT; // 3% + æ¶ˆè´¹ç¨
} else if(brokerType==="1.5pct") {
    broker = price * 0.015 * VAT; // 1.5% + æ¶ˆè´¹ç¨
} else if(brokerType==="custom_amt") {
    broker = Number($("brokerCustomVal").value) || 0;
} else if(brokerType==="custom_pct") {
    const pctVal = Number($("brokerCustomVal").value) || 0;
    broker = price * (pctVal / 100) * VAT;
}

// å¸æ³•ä¹¦å£«è´¹åŠ æ¶ˆè´¹ç¨
const shihoWithTax = shiho * VAT;

// ç¨è´¹
const stamp=calcStamp(price);
const acqTax=evalLand*(TAX.acqLand/100)+evalBld*(TAX.acqBld/100);
const regTax=evalLand*(TAX.regLand/100)+evalBld*((isNew?0.4:TAX.regBld)/100);
const totalTax=stamp+acqTax+regTax;
const totalFee=broker+shihoWithTax+fire;
const grandTotal=totalTax+totalFee;

// è´·æ¬¾è®¡ç®—
const down=getVal("down");
const principal=Math.max(0,price-down);
const rate=getVal("loanRate")/100;
const years=getVal("years");
const n=years*12,rM=rate/12;
const monthly=rM>0?principal*rM*Math.pow(1+rM,n)/(Math.pow(1+rM,n)-1):principal/n;
const totalRepay=monthly*n;
const totalInt=totalRepay-principal;

let html=`<div class="result-header"><span class="result-title">${i18n("resultBuy")}</span><span class="result-total">${money(grandTotal)}</span></div>`;
html+=`<table class="result-table">
<tr><td colspan="2" style="font-weight:600;color:#515154">â–  ç¨è´¹</td></tr>
<tr><td>å°çº¸ç¨</td><td>${money(stamp)}</td></tr>
<tr><td>ä¸åŠ¨äº§å–å¾—ç¨</td><td>${money(acqTax)}</td></tr>
<tr class="sub"><td>â”” åœŸåœ° ${TAX.acqLand}%</td><td>${money(evalLand*(TAX.acqLand/100))}</td></tr>
<tr class="sub"><td>â”” å»ºç‰© ${TAX.acqBld}%</td><td>${money(evalBld*(TAX.acqBld/100))}</td></tr>
<tr><td>ç™»å½•å…è®¸ç¨</td><td>${money(regTax)}</td></tr>
<tr><td colspan="2" style="font-weight:600;color:#515154;padding-top:8px">â–  å…¶ä»–è´¹ç”¨</td></tr>
<tr><td>ä¸­ä»‹æ‰‹ç»­è´¹ (å«ç¨)</td><td>${money(broker)}</td></tr>
<tr><td>å¸æ³•ä¹¦å£«è´¹ (å«ç¨)</td><td>${money(shihoWithTax)}</td></tr>
<tr><td>ç«ç¾ä¿é™©</td><td>${money(fire)}</td></tr>
<tr class="highlight"><td>è´­ç½®æ€»è´¹ç”¨</td><td>${money(grandTotal)}</td></tr>
<tr><td>å ç‰©ä»¶ä»·æ ¼æ¯”ä¾‹</td><td>${(grandTotal/price*100).toFixed(2)}%</td></tr>
</table>`;

if(principal>0){
html+=`<div style="margin-top:12px;padding-top:10px;border-top:1px solid #e5e5e7">
<div style="font-size:0.75rem;font-weight:600;color:#515154;margin-bottom:6px">â–  è´·æ¬¾å‚è€ƒ</div>
<table class="result-table">
<tr><td>è´·æ¬¾é‡‘é¢</td><td>${money(principal)}</td></tr>
<tr><td>æœˆä¾›</td><td>${money(monthly)}</td></tr>
<tr><td>æ€»è¿˜æ¬¾é¢</td><td>${money(totalRepay)}</td></tr>
<tr><td>æ€»åˆ©æ¯</td><td>${money(totalInt)}</td></tr>
</table></div>`;
}
html+=`<p class="result-note">${i18n("note")}</p>`;
$("buyResult").innerHTML=html;
$("buyResult").classList.add("show");
});

// è®¡ç®—æ”¶ç›Š
$("btnCalcRent").addEventListener("click",()=>{
const price=getVal("price");
const evalP=getVal("evalPrice")||price*0.7;
const down=getVal("down");
const principal=Math.max(0,price-down);
const rate=getVal("loanRate")/100;
const years=getVal("years");
const n=years*12,rM=rate/12;
const monthly=rM>0?principal*rM*Math.pow(1+rM,n)/(Math.pow(1+rM,n)-1):principal/n;
const annualDebt=monthly*12;

const isMinpaku=$("opType").value==="minpaku";
const rentVal=getVal("rentInput");
const occ=getVal("occ");
const rooms=getVal("rooms");
const opDays=getVal("opDays");
const mgmtPct=getVal("mgmt")/100;
const repPct=getVal("rep")/100;
const otherCost=getVal("otherCost");

// å¹´æ”¶å…¥è®¡ç®—
let annualIncome;
if(isMinpaku){
annualIncome=rentVal*occ*rooms*opDays; // ADR Ã— å…¥ä½ç‡ Ã— æˆ¿é—´æ•° Ã— è¿è¥å¤©æ•°
}else{
annualIncome=rentVal*12*occ; // æœˆç§Ÿ Ã— 12 Ã— å…¥ä½ç‡
}

// å¹´æ”¯å‡º
const mgmtCost=annualIncome*mgmtPct;
const repCost=annualIncome*repPct;
const fixedTax=evalP*(TAX.fixedTax/100);
const cityTax=evalP*(TAX.cityTax/100);
const annualTax=fixedTax+cityTax;
const totalExpense=mgmtCost+repCost+annualTax+otherCost;

// æ”¶ç›ŠæŒ‡æ ‡
const goi=annualIncome; // æ¯›æ”¶å…¥
const noi=annualIncome-totalExpense; // å‡€è¥ä¸šæ”¶å…¥
const cashFlow=noi-annualDebt; // ç¨å‰ç°é‡‘æµ
const grossYield=price>0?annualIncome/price:0; // è¡¨é¢åˆ©å›
const capRate=price>0?noi/price:0; // èµ„æœ¬åŒ–ç‡
const cashOnCash=down>0?cashFlow/down:0; // ç°é‡‘å›æŠ¥ç‡

// IRRè®¡ç®—ï¼ˆ10å¹´ï¼Œå‡è®¾é€€å‡ºä»·æ ¼=ä¹°å…¥ä»·æ ¼ï¼‰
const holdYears=10;
// è·å–è´­ç½®æˆæœ¬ä¸­çš„æ€»è´¹ç”¨ï¼Œå¦‚æœæœªè®¡ç®—åˆ™ä¼°ç®—ä¸€ä¸ª
let totalFee = 0;
const buyResStr = $("buyResult").innerText;
if(buyResStr) {
    // ç®€å•çš„å°è¯•ä»ç»“æœæ–‡æœ¬æå–ï¼Œè¿™ä¸æ˜¯å¾ˆç¨³å¥ï¼Œä½†å¯¹äºç®€å•å·¥å…·å¤Ÿç”¨äº†
    // æ›´å¥½çš„æ–¹å¼æ˜¯æŠŠ cost å­˜å…¨å±€å˜é‡ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
    // å¦‚æœæ²¡æœ‰ç‚¹è®¡ç®—è´­ç½®æˆæœ¬ï¼Œè¿™é‡ŒIRRçš„åˆæœŸæŠ•å…¥ä¼šåä½ï¼ˆåªå«é¦–ä»˜ï¼‰
}
// é‡æ–°è®¡ç®—ä¸€æ¬¡è´­ç½®æ‚è´¹ç”¨äºIRRï¼ˆä¸ºäº†å‡†ç¡®æ€§ï¼‰
const stamp=calcStamp(price);
// ...ç®€åŒ–ç‰ˆï¼Œç›´æ¥å–é¦–ä»˜+7%ä¼°ç®—æ‚è´¹ä½œä¸ºåˆå§‹æµå‡ºï¼Œå¦‚æœæœ‰å…·ä½“è®¡ç®—ç»“æœæ›´å¥½
// è¿™é‡Œä¸ºäº†ä»£ç ç®€æ´ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·å·²ç»ç‚¹äº†è®¡ç®—è´­ç½®æˆæœ¬ï¼Œæˆ–è€…ç®€å•çš„ é¦–ä»˜ + ä»·æ ¼*7%
const initialOut = down + (price * 0.07); 
const flows=[-initialOut];

for(let y=1;y<holdYears;y++)flows.push(cashFlow);
flows.push(cashFlow+price-principal*(1-holdYears/years)); // æœ€åä¸€å¹´åŠ é€€å‡º
const irr=computeIRR(flows);

// åˆ¤æ–­æ”¶ç›Šç­‰çº§
const getClass=v=>v>=0.08?"good":v>=0.05?"":"warn";

let html=`<div class="result-header"><span class="result-title">${i18n("resultRent")}</span></div>`;
html+=`<div class="result-grid">
<div class="metric"><div class="val">${pct(grossYield)}</div><div class="lbl">è¡¨é¢åˆ©å› Gross Yield</div></div>
<div class="metric ${getClass(capRate)}"><div class="val">${pct(capRate)}</div><div class="lbl">å®é™…åˆ©å› Cap Rate</div></div>
<div class="metric ${getClass(cashOnCash)}"><div class="val">${isFinite(cashOnCash)?pct(cashOnCash):"-"}</div><div class="lbl">ç°é‡‘å›æŠ¥ Cash-on-Cash</div></div>
<div class="metric"><div class="val">${isFinite(irr)?pct(irr):"-"}</div><div class="lbl">IRR (${holdYears}å¹´)</div></div>
</div>`;

html+=`<table class="result-table">
<tr><td colspan="2" style="font-weight:600;color:#515154">â–  æ”¶å…¥</td></tr>
<tr><td>å¹´æ¯›æ”¶å…¥ (GOI)</td><td>${money(goi)}</td></tr>
<tr><td colspan="2" style="font-weight:600;color:#515154;padding-top:8px">â–  æ”¯å‡º</td></tr>
<tr><td>ç®¡ç†è´¹/æ‰˜ç®¡è´¹ (${(mgmtPct*100).toFixed(0)}%)</td><td>${money(mgmtCost)}</td></tr>
<tr><td>ä¿®ç¹•ç§¯ç«‹é‡‘ (${(repPct*100).toFixed(0)}%)</td><td>${money(repCost)}</td></tr>
<tr><td>å›ºå®šèµ„äº§ç¨+éƒ½å¸‚è®¡åˆ’ç¨</td><td>${money(annualTax)}</td></tr>
<tr><td>å…¶ä»–æ‚è´¹</td><td>${money(otherCost)}</td></tr>
<tr style="border-top:1px solid #d2d2d7"><td>å¹´æ”¯å‡ºåˆè®¡</td><td>${money(totalExpense)}</td></tr>
<tr><td colspan="2" style="font-weight:600;color:#515154;padding-top:8px">â–  ç°é‡‘æµ</td></tr>
<tr><td>NOI å‡€è¥ä¸šæ”¶å…¥</td><td>${money(noi)}</td></tr>
<tr><td>å¹´è¿˜è´·é‡‘é¢</td><td>${money(annualDebt)}</td></tr>
<tr class="highlight"><td>å¹´å‡€ç°é‡‘æµ</td><td>${money(cashFlow)}</td></tr>
<tr><td>æœˆå‡€ç°é‡‘æµ</td><td>${money(cashFlow/12)}</td></tr>
</table>`;
html+=`<p class="result-note">${i18n("note")}</p>`;
$("rentResult").innerHTML=html;
$("rentResult").classList.add("show");
});

function computeIRR(cf,guess=0.1){let x=guess;for(let i=0;i<200;i++){let f=0,df=0;for(let t=0;t<cf.length;t++){f+=cf[t]/Math.pow(1+x,t);if(t>0)df+=-t*cf[t]/Math.pow(1+x,t+1);}const nx=x-f/df;if(!isFinite(nx))return NaN;if(Math.abs(nx-x)<1e-7)return nx;x=nx;}return NaN;}

function resetBuy(){
$("price").value="";$("evalPrice").value="";
$("propType").value="house";$("propAge").value="used";
$("broker").value="3pct"; toggleBrokerInput();
$("shiho").value="";$("fire").value="";
$("down").value="";$("loanRate").value="";$("years").value="";
$("buyResult").classList.remove("show");
}
function resetRent(){
$("opType").value="rent"; toggleOpType();
$("rentInput").value="";$("occ").value="";
$("rooms").value="";$("opDays").value="";$("mgmt").value="";$("rep").value="";$("otherCost").value="";
$("rentResult").classList.remove("show");
}

// åˆå§‹åŒ–
toggleOpType();
</script>
</body>
</html>
