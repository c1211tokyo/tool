<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TOKYO 3D INVESTMENT ANALYZER (v5.0)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600&display=swap" rel="stylesheet">

<style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Rajdhani', sans-serif; color: #fff; }
    
    /* åŠ è½½å±‚ & é”™è¯¯å¤„ç† (å…³é”®ä¿®æ”¹) */
    #loader { 
        position: fixed; inset: 0; background: #000; z-index: 9999; 
        display: flex; flex-direction: column; justify-content: center; align-items: center; 
    }
    .status-text { color: #00f3ff; font-size: 14px; margin-top: 15px; letter-spacing: 2px; }
    .error-box { 
        display: none; border: 1px solid #ff003c; background: rgba(50,0,0,0.9); 
        padding: 20px; text-align: center; margin-top: 20px; max-width: 80%;
    }
    
    /* æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨ä¸Šä¼ æŒ‰é’® */
    #manual-input { display: none; margin-top: 20px; }
    .upload-btn {
        background: #00f3ff; color: #000; border: none; padding: 12px 24px; 
        font-weight: bold; cursor: pointer; letter-spacing: 1px; font-family: inherit;
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    .upload-btn:hover { background: #fff; }

    /* UI å¸ƒå±€ */
    #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
    #control-panel { 
        position: absolute; top: 20px; left: 20px; width: 220px; pointer-events: auto;
        background: rgba(10, 15, 20, 0.9); border-left: 2px solid #00f3ff; padding: 15px;
    }
    .mode-btn { 
        padding: 10px; margin-bottom: 5px; background: rgba(255,255,255,0.05); 
        border: 1px solid #333; cursor: pointer; color: #888; display: flex; justify-content: space-between;
    }
    .mode-btn.active { border-color: var(--c); color: var(--c); background: rgba(0,243,255,0.1); }
    
    #sidebar {
        position: absolute; top: 0; right: -400px; bottom: 0; width: 350px;
        background: rgba(10, 15, 20, 0.95); border-left: 1px solid #333; pointer-events: auto;
        padding: 25px; transition: right 0.3s; display: flex; flex-direction: column; overflow-y: auto;
    }
    #sidebar.open { right: 0; }
    
    .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
    .data-box { background: rgba(255,255,255,0.05); padding: 10px; }
    .val { font-size: 18px; font-weight: bold; color: #fff; }
    .lbl { font-size: 10px; color: #888; }
</style>
</head>
<body>

<div id="loader">
    <div style="font-size: 24px; letter-spacing: 5px;">SYSTEM INITIALIZING</div>
    <div class="status-text" id="status">CONNECTING TO NETWORK...</div>
    
    <div class="error-box" id="error-box">
        <div style="color:#ff003c; font-size:16px; margin-bottom:10px;">âš ï¸ è‡ªåŠ¨åŠ è½½å¤±è´¥ (AUTO LOAD FAILED)</div>
        <div style="color:#aaa; font-size:12px; margin-bottom:15px;">
            åŸå› ï¼šæµè§ˆå™¨æ‹¦æˆªäº†è·¨åŸŸè¯·æ±‚ (CORS Blocked) æˆ– ç½‘ç»œè¶…æ—¶ã€‚<br>
            è§£å†³æ–¹æ¡ˆï¼šè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œæ‰‹åŠ¨é€‰æ‹©ä¸‹è½½å¥½çš„ <b>tokyo.geojson</b> æ–‡ä»¶ã€‚
        </div>
        
        <label class="upload-btn">
            ğŸ“‚ ç‚¹å‡»åŠ è½½æœ¬åœ°åœ°å›¾æ–‡ä»¶ (LOAD LOCAL FILE)
            <input type="file" id="file-input" style="display: none;" accept=".json,.geojson">
        </label>
    </div>
</div>

<div id="canvas-container"></div>

<div id="ui-layer">
    <div id="control-panel">
        <h2 style="margin:0 0 10px 0; color:#00f3ff; font-size:18px;">TOKYO RE:VIEW</h2>
        <div id="btn-container"></div>
    </div>

    <div id="sidebar">
        <div style="text-align:right; cursor:pointer; font-size:24px;" onclick="closeSidebar()">Ã—</div>
        <h1 id="ward-name" style="margin:0; background:linear-gradient(90deg,#fff,#888); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">--</h1>
        <div id="ward-tags" style="margin:10px 0; display:flex; gap:5px; flex-wrap:wrap;"></div>
        
        <div class="data-grid" id="ward-stats"></div>
        
        <div style="height:200px;"><canvas id="radarChart"></canvas></div>
        
        <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
            <div style="color:#00f3ff; font-size:12px; font-weight:bold;">ANALYSIS</div>
            <p id="ward-desc" style="font-size:13px; color:#ccc; line-height:1.5;"></p>
            <div style="color:#ff9100; font-size:12px; font-weight:bold; margin-top:15px;">RECOMMENDATION</div>
            <p id="ward-rec" style="font-size:13px; color:#ccc; line-height:1.5;"></p>
            <div style="color:#ff003c; font-size:12px; font-weight:bold; margin-top:15px;">RISKS</div>
            <p id="ward-risk" style="font-size:13px; color:#ccc; line-height:1.5;"></p>
        </div>
    </div>
</div>

<script>
    // === é…ç½®æ•°æ® ===
    const METRICS = {
        growth: { label: 'LAND GROWTH', color: '#d600ff', max: 10 },
        yield:  { label: 'RENTAL YIELD', color: '#ff9100', max: 6 },
        airbnb: { label: 'AIRBNB SCORE', color: '#00f3ff', max: 10 },
        future: { label: 'FUTURE POT.', color: '#ff003c', max: 10 }
    };

    // æ•°æ®åº“ (å®Œæ•´)
    const DB = {
        "åƒä»£ç”°åŒº": { growth: 9.5, yield: 3.0, airbnb: 4.0, future: 9.0, tags: ["æ ¸å¿ƒ", "ä¿å€¼"], desc: "ä¸œäº¬å¿ƒè„ï¼Œ2025å¹´åœ°ä»·æ¶¨å¹…è¿‘åŒä½æ•°ã€‚ç§Ÿé‡‘æé«˜ä½†æˆ¿ä»·æ›´é«˜ï¼Œå›æŠ¥ç‡åä½ã€‚", rec: "è±ªå®…ã€å†™å­—æ¥¼ã€äº”æ˜Ÿé…’åº—ã€‚èµ„äº§ä¿å€¼é¦–é€‰ã€‚", risk: "é—¨æ§›æé«˜ï¼ŒåˆæœŸæŠ•å…¥å·¨å¤§ã€‚" },
        "ä¸­å¤®åŒº": { growth: 9.8, yield: 3.2, airbnb: 5.0, future: 9.2, tags: ["é“¶åº§", "é‡‘è"], desc: "åœ°ä»·å…¨å›½æœ€é«˜ç‚¹ä¹‹ä¸€ã€‚é“¶åº§ã€æ™´æµ·å†å¼€å‘åŠ¨åŠ›å¼ºã€‚", rec: "é«˜ç«¯å…¬å¯“ã€å•†ä¸šåœ°äº§ã€‚", risk: "æˆ¿ä»·æ³¡æ²«é£é™©ï¼Œæ°‘å®¿é™åˆ¶ä¸¥æ ¼ã€‚" },
        "æ¸¯åŒº": { growth: 10.0, yield: 3.4, airbnb: 3.5, future: 9.5, tags: ["å…­æœ¬æœ¨", "è±ªå®…"], desc: "å…¨ä¸œäº¬æœ€é¡¶çº§æ¶¨å¹…ã€‚å¤–èµ„ä¸å¯Œäººèšé›†ã€‚", rec: "å¥¢ä¾ˆæ¥¼ç›˜ã€Açº§å†™å­—æ¥¼ã€‚", risk: "çŸ­ç§Ÿéš¾åšï¼Œå›æŠ¥ç‡è¢«é«˜åœ°ä»·ç¨€é‡Šã€‚" },
        "æ–°å®¿åŒº": { growth: 8.5, yield: 4.0, airbnb: 9.0, future: 8.0, tags: ["æ¢çº½", "æ­Œèˆä¼ç”º"], desc: "æ°‘å®¿å›æŠ¥ç‡æé«˜ï¼Œéƒ¨åˆ†æ•´æ ‹å…¬å¯“å¯è¾¾30%å›æŠ¥ã€‚", rec: "æ•´æ ‹å…¬å¯“å‡ºç§Ÿã€å•†ä¸šç»¼åˆä½“ã€‚", risk: "ç«äº‰æ¿€çƒˆï¼Œæ²»å®‰åŠå™ªéŸ³é—®é¢˜ã€‚" },
        "æ–‡äº¬åŒº": { growth: 8.0, yield: 3.8, airbnb: 3.0, future: 7.0, tags: ["æ•™è‚²", "æ²»å®‰"], desc: "æ²»å®‰ä¸œäº¬ç¬¬ä¸€ï¼Œæ•™è‚²èµ„æºé¡¶å°–ã€‚", rec: "å­¦åŒºæˆ¿ã€å®¶åº­å‹é•¿ç§Ÿå…¬å¯“ã€‚", risk: "æ°‘å®¿å‡ ä¹æ— æ³•ç»è¥ã€‚" },
        "å°ä¸œåŒº": { growth: 9.0, yield: 4.8, airbnb: 9.5, future: 7.5, tags: ["æµ…è‰", "æ—…æ¸¸"], desc: "å•†ä¸šåœ°ä»·æ¶¨å¹…æœ€å¤§ã€‚æ—…æ¸¸ä¸šæ”¯æŸ±ï¼ŒAirbnbå…¥ä½ç‡æé«˜ã€‚", rec: "ç®€æ˜“æ—…é¦†ã€æ°‘å®¿æ”¹é€ ã€‚", risk: "å±…æ°‘å¯¹æ°‘å®¿æœ‰åå¼¹æƒ…ç»ªã€‚" },
        "å¢¨ç”°åŒº": { growth: 7.5, yield: 4.5, airbnb: 8.0, future: 7.8, tags: ["æ™´ç©ºå¡”", "ä¸‹ç”º"], desc: "æˆ¿ä»·äº²æ°‘ï¼Œå‡å€¼å¿«ã€‚ä»è€å·¥ä¸šåŒºè½¬å‹æ—…æ¸¸åŒºã€‚", rec: "æŠ¼ä¸Šå‘¨è¾¹é«˜å±‚å…¬å¯“ã€æ°‘å®¿ã€‚", risk: "éƒ¨åˆ†åŒºåŸŸä»æœ‰è€æ—§å·¥ä¸šæ„Ÿã€‚" },
        "æ±Ÿä¸œåŒº": { growth: 7.0, yield: 4.5, airbnb: 6.0, future: 8.0, tags: ["æ¹¾å²¸", "å¥¥è¿"], desc: "ä¸°æ´²ã€æœ‰æ˜æ¹¾å²¸å¼€å‘ã€‚å¹´è½»å®¶åº­æµå…¥å¤šã€‚", rec: "å¤§æˆ·å‹å®¶åº­å…¬å¯“ã€‚", risk: "å¡«æµ·åŒºåœ°åŸºæ‹…å¿§ï¼Œä½ç½®å·®å¼‚å¤§ã€‚" },
        "å“å·åŒº": { growth: 6.8, yield: 4.2, airbnb: 5.5, future: 8.8, tags: ["æ–°å¹²çº¿", "å•†åŠ¡"], desc: "äº¤é€šæ¢çº½ï¼Œç£æ‚¬æµ®å§‹å‘ç«™é¢„æœŸã€‚", rec: "å†™å­—æ¥¼ã€å•†åŠ¡é…’åº—ã€‚", risk: "å±…ä½èˆ’é€‚åº¦å‚å·®ä¸é½ã€‚" },
        "ç›®é»‘åŒº": { growth: 7.2, yield: 3.6, airbnb: 4.5, future: 6.5, tags: ["æ—¶å°š", "å®œå±…"], desc: "ä¸­ç›®é»‘ã€è‡ªç”±ä¹‹ä¸˜ã€‚å“ç‰Œä»·å€¼é«˜ã€‚", rec: "ç²¾å“è®¾è®¡å…¬å¯“ã€‚", risk: "æˆ¿ä»·å·²é«˜ï¼Œç§Ÿé‡‘å¢é•¿æœ‰é™ã€‚" },
        "å¤§ç”°åŒº": { growth: 6.5, yield: 5.2, airbnb: 9.8, future: 7.0, tags: ["ç‰¹åŒºæ°‘å®¿", "æœºåœº"], desc: "å”¯ä¸€å…è®¸å…¨å¹´365å¤©æ°‘å®¿çš„åŒºåŸŸã€‚", rec: "ç‰¹åŒºæ°‘å®¿ã€æœºåœºç‰©æµã€‚", risk: "éƒ¨åˆ†åŒºåŸŸå·¥å‚å¤šç¯å¢ƒä¸€èˆ¬ã€‚" },
        "ä¸–ç”°è°·åŒº": { growth: 5.5, yield: 4.2, airbnb: 2.0, future: 5.0, tags: ["å¯Œäººå±…ä½", "å®¶åº­"], desc: "äººå£æœ€å¤šï¼Œç¯å¢ƒä¼˜ç¾ã€‚ä½†å•†ä¸šå¼±ã€‚", rec: "ç‹¬æ ‹ä½å®…ã€å®¶åº­é•¿ç§Ÿã€‚", risk: "äººå£è€é¾„åŒ–ï¼Œç¼ºä¹çˆ†ç‚¹ã€‚" },
        "æ¶©è°·åŒº": { growth: 9.2, yield: 3.5, airbnb: 8.5, future: 9.8, tags: ["IT", "æ½®æµ"], desc: "ç™¾å¹´ä¸€é‡å¤§å¼€å‘ã€‚è¡¨å‚é“åœ°ä»·æš´æ¶¨ã€‚", rec: "åˆ›æ„åŠå…¬ã€ç²¾å“å…¬å¯“ã€‚", risk: "å…¥æ‰‹æˆæœ¬æé«˜ã€‚" },
        "ä¸­é‡åŒº": { growth: 6.0, yield: 4.5, airbnb: 5.0, future: 6.0, tags: ["æ¬¡æ–‡åŒ–", "å•èº«"], desc: "å•èº«ç§Ÿèµéœ€æ±‚æå¤§ã€‚", rec: "å•èº«å…¬å¯“ã€å°æˆ·å‹ã€‚", risk: "å‘å±•ç›¸å¯¹å¹³ç¼“ã€‚" },
        "æ‰å¹¶åŒº": { growth: 5.0, yield: 5.0, airbnb: 1.0, future: 4.5, tags: ["ä½å®…", "é¿é™©"], desc: "å®‰é™çš„é«˜çº§ä½å®…åŒºã€‚èµ„äº§æç¨³ã€‚", rec: "é•¿æœŸæ”¶ç§Ÿå‹ä½å®…ã€‚", risk: "å¢å€¼çˆ†å‘åŠ›å¼±ã€‚" },
        "ä¸°å²›åŒº": { growth: 8.0, yield: 4.5, airbnb: 8.0, future: 7.0, tags: ["æ± è¢‹", "åŠ¨æ¼«"], desc: "æ± è¢‹å‰¯éƒ½å¿ƒã€‚ç›¸æ¯”æ–°å®¿ä»·æ ¼ä»æ˜¯æ´¼åœ°ã€‚", rec: "æ°‘å®¿ã€å•†ä¸šåœ°äº§ã€‚", risk: "å•†åœˆç«äº‰æ¿€çƒˆã€‚" },
        "åŒ—åŒº": { growth: 5.5, yield: 4.8, airbnb: 3.0, future: 6.5, tags: ["èµ¤ç¾½", "æ€§ä»·æ¯”"], desc: "èµ¤ç¾½äº¤é€šæä¾¿åˆ©ã€‚é€‚åˆå®åˆ©ä¸»ä¹‰æŠ•èµ„ã€‚", rec: "é€šå‹¤åˆšéœ€æˆ¿ã€‚", risk: "ç¼ºä¹æ ¸å¿ƒé«˜ç«¯å•†ä¸šã€‚" },
        "è’å·åŒº": { growth: 5.8, yield: 5.2, airbnb: 4.0, future: 5.5, tags: ["æ—¥æš®é‡Œ", "ä¸‹ç”º"], desc: "äº¤é€šæ¢çº½æ—¥æš®é‡Œéå¸¸æ–¹ä¾¿ã€‚ä»·æ ¼æ´¼åœ°ã€‚", rec: "ä¸­å°æˆ·å‹å…¬å¯“ã€‚", risk: "äººå£æœ‰å‡å°‘è¶‹åŠ¿ã€‚" },
        "æ¿æ¡¥åŒº": { growth: 4.5, yield: 5.3, airbnb: 1.5, future: 4.5, tags: ["ç¡åŸ", "ç¨³å¥"], desc: "å®¶åº­ç§Ÿèµéœ€æ±‚å¤§ï¼Œç©ºç½®é£é™©ä½ã€‚", rec: "å®¶åº­å‹ç§Ÿèµå…¬å¯“ã€‚", risk: "åŸºæœ¬æ— æ°‘å®¿ä»·å€¼ã€‚" },
        "ç»ƒé©¬åŒº": { growth: 4.0, yield: 5.5, airbnb: 1.0, future: 4.8, tags: ["ç»¿åŒ–", "å†œä¸š"], desc: "ç»¿åŒ–æœ€å¥½ï¼Œé€‚åˆè‡ªä½ã€‚", rec: "æ•´æ ‹æœ¨é€ å…¬å¯“ã€‚", risk: "äº¤é€šé™åˆ¶å®¢æºã€‚" },
        "è¶³ç«‹åŒº": { growth: 5.0, yield: 5.8, airbnb: 4.5, future: 5.0, tags: ["é«˜å›æŠ¥", "åœ°æ¿ä»·"], desc: "è¡¨é¢å›æŠ¥ç‡æœ€é«˜(5%ä»¥ä¸Š)ã€‚", rec: "é«˜ç°é‡‘æµå¯¼å‘å…¬å¯“ã€‚", risk: "æ²»å®‰åå£°ä¸€èˆ¬ã€‚" },
        "è‘›é¥°åŒº": { growth: 3.5, yield: 6.0, airbnb: 2.0, future: 4.0, tags: ["è€è¡—", "ä½æˆæœ¬"], desc: "æˆ¿ä»·æä½ï¼Œç§Ÿå®¢å¤šä¸ºè€å¹´äººã€‚", rec: "ä½æˆæœ¬å¸çº³é•¿ç§Ÿæˆ¿ã€‚", risk: "å‡å€¼ç©ºé—´æœ‰é™ã€‚" },
        "æ±Ÿæˆ·å·åŒº": { growth: 4.0, yield: 5.8, airbnb: 1.5, future: 4.5, tags: ["å…¬å›­", "è‚²å„¿"], desc: "è‚²å„¿ç¯å¢ƒå¥½ï¼Œæˆ¿ä»·äº²æ°‘ã€‚", rec: "å®¶åº­åˆšéœ€æˆ¿ã€‚", risk: "éƒ¨åˆ†ä½æ´¼åœ°åŒºæœ‰æ´ªæ°´é£é™©ã€‚" }
    };

    // 3D å¼•æ“å˜é‡
    let scene, camera, renderer, raycaster, mouse;
    let wardsGroup = new THREE.Group();
    let currentMetric = 'growth';
    let myChart = null;

    // é»˜è®¤å°è¯• NII æº
    const DATA_URL = "https://geoshape.ex.nii.ac.jp/city/geojson/2020/13.geojson";

    // åˆå§‹åŒ–
    init();

    function init() {
        // åœºæ™¯æ­å»º
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.001);
        
        camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 10000);
        camera.position.set(0, 1000, 1000);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // ç¯å…‰
        scene.add(new THREE.AmbientLight(0x404040, 2)); 
        const dl = new THREE.DirectionalLight(0xffffff, 1);
        dl.position.set(100, 200, 100);
        scene.add(dl);
        const pl = new THREE.PointLight(0x00f3ff, 1, 1000);
        pl.position.set(-200, 200, -200);
        scene.add(pl);

        // äº¤äº’
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        document.addEventListener('mousemove', onMove);
        document.addEventListener('click', onClick);

        // UI
        initUI();
        
        // å°è¯•è‡ªåŠ¨åŠ è½½
        attemptAutoLoad();
        
        // æ¸²æŸ“å¾ªç¯
        animate();
    }

    function attemptAutoLoad() {
        fetch(DATA_URL)
            .then(res => {
                if(!res.ok) throw new Error("Net Error");
                return res.json();
            })
            .then(json => {
                document.getElementById('status').innerText = "PROCESSING GEOMETRY...";
                processGeoJSON(json);
            })
            .catch(err => {
                console.error(err);
                showManualUpload(); // å¤±è´¥åˆ™æ˜¾ç¤ºæ‰‹åŠ¨ä¸Šä¼ 
            });
            
        // 3ç§’å…œåº•ï¼šå¦‚æœ3ç§’è¿˜åœ¨è½¬åœˆï¼Œä¹Ÿå¼ºåˆ¶æ˜¾ç¤ºæ‰‹åŠ¨ä¸Šä¼ 
        setTimeout(() => {
            if(document.getElementById('loader').style.display !== 'none') {
                showManualUpload();
            }
        }, 3000);
    }

    function showManualUpload() {
        document.getElementById('status').style.display = 'none';
        document.getElementById('error-box').style.display = 'block';
    }

    // ç›‘å¬æ–‡ä»¶ä¸Šä¼ 
    document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const json = JSON.parse(event.target.result);
                processGeoJSON(json);
            } catch(err) {
                alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿æ˜¯ .geojson æ–‡ä»¶");
            }
        };
        reader.readAsText(file);
    });

    function processGeoJSON(json) {
        document.getElementById('status').style.display = 'block';
        document.getElementById('error-box').style.display = 'none';
        document.getElementById('status').innerText = "GENERATING 3D CITY...";

        // D3 æŠ•å½±
        const projection = d3.geoMercator().center([139.75, 35.68]).scale(55000).translate([0, 0]);

        json.features.forEach(f => {
            // ç­›é€‰23åŒº (æ ¹æ®è¡Œæ”¿ä»£ç  13101-13123 æˆ– åå­—åŒ¹é…)
            let name = f.properties.N03_004 || f.properties.name;
            let dbData = null;

            // æ¨¡ç³ŠåŒ¹é…
            if(DB[name]) dbData = DB[name];
            else {
                for(let k in DB) {
                    if(name && name.indexOf(k) > -1) { name = k; dbData = DB[k]; break; }
                }
            }

            if(dbData) {
                const shapes = [];
                const coords = f.geometry.type==='Polygon' ? [f.geometry.coordinates] : f.geometry.coordinates;
                
                coords.forEach(poly => {
                    const shape = new THREE.Shape();
                    poly[0].forEach((p, i) => {
                        const [x, y] = projection(p);
                        i===0 ? shape.moveTo(x,y) : shape.lineTo(x,y);
                    });
                    // Holes
                    for(let i=1; i<poly.length; i++) {
                        const hole = new THREE.Path();
                        poly[i].forEach((p, j) => {
                            const [x, y] = projection(p);
                            j===0 ? hole.moveTo(x,y) : hole.lineTo(x,y);
                        });
                        shape.holes.push(hole);
                    }
                    shapes.push(shape);
                });

                shapes.forEach(s => {
                    const h = (dbData[currentMetric] / METRICS[currentMetric].max) * 80 + 5;
                    const c = new THREE.Color(METRICS[currentMetric].color);
                    
                    const geo = new THREE.ExtrudeGeometry(s, { depth: h, bevelEnabled: true, bevelSize: 0.5, bevelThickness: 0.5 });
                    const mat = new THREE.MeshPhongMaterial({ color: c, transparent: true, opacity: 0.9, shininess: 100 });
                    
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.rotation.x = Math.PI/2;
                    mesh.scale.y = -1;
                    mesh.userData = { name: name, data: dbData, baseH: h };
                    wardsGroup.add(mesh);
                });
            }
        });

        // Center
        new THREE.Box3().setFromObject(wardsGroup).getCenter(wardsGroup.position).multiplyScalar(-1);
        scene.add(wardsGroup);

        // Done
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
        }, 500);
    }

    function animate() {
        requestAnimationFrame(animate);
        wardsGroup.rotation.z += 0.0005;
        renderer.render(scene, camera);
    }

    // äº¤äº’é€»è¾‘
    let hovered = null;
    function onMove(e) {
        mouse.x = (e.clientX/window.innerWidth)*2-1;
        mouse.y = -(e.clientY/window.innerHeight)*2+1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(wardsGroup.children);
        
        if(intersects.length > 0) {
            const obj = intersects[0].object;
            if(hovered !== obj) {
                if(hovered) hovered.material.emissive.setHex(0x000000);
                hovered = obj;
                hovered.material.emissive.setHex(0x555555);
            }
        } else {
            if(hovered) hovered.material.emissive.setHex(0x000000);
            hovered = null;
        }
    }

    function onClick(e) {
        if(hovered) openSidebar(hovered.userData.name);
    }

    // UI Logic
    function initUI() {
        const c = document.getElementById('btn-container');
        Object.keys(METRICS).forEach(k => {
            const d = document.createElement('div');
            d.className = `mode-btn ${k===currentMetric?'active':''}`;
            d.style.setProperty('--c', METRICS[k].color);
            d.innerHTML = `<span>${METRICS[k].label}</span>`;
            d.onclick = () => switchMetric(k);
            c.appendChild(d);
        });
    }

    function switchMetric(k) {
        currentMetric = k;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(METRICS[k].label)));
        
        wardsGroup.children.forEach(m => {
            const d = m.userData.data;
            const targetH = (d[k] / METRICS[k].max) * 80 + 5;
            const targetC = new THREE.Color(METRICS[k].color);
            
            m.scale.z = targetH / m.userData.baseH;
            m.material.color.set(targetC);
        });
    }

    function openSidebar(name) {
        const d = DB[name];
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('ward-name').innerText = name;
        document.getElementById('ward-tags').innerHTML = d.tags.map(t=>`<span style="background:#333; padding:2px 8px; font-size:10px;">${t}</span>`).join('');
        document.getElementById('ward-stats').innerHTML = `
            <div class="data-box"><div class="lbl">LAND GROWTH</div><div class="val" style="color:${METRICS.growth.color}">${d.growth}</div></div>
            <div class="data-box"><div class="lbl">RENTAL YIELD</div><div class="val" style="color:${METRICS.yield.color}">${d.yield}%</div></div>
            <div class="data-box"><div class="lbl">AIRBNB</div><div class="val" style="color:${METRICS.airbnb.color}">${d.airbnb}</div></div>
            <div class="data-box"><div class="lbl">FUTURE</div><div class="val" style="color:${METRICS.future.color}">${d.future}</div></div>
        `;
        document.getElementById('ward-desc').innerText = d.desc;
        document.getElementById('ward-rec').innerText = d.rec;
        document.getElementById('ward-risk').innerText = d.risk;
        updateChart(name, d);
    }

    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

    function updateChart(name, d) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['GROWTH', 'YIELD', 'AIRBNB', 'FUTURE'],
                datasets: [{
                    label: name,
                    data: [d.growth, d.yield*1.5, d.airbnb, d.future],
                    backgroundColor: 'rgba(0,243,255,0.2)',
                    borderColor: '#00f3ff',
                    borderWidth: 1,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    r: {
                        angleLines: { color: '#333' },
                        grid: { color: '#333' },
                        pointLabels: { color: '#888', font: {size: 10} },
                        ticks: { display: false, max: 10, min: 0 }
                    }
                },
                maintainAspectRatio: false
            }
        });
    }
</script>
</body>
</html>
