<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TOKYO 3D INVESTMENT ANALYZER</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

<style>
    :root { --neon-blue: #00f3ff; --neon-purple: #bc13fe; --neon-orange: #ff9100; --neon-red: #ff003c; --bg: #050505; --glass: rgba(10, 10, 15, 0.85); }
    body { margin: 0; overflow: hidden; background-color: var(--bg); font-family: 'Rajdhani', sans-serif; color: #fff; }
    #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); }
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

    /* 控制面板 */
    #control-panel {
        position: absolute; top: 20px; left: 20px; width: 240px; pointer-events: auto;
        background: var(--glass); border-left: 2px solid var(--neon-blue);
        padding: 20px; backdrop-filter: blur(10px); clip-path: polygon(0 0, 100% 0, 100% 98%, 92% 100%, 0 100%);
    }
    h1 { margin: 0 0 5px 0; font-size: 24px; letter-spacing: 2px; color: var(--neon-blue); text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
    .subtitle { font-size: 10px; color: #888; margin-bottom: 20px; letter-spacing: 1px; }
    .mode-btn {
        display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 12px; margin-bottom: 8px;
        background: rgba(255,255,255,0.03); border: 1px solid #333; color: #aaa; font-size: 14px; cursor: pointer; transition: 0.3s;
    }
    .mode-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #666; }
    .mode-btn.active { background: rgba(0, 243, 255, 0.1); border-color: var(--color); color: var(--color); box-shadow: inset 2px 0 0 var(--color); }

    /* 侧边栏 */
    #sidebar {
        position: absolute; top: 0; right: -450px; bottom: 0; width: 400px;
        background: var(--glass); border-left: 1px solid #333; pointer-events: auto;
        padding: 30px; box-sizing: border-box; transition: right 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        display: flex; flex-direction: column; overflow-y: auto;
    }
    #sidebar.open { right: 0; }
    .ward-title { font-size: 36px; font-weight: 700; margin: 0; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .tag { font-size: 11px; padding: 4px 8px; border: 1px solid #444; color: #bbb; background: rgba(0,0,0,0.5); margin-right: 5px;}
    .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .data-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px; }
    .data-label { font-size: 11px; color: #777; display: block; margin-bottom: 2px; }
    .data-value { font-size: 18px; font-weight: 700; color: #eee; }
    .analysis-text { font-size: 13px; line-height: 1.6; color: #ccc; margin-bottom: 15px; }
    .section-title { color: var(--neon-blue); font-size: 12px; margin-bottom: 5px; font-weight: bold; margin-top: 20px;}

    #tooltip {
        position: absolute; display: none; background: rgba(0,0,0,0.9); border: 1px solid #fff;
        padding: 8px 15px; pointer-events: none; z-index: 20; font-size: 14px; font-weight: bold;
        transform: translate(-50%, -150%); white-space: nowrap; box-shadow: 0 0 15px rgba(0,0,0,0.8);
    }

    /* Loading Screen */
    #loader { position: absolute; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s; }
    .loading-bar { width: 200px; height: 2px; background: #333; margin-top: 20px; position: relative; overflow: hidden; }
    .loading-progress { position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: var(--neon-blue); transition: width 0.2s; }
    #error-log { color: #ff003c; margin-top: 20px; font-family: monospace; font-size: 12px; max-width: 80%; text-align: center; display: none; border: 1px solid #ff003c; padding: 10px; }

    @media (max-width: 768px) {
        #control-panel { top: auto; bottom: 0; width: 100%; border-left: none; border-top: 2px solid var(--neon-blue); padding: 15px; clip-path: none; }
        #sidebar { width: 100%; top: auto; bottom: -100%; height: 70%; right: 0; border-radius: 16px 16px 0 0; }
        #sidebar.open { bottom: 0; right: 0; }
    }
</style>
</head>
<body>

<div id="loader">
    <div style="font-size: 24px; letter-spacing: 5px; color: #fff;">SYSTEM INITIALIZING</div>
    <div class="loading-bar"><div class="loading-progress" id="progress"></div></div>
    <div id="status-text" style="color: #666; font-size: 10px; margin-top: 10px;">CONNECTING TO CDN...</div>
    <div id="error-log"></div>
</div>

<div id="tooltip"></div>
<div id="canvas-container"></div>

<div id="ui-layer">
    <div id="control-panel">
        <h1>TOKYO RE:VIEW</h1>
        <div class="subtitle">REAL ESTATE INVESTMENT ANALYTICS</div>
        <div id="metrics-container"></div>
        <div style="margin-top: 20px; font-size: 10px; color: #555;">* 左键旋转 / 右键平移 / 滚轮缩放</div>
    </div>

    <div id="sidebar">
        <div style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:24px;" onclick="closeSidebar()">×</div>
        <div class="ward-title" id="detail-name">--</div>
        <div style="margin: 10px 0;" id="detail-tags"></div>
        <div class="data-grid" id="detail-stats"></div>
        <div style="height: 180px; width: 100%;"><canvas id="radarChart"></canvas></div>
        <div style="border-top: 1px solid #333; margin-top: 20px;">
            <div class="section-title">ANALYSIS</div>
            <div class="analysis-text" id="detail-desc"></div>
            <div class="section-title">RECOMMENDATION</div>
            <div class="analysis-text" id="detail-rec" style="color: var(--neon-blue);"></div>
            <div class="section-title">RISKS</div>
            <div class="analysis-text" id="detail-risk" style="color: var(--neon-orange);"></div>
        </div>
    </div>
</div>

<script>
    // 1. 数据定义 (完整保留您的文档数据)
    const METRICS = {
        growth: { label: 'LAND GROWTH', color: '#d600ff', max: 10 },
        yield:  { label: 'RENTAL YIELD', color: '#ff9100', max: 6 },
        airbnb: { label: 'AIRBNB SCORE', color: '#00f3ff', max: 10 },
        future: { label: 'FUTURE POT.', color: '#ff003c', max: 10 }
    };

    const DB = {
        [cite_start]"千代田区": { growth: 9.5, yield: 3.0, airbnb: 4.0, future: 9.0, tags: ["核心", "保值", "政企"], desc: "东京心脏，2025年地价涨幅近双位数 [cite: 3][cite_start]。租金极高但房价更高，回报率偏低(约3%) [cite: 4][cite_start]。", rec: "适合豪宅、写字楼、五星酒店 [cite: 6][cite_start]。资产保值首选。", risk: "门槛极高，初期投入巨大 [cite: 7][cite_start]。民宿受限严重 [cite: 5]。" },
        [cite_start]"中央区": { growth: 9.8, yield: 3.2, airbnb: 5.0, future: 9.2, tags: ["银座", "金融", "再开发"], desc: "地价全国最高点之一 [cite: 9][cite_start]。银座、晴海再开发动力强。租客以金融高管为主 [cite: 10][cite_start]。", rec: "高端公寓、商业地产 [cite: 12][cite_start]。", risk: "房价泡沫风险，民宿180天限制严格 [cite: 13]。" },
        [cite_start]"港区": { growth: 10.0, yield: 3.4, airbnb: 3.5, future: 9.5, tags: ["六本木", "外企", "超豪宅"], desc: "全东京最顶级涨幅 [cite: 15][cite_start]。外资与富人聚集。租金全东京最高 [cite: 16][cite_start]。", rec: "奢侈楼盘、A级写字楼 [cite: 18][cite_start]。", risk: "特区民宿政策未覆盖，短租难做 [cite: 17]。" },
        [cite_start]"新宿区": { growth: 8.5, yield: 4.0, airbnb: 9.0, future: 8.0, tags: ["枢纽", "高流转", "歌舞伎町"], desc: "三大副都心之一。民宿回报率极高，部分整栋公寓可达30%回报 [cite: 23][cite_start]。", rec: "整栋公寓出租、商业综合体 [cite: 24][cite_start]。", risk: "过度开发竞争激烈，歌舞伎町治安问题 [cite: 25]。" },
        [cite_start]"文京区": { growth: 8.0, yield: 3.8, airbnb: 3.0, future: 7.0, tags: ["教育", "治安", "东大"], desc: "治安东京第一，教育资源顶尖 [cite: 32][cite_start]。租户极其稳定（学者、家庭） [cite: 33][cite_start]。", rec: "学区房、家庭型长租公寓 [cite: 35][cite_start]。", risk: "纯住宅区多，民宿几乎无法经营 [cite: 34]。" },
        [cite_start]"台东区": { growth: 9.0, yield: 4.8, airbnb: 9.5, future: 7.5, tags: ["浅草", "旅游", "高收益"], desc: "商业地价涨幅最大 [cite: 38][cite_start]。旅游业支柱，Airbnb入住率极高 [cite: 40][cite_start]。", rec: "简易旅馆、民宿改造 [cite: 41][cite_start]。", risk: "居民对民宿有反弹情绪 [cite: 42]。" },
        [cite_start]"墨田区": { growth: 7.5, yield: 4.5, airbnb: 8.0, future: 7.8, tags: ["晴空塔", "下町", "潜力"], desc: "依托晴空塔，从老工业区转型旅游区 [cite: 45][cite_start]。房价亲民，升值快 [cite: 44][cite_start]。", rec: "押上周边高层公寓、民宿运营 [cite: 47][cite_start]。", risk: "部分区域仍有老旧工业感 [cite: 48]。" },
        [cite_start]"江东区": { growth: 7.0, yield: 4.5, airbnb: 6.0, future: 8.0, tags: ["湾岸", "塔楼", "奥运"], desc: "丰洲、有明湾岸开发。年轻家庭流入多 [cite: 50][cite_start]。", rec: "大户型家庭公寓、商办结合项目 [cite: 53][cite_start]。", risk: "填海区地基担忧，区域太大位置差异明显 [cite: 54]。" },
        [cite_start]"品川区": { growth: 6.8, yield: 4.2, airbnb: 5.5, future: 8.8, tags: ["新干线", "商务", "磁悬浮"], desc: "交通枢纽，磁悬浮始发站预期 [cite: 56][cite_start]。", rec: "写字楼、商务酒店 [cite: 59][cite_start]。", risk: "可开发用地减少，商业氛围浓导致居住舒适度参差 [cite: 60]。" },
        [cite_start]"目黑区": { growth: 7.2, yield: 3.6, airbnb: 4.5, future: 6.5, tags: ["时尚", "宜居", "品牌"], desc: "深受高收入年轻人喜爱，品牌价值高 [cite: 62][cite_start]。", rec: "精品设计公寓、高端长租 [cite: 65][cite_start]。", risk: "房价已高，租金增长空间有限 [cite: 66]。" },
        [cite_start]"大田区": { growth: 6.5, yield: 5.2, airbnb: 9.8, future: 7.0, tags: ["特区民宿", "机场", "高回报"], desc: "国家战略特区，唯一允许全年365天民宿的区域 [cite: 68][cite_start]。", rec: "特区民宿、机场相关物流 [cite: 72][cite_start]。", risk: "部分区域工厂多环境一般 [cite: 73]。" },
        [cite_start]"世田谷区": { growth: 5.5, yield: 4.2, airbnb: 2.0, future: 5.0, tags: ["富人居住", "家庭", "稳定"], desc: "人口最多，环境优美。适合家族居住，民宿难做 [cite: 75][cite_start]。", rec: "独栋住宅、家庭型公寓 [cite: 77][cite_start]。", risk: "人口老龄化，缺乏大型开发爆点 [cite: 78]。" },
        [cite_start]"涩谷区": { growth: 9.2, yield: 3.5, airbnb: 8.5, future: 9.8, tags: ["IT", "潮流", "再开发"], desc: "IT企业聚集，百年一遇大开发 [cite: 27][cite_start]。", rec: "创意办公、精品公寓 [cite: 29][cite_start]。", risk: "入手成本极高 [cite: 30]。" },
        [cite_start]"中野区": { growth: 6.0, yield: 4.5, airbnb: 5.0, future: 6.0, tags: ["次文化", "单身", "高需"], desc: "单身租赁需求极大 [cite: 80][cite_start]。", rec: "单身公寓、小户型 [cite: 81][cite_start]。", risk: "除了车站周边外发展平缓 [cite: 83]。" },
        [cite_start]"杉并区": { growth: 5.0, yield: 5.0, airbnb: 1.0, future: 4.5, tags: ["住宅", "避险", "中央线"], desc: "安静的高级住宅区。资产极稳，短租极弱 [cite: 85][cite_start]。", rec: "长期收租型住宅 [cite: 86][cite_start]。", risk: "增值爆发力弱 [cite: 88]。" },
        [cite_start]"丰岛区": { growth: 8.0, yield: 4.5, airbnb: 8.0, future: 7.0, tags: ["池袋", "动漫", "洼地"], desc: "动漫吸引全球游客。相比新宿价格仍是洼地 [cite: 90][cite_start]。", rec: "池袋周边民宿、商业地产 [cite: 91][cite_start]。", risk: "商圈竞争激烈 [cite: 92]。" },
        [cite_start]"北区": { growth: 5.5, yield: 4.8, airbnb: 3.0, future: 6.5, tags: ["赤羽", "交通", "性价比"], desc: "赤羽交通极便利。适合实利主义投资 [cite: 94][cite_start]。", rec: "中高层公寓、通勤刚需房 [cite: 95][cite_start]。", risk: "缺乏核心高端商业 [cite: 96]。" },
        [cite_start]"荒川区": { growth: 5.8, yield: 5.2, airbnb: 4.0, future: 5.5, tags: ["日暮里", "下町", "低价"], desc: "交通枢纽日暮里非常方便。价格洼地 [cite: 98][cite_start]。", rec: "中小户型公寓 [cite: 99][cite_start]。", risk: "人口有减少趋势 [cite: 100]。" },
        [cite_start]"板桥区": { growth: 4.5, yield: 5.3, airbnb: 1.5, future: 4.5, tags: ["睡城", "稳健", "家庭"], desc: "典型睡城，家庭租赁需求大 [cite: 102][cite_start]。", rec: "家庭型租赁公寓 [cite: 102][cite_start]。", risk: "远离市中心，基本无民宿价值 [cite: 104]。" },
        [cite_start]"练马区": { growth: 4.0, yield: 5.5, airbnb: 1.0, future: 4.8, tags: ["绿化", "农业", "自住"], desc: "绿化最好，适合自住 [cite: 106][cite_start]。", rec: "整栋木造公寓 [cite: 106][cite_start]。", risk: "交通限制客源 [cite: 108]。" },
        [cite_start]"足立区": { growth: 5.0, yield: 5.8, airbnb: 4.5, future: 5.0, tags: ["高回报", "地板价", "门槛低"], desc: "表面回报率最高(5%以上) [cite: 110][cite_start]。", rec: "高现金流导向的公寓 [cite: 110][cite_start]。", risk: "治安名声一般 [cite: 112]。" },
        [cite_start]"葛饰区": { growth: 3.5, yield: 6.0, airbnb: 2.0, future: 4.0, tags: ["老街", "低成本", "养老"], desc: "房价极低，租客多为老年人 [cite: 114][cite_start]。", rec: "低成本吸纳长租房 [cite: 116][cite_start]。", risk: "升值空间有限 [cite: 114]。" },
        [cite_start]"江户川区": { growth: 4.0, yield: 5.8, airbnb: 1.5, future: 4.5, tags: ["公园", "育儿", "水灾"], desc: "育儿环境好，房价亲民 [cite: 118][cite_start]。", rec: "家庭刚需房 [cite: 118][cite_start]。", risk: "部分低洼地区有洪水风险 [cite: 120]。" }
    };

    // 2. 3D 核心
    let scene, camera, renderer, raycaster, mouse;
    let wardsGroup = new THREE.Group();
    let currentMetric = 'growth';
    let hoveredObject = null;
    let selectedWardName = null;
    let myChart = null;
    
    // 使用 jsDelivr 全球 CDN (支持跨域) - 解决卡死问题的关键
    const GEOJSON_URL = "https://cdn.jsdelivr.net/gh/dataofjapan/land@master/tokyo.geojson";

    function init() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.002);
        
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 5000);
        camera.position.set(0, 800, 800);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 灯光
        scene.add(new THREE.AmbientLight(0x404040, 1.5));
        const dl = new THREE.DirectionalLight(0xffffff, 0.8);
        dl.position.set(100, 200, 100);
        scene.add(dl);
        const pl = new THREE.PointLight(0x00f3ff, 1, 800);
        pl.position.set(-200, 100, -200);
        scene.add(pl);

        // 网格
        scene.add(new THREE.GridHelper(3000, 100, 0x333333, 0x111111));

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

        window.addEventListener('resize', onResize, false);
        document.addEventListener('mousemove', onMouseMove, false);
        document.addEventListener('click', onClick, false);

        initUI();
        loadGeoData();
        animate();
    }

    // 3. 数据加载与处理
    function loadGeoData() {
        const pBar = document.getElementById('progress');
        const sText = document.getElementById('status-text');
        
        pBar.style.width = '30%';
        sText.innerText = "FETCHING DATA...";

        fetch(GEOJSON_URL)
            .then(res => {
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(json => {
                pBar.style.width = '60%';
                sText.innerText = "BUILDING 3D MODELS...";

                // D3 投影
                const projection = d3.geoMercator().center([139.75, 35.68]).scale(60000).translate([0, 0]);

                json.features.forEach(feature => {
                    // 模糊匹配名字 (解决 NII vs DataOfJapan 名字差异)
                    const rawName = feature.properties.N03_004 || feature.properties.name || "";
                    let dbKey = null;
                    
                    // 尝试匹配 DB
                    if(DB[rawName]) dbKey = rawName;
                    else {
                        // 反向查找
                        for(let k in DB) {
                            if(rawName.includes(k) || (rawName.includes("Chiyoda") && k==="千代田区")) { // 示例补丁
                                dbKey = k; break;
                            }
                        }
                    }

                    if(dbKey) {
                        const shapes = createShapes(feature, projection);
                        shapes.forEach(shape => {
                            const height = getHeight(dbKey);
                            const color = getColor(dbKey);
                            
                            const geo = new THREE.ExtrudeGeometry(shape, { depth: height, bevelEnabled: true, bevelSize:0.5, bevelThickness:0.5 });
                            const matTop = new THREE.MeshPhongMaterial({ color: color, emissive: color, emissiveIntensity: 0.4 });
                            const matSide = new THREE.MeshLambertMaterial({ color: color, transparent: true, opacity: 0.8 });
                            
                            const mesh = new THREE.Mesh(geo, [matTop, matSide]);
                            mesh.rotation.x = Math.PI/2;
                            mesh.scale.y = -1; 
                            
                            // 绑定数据
                            mesh.userData = { name: dbKey, ...DB[dbKey], baseH: height };
                            wardsGroup.add(mesh);
                        });
                    }
                });

                // 居中
                new THREE.Box3().setFromObject(wardsGroup).getCenter(wardsGroup.position).multiplyScalar(-1);
                scene.add(wardsGroup);

                pBar.style.width = '100%';
                setTimeout(() => { document.getElementById('loader').style.opacity = 0; setTimeout(()=>document.getElementById('loader').style.display='none', 800); }, 500);
            })
            .catch(err => {
                pBar.style.background = 'red';
                sText.innerText = "LOAD FAILED";
                const log = document.getElementById('error-log');
                log.style.display = 'block';
                log.innerText = `ERROR: ${err.message}\nTry checking your network connection or CORS settings.`;
            });
    }

    function createShapes(feature, projection) {
        const shapes = [];
        const coords = feature.geometry.type === 'Polygon' ? [feature.geometry.coordinates] : feature.geometry.coordinates;
        coords.forEach(poly => {
            const shape = new THREE.Shape();
            poly[0].forEach((pt, i) => {
                const [x, y] = projection(pt);
                i===0 ? shape.moveTo(x,y) : shape.lineTo(x,y);
            });
            for(let i=1; i<poly.length; i++) {
                const hole = new THREE.Path();
                poly[i].forEach((pt, j) => {
                    const [x, y] = projection(pt);
                    j===0 ? hole.moveTo(x,y) : hole.lineTo(x,y);
                });
                shape.holes.push(hole);
            }
            shapes.push(shape);
        });
        return shapes;
    }

    // 4. 视觉与交互逻辑
    function getHeight(name) { return (DB[name][currentMetric] / METRICS[currentMetric].max) * 60 + 5; }
    function getColor(name) {
        const r = DB[name][currentMetric] / METRICS[currentMetric].max;
        const c = new THREE.Color(METRICS[currentMetric].color);
        return r < 0.4 ? c.multiplyScalar(0.4) : c;
    }

    function switchMetric(key) {
        currentMetric = key;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(METRICS[key].label)));
        
        wardsGroup.children.forEach(mesh => {
            const h = getHeight(mesh.userData.name);
            const c = getColor(mesh.userData.name);
            mesh.scale.z = h / mesh.userData.baseH; // 动态缩放高度
            mesh.material[0].color.set(c);
            mesh.material[0].emissive.set(c);
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        if(!selectedWardName) wardsGroup.rotation.z += 0.0005; // 待机旋转
        
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(wardsGroup.children);
        
        if(intersects.length > 0) {
            const obj = intersects[0].object;
            if(hoveredObject !== obj) {
                if(hoveredObject) hoveredObject.material[0].emissiveIntensity = 0.4;
                hoveredObject = obj;
                hoveredObject.material[0].emissiveIntensity = 1.0;
                
                const tip = document.getElementById('tooltip');
                tip.style.display = 'block';
                tip.innerHTML = `${obj.userData.name}<br>${METRICS[currentMetric].label}: ${DB[obj.userData.name][currentMetric]}`;
            }
        } else {
            if(hoveredObject) hoveredObject.material[0].emissiveIntensity = 0.4;
            hoveredObject = null;
            document.getElementById('tooltip').style.display = 'none';
        }
        renderer.render(scene, camera);
    }

    function onMouseMove(e) {
        mouse.x = (e.clientX/window.innerWidth)*2-1;
        mouse.y = -(e.clientY/window.innerHeight)*2+1;
        const tip = document.getElementById('tooltip');
        tip.style.left = e.clientX + 'px';
        tip.style.top = e.clientY + 'px';
    }

    function onClick(e) {
        if(hoveredObject) openSidebar(hoveredObject.userData.name);
    }

    function onResize() {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // 5. UI 逻辑
    function initUI() {
        const c = document.getElementById('metrics-container');
        Object.keys(METRICS).forEach(k => {
            const d = document.createElement('div');
            d.className = `mode-btn ${k===currentMetric?'active':''}`;
            d.style.setProperty('--color', METRICS[k].color);
            d.innerHTML = `<span>${METRICS[k].label}</span>`;
            d.onclick = () => switchMetric(k);
            c.appendChild(d);
        });
    }

    function openSidebar(name) {
        const d = DB[name];
        selectedWardName = name;
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('detail-name').innerText = name;
        document.getElementById('detail-tags').innerHTML = d.tags.map(t=>`<span class="tag">${t}</span>`).join('');
        
        document.getElementById('detail-stats').innerHTML = `
            <div class="data-item"><span class="data-label">土地涨幅</span><span class="data-value" style="color:${METRICS.growth.color}">${d.growth}</span></div>
            <div class="data-item"><span class="data-label">租金回报</span><span class="data-value" style="color:${METRICS.yield.color}">${d.yield}%</span></div>
            <div class="data-item"><span class="data-label">民宿潜力</span><span class="data-value" style="color:${METRICS.airbnb.color}">${d.airbnb}</span></div>
            <div class="data-item"><span class="data-label">未来潜力</span><span class="data-value" style="color:${METRICS.future.color}">${d.future}</span></div>
        `;
        document.getElementById('detail-desc').innerText = d.desc;
        document.getElementById('detail-rec').innerText = d.rec;
        document.getElementById('detail-risk').innerText = d.risk;

        updateChart(name, d);
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        selectedWardName = null;
    }

    function updateChart(name, d) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['涨幅', '回报', '民宿', '未来'],
                datasets: [{
                    label: name,
                    data: [d.growth, d.yield*1.5, d.airbnb, d.future],
                    backgroundColor: 'rgba(0,243,255,0.2)',
                    borderColor: '#00f3ff',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { display: false, max: 10, min: 0 },
                        pointLabels: { color: '#aaa', font: {size: 10} }
                    }
                },
                maintainAspectRatio: false
            }
        });
    }
</script>
</body>
</html>
