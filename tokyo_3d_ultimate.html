<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TOKYO 3D ANALYTICS (v8.0 FINAL)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600&display=swap" rel="stylesheet">

<style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Rajdhani', sans-serif; color: #fff; }
    
    #loader { 
        position: fixed; inset: 0; background: #000; z-index: 9999; 
        display: flex; flex-direction: column; justify-content: center; align-items: center; 
        transition: opacity 0.5s; pointer-events: none;
    }
    .status-text { color: #00f3ff; font-size: 14px; margin-top: 15px; letter-spacing: 2px; }
    
    #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
    #control-panel { 
        position: absolute; top: 20px; left: 20px; width: 220px; pointer-events: auto;
        background: rgba(8, 12, 16, 0.9); border-left: 2px solid #00f3ff; padding: 15px;
    }
    .mode-btn { 
        padding: 10px; margin-bottom: 5px; background: rgba(255,255,255,0.05); 
        border: 1px solid #333; cursor: pointer; color: #888; display: flex; justify-content: space-between; transition: 0.2s;
    }
    .mode-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .mode-btn.active { border-color: var(--c); color: var(--c); background: rgba(0,243,255,0.1); }
    
    #sidebar {
        position: absolute; top: 0; right: -420px; bottom: 0; width: 380px;
        background: rgba(8, 12, 16, 0.95); border-left: 1px solid #333; pointer-events: auto;
        padding: 25px; transition: right 0.4s; display: flex; flex-direction: column; overflow-y: auto;
    }
    #sidebar.open { right: 0; }
    
    .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 20px 0; }
    .data-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 4px; }
    .val { font-size: 20px; font-weight: bold; color: #fff; }
    .lbl { font-size: 10px; color: #666; }
    
    #tooltip {
        position: absolute; display: none; background: rgba(0,0,0,0.9); border: 1px solid #fff;
        padding: 8px 15px; pointer-events: none; z-index: 20; font-size: 14px; font-weight: bold;
        transform: translate(-50%, -150%); white-space: nowrap; box-shadow: 0 0 15px rgba(0,0,0,0.8);
    }
</style>
</head>
<body>

<div id="loader">
    <div style="font-size: 24px; letter-spacing: 5px; font-weight:bold;">TOKYO RE:VIEW</div>
    <div class="status-text" id="status">STARTING CORE...</div>
</div>

<div id="tooltip"></div>
<div id="canvas-container"></div>

<div id="ui-layer">
    <div id="control-panel">
        <h2 style="margin:0 0 5px 0; color:#00f3ff; font-size:18px;">DATA METRICS</h2>
        <div id="btn-container"></div>
        <div style="font-size:10px; color:#555; margin-top:20px;">
            * DRAG TO ROTATE<br>* RIGHT-CLICK TO PAN<br>* SCROLL TO ZOOM
        </div>
    </div>

    <div id="sidebar">
        <div style="text-align:right; cursor:pointer; font-size:24px;" onclick="closeSidebar()">×</div>
        <h1 id="ward-name" style="margin:0; background:linear-gradient(90deg,#fff,#aaa); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">--</h1>
        <div id="ward-tags" style="margin:10px 0; display:flex; gap:5px; flex-wrap:wrap;"></div>
        <div class="data-grid" id="ward-stats"></div>
        <div style="height:200px; width:100%;"><canvas id="radarChart"></canvas></div>
        <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <div style="color:#00f3ff; font-size:11px; font-weight:bold;">ANALYSIS</div>
            <p id="ward-desc" style="font-size:13px; color:#bbb; line-height:1.6; margin-bottom:15px;"></p>
            <div style="color:#ff9100; font-size:11px; font-weight:bold;">STRATEGY</div>
            <p id="ward-rec" style="font-size:13px; color:#bbb; line-height:1.6; margin-bottom:15px;"></p>
            <div style="color:#ff003c; font-size:11px; font-weight:bold;">RISKS</div>
            <p id="ward-risk" style="font-size:13px; color:#bbb; line-height:1.6;"></p>
        </div>
    </div>
</div>

<script>
    // 1. 数据配置 (完整版)
    const METRICS = {
        growth: { label: 'LAND GROWTH', color: '#d600ff', max: 10 },
        yield:  { label: 'RENTAL YIELD', color: '#ff9100', max: 6 },
        airbnb: { label: 'AIRBNB POT.', color: '#00f3ff', max: 10 },
        future: { label: 'FUTURE DEV.', color: '#ff003c', max: 10 }
    };

    // 内置抽象坐标 (HEX GRID) - 确保无网也能显示
    // 格式: [X, Y] (Hex coordinates)
    const DB = {
        "千代田区": { pos: [0, 0], growth: 9.5, yield: 3.0, airbnb: 4.0, future: 9.0, tags: ["核心", "保值"], desc: "东京心脏，资产安全性极高。", rec: "豪宅、写字楼保值。", risk: "门槛极高。" },
        "中央区": { pos: [1, -1], growth: 9.8, yield: 3.2, airbnb: 5.0, future: 9.2, tags: ["银座", "金融"], desc: "地价最高点之一，晴海再开发。", rec: "高端公寓、商业。", risk: "泡沫风险。" },
        "港区": { pos: [-1, -1], growth: 10.0, yield: 3.4, airbnb: 3.5, future: 9.5, tags: ["六本木", "豪宅"], desc: "富人与外资聚集。", rec: "奢侈资产、身份象征。", risk: "回报率被稀释。" },
        "新宿区": { pos: [-2, 1], growth: 8.5, yield: 4.0, airbnb: 9.0, future: 8.0, tags: ["枢纽", "歌舞伎"], desc: "民宿回报率极高。", rec: "整栋公寓、商业。", risk: "竞争激烈。" },
        "文京区": { pos: [-1, 1], growth: 8.0, yield: 3.8, airbnb: 3.0, future: 7.0, tags: ["教育", "治安"], desc: "治安第一，学区房。", rec: "家庭长租。", risk: "民宿难做。" },
        "台东区": { pos: [1, 1], growth: 9.0, yield: 4.8, airbnb: 9.5, future: 7.5, tags: ["浅草", "旅游"], desc: "旅游业支柱，Airbnb火爆。", rec: "民宿、旅馆。", risk: "反弹情绪。" },
        "墨田区": { pos: [2, 1], growth: 7.5, yield: 4.5, airbnb: 8.0, future: 7.8, tags: ["晴空塔", "下町"], desc: "晴空塔带动，房价亲民。", rec: "高层公寓。", risk: "老旧工业感。" },
        "江东区": { pos: [2, -2], growth: 7.0, yield: 4.5, airbnb: 6.0, future: 8.0, tags: ["湾岸", "奥运"], desc: "湾岸塔楼，年轻家庭。", rec: "大户型、商办。", risk: "填海地基。" },
        "品川区": { pos: [-1, -2], growth: 6.8, yield: 4.2, airbnb: 5.5, future: 8.8, tags: ["新干线", "商务"], desc: "磁悬浮预期，商务强。", rec: "写字楼。", risk: "商业氛围过浓。" },
        "目黑区": { pos: [-2, -1], growth: 7.2, yield: 3.6, airbnb: 4.5, future: 6.5, tags: ["时尚", "宜居"], desc: "中目黑，品牌价值高。", rec: "精品设计公寓。", risk: "租金增长受限。" },
        "大田区": { pos: [-1, -3], growth: 6.5, yield: 5.2, airbnb: 9.8, future: 7.0, tags: ["特区", "机场"], desc: "特区民宿全年无休。", rec: "特区民宿。", risk: "工厂环境。" },
        "世田谷区": { pos: [-3, -1], growth: 5.5, yield: 4.2, airbnb: 2.0, future: 5.0, tags: ["居住", "稳定"], desc: "人口最多，环境优。", rec: "独栋住宅。", risk: "老龄化。" },
        "涩谷区": { pos: [-2, 0], growth: 9.2, yield: 3.5, airbnb: 8.5, future: 9.8, tags: ["IT", "潮流"], desc: "百年大开发，IT聚集。", rec: "创意办公。", risk: "入手成本高。" },
        "中野区": { pos: [-3, 2], growth: 6.0, yield: 4.5, airbnb: 5.0, future: 6.0, tags: ["单身", "次文化"], desc: "单身租赁需求大。", rec: "单身公寓。", risk: "发展平缓。" },
        "杉并区": { pos: [-4, 1], growth: 5.0, yield: 5.0, airbnb: 1.0, future: 4.5, tags: ["住宅", "避险"], desc: "高级住宅，极稳。", rec: "长期收租。", risk: "爆发力弱。" },
        "丰岛区": { pos: [-2, 2], growth: 8.0, yield: 4.5, airbnb: 8.0, future: 7.0, tags: ["池袋", "动漫"], desc: "池袋副都心，价格洼地。", rec: "民宿、商业。", risk: "商圈竞争。" },
        "北区": { pos: [-1, 3], growth: 5.5, yield: 4.8, airbnb: 3.0, future: 6.5, tags: ["赤羽", "性价比"], desc: "赤羽交通极便利。", rec: "刚需房。", risk: "缺高端商业。" },
        "荒川区": { pos: [1, 2], growth: 5.8, yield: 5.2, airbnb: 4.0, future: 5.5, tags: ["日暮里", "下町"], desc: "日暮里枢纽，低价。", rec: "中小公寓。", risk: "人口减少。" },
        "板桥区": { pos: [-2, 3], growth: 4.5, yield: 5.3, airbnb: 1.5, future: 4.5, tags: ["睡城", "稳健"], desc: "家庭租赁大。", rec: "家庭公寓。", risk: "无民宿价值。" },
        "练马区": { pos: [-4, 2], growth: 4.0, yield: 5.5, airbnb: 1.0, future: 4.8, tags: ["绿化", "自住"], desc: "绿化最好。", rec: "木造公寓。", risk: "交通限制。" },
        "足立区": { pos: [0, 3], growth: 5.0, yield: 5.8, airbnb: 4.5, future: 5.0, tags: ["高回报", "低价"], desc: "表面回报率最高。", rec: "高现金流。", risk: "治安名声。" },
        "葛饰区": { pos: [2, 3], growth: 3.5, yield: 6.0, airbnb: 2.0, future: 4.0, tags: ["老街", "低成本"], desc: "房价极低，养老。", rec: "低成本吸纳。", risk: "升值有限。" },
        "江户川区": { pos: [3, 0], growth: 4.0, yield: 5.8, airbnb: 1.5, future: 4.5, tags: ["公园", "育儿"], desc: "育儿好，房价低。", rec: "刚需房。", risk: "洪水风险。" }
    };

    const NAME_MAP = {
        'Chiyoda': '千代田区', 'Chuo': '中央区', 'Minato': '港区', 'Shinjuku': '新宿区', 'Bunkyo': '文京区',
        'Taito': '台东区', 'Sumida': '墨田区', 'Koto': '江东区', 'Shinagawa': '品川区', 'Meguro': '目黑区',
        'Ota': '大田区', 'Setagaya': '世田谷区', 'Shibuya': '涩谷区', 'Nakano': '中野区', 'Suginami': '杉并区',
        'Toshima': '丰岛区', 'Kita': '北区', 'Arakawa': '荒川区', 'Itabashi': '板桥区', 'Nerima': '练马区',
        'Adachi': '足立区', 'Katsushika': '葛饰区', 'Edogawa': '江户川区'
    };

    // 2. 核心变量
    let scene, camera, renderer, raycaster, mouse;
    let wardsGroup = new THREE.Group();
    let currentMetric = 'growth';
    let myChart = null;
    let isDragging = false, previousMousePosition = { x: 0, y: 0 }; // 手写控制器变量
    let targetRotationX = 0, targetRotationY = 0;

    // 3. 初始化
    init();

    function init() {
        // 场景
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.001);

        // 相机
        camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 10000);
        camera.position.set(0, 800, 1000);
        camera.lookAt(0, 0, 0);

        // 渲染器
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 灯光
        scene.add(new THREE.AmbientLight(0x404040, 2));
        const dl = new THREE.DirectionalLight(0xffffff, 1);
        dl.position.set(100, 200, 100);
        scene.add(dl);
        const pl = new THREE.PointLight(0x00f3ff, 1, 1000);
        pl.position.set(-200, 200, -200);
        scene.add(pl);

        // 交互
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        
        // 手写控制器 (替换 OrbitControls)
        const dom = renderer.domElement;
        dom.addEventListener('mousedown', e => { isDragging = true; previousMousePosition = { x: e.offsetX, y: e.offsetY }; });
        dom.addEventListener('mouseup', () => isDragging = false);
        dom.addEventListener('mousemove', e => {
            // 射线检测
            mouse.x = (e.clientX/window.innerWidth)*2-1;
            mouse.y = -(e.clientY/window.innerHeight)*2+1;
            
            // 拖拽旋转
            if(isDragging) {
                const deltaX = e.offsetX - previousMousePosition.x;
                const deltaY = e.offsetY - previousMousePosition.y;
                targetRotationY += deltaX * 0.005;
                targetRotationX += deltaY * 0.005;
                targetRotationX = Math.max(-Math.PI/4, Math.min(Math.PI/4, targetRotationX)); // 限制俯仰角
                previousMousePosition = { x: e.offsetX, y: e.offsetY };
            }
        });
        dom.addEventListener('click', onClick);
        dom.addEventListener('wheel', e => {
            camera.position.z += e.deltaY * 0.5;
            camera.position.z = Math.max(500, Math.min(2000, camera.position.z));
        });
        window.addEventListener('resize', onResize);

        // UI
        initUI();

        // 核心：直接生成抽象地图 (100% 成功)
        generateAbstractMap();
        
        // 后台尝试加载真实地图 (静默升级)
        loadRealMapBackground();

        animate();
    }

    // 4. 地图生成逻辑
    function generateAbstractMap() {
        // 创建六边形
        const r = 50; 
        const hexShape = new THREE.Shape();
        for(let i=0; i<6; i++) {
            const angle = (Math.PI/3)*i;
            hexShape[i===0?'moveTo':'lineTo'](Math.cos(angle)*r, Math.sin(angle)*r);
        }

        wardsGroup.clear();
        
        Object.keys(DB).forEach(name => {
            const pos = DB[name].pos;
            // 蜂巢布局计算
            const w = r * 1.732;
            const h = r * 2;
            const x = (pos[0] * w * 0.75) * 1.2; 
            const z = (pos[1] * h * 0.5 + (pos[0]%2)*h*0.25) * 1.2;

            const mesh = createMesh(hexShape, name, x, z);
            wardsGroup.add(mesh);
        });
        
        // 居中
        new THREE.Box3().setFromObject(wardsGroup).getCenter(wardsGroup.position).multiplyScalar(-1);
        scene.add(wardsGroup);
        
        // 移除 Loader
        setTimeout(() => document.getElementById('loader').style.opacity = 0, 500);
        setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
    }

    function createMesh(shape, name, x, z) {
        const d = DB[name];
        const height = (d[currentMetric] / METRICS[currentMetric].max) * 100 + 5;
        const color = new THREE.Color(METRICS[currentMetric].color);
        
        const geo = new THREE.ExtrudeGeometry(shape, { depth: 1, bevelEnabled: false });
        const mat = new THREE.MeshPhongMaterial({ color: color, transparent: true, opacity: 0.9, shininess: 80 });
        
        const mesh = new THREE.Mesh(geo, mat);
        mesh.rotation.x = Math.PI/2;
        mesh.scale.y = -1;
        mesh.scale.z = height; // 高度
        mesh.position.set(x, 0, z);
        mesh.userData = { name: name, data: d, baseH: height }; // 存储数据
        return mesh;
    }

    // 后台加载真实地图 (使用最稳的CDN)
    function loadRealMapBackground() {
        fetch("https://cdn.jsdelivr.net/gh/dataofjapan/land@master/tokyo.geojson")
            .then(r => r.json())
            .then(json => {
                const projection = d3.geoMercator().center([139.75, 35.68]).scale(55000).translate([0, 0]);
                const newGroup = new THREE.Group();
                let successCount = 0;

                json.features.forEach(f => {
                    let name = f.properties.N03_004 || f.properties.name || "";
                    // 名字匹配
                    let dbName = DB[name] ? name : null;
                    if(!dbName) for(let k in NAME_MAP) if(name.includes(k)) dbName = NAME_MAP[k];
                    if(!dbName) for(let k in DB) if(name.includes(k)) dbName = k;

                    if(dbName) {
                        const coords = f.geometry.type==='Polygon'?[f.geometry.coordinates]:f.geometry.coordinates;
                        coords.forEach(poly => {
                            const shape = new THREE.Shape();
                            poly[0].forEach((p, i) => {
                                const [x,y] = projection(p);
                                i===0?shape.moveTo(x,y):shape.lineTo(x,y);
                            });
                            // Holes (性能优化: 忽略小孔洞)
                            if(poly.length > 1 && poly[1].length > 5) {
                                for(let i=1; i<poly.length; i++) {
                                    const hole = new THREE.Path();
                                    poly[i].forEach((p, j) => {
                                        const [x,y] = projection(p);
                                        j===0?hole.moveTo(x,y):hole.lineTo(x,y);
                                    });
                                    shape.holes.push(hole);
                                }
                            }
                            
                            const mesh = createMesh(shape, dbName, 0, 0);
                            mesh.position.set(0,0,0); // Reset pos for geojson
                            newGroup.add(mesh);
                            successCount++;
                        });
                    }
                });

                if(successCount > 10) {
                    console.log("Real map loaded, switching...");
                    scene.remove(wardsGroup);
                    wardsGroup = newGroup;
                    new THREE.Box3().setFromObject(wardsGroup).getCenter(wardsGroup.position).multiplyScalar(-1);
                    scene.add(wardsGroup);
                }
            })
            .catch(e => console.log("Real map load skipped, using abstract map."));
    }

    // 5. 动画与交互
    function animate() {
        requestAnimationFrame(animate);
        // 平滑旋转
        wardsGroup.rotation.y += (targetRotationY - wardsGroup.rotation.y) * 0.1;
        wardsGroup.rotation.x += (targetRotationX - wardsGroup.rotation.x) * 0.1;
        
        // 自动微旋
        if(!isDragging) wardsGroup.rotation.y += 0.001;

        // Raycaster
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(wardsGroup.children);
        
        const tip = document.getElementById('tooltip');
        if(intersects.length > 0) {
            const obj = intersects[0].object;
            tip.style.display = 'block';
            tip.style.left = (event.clientX + 15) + 'px';
            tip.style.top = (event.clientY + 15) + 'px';
            tip.innerHTML = `${obj.userData.name}<br><span style="color:${METRICS[currentMetric].color}">${METRICS[currentMetric].label}: ${obj.userData.data[currentMetric]}</span>`;
            
            // Highlight
            obj.material.emissive.setHex(0x333333);
        } else {
            tip.style.display = 'none';
            wardsGroup.children.forEach(c => c.material.emissive.setHex(0x000000));
        }

        renderer.render(scene, camera);
    }

    function onClick(e) {
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(wardsGroup.children);
        if(intersects.length > 0) openSidebar(intersects[0].object.userData.name);
    }

    function onResize() {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // UI Logic
    function initUI() {
        const c = document.getElementById('btn-container');
        Object.keys(METRICS).forEach(k => {
            const d = document.createElement('div');
            d.className = `mode-btn ${k===currentMetric?'active':''}`;
            d.style.setProperty('--c', METRICS[k].color);
            d.innerHTML = `<span>${METRICS[k].label}</span>`;
            d.onclick = () => switchMetric(k);
            c.appendChild(d);
        });
    }

    function switchMetric(k) {
        currentMetric = k;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(METRICS[k].label)));
        
        wardsGroup.children.forEach(m => {
            const d = m.userData.data;
            const targetH = (d[k] / METRICS[k].max) * 100 + 5;
            const targetC = new THREE.Color(METRICS[k].color);
            m.scale.z = targetH;
            m.material.color.set(targetC);
        });
    }

    function openSidebar(name) {
        const d = DB[name];
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('ward-name').innerText = name;
        document.getElementById('ward-tags').innerHTML = d.tags.map(t=>`<span style="background:#333; padding:2px 8px; border-radius:4px; font-size:10px; border:1px solid #444;">${t}</span>`).join('');
        
        document.getElementById('ward-stats').innerHTML = `
            <div class="data-box"><div class="lbl">LAND GROWTH</div><div class="val" style="color:${METRICS.growth.color}">${d.growth}</div></div>
            <div class="data-box"><div class="lbl">RENTAL YIELD</div><div class="val" style="color:${METRICS.yield.color}">${d.yield}%</div></div>
            <div class="data-box"><div class="lbl">AIRBNB</div><div class="val" style="color:${METRICS.airbnb.color}">${d.airbnb}</div></div>
            <div class="data-box"><div class="lbl">FUTURE</div><div class="val" style="color:${METRICS.future.color}">${d.future}</div></div>
        `;
        document.getElementById('ward-desc').innerText = d.desc;
        document.getElementById('ward-rec').innerText = d.rec;
        document.getElementById('ward-risk').innerText = d.risk;
        updateChart(name, d);
    }

    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

    function updateChart(name, d) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['GROWTH', 'YIELD', 'AIRBNB', 'FUTURE'],
                datasets: [{
                    label: name,
                    data: [d.growth, d.yield*1.5, d.airbnb, d.future],
                    backgroundColor: 'rgba(0,243,255,0.1)',
                    borderColor: '#00f3ff',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    r: {
                        angleLines: { color: '#333' },
                        grid: { color: '#222' },
                        pointLabels: { color: '#888', font: {size: 10} },
                        ticks: { display: false, max: 10, min: 0 }
                    }
                },
                maintainAspectRatio: false
            }
        });
    }
</script>
</body>
</html>
