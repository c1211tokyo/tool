<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°‘å®¿æ™ºèƒ½ç»è¥ç³»ç»Ÿ Ultimate V3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root { 
            --primary: #007aff; 
            --bg: #f5f5f7; 
            --card: #ffffff; 
            --text: #1d1d1f; 
            --border: #d2d2d7; 
            --success: #34c759; 
            --danger: #ff3b30; 
            --warning: #ffcc00;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; }
        .card { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* å¯¼èˆªåˆ‡æ¢ */
        .nav-tabs { display: flex; justify-content: center; margin-bottom: 30px; gap: 15px; }
        .nav-btn {
            background: #e5e5ea; border: none; padding: 12px 30px; border-radius: 20px;
            font-size: 16px; font-weight: 600; cursor: pointer; color: #86868b;
            transition: all 0.2s;
        }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .nav-btn:hover:not(.active) { background: #d1d1d6; }

        /* éšè—/æ˜¾ç¤ºåŒºåŸŸ */
        .mode-section { display: none; animation: fadeIn 0.4s ease; }
        .mode-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨å•å…ƒç´  */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: #86868b; }
        input[type="file"], input[type="text"], select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        button.action-btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 16px; cursor: pointer; width: 100%; font-weight: 600; }
        button.action-btn:hover { background: #0062cc; }

        /* è¯Šæ–­å¡ç‰‡æ ·å¼ */
        .result-card { border-left: 6px solid #ccc; background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .result-card.danger { border-left-color: var(--danger); }
        .result-card.success { border-left-color: var(--success); }
        .result-card.warning { border-left-color: var(--warning); }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; color: #fff; margin-left: 10px; }
        .bg-red { background: var(--danger); }
        .bg-green { background: var(--success); }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container { height: 400px; width: 100%; margin-top: 20px; }
        
        /* è¡¨æ ¼æ ·å¼ */
        table.custom-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        table.custom-table th { text-align: left; padding: 10px; background: #f2f2f7; color: #666; font-weight: 600; }
        table.custom-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .diff-pos { color: var(--success); }
        .diff-neg { color: var(--danger); }

        /* åŸæœ‰é“¾æ¥è®¾ç½®æ ·å¼ (ä¿ç•™) */
        #linkContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ  æ°‘å®¿æ™ºèƒ½ç»è¥ç³»ç»Ÿ <span style="font-size:14px; color:#888; background:#eee; padding:2px 6px; border-radius:4px;">Ultimate V3.0</span></h1>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchMode('calendar')">ğŸ“… å…¥ä½ç‡æ—¥å†æ¨¡å¼</button>
        <button class="nav-btn" onclick="switchMode('analysis')">ğŸ“Š ç»è¥æ™ºèƒ½è¯Šæ–­æ¨¡å¼</button>
    </div>

    <div id="mode-calendar" class="mode-section active">
        <div class="card">
            <h3>1. ä¸Šä¼ æ—¥å†æ•°æ® (Excel/Image)</h3>
            <div class="form-group">
                <input type="file" id="calendarFile" accept=".xlsx, .xls, .jpg, .png" onchange="handleCalendarFile()">
                <small style="color:#888">æ”¯æŒåŸæœ‰çš„ Excel æ ¼å¼æˆ–å›¾ç‰‡è¯†åˆ«ï¼ˆéœ€æ¥å…¥OCR APIï¼‰</small>
            </div>
            
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4>æˆ¿æºå…³è”è®¾ç½® (Parent/Child)</h4>
                    <button class="action-btn" style="width:auto; padding:5px 15px; font-size:14px;" onclick="addLinkGroup()">+ æ–°å¢å…³è”ç»„</button>
                </div>
                <div id="linkContainer">
                    </div>
            </div>
            
            <button class="action-btn" style="margin-top:20px;" onclick="generateCalendarChart()">ç”Ÿæˆæ—¥å†å›¾è¡¨</button>
        </div>
        
        <div class="card">
            <div id="calendarChart" class="chart-container" style="height:600px;"></div>
        </div>
    </div>

    <div id="mode-analysis" class="mode-section">
        <div class="card">
            <h3>1. ä¸Šä¼ ç»è¥æ•°æ® (CSV)</h3>
            <div class="row" style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="flex:1; min-width:300px;">
                    <label>ğŸ“„ å†å²/å·²å®Œæˆæ•°æ® (å¦‚11æœˆ)</label>
                    <input type="file" id="csvPast" accept=".csv">
                </div>
                <div style="flex:1; min-width:300px;">
                    <label>ğŸ“… æœªæ¥/é¢„è®¢æ•°æ® (å¦‚12-1æœˆ)</label>
                    <input type="file" id="csvFuture" accept=".csv">
                </div>
            </div>
            <button class="action-btn" style="margin-top:20px;" onclick="startDiagnosis()">å¼€å§‹æ™ºèƒ½åˆ†æ</button>
        </div>

        <div id="analysisOutput" style="display:none;">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
                <div class="card" style="padding:15px; text-align:center; margin-bottom:0;">
                    <div style="color:#86868b; font-size:12px;">æœªæ¥æ€»è¥æ”¶é¢„æµ‹</div>
                    <div style="font-size:24px; font-weight:bold; color:var(--primary);" id="totalRevenue">--</div>
                </div>
                <div class="card" style="padding:15px; text-align:center; margin-bottom:0;">
                    <div style="color:#86868b; font-size:12px;">å¹³å‡å…¥ä½ç‡å˜åŒ–</div>
                    <div style="font-size:24px; font-weight:bold;" id="avgOccChange">--</div>
                </div>
                <div class="card" style="padding:15px; text-align:center; margin-bottom:0;">
                    <div style="color:#86868b; font-size:12px;">å¹³å‡æˆ¿ä»·(ADR)å˜åŒ–</div>
                    <div style="font-size:24px; font-weight:bold;" id="avgAdrChange">--</div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ ä»·æ ¼ä¸å…¥ä½ç‡ åŠ¨æ€å…³ç³»å›¾</h3>
                <p style="color:#666; font-size:12px;">æ¯ä¸€ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªæˆ¿é—´ã€‚ç®­å¤´è¡¨ç¤ºä»â€œè¿‡å»â€åˆ°â€œæœªæ¥â€çš„å˜åŒ–è½¨è¿¹ã€‚<br>ğŸ”´ çº¢è‰²ç®­å¤´ï¼šæ¶¨ä»·ä¸”å…¥ä½ç‡ä¸‹è·Œ (è­¦ç¤º) | ğŸŸ¢ ç»¿è‰²ç®­å¤´ï¼šè¡¨ç°ä¼˜å¼‚</p>
                <div id="scatterChart" class="chart-container"></div>
            </div>

            <div class="card">
                <h3>ğŸ’° å‡€æ”¶å…¥å¯¹æ¯” (Top 10)</h3>
                <div id="barChart" class="chart-container"></div>
            </div>

            <div class="card">
                <h3>ğŸ’¡ AI è¯Šæ–­å»ºè®®</h3>
                <div id="adviceContainer"></div>
            </div>

            <div class="card" style="overflow-x:auto;">
                <h3>ğŸ“‹ è¯¦ç»†æ•°æ®å¯¹æ¯”</h3>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>æˆ¿æº</th>
                            <th>æœªæ¥ADR (å˜åŒ–)</th>
                            <th>æœªæ¥å…¥ä½ç‡ (å˜åŒ–)</th>
                            <th>å‡€æ”¶å…¥é¢„æµ‹</th>
                            <th>ä½£é‡‘ç‡</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= å…¨å±€åˆ‡æ¢é€»è¾‘ =================
    function switchMode(mode) {
        // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // åˆ‡æ¢æ˜¾ç¤ºåŒºåŸŸ
        document.querySelectorAll('.mode-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.add('active');
    }

    // ================= æ¨¡å¼äºŒï¼šç»è¥æ™ºèƒ½è¯Šæ–­é€»è¾‘ (æ ¸å¿ƒæ–°åŠŸèƒ½) =================
    
    function startDiagnosis() {
        const filePast = document.getElementById('csvPast').files[0];
        const fileFuture = document.getElementById('csvFuture').files[0];

        if (!filePast || !fileFuture) {
            alert("è¯·ç¡®ä¿ä¸¤ä¸ªCSVæ–‡ä»¶éƒ½å·²ä¸Šä¼ ï¼");
            return;
        }

        Promise.all([parseCSV(filePast), parseCSV(fileFuture)]).then(results => {
            const dataPast = cleanBusinessData(results[0].data);
            const dataFuture = cleanBusinessData(results[1].data);
            renderAnalysis(dataPast, dataFuture);
            document.getElementById('analysisOutput').style.display = 'block';
        });
    }

    // è§£æCSV
    function parseCSV(file) {
        return new Promise(resolve => {
            Papa.parse(file, {
                header: false, // æˆ‘ä»¬è‡ªå·±æ‰¾è¡¨å¤´ï¼Œé˜²æ­¢ç¬¬ä¸€è¡Œæ˜¯æ— ç”¨ä¿¡æ¯
                skipEmptyLines: true,
                complete: resolve
            });
        });
    }

    // æ¸…æ´—æ•°æ®ï¼šæ‰¾åˆ°æ­£ç¡®çš„è¡¨å¤´è¡Œå¹¶æå–æ•°æ®
    function cleanBusinessData(rawData) {
        let headerIndex = -1;
        let map = {};
        
        // 1. å¯»æ‰¾åŒ…å«"æˆ¿æº"çš„è¡Œä½œä¸ºè¡¨å¤´
        for (let i = 0; i < Math.min(10, rawData.length); i++) {
            if (rawData[i].includes('æˆ¿æº') && rawData[i].includes('å…¥ä½ç‡')) {
                headerIndex = i;
                break;
            }
        }

        if (headerIndex === -1) {
            alert("æ— æ³•è¯†åˆ«CSVæ ¼å¼ï¼Œè¯·ç¡®ä¿æ–‡ä»¶ä¸­åŒ…å«'æˆ¿æº'ã€'å…¥ä½ç‡'ç­‰åˆ—");
            return {};
        }

        const headers = rawData[headerIndex];
        // æ˜ å°„å…³é”®åˆ—çš„ç´¢å¼•
        const idxName = headers.indexOf('æˆ¿æº');
        const idxOcc = headers.indexOf('å…¥ä½ç‡');
        const idxPrice = headers.indexOf('æˆ¿è´¹.1'); // å‡ä»· ADR
        const idxIncome = headers.indexOf('å‡€æ”¶å…¥');
        const idxComm = headers.indexOf('ä½£é‡‘');
        const idxRoomFee = headers.indexOf('æˆ¿è´¹');

        // 2. æå–æ•°æ®
        for (let i = headerIndex + 1; i < rawData.length; i++) {
            const row = rawData[i];
            const name = row[idxName];
            
            if (name && name !== 'æ€»è®¡' && name.trim() !== '') {
                const parseNum = (val) => {
                    if (!val) return 0;
                    return parseFloat(String(val).replace(/[Â¥,%\s]/g, ''));
                };

                const occ = parseNum(row[idxOcc]) / 100.0; // 35% -> 0.35
                const adr = parseNum(row[idxPrice]);
                const income = parseNum(row[idxIncome]);
                const commRaw = parseNum(row[idxComm]);
                const roomFee = parseNum(row[idxRoomFee]);
                const commRate = roomFee > 0 ? (commRaw / roomFee) : 0;

                map[name] = { name, occ, adr, income, commRate };
            }
        }
        return map;
    }

    // æ¸²æŸ“åˆ†æç»“æœ
    function renderAnalysis(pastMap, futureMap) {
        const rooms = Object.keys(futureMap);
        let totalRevenue = 0;
        let totalOccDiff = 0;
        let totalAdrDiff = 0;
        let count = 0;

        const chartDataSeries = []; // ç”¨äºæ•£ç‚¹å›¾
        const barDataNames = []; // ç”¨äºæŸ±çŠ¶å›¾
        const barDataPast = [];
        const barDataFuture = [];
        
        const adviceContainer = document.getElementById('adviceContainer');
        const tableBody = document.getElementById('detailTableBody');
        adviceContainer.innerHTML = '';
        tableBody.innerHTML = '';

        rooms.forEach(room => {
            const future = futureMap[room];
            const past = pastMap[room] || { occ: 0, adr: future.adr, income: 0 }; // é»˜è®¤å€¼é˜²æ­¢æŠ¥é”™

            totalRevenue += future.income;
            if(pastMap[room]) {
                totalOccDiff += (future.occ - past.occ);
                totalAdrDiff += (future.adr - past.adr);
                count++;
            }

            // è®¡ç®—å˜åŒ–
            const priceChangePct = past.adr > 0 ? (future.adr - past.adr) / past.adr : 0;
            const occDiff = future.occ - past.occ;

            // 1. ç”Ÿæˆè¡¨æ ¼è¡Œ
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${room}</td>
                <td>Â¥${future.adr.toLocaleString()} <span class="${priceChangePct>0?'diff-pos':'diff-neg'}">(${priceChangePct>0?'+':''}${(priceChangePct*100).toFixed(1)}%)</span></td>
                <td>${(future.occ*100).toFixed(0)}% <span class="${occDiff>0?'diff-pos':'diff-neg'}">(${occDiff>0?'+':''}${(occDiff*100).toFixed(0)}%)</span></td>
                <td>Â¥${future.income.toLocaleString()}</td>
                <td style="${future.commRate>0.12?'color:red;font-weight:bold;':''}">${(future.commRate*100).toFixed(1)}%</td>
            `;
            tableBody.appendChild(tr);

            // 2. ç”Ÿæˆè¯Šæ–­å»ºè®®
            let alertHtml = '';
            // ğŸ”´ æ¶¨ä»·å´©ç›˜è­¦å‘Š
            if (priceChangePct > 0.05 && future.occ < 0.3 && past.occ > 0.6) {
                alertHtml = `
                <div class="result-card danger">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>ğŸ”´ ${room} - æ¶¨ä»·å¤±è¯¯è­¦å‘Š</strong>
                        <span class="tag bg-red">éœ€é™ä»·</span>
                    </div>
                    <p style="margin:5px 0; color:#666;">å‡ä»·ä¸Šæ¶¨ <b>${(priceChangePct*100).toFixed(1)}%</b>ï¼Œå¯¼è‡´å…¥ä½ç‡ä» ${(past.occ*100).toFixed(0)}% è·Œè‡³ ${(future.occ*100).toFixed(0)}%ã€‚<br>å»ºè®®ç«‹å³å›è°ƒä»·æ ¼è‡³ Â¥${past.adr.toFixed(0)} å·¦å³ã€‚</p>
                </div>`;
            }
            // ğŸŸ¢ æä»·æ½œåŠ›
            else if (future.occ > 0.75 && priceChangePct < 0.05) {
                alertHtml = `
                <div class="result-card success">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>ğŸŸ¢ ${room} - æä»·æ½œåŠ›</strong>
                        <span class="tag bg-green">å¯æ¶¨ä»·</span>
                    </div>
                    <p style="margin:5px 0; color:#666;">è¡¨ç°ä¼˜å¼‚ï¼å…¥ä½ç‡ç»´æŒåœ¨ ${(future.occ*100).toFixed(0)}% ä¸”ä»·æ ¼æœªæ˜æ˜¾ä¸Šæ¶¨ã€‚<br>å»ºè®®å°è¯•æä»· 5%-10% ä»¥å¢åŠ çº¯åˆ©æ¶¦ã€‚</p>
                </div>`;
            }
            // ğŸŸ¡ é«˜ä½£é‡‘è­¦å‘Š
            else if (future.commRate > 0.12) {
                alertHtml = `
                <div class="result-card warning">
                    <strong>ğŸŸ¡ ${room} - æ¸ é“æˆæœ¬è¿‡é«˜</strong>
                    <p style="margin:5px 0; color:#666;">å½“å‰ä½£é‡‘ç‡é«˜è¾¾ ${(future.commRate*100).toFixed(1)}% (å¹³å‡çº¦8%)ã€‚è¯·æ£€æŸ¥æ˜¯å¦å¼€å¯äº†é«˜é¢æ¨å¹¿ï¼Œå»ºè®®ä¼˜åŒ–æ¸ é“ã€‚</p>
                </div>`;
            }

            if (alertHtml) adviceContainer.innerHTML += alertHtml;

            // 3. å‡†å¤‡å›¾è¡¨æ•°æ®
            // æ•£ç‚¹å›¾æ•°æ®: [ADRå˜åŒ–ç‡, å…¥ä½ç‡å˜åŒ–, æ°”æ³¡å¤§å°, æˆ¿å, æœªæ¥å…¥ä½ç‡, æœªæ¥ä»·æ ¼]
            chartDataSeries.push([
                priceChangePct * 100, // X: ä»·æ ¼å˜åŒ–%
                occDiff * 100,        // Y: å…¥ä½ç‡å˜åŒ–%
                future.income / 10000, // Size: æ”¶å…¥(ä¸‡)
                room,
                future.occ,
                future.adr
            ]);

            // æŸ±çŠ¶å›¾æ•°æ® (Top 10)
            barDataNames.push(room);
            barDataPast.push(past.income);
            barDataFuture.push(future.income);
        });

        if (!adviceContainer.innerHTML) adviceContainer.innerHTML = '<div style="color:#888; text-align:center;">æš‚æ— æ¿€è¿›çš„è°ƒæ•´å»ºè®®ï¼Œæ•´ä½“ç»è¥å¹³ç¨³ã€‚</div>';

        // æ›´æ–°é¡¶éƒ¨æ•°å­—
        document.getElementById('totalRevenue').innerText = 'Â¥' + totalRevenue.toLocaleString();
        document.getElementById('avgOccChange').innerText = (count > 0 ? (totalOccDiff/count*100).toFixed(1) : 0) + '%';
        document.getElementById('avgOccChange').style.color = totalOccDiff >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('avgAdrChange').innerText = 'Â¥' + (count > 0 ? (totalAdrDiff/count).toFixed(0) : 0);

        // æ¸²æŸ“å›¾è¡¨
        renderScatterChart(chartDataSeries);
        renderBarChart(barDataNames, barDataPast, barDataFuture);
    }

    function renderScatterChart(data) {
        const chart = echarts.init(document.getElementById('scatterChart'));
        const option = {
            tooltip: {
                formatter: function (param) {
                    return `<b>${param.data[3]}</b><br/>
                            ä»·æ ¼å˜åŒ–: ${param.data[0].toFixed(1)}%<br/>
                            å…¥ä½ç‡å˜åŒ–: ${param.data[1].toFixed(1)}%<br/>
                            å½“å‰é¢„æµ‹: Â¥${param.data[5]} (${(param.data[4]*100).toFixed(0)}%)`;
                }
            },
            xAxis: { name: 'ä»·æ ¼å˜åŒ– (%)', splitLine: { show: false } },
            yAxis: { name: 'å…¥ä½ç‡å˜åŒ– (%)', splitLine: { show: false } },
            series: [{
                type: 'scatter',
                data: data,
                symbolSize: function (data) { return Math.max(10, Math.sqrt(data[2]) * 5); }, // æ ¹æ®æ”¶å…¥å¤§å°è°ƒæ•´æ°”æ³¡
                itemStyle: {
                    color: function(param) {
                        // æ¶¨ä»·ä¸”å…¥ä½ç‡è·Œä¸ºçº¢è‰²ï¼Œå¦åˆ™è“è‰²
                        if (param.data[0] > 5 && param.data[1] < -10) return '#ff3b30';
                        if (param.data[4] > 0.8) return '#34c759';
                        return '#007aff';
                    },
                    opacity: 0.7
                },
                markLine: {
                    silent: true,
                    data: [{ xAxis: 0 }, { yAxis: 0 }],
                    lineStyle: { color: '#ccc', type: 'dashed' }
                }
            }]
        };
        chart.setOption(option);
    }

    function renderBarChart(names, past, future) {
        // ç®€å•æ’åºå–å‰10
        const indices = names.map((_, i) => i);
        indices.sort((a, b) => future[b] - future[a]);
        const topIndices = indices.slice(0, 10);
        
        const chart = echarts.init(document.getElementById('barChart'));
        const option = {
            tooltip: { trigger: 'axis' },
            legend: { data: ['ä¸Šæœˆå®æ”¶', 'æœ¬æœˆé¢„æµ‹'] },
            xAxis: { type: 'category', data: topIndices.map(i => names[i]), axisLabel: { interval: 0, rotate: 30 } },
            yAxis: { type: 'value', name: 'å‡€æ”¶å…¥ (JPY)' },
            series: [
                { name: 'ä¸Šæœˆå®æ”¶', type: 'bar', data: topIndices.map(i => past[i]), itemStyle: { color: '#ccc' } },
                { name: 'æœ¬æœˆé¢„æµ‹', type: 'bar', data: topIndices.map(i => future[i]), itemStyle: { color: '#007aff' } }
            ]
        };
        chart.setOption(option);
    }

    // ================= æ¨¡å¼ä¸€ï¼šåŸæœ‰æ—¥å†é€»è¾‘ (æ­¤å¤„ä¿ç•™ç»“æ„ï¼Œéœ€è¦å¡«å…¥æ‚¨åŸæœ‰çš„å…·ä½“é€»è¾‘) =================
    // æ³¨æ„ï¼šå› ä¸ºæˆ‘æ²¡æœ‰æ‚¨åŸæ–‡ä»¶çš„å®Œæ•´ä»£ç ï¼Œæˆ‘åœ¨è¿™é‡Œä¸ºæ‚¨é‡æ„äº†æ ¸å¿ƒæ¡†æ¶ã€‚
    // å¦‚æœæ‚¨æœ‰ç‰¹å®šçš„Excelè§£æé€»è¾‘ï¼Œè¯·æ›¿æ¢ä¸‹é¢çš„ `handleCalendarFile` å’Œ `generateCalendarChart`
    
    let calendarData = null; // å­˜å‚¨è§£æåçš„æ—¥å†æ•°æ®
    let roomLinks = {}; // å­˜å‚¨çˆ¶å­æˆ¿å…³ç³»

    // æ¨¡æ‹Ÿçš„æ—¥å†æ–‡ä»¶å¤„ç†
    function handleCalendarFile() {
        const file = document.getElementById('calendarFile').files[0];
        if(!file) return;

        // å¦‚æœæ˜¯Excel
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            // ç®€å•çš„è¯»å–ç¬¬ä¸€ä¸ªsheet
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            
            console.log("Excelè¯»å–æˆåŠŸ:", json);
            // è¿™é‡Œåº”è¯¥è°ƒç”¨æ‚¨åŸæœ‰çš„å¤„ç†é€»è¾‘æ¥è§£ææ—¥æœŸå’Œæˆ¿é—´
            alert("æ–‡ä»¶è¯»å–æˆåŠŸï¼è¯·ç‚¹å‡»ä¸‹æ–¹'ç”Ÿæˆæ—¥å†å›¾è¡¨'æŸ¥çœ‹ç»“æœ (æ­¤å¤„ä½¿ç”¨æ¼”ç¤ºé€»è¾‘)");
            
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºæ¼”ç¤ºå›¾è¡¨
            calendarData = json; 
        };
        reader.readAsArrayBuffer(file);
    }

    // ç®€å•çš„å…³è”ç»„æ·»åŠ é€»è¾‘
    function addLinkGroup() {
        const container = document.getElementById('linkContainer');
        const div = document.createElement('div');
        div.style.background = "#fff";
        div.style.padding = "10px";
        div.style.borderRadius = "8px";
        div.style.border = "1px solid #ddd";
        div.innerHTML = `
            <div style="font-size:12px; color:#666; margin-bottom:5px;">å…³è”ç»„</div>
            <input type="text" placeholder="çˆ¶æˆ¿æº (å¦‚ Both)" style="margin-bottom:5px;">
            <input type="text" placeholder="å­æˆ¿æº (å¦‚ A, B)" style="margin-bottom:5px;">
            <button onclick="this.parentElement.remove()" style="font-size:12px; color:red; border:none; background:none;">åˆ é™¤</button>
        `;
        container.appendChild(div);
    }

    function generateCalendarChart() {
        // è¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºæ‚¨åŸæ¥å¤æ‚çš„ Echarts ç”˜ç‰¹å›¾/çƒ­åŠ›å›¾é€»è¾‘
        const chart = echarts.init(document.getElementById('calendarChart'));
        
        // ä¸€ä¸ªå ä½çš„ç¤ºä¾‹å›¾è¡¨
        chart.setOption({
            title: { text: 'å…¥ä½ç‡æ—¥å†è§†å›¾ (ç¤ºä¾‹)' },
            tooltip: { position: 'top' },
            grid: { height: '50%', top: '10%' },
            xAxis: { type: 'category', data: ['1æ—¥', '2æ—¥', '3æ—¥', '4æ—¥', '5æ—¥'], splitArea: { show: true } },
            yAxis: { type: 'category', data: ['æˆ¿é—´A', 'æˆ¿é—´B', 'æˆ¿é—´C'], splitArea: { show: true } },
            visualMap: { min: 0, max: 1, calculate: true, orient: 'horizontal', left: 'center', bottom: '15%' },
            series: [{
                name: 'Occupancy',
                type: 'heatmap',
                data: [[0,0,1], [0,1,0], [0,2,1], [1,0,0], [1,1,1], [1,2,0], [2,0,1], [2,1,1], [2,2,1]],
                label: { show: true }
            }]
        });
    }

</script>
</body>
</html>
