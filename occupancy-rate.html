<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½å…¥ä½ç‡åˆ†æ Pro | è˜‡çš„å·¥å…·ç®±</title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
    :root { 
        --primary: #007aff; 
        --success: #34c759;
        --bg: #f5f5f7; 
        --card-bg: #ffffff; 
        --text: #1d1d1f;
        --border: #d2d2d7;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; -webkit-font-smoothing: antialiased; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* å¤´éƒ¨ */
    header { text-align: center; margin-bottom: 30px; }
    h1 { margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
    .badge { font-size: 12px; background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; vertical-align: middle; margin-left: 8px; font-weight: 500;}

    /* å¡ç‰‡é€šç”¨æ ·å¼ */
    .card { background: var(--card-bg); border-radius: 18px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 25px; transition: transform 0.2s; }
    
    /* æ§åˆ¶æ  */
    .controls { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
    .control-item { display: flex; flex-direction: column; gap: 6px; }
    .control-item label { font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; }
    input[type="number"], input[type="date"], input[type="file"] { 
        padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: #fff; outline: none; transition: 0.2s;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }

    /* æŒ‰é’®ç»„ */
    .btn-group { display: flex; gap: 10px; margin-left: auto; }
    .btn { 
        background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; 
        font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { background: #0062cc; transform: translateY(-1px); }
    .btn-secondary { background: #e5e5ea; color: #1d1d1f; }
    .btn-secondary:hover { background: #d1d1d6; }
    .btn-success { background: var(--success); }
    .btn-success:hover { background: #2db14e; }
    .btn-danger { background: #ff3b30; padding: 4px 10px; font-size: 12px; border-radius: 6px; }

    /* Canvas ç¼–è¾‘åŒº */
    .editor-area { position: relative; background: #2c2c2e; border-radius: 12px; padding: 20px; height: 60vh; display: flex; justify-content: center; overflow: hidden; }
    canvas { box-shadow: 0 8px 30px rgba(0,0,0,0.3); max-width: 100%; max-height: 100%; object-fit: contain; }
    
    /* ç»“æœå±•ç¤ºåŒº */
    .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
    .stat-box { background: #f5f7fa; padding: 15px; border-radius: 12px; text-align: center; }
    .stat-label { font-size: 12px; color: #86868b; margin-bottom: 5px; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--text); }

    /* è¡¨æ ¼ */
    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e5e5e5; max-height: 600px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
    th { background: #f2f2f7; padding: 12px 8px; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #d2d2d7; }
    td { padding: 8px; border: 1px solid #e5e5e5; text-align: center; transition: background 0.1s; }
    td.date-col { background: #fff; position: sticky; left: 0; z-index: 5; font-weight: 600; border-right: 2px solid #e5e5e5; }
    
    /* çŠ¶æ€é¢œè‰² */
    .occupied { background-color: rgba(52, 199, 89, 0.3) !important; color: #004d1a; }
    .cell-clickable:hover { background-color: rgba(0,0,0,0.05); cursor: pointer; }

    /* æˆ¿åè¾“å…¥æ¡† */
    .th-name-input { 
        border: none; background: transparent; font-weight: 700; width: 80px; text-align: center; font-size: 13px; color: #1d1d1f;
        border-bottom: 1px dashed #999; 
    }
    .th-name-input:focus { outline: none; border-bottom: 2px solid var(--primary); color: var(--primary); }

    /* å…³è”è®¾ç½®æ¨¡æ€æ¡† */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal { background: #fff; width: 500px; max-width: 90%; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    .modal h3 { margin-top: 0; }
    .link-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
    
    /* æç¤ºæ¡ */
    .tip { background: #fffbe6; border: 1px solid #ffe58f; padding: 10px 15px; border-radius: 8px; color: #8a6d3b; font-size: 13px; display: flex; align-items: center; gap: 8px; margin-top: 15px;}
</style>
</head>
<body>

<div class="container">
    <header>
        <h1>æ™ºèƒ½å…¥ä½ç‡åˆ†æç³»ç»Ÿ <span class="badge">Pro v2.0</span></h1>
        <p style="color:#86868b; font-size:14px; margin-top:5px;">æ”¯æŒè‡ªç”±åˆ—å®½ Â· ç»„åˆæˆ¿å‹é€»è¾‘ Â· åŒå›¾è¡¨åˆ†æ Â· PNGå¯¼å‡º</p>
    </header>

    <div class="card">
        <div class="controls">
            <div class="control-item">
                <label>1. ä¸Šä¼ æ’æœŸæˆªå›¾</label>
                <input type="file" id="imgInput" accept="image/*">
            </div>
            <div class="control-item">
                <label>2. æˆ¿é—´æ•°é‡ (åˆ—)</label>
                <input type="number" id="colCount" value="10" min="1" style="width: 80px;" onchange="resetDividers()">
            </div>
            <div class="control-item">
                <label>3. ç»Ÿè®¡å¤©æ•° (è¡Œ)</label>
                <input type="number" id="rowCount" value="30" min="1" style="width: 80px;">
            </div>
            <div class="control-item">
                <label>4. èµ·å§‹æ—¥æœŸ</label>
                <input type="date" id="startDate">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="resetDividers()">ğŸ”„ é‡ç½®ç½‘æ ¼</button>
                <button class="btn" onclick="runAnalysis()">âš¡ å¼€å§‹åˆ†æ</button>
            </div>
        </div>
        
        <div class="tip">
            <span>ğŸ’¡ <strong>æ“ä½œæç¤ºï¼š</strong> çº¢æ¡†é¡¶éƒ¨çš„ âšªï¸ å°ç™½ç‚¹å¯ä»¥å·¦å³æ‹–åŠ¨ï¼Œè¯·å¯¹é½æ¯ä¸€åˆ—çš„è¾¹ç•Œã€‚ä¸­é—´è‹¥æœ‰ç©ºç™½é—´éš”ï¼Œè¯·å°†çº¿å¯¹é½åˆ°æœ‰æ•ˆåŒºåŸŸã€‚</span>
        </div>

        <div class="editor-area" style="margin-top: 20px;">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>

    <div class="card" id="resultCard" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; font-size:20px;">ğŸ“Š åˆ†æç»“æœ</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="openLinkModal()">ğŸ”— ç»„åˆæˆ¿é…ç½® (å¦‚B+C)</button>
                <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ å¯¼å‡º Excel</button>
                <button class="btn btn-success" style="background:#5856d6;" onclick="exportImage()">ğŸ–¼ å¯¼å‡ºå›¾ç‰‡</button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-label">æ€»å¯å”®æˆ¿æ™š (åŠ¨æ€)</div>
                <div class="stat-value" id="valTotalSlots">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">å®é™…å…¥ä½æˆ¿æ™š</div>
                <div class="stat-value" id="valOccupied" style="color:var(--success)">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ç»¼åˆå…¥ä½ç‡</div>
                <div class="stat-value" id="valRate" style="color:var(--primary)">-</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:30px;">
            <div style="background:#fff; border:1px solid #e5e5e5; border-radius:12px; padding:15px;">
                <h4 style="margin:0 0 10px 0; text-align:center;">å„æˆ¿é—´å…¥ä½ç‡æ’å</h4>
                <div id="chartBar" style="width:100%; height:350px;"></div>
            </div>
            <div style="background:#fff; border:1px solid #e5e5e5; border-radius:12px; padding:15px;">
                <h4 style="margin:0 0 10px 0; text-align:center;">æ¯æ—¥æ€»å…¥ä½è¶‹åŠ¿</h4>
                <div id="chartLine" style="width:100%; height:350px;"></div>
            </div>
        </div>

        <div class="table-container">
            <table id="dataTable"></table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="linkModal">
    <div class="modal">
        <h3>ğŸ”— ç»„åˆæˆ¿å‹é…ç½®</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px;">
            å½“â€œä¸»æˆ¿æºâ€(å¦‚ B+C) <strong>æœ‰å…¥ä½</strong>æ—¶ï¼Œå°†è‡ªåŠ¨å¿½ç•¥å…¶â€œå­æˆ¿æºâ€(B, C) çš„ç»Ÿè®¡ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚<br>
            å½“â€œä¸»æˆ¿æºâ€<strong>ç©ºé—²</strong>æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—â€œå­æˆ¿æºâ€çš„å…¥ä½æƒ…å†µã€‚
        </p>
        <div id="linkConfigList" style="max-height: 300px; overflow-y: auto;">
            </div>
        <div style="margin-top:20px; text-align:right; display:flex; justify-content:space-between;">
             <button class="btn btn-secondary" onclick="addLinkGroup()">+ æ·»åŠ ä¸€ç»„</button>
             <div>
                 <button class="btn btn-secondary" onclick="document.getElementById('linkModal').style.display='none'">å–æ¶ˆ</button>
                 <button class="btn" onclick="saveLinkConfig()">ä¿å­˜å¹¶é‡ç®—</button>
             </div>
        </div>
    </div>
</div>

<script>
/**
 * æ ¸å¿ƒé€»è¾‘å˜é‡
 */
let img = new Image();
let canvas = document.getElementById('mainCanvas');
let ctx = canvas.getContext('2d');

// ç»˜å›¾ç›¸å…³
let grid = { x: 50, y: 50, w: 0, h: 0 };
let colDividers = []; // 0.0 ~ 1.0 ä¹‹é—´çš„æ¯”ä¾‹
let isDragging = false;
let dragTarget = null; // { type: 'box'|'divider', index: 0, handle: 'tl' }

// æ•°æ®ç›¸å…³
let rawData = []; // [row][col] -> 0 or 1
let roomNames = []; 
let dateList = [];
let validCols = []; // å½“å‰æ˜¾ç¤ºçš„åˆ—ç´¢å¼•åˆ—è¡¨
let linkConfig = []; // [{ parent: colIdx, children: [colIdx, colIdx] }]

// åˆå§‹åŒ–
document.getElementById('startDate').valueAsDate = new Date();

// --- 1. å›¾ç‰‡åŠ è½½ä¸äº¤äº’ ---

document.getElementById('imgInput').addEventListener('change', function(e) {
    if(!e.target.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        img.onload = function() { 
            initCanvas(); 
            resetDividers();
        }
        img.src = evt.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
});

function initCanvas() {
    const maxWidth = 1600;
    const scale = Math.min(1, maxWidth / img.width);
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    
    // åˆå§‹åŒ–é€‰åŒº (ç•™å‡ºä¸Šæ–¹ä½œä¸º buffer)
    grid.x = canvas.width * 0.05;
    grid.y = canvas.height * 0.15; 
    grid.w = canvas.width * 0.9;
    grid.h = canvas.height * 0.8;
    
    draw();
}

function resetDividers() {
    const cols = parseInt(document.getElementById('colCount').value) || 1;
    colDividers = [];
    for(let i=1; i<cols; i++) {
        colDividers.push(i / cols);
    }
    draw();
}

// ç»˜å›¾å¾ªç¯
function draw() {
    if (!ctx) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // ç”»å›¾
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // è’™ç‰ˆ
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,canvas.width, grid.y);
    ctx.fillRect(0,grid.y+grid.h,canvas.width, canvas.height-(grid.y+grid.h));
    ctx.fillRect(0,grid.y,grid.x,grid.h);
    ctx.fillRect(grid.x+grid.w, grid.y, canvas.width-(grid.x+grid.w), grid.h);

    // å¤–æ¡†
    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 2;
    ctx.strokeRect(grid.x, grid.y, grid.w, grid.h);

    // è¡Œçº¿ (è§†è§‰å‚è€ƒ)
    const rows = parseInt(document.getElementById('rowCount').value) || 1;
    const cellH = grid.h / rows;
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255, 59, 48, 0.2)';
    ctx.lineWidth = 1;
    for(let i=1; i<rows; i++) {
        let y = grid.y + i * cellH;
        ctx.moveTo(grid.x, y);
        ctx.lineTo(grid.x + grid.w, y);
    }
    ctx.stroke();

    // åˆ—çº¿ (åˆ†å‰²çº¿)
    ctx.beginPath();
    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 2;
    colDividers.forEach((ratio) => {
        let x = grid.x + ratio * grid.w;
        ctx.moveTo(x, grid.y);
        ctx.lineTo(x, grid.y + grid.h);
    });
    ctx.stroke();

    // æ‰‹æŸ„ç»˜åˆ¶
    drawHandle(grid.x, grid.y, '#007aff'); // TL
    drawHandle(grid.x+grid.w, grid.y+grid.h, '#007aff'); // BR

    // åˆ—æ‰‹æŸ„
    colDividers.forEach((ratio) => {
        let x = grid.x + ratio * grid.w;
        drawHandle(x, grid.y, '#fff', '#ff3b30');
    });
}

function drawHandle(x, y, color, stroke) {
    ctx.beginPath();
    ctx.arc(x, y, 7, 0, Math.PI*2);
    ctx.fillStyle = color;
    ctx.fill();
    if(stroke) { ctx.strokeStyle = stroke; ctx.stroke(); }
    ctx.shadowBlur = 5; ctx.shadowColor = 'rgba(0,0,0,0.3)';
}

// æ‹–æ‹½é€»è¾‘
const getPos = (e) => {
    const r = canvas.getBoundingClientRect();
    return { x: (e.clientX - r.left)*(canvas.width/r.width), y: (e.clientY - r.top)*(canvas.height/r.height) };
};

canvas.addEventListener('mousedown', e => {
    const {x, y} = getPos(e);
    const R = 15; // åˆ¤å®šåŠå¾„

    // æ£€æŸ¥åˆ—åˆ†å‰²çº¿
    for(let i=0; i<colDividers.length; i++) {
        let lx = grid.x + colDividers[i] * grid.w;
        if(Math.hypot(x-lx, y-grid.y) < R) {
            isDragging = true; dragTarget = {type:'divider', index:i}; return;
        }
    }
    // æ£€æŸ¥å¤–æ¡†
    if(Math.hypot(x-grid.x, y-grid.y) < R) { isDragging = true; dragTarget = {type:'box', handle:'tl'}; return;}
    if(Math.hypot(x-(grid.x+grid.w), y-(grid.y+grid.h)) < R) { isDragging = true; dragTarget = {type:'box', handle:'br'}; return;}
    
    if(x>grid.x && x<grid.x+grid.w && y>grid.y && y<grid.y+grid.h) {
        isDragging = true; dragTarget = {type:'move'}; canvas.lastP = {x,y};
    }
});

canvas.addEventListener('mousemove', e => {
    const {x, y} = getPos(e);
    // é¼ æ ‡æ ·å¼
    let cursor = 'default';
    for(let i=0; i<colDividers.length; i++) {
        if(Math.hypot(x-(grid.x + colDividers[i] * grid.w), y-grid.y) < 15) cursor = 'col-resize';
    }
    canvas.style.cursor = cursor;

    if(!isDragging) return;
    
    if(dragTarget.type === 'divider') {
        let idx = dragTarget.index;
        let newRatio = (x - grid.x) / grid.w;
        // é™åˆ¶èŒƒå›´
        let min = (idx===0) ? 0 : colDividers[idx-1];
        let max = (idx===colDividers.length-1) ? 1 : colDividers[idx+1];
        if(newRatio > min + 0.01 && newRatio < max - 0.01) colDividers[idx] = newRatio;
    } else if(dragTarget.type === 'box') {
        if(dragTarget.handle === 'tl') {
            let r = grid.x+grid.w, b = grid.y+grid.h;
            grid.x = x; grid.y = y; grid.w = r-x; grid.h = b-y;
        } else {
            grid.w = x-grid.x; grid.h = y-grid.y;
        }
    } else if(dragTarget.type === 'move') {
        grid.x += x - canvas.lastP.x;
        grid.y += y - canvas.lastP.y;
        canvas.lastP = {x,y};
    }
    draw();
});

canvas.addEventListener('mouseup', () => isDragging = false);

// --- 2. åˆ†æé€»è¾‘ (ç§»é™¤OCR) ---

function runAnalysis() {
    if(!img.src) { alert("è¯·å…ˆä¸Šä¼ æ’æœŸå›¾"); return; }
    
    const rows = parseInt(document.getElementById('rowCount').value);
    const cellH = grid.h / rows;
    const boundaries = [0, ...colDividers, 1.0];
    const cols = boundaries.length - 1;

    rawData = [];
    roomNames = []; 
    validCols = [];
    dateList = [];
    
    const imgData = ctx.getImageData(0,0, canvas.width, canvas.height).data;

    // ç”Ÿæˆé»˜è®¤å
    for(let c=0; c<cols; c++) {
        validCols.push(c);
        roomNames.push(String.fromCharCode(65 + c)); // A, B, C...
    }

    // ç”Ÿæˆæ—¥æœŸ
    const startD = new Date(document.getElementById('startDate').value);
    for(let r=0; r<rows; r++) {
        let d = new Date(startD);
        d.setDate(d.getDate() + r);
        dateList.push(`${d.getMonth()+1}/${d.getDate()}`);
        
        let rowData = [];
        let rowY = grid.y + r * cellH;

        for(let c=0; c<cols; c++) {
            let r1 = boundaries[c], r2 = boundaries[c+1];
            let cellX = Math.floor(grid.x + r1 * grid.w);
            let cellW = Math.floor((r2-r1) * grid.w);
            let cellY = Math.floor(rowY);
            
            // é‡‡æ ·ä¸­å¿ƒåŒºåŸŸ (é¿å…è¾¹ç¼˜å¹²æ‰°)
            let sX = cellX + cellW * 0.3;
            let sY = cellY + cellH * 0.3;
            let sW = cellW * 0.4;
            let sH = cellH * 0.4;

            let colored = 0, total = 0;
            for(let py=sY; py<sY+sH; py++) {
                for(let px=sX; px<sX+sW; px++) {
                    let idx = (Math.floor(py)*canvas.width + Math.floor(px))*4;
                    // æ£€æµ‹éç™½è‰² (é˜ˆå€¼ 230)
                    if(imgData[idx] < 230 || imgData[idx+1] < 230 || imgData[idx+2] < 230) colored++;
                    total++;
                }
            }
            rowData.push( (colored/total > 0.05) ? 1 : 0 );
        }
        rawData.push(rowData);
    }
    
    document.getElementById('resultCard').style.display = 'block';
    renderTable();
    calculateStats();
    
    // æ»šåŠ¨åˆ°ç»“æœåŒº
    document.getElementById('resultCard').scrollIntoView({behavior:'smooth'});
}

// --- 3. ç»“æœæ¸²æŸ“ä¸é€»è¾‘å¤„ç† ---

function renderTable() {
    const table = document.getElementById('dataTable');
    table.innerHTML = '';
    
    // 1. è¡¨å¤´
    let thead = document.createElement('thead');
    let tr = document.createElement('tr');
    tr.innerHTML = '<th style="z-index:11; left:0;">æ—¥æœŸ</th>';
    
    validCols.forEach(colIdx => {
        let th = document.createElement('th');
        // è¾“å…¥æ¡†
        let input = document.createElement('input');
        input.className = 'th-name-input';
        input.value = roomNames[colIdx];
        input.onchange = (e) => { 
            roomNames[colIdx] = e.target.value; 
            calculateStats(); // åå­—å˜äº†åˆ·æ–°å›¾è¡¨
        };
        
        // åˆ é™¤æŒ‰é’®
        let delBtn = document.createElement('span');
        delBtn.innerHTML = ' Ã—';
        delBtn.style.cursor='pointer'; delBtn.style.color='#ff3b30';
        delBtn.onclick = () => {
            if(confirm("ç¡®å®šç§»é™¤æ­¤åˆ—ï¼Ÿ")) {
                validCols = validCols.filter(c => c !== colIdx);
                // åŒæ—¶æ¸…ç†å…³è”é…ç½®
                linkConfig = linkConfig.filter(cfg => cfg.parent !== colIdx && !cfg.children.includes(colIdx));
                renderTable();
                calculateStats();
            }
        };

        th.appendChild(input);
        th.appendChild(delBtn);
        tr.appendChild(th);
    });
    thead.appendChild(tr);
    table.appendChild(thead);

    // 2. è¡¨ä½“
    let tbody = document.createElement('tbody');
    for(let r=0; r<rawData.length; r++) {
        let tr = document.createElement('tr');
        let tdDate = document.createElement('td');
        tdDate.className = 'date-col';
        tdDate.innerText = dateList[r];
        tr.appendChild(tdDate);

        validCols.forEach(c => {
            let td = document.createElement('td');
            td.className = 'cell-clickable';
            if(rawData[r][c]) td.classList.add('occupied');
            
            // ç‚¹å‡»åˆ‡æ¢çŠ¶æ€
            td.onclick = () => {
                rawData[r][c] = rawData[r][c] ? 0 : 1;
                td.className = 'cell-clickable ' + (rawData[r][c] ? 'occupied' : '');
                calculateStats();
            };
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);
}

// --- 4. ç»Ÿè®¡æ ¸å¿ƒé€»è¾‘ (å«ç»„åˆæˆ¿) ---

function calculateStats() {
    // å‡†å¤‡æ•°æ®
    const totalDays = rawData.length;
    let roomOccupancy = {}; // { colIdx: count }
    validCols.forEach(c => roomOccupancy[c] = 0);
    
    let dailyOccupancy = []; // [ {date, count, totalSlots} ]
    
    let grandTotalSlots = 0;
    let grandOccupied = 0;

    for(let r=0; r<totalDays; r++) {
        let dayStats = calculateDayLogic(r);
        dailyOccupancy.push(dayStats);
        
        grandTotalSlots += dayStats.totalSlots;
        grandOccupied += dayStats.occupied;

        // ç´¯åŠ æ¯ä¸ªæˆ¿é—´çš„å…¥ä½ (æ³¨æ„ï¼šå¦‚æœæ˜¯ç»„åˆæˆ¿é€»è¾‘ï¼Œè¿™é‡Œå±•ç¤ºçš„å•æˆ¿æ•°æ®éœ€è¦æ€ä¹ˆå¤„ç†ï¼Ÿ)
        // ç®€å•èµ·è§ï¼Œå•æˆ¿ç»Ÿè®¡æˆ‘ä»¬ä»ç„¶ç»Ÿè®¡è¯¥åˆ—æ˜¯å¦è¢«æ¶‚è‰²ï¼Œä½†åœ¨â€œæ€»å…¥ä½ç‡â€ä¸­æˆ‘ä»¬ç”¨é«˜çº§é€»è¾‘
        validCols.forEach(c => {
            if(rawData[r][c]) roomOccupancy[c]++;
        });
    }

    // æ›´æ–°ç•Œé¢æ•°å­—
    document.getElementById('valTotalSlots').innerText = grandTotalSlots;
    document.getElementById('valOccupied').innerText = grandOccupied;
    let rate = grandTotalSlots > 0 ? (grandOccupied / grandTotalSlots * 100).toFixed(1) : 0;
    document.getElementById('valRate').innerText = rate + "%";

    updateCharts(roomOccupancy, dailyOccupancy);
}

/**
 * æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—æŸè¿™ä¸€å¤©çš„å®é™…åˆ†æ¯å’Œåˆ†å­
 * é€»è¾‘ï¼š
 * 1. éå†æ‰€æœ‰â€œç»„åˆé…ç½®â€ã€‚
 * 2. å¦‚æœ Parent æœ‰å…¥ä½ -> è¿™ä¸€ç»„è´¡çŒ®ï¼šåˆ†æ¯+1, åˆ†å­+1. (Children è¢«æ¶ˆè€—æ‰ï¼Œä¸è®¡å…¥)
 * 3. å¦‚æœ Parent æ— å…¥ä½ -> è¿™ä¸€ç»„è´¡çŒ®ï¼šåˆ†æ¯+Childrenæ•°, åˆ†å­+Childrenå…¥ä½æ•°. (Parent ä¸è®¡å…¥)
 * 4. æ²¡æœ‰é…ç½®è¿›ç»„åˆçš„æ™®é€šæˆ¿é—´ -> æ­£å¸¸ åˆ†æ¯+1, åˆ†å­+(1 or 0)
 */
function calculateDayLogic(rowIdx) {
    let rowDataArr = rawData[rowIdx];
    let processedCols = new Set();
    
    let dayTotalSlots = 0;
    let dayOccupied = 0;

    // 1. å¤„ç†ç»„åˆæˆ¿
    linkConfig.forEach(cfg => {
        // ç¡®ä¿è¿™äº›åˆ—è¿˜å­˜åœ¨
        if(!validCols.includes(cfg.parent)) return;
        
        processedCols.add(cfg.parent);
        cfg.children.forEach(child => processedCols.add(child));

        if(rowDataArr[cfg.parent] === 1) {
            // ä¸»æˆ¿æœ‰å®¢ï¼šç®— 1 é—´
            dayTotalSlots += 1;
            dayOccupied += 1;
        } else {
            // ä¸»æˆ¿æ²¡å®¢ï¼šçœ‹å­æˆ¿ (åªæœ‰å­˜åœ¨çš„åˆ—æ‰ç®—)
            let validChildren = cfg.children.filter(c => validCols.includes(c));
            dayTotalSlots += validChildren.length;
            validChildren.forEach(c => {
                if(rowDataArr[c] === 1) dayOccupied += 1;
            });
        }
    });

    // 2. å¤„ç†å‰©ä½™æ™®é€šæˆ¿
    validCols.forEach(c => {
        if(!processedCols.has(c)) {
            dayTotalSlots += 1;
            if(rowDataArr[c] === 1) dayOccupied += 1;
        }
    });

    return { 
        occupied: dayOccupied, 
        totalSlots: dayTotalSlots,
        date: dateList[rowIdx]
    };
}

// --- 5. å›¾è¡¨æ›´æ–° (æ‹†åˆ†ä¸ºä¸¤ä¸ª) ---

function updateCharts(roomOccObj, dailyData) {
    // 1. æŸ±çŠ¶å›¾ï¼šå„æˆ¿é—´å…¥ä½ç‡
    const chartBar = echarts.init(document.getElementById('chartBar'));
    const xData = validCols.map(c => roomNames[c]);
    const yData = validCols.map(c => {
        // ç®€å•è®¡ç®—ï¼šè¯¥åˆ—æœ‰è‰²å¤©æ•° / æ€»å¤©æ•°
        return (roomOccObj[c] / rawData.length * 100).toFixed(1);
    });

    chartBar.setOption({
        tooltip: { trigger: 'axis', formatter: '{b}: {c}%' },
        grid: { top: 30, bottom: 60, left: 50, right: 20 },
        xAxis: { type: 'category', data: xData, axisLabel: {rotate: 45, interval:0} },
        yAxis: { type: 'value', max: 100, name: '%' },
        series: [{
            type: 'bar',
            data: yData,
            itemStyle: { color: '#007aff', borderRadius: [4,4,0,0] },
            label: { show: true, position: 'top', formatter: '{c}%' }
        }]
    });

    // 2. æŠ˜çº¿å›¾ï¼šæ¯æ—¥è¶‹åŠ¿
    const chartLine = echarts.init(document.getElementById('chartLine'));
    const dateX = dailyData.map(d => d.date);
    const dateY = dailyData.map(d => d.totalSlots > 0 ? (d.occupied / d.totalSlots * 100).toFixed(1) : 0);

    chartLine.setOption({
        tooltip: { trigger: 'axis', formatter: '{b}: {c}%' },
        grid: { top: 30, bottom: 60, left: 50, right: 30 },
        xAxis: { type: 'category', data: dateX },
        yAxis: { type: 'value', max: 100, name: '%' },
        series: [{
            type: 'line',
            smooth: true,
            data: dateY,
            itemStyle: { color: '#34c759' },
            areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0, color:'rgba(52,199,89,0.5)'}, {offset:1, color:'rgba(52,199,89,0.0)'}]) },
            markLine: { data: [{type: 'average', name: 'å¹³å‡å€¼'}] }
        }]
    });
    
    // è‡ªé€‚åº”
    window.onresize = () => { chartBar.resize(); chartLine.resize(); };
}


// --- 6. å…³è”é…ç½® UI é€»è¾‘ ---

function openLinkModal() {
    const list = document.getElementById('linkConfigList');
    list.innerHTML = '';
    
    // å¦‚æœå·²æœ‰é…ç½®ï¼Œæ¸²æŸ“å‡ºæ¥ï¼›å¦‚æœæ²¡æœ‰ï¼ŒåŠ ä¸€ä¸ªç©ºçš„
    if(linkConfig.length === 0) {
        // createEmptyLinkRow(list);
    } else {
        linkConfig.forEach((cfg, idx) => createLinkRow(list, cfg, idx));
    }
    
    document.getElementById('linkModal').style.display = 'flex';
}

function addLinkGroup() {
    createLinkRow(document.getElementById('linkConfigList'), null, null);
}

function createLinkRow(container, data, idx) {
    const div = document.createElement('div');
    div.className = 'link-row';
    
    // ä¸»æˆ¿ Select
    let selParent = document.createElement('select');
    selParent.innerHTML = '<option value="-1">é€‰æ‹©ä¸»æˆ¿æº (å¦‚B+C)</option>';
    validCols.forEach(c => {
        let opt = new Option(roomNames[c], c);
        if(data && data.parent == c) opt.selected = true;
        selParent.add(opt);
    });

    div.innerHTML += `<span>ä¸»:</span>`;
    div.appendChild(selParent);

    // å­æˆ¿ Select (å¤šé€‰æ¨¡æ‹Ÿï¼Œè¿™é‡Œç®€åŒ–ä¸ºæ–‡å­—æè¿°ï¼Œå®é™…ç”¨å¤šä¸ªselectæˆ–checkæ¯”è¾ƒå¤æ‚ï¼Œ
    // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç”¨ "å¤šé€‰Select" æ›¿ä»£æ–¹æ¡ˆï¼Œæˆ–è€…ç®€å•çš„ input comma separated? 
    // ä¸ï¼Œè¿™å¤ªæå®¢äº†ã€‚æˆ‘ä»¬ç”¨å‡ ä¸ªå¤é€‰æ¡†å§)
    
    let childArea = document.createElement('div');
    childArea.style.cssText = "display:flex; flex-wrap:wrap; gap:5px; margin-left:10px; flex:1;";
    
    validCols.forEach(c => {
        let label = document.createElement('label');
        label.style.fontSize='12px'; label.style.display='flex'; label.style.alignItems='center';
        let chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.value = c;
        if(data && data.children.includes(c)) chk.checked = true;
        
        label.appendChild(chk);
        label.appendChild(document.createTextNode(roomNames[c]));
        childArea.appendChild(label);
    });
    
    div.appendChild(document.createElement('span').appendChild(document.createTextNode("åŒ…å«å­æˆ¿:")));
    div.appendChild(childArea);

    // åˆ é™¤æŒ‰é’®
    let btnDel = document.createElement('button');
    btnDel.className = 'btn-danger';
    btnDel.innerText = 'åˆ é™¤';
    btnDel.onclick = () => div.remove();
    div.appendChild(btnDel);

    container.appendChild(div);
}

function saveLinkConfig() {
    const rows = document.querySelectorAll('.link-row');
    const newConfig = [];
    
    rows.forEach(row => {
        const parentIdx = parseInt(row.querySelector('select').value);
        if(parentIdx === -1) return;
        
        const children = [];
        row.querySelectorAll('input[type="checkbox"]').forEach(chk => {
            if(chk.checked) children.push(parseInt(chk.value));
        });
        
        if(children.length > 0) {
            newConfig.push({ parent: parentIdx, children: children });
        }
    });
    
    linkConfig = newConfig;
    document.getElementById('linkModal').style.display = 'none';
    calculateStats();
}

// --- 7. å¯¼å‡ºåŠŸèƒ½ ---

function exportExcel() {
    let wb = XLSX.utils.book_new();
    let wsData = [];
    
    // Header
    let header = ['æ—¥æœŸ'];
    validCols.forEach(c => header.push(roomNames[c]));
    header.push('å½“æ—¥å®é™…å…¥ä½ç‡(%)');
    header.push('æ€»å¯å”®(åŠ¨æ€)');
    wsData.push(header);
    
    for(let r=0; r<rawData.length; r++) {
        let stats = calculateDayLogic(r);
        let row = [dateList[r]];
        
        // æˆ¿é—´å…·ä½“çŠ¶æ€ (1/0)
        validCols.forEach(c => row.push(rawData[r][c] ? 'å…¥ä½' : ''));
        
        // ç»Ÿè®¡
        let rate = stats.totalSlots > 0 ? (stats.occupied/stats.totalSlots*100).toFixed(1) : 0;
        row.push(rate + '%');
        row.push(stats.totalSlots);
        
        wsData.push(row);
    }
    
    let ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "å…¥ä½æ•°æ®");
    XLSX.writeFile(wb, `å…¥ä½ç‡åˆ†æ_${new Date().toLocaleDateString()}.xlsx`);
}

function exportImage() {
    const card = document.getElementById('resultCard');
    html2canvas(card, { scale: 2 }).then(canvas => {
        let link = document.createElement('a');
        link.download = `å…¥ä½åˆ†ææŠ¥è¡¨_${new Date().toLocaleDateString()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });
}
</script>

</body>
</html>
