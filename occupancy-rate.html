<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¥ä½ç‡æ™ºèƒ½è®¡ç®—å™¨ | è˜‡çš„å·¥å…·ç®±</title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    :root {
        --primary: #0071e3;
        --bg: #f5f5f7;
        --card-bg: #ffffff;
        --text: #1d1d1f;
        --border: #d2d2d7;
        --success: #34c759;
        --grid-line: rgba(255, 59, 48, 0.8);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
        line-height: 1.5;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* å¤´éƒ¨ */
    header {
        text-align: center;
        margin-bottom: 24px;
    }
    h1 { margin: 0; font-size: 24px; font-weight: 600; }
    .subtitle { font-size: 13px; color: #86868b; margin-top: 4px; }

    /* å¡ç‰‡é€šç”¨æ ·å¼ */
    .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }

    .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 16px;
    }

    /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
    .btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn:hover { background: #0077ed; }
    .btn-secondary { background: #e5e5ea; color: var(--text); }
    .btn-secondary:hover { background: #d1d1d6; }
    
    input[type="file"] { font-size: 13px; }
    input[type="number"], input[type="date"] {
        padding: 6px;
        border: 1px solid var(--border);
        border-radius: 6px;
        width: 100px;
    }
    label { font-size: 13px; font-weight: 500; color: #666; margin-right: 4px;}

    /* ç”»å¸ƒåŒºåŸŸ */
    .canvas-wrapper {
        position: relative;
        overflow: hidden;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        background: #fafafa;
        cursor: crosshair;
        max-height: 80vh;
        text-align: center;
    }
    canvas { display: block; margin: 0 auto; max-width: 100%; }
    
    .instruction {
        font-size: 12px;
        color: #ff3b30;
        margin-bottom: 8px;
        background: #fff0f0;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #ff3b30;
    }

    /* ç»“æœå±•ç¤º */
    .result-tabs {
        display: flex;
        gap: 10px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
        margin-bottom: 16px;
    }
    .tab {
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: #666;
    }
    .tab.active { background: var(--primary); color: white; }

    #chartContainer { width: 100%; height: 400px; }

    /* æ•°æ®è¡¨æ ¼ */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .data-table th, .data-table td {
        border: 1px solid #e5e5e5;
        padding: 6px 4px;
        text-align: center;
    }
    .data-table th { background: #f5f5f7; font-weight: 600; color: #666; }
    .data-table .room-name-input {
        width: 100%;
        border: none;
        background: transparent;
        text-align: center;
        font-weight: bold;
    }
    .data-table .cell-check {
        width: 16px; height: 16px;
        cursor: pointer;
    }
    /* é€‰ä¸­ï¼ˆå…¥ä½ï¼‰æ ·å¼ */
    .occupied { background-color: rgba(52, 199, 89, 0.2); }
    
    .stats-box {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        background: #f0f9ff;
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
        color: #0071e3;
    }
</style>
</head>
<body>

<div class="container">
    <header>
        <h1>å…¥ä½ç‡æ™ºèƒ½è®¡ç®—å™¨</h1>
        <p class="subtitle">è˜‡çš„å·¥å…·ç®± Â· æˆªå›¾è¯†åˆ« Â· è‡ªåŠ¨ç½‘æ ¼åˆ†æ Â· æ•°æ®å¯è§†åŒ–</p>
    </header>

    <div class="card">
        <div class="instruction">
            <strong>ğŸ’¡ æ“ä½œæŒ‡å¼•ï¼š</strong> 
            1. ä¸Šä¼ è¡¨æ ¼æˆªå›¾ã€‚
            2. è°ƒæ•´çº¢è‰²ç½‘æ ¼ï¼Œä½¿å…¶ä»…è¦†ç›–<b>ä¸­é—´çš„å½©è‰²å…¥ä½åŒºåŸŸ</b>ï¼ˆä¸åŒ…å«é¡¶éƒ¨çš„æˆ¿åå’Œå·¦ä¾§çš„æ—¥æœŸï¼‰ã€‚
            3. è®¾ç½®æ­£ç¡®çš„â€œæˆ¿é—´æ•°(åˆ—)â€å’Œâ€œç»Ÿè®¡å¤©æ•°(è¡Œ)â€ã€‚
            4. ç‚¹å‡»â€œæå–æ•°æ®â€ã€‚
        </div>
        
        <div class="controls">
            <input type="file" id="imgUpload" accept="image/*">
            
            <div style="border-left:1px solid #ddd; padding-left:12px; display:flex; gap:12px;">
                <div>
                    <label>æˆ¿é—´æ•° (åˆ—):</label>
                    <input type="number" id="colCount" value="15" min="1">
                </div>
                <div>
                    <label>ç»Ÿè®¡å¤©æ•° (è¡Œ):</label>
                    <input type="number" id="rowCount" value="30" min="1">
                </div>
                <div>
                    <label>èµ·å§‹æ—¥æœŸ:</label>
                    <input type="date" id="startDate">
                </div>
            </div>

            <button class="btn" onclick="processImage()">ğŸ“Š æå–å…¥ä½æ•°æ®</button>
        </div>

        <div class="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>

    <div class="card" id="resultSection" style="display:none;">
        <div class="result-tabs">
            <div class="tab active" onclick="switchTab('table')">æ•°æ®ä¿®æ­£è¡¨</div>
            <div class="tab" onclick="switchTab('bar')">æŸ±çŠ¶å›¾ (åˆ†æˆ¿)</div>
            <div class="tab" onclick="switchTab('line')">æŠ˜çº¿å›¾ (è¶‹åŠ¿)</div>
            <div style="margin-left:auto">
                <button class="btn btn-secondary" onclick="exportExcel()">ğŸ“¥ å¯¼å‡º Excel</button>
            </div>
        </div>

        <div class="stats-box" id="globalStats">
            </div>

        <div id="viewTable">
            <div style="overflow-x:auto;">
                <table class="data-table" id="dataTable">
                    </table>
            </div>
            <p style="font-size:12px; color:#999; margin-top:8px;">* æç¤ºï¼šç‚¹å‡»è¡¨æ ¼å†…çš„å¤é€‰æ¡†å¯æ‰‹åŠ¨ä¿®æ­£è¯†åˆ«é”™è¯¯ã€‚B+Cé€»è¾‘ï¼šå¦‚éœ€æ’é™¤æŸäº›åˆ—ä¸è®¡å…¥æ€»å…¥ä½ç‡ï¼Œè¯·åœ¨å¯¼å‡ºExcelåå¤„ç†ï¼Œæˆ–åœ¨ä¸‹æ–¹è§†è§‰ä¸Šå¿½ç•¥ã€‚</p>
        </div>

        <div id="viewChart" style="display:none;">
            <div id="chartContainer"></div>
        </div>
    </div>
</div>

<script>
// --- å…¨å±€å˜é‡ ---
let img = new Image();
let canvas = document.getElementById('mainCanvas');
let ctx = canvas.getContext('2d');
let grid = { x: 50, y: 50, w: 0, h: 0 }; // ç½‘æ ¼åŒºåŸŸ
let isDragging = false;
let dragHandle = null; // 'tl', 'tr', 'bl', 'br', 'body'
let rawData = []; // 0=ç©º, 1=å…¥ä½
let roomNames = []; 
let dateList = [];

// åˆå§‹åŒ–æ—¥æœŸ
document.getElementById('startDate').valueAsDate = new Date();

// --- å›¾åƒåŠ è½½ä¸äº¤äº’ ---
document.getElementById('imgUpload').addEventListener('change', function(e) {
    if(!e.target.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        img.onload = function() {
            initCanvas();
        }
        img.src = evt.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
});

function initCanvas() {
    // è®¾ç½®ç”»å¸ƒå¤§å°ï¼Œé™åˆ¶æœ€å¤§å®½åº¦ä»¥é˜²å¡é¡¿ï¼Œä½†ä¿æŒæ¯”ä¾‹
    const maxWidth = 1100;
    const scale = Math.min(1, maxWidth / img.width);
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    
    // åˆå§‹åŒ–ç½‘æ ¼ä½ç½® (é»˜è®¤ä¸ºç”»å¸ƒä¸­é—´ 80% åŒºåŸŸ)
    grid.x = canvas.width * 0.1;
    grid.y = canvas.height * 0.1;
    grid.w = canvas.width * 0.8;
    grid.h = canvas.height * 0.8;

    draw();
}

// --- ç»˜å›¾ä¸ç½‘æ ¼é€»è¾‘ ---
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // 1. ç»˜åˆ¶å›¾ç‰‡
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // 2. ç»˜åˆ¶åŠé€æ˜é®ç½© (è®©éç½‘æ ¼åŒºåŸŸå˜æš—ï¼Œèšç„¦è§†çº¿)
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(0, 0, canvas.width, grid.y); // ä¸Š
    ctx.fillRect(0, grid.y + grid.h, canvas.width, canvas.height - (grid.y + grid.h)); // ä¸‹
    ctx.fillRect(0, grid.y, grid.x, grid.h); // å·¦
    ctx.fillRect(grid.x + grid.w, grid.y, canvas.width - (grid.x + grid.w), grid.h); // å³

    // 3. ç»˜åˆ¶çº¢è‰²ç½‘æ ¼æ¡†
    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 2;
    ctx.strokeRect(grid.x, grid.y, grid.w, grid.h);

    // 4. ç»˜åˆ¶å†…éƒ¨å‚è€ƒçº¿ (æ ¹æ®è¾“å…¥çš„è¡Œåˆ—æ•°)
    const cols = parseInt(document.getElementById('colCount').value) || 10;
    const rows = parseInt(document.getElementById('rowCount').value) || 30;
    
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255, 59, 48, 0.3)'; // æµ…çº¢è‰²
    ctx.lineWidth = 1;
    
    // ç«–çº¿
    const cellW = grid.w / cols;
    for(let i=1; i<cols; i++) {
        let x = grid.x + i * cellW;
        ctx.moveTo(x, grid.y);
        ctx.lineTo(x, grid.y + grid.h);
    }
    // æ¨ªçº¿
    const cellH = grid.h / rows;
    for(let i=1; i<rows; i++) {
        let y = grid.y + i * cellH;
        ctx.moveTo(grid.x, y);
        ctx.lineTo(grid.x + grid.w, y);
    }
    ctx.stroke();

    // 5. ç»˜åˆ¶æ‹–æ‹½æ‰‹æŸ„
    drawHandle(grid.x, grid.y); // TL
    drawHandle(grid.x + grid.w, grid.y); // TR
    drawHandle(grid.x, grid.y + grid.h); // BL
    drawHandle(grid.x + grid.w, grid.y + grid.h); // BR
}

function drawHandle(x, y) {
    ctx.fillStyle = '#fff';
    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
}

// --- é¼ æ ‡æ‹–æ‹½äº‹ä»¶ ---
canvas.addEventListener('mousedown', function(e) {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    
    // åˆ¤å®šç‚¹å‡»äº†å“ªä¸ªæ‰‹æŸ„
    const dist = 10; 
    if(Math.hypot(mx - grid.x, my - grid.y) < dist) dragHandle = 'tl';
    else if(Math.hypot(mx - (grid.x+grid.w), my - grid.y) < dist) dragHandle = 'tr';
    else if(Math.hypot(mx - grid.x, my - (grid.y+grid.h)) < dist) dragHandle = 'bl';
    else if(Math.hypot(mx - (grid.x+grid.w), my - (grid.y+grid.h)) < dist) dragHandle = 'br';
    else if(mx > grid.x && mx < grid.x+grid.w && my > grid.y && my < grid.y+grid.h) {
        dragHandle = 'body';
        this.lastX = mx;
        this.lastY = my;
    } else {
        return;
    }
    isDragging = true;
});

canvas.addEventListener('mousemove', function(e) {
    if(!isDragging) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    if(dragHandle === 'body') {
        const dx = mx - this.lastX;
        const dy = my - this.lastY;
        grid.x += dx;
        grid.y += dy;
        this.lastX = mx;
        this.lastY = my;
    } else if(dragHandle === 'tl') {
        const oldR = grid.x + grid.w;
        const oldB = grid.y + grid.h;
        grid.x = mx; grid.y = my;
        grid.w = oldR - grid.x; grid.h = oldB - grid.y;
    } else if(dragHandle === 'tr') {
        const oldB = grid.y + grid.h;
        grid.y = my;
        grid.w = mx - grid.x;
        grid.h = oldB - grid.y;
    } else if(dragHandle === 'bl') {
        const oldR = grid.x + grid.w;
        grid.x = mx;
        grid.w = oldR - grid.x;
        grid.h = my - grid.y;
    } else if(dragHandle === 'br') {
        grid.w = mx - grid.x;
        grid.h = my - grid.y;
    }
    
    draw(); // é‡ç»˜
});

canvas.addEventListener('mouseup', () => isDragging = false);
document.getElementById('colCount').addEventListener('input', draw);
document.getElementById('rowCount').addEventListener('input', draw);

// --- æ ¸å¿ƒè¯†åˆ«é€»è¾‘ ---
function processImage() {
    if(!img.src) { alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"); return; }
    
    const cols = parseInt(document.getElementById('colCount').value);
    const rows = parseInt(document.getElementById('rowCount').value);
    const cellW = grid.w / cols;
    const cellH = grid.h / rows;
    
    rawData = []; // é‡ç½®æ•°æ® [row][col]
    
    // è·å–ç”»å¸ƒåƒç´ æ•°æ®
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

    for(let r=0; r<rows; r++) {
        let rowArr = [];
        for(let c=0; c<cols; c++) {
            // é‡‡æ ·æ¯ä¸ªæ ¼å­ä¸­å¿ƒç‚¹çš„é¢œè‰²
            const cx = Math.floor(grid.x + c * cellW + cellW/2);
            const cy = Math.floor(grid.y + r * cellH + cellH/2);
            
            // è·å–åƒç´ ç´¢å¼•
            const idx = (cy * canvas.width + cx) * 4;
            const R = imgData[idx];
            const G = imgData[idx+1];
            const B = imgData[idx+2];
            
            // ç®€å•åˆ¤æ–­ï¼šå¦‚æœä¸æ˜¯æ¥è¿‘ç™½è‰²/æµ…ç°è‰²ï¼Œå°±è®¤ä¸ºæ˜¯â€œå…¥ä½â€
            // æˆªå›¾èƒŒæ™¯ä¸€èˆ¬æ˜¯çº¯ç™½æˆ–ææµ…ç° (240-255)
            // é˜ˆå€¼è®¾ä¸º 230ï¼Œåªè¦æœ‰ä¸€ä¸ªåˆ†é‡å°äº230ï¼Œæˆ–è€…æ•´ä½“å¤ªæš—ï¼Œå°±ç®—æœ‰é¢œè‰²
            const isWhite = (R > 230 && G > 230 && B > 230);
            rowArr.push(isWhite ? 0 : 1);
        }
        rawData.push(rowArr);
    }

    // åˆå§‹åŒ–åˆ—åå’Œæ—¥æœŸ
    roomNames = [];
    for(let i=0; i<cols; i++) roomNames.push(`æˆ¿${i+1}`); // é»˜è®¤åˆ—å
    
    dateList = [];
    const startD = new Date(document.getElementById('startDate').value);
    for(let i=0; i<rows; i++) {
        let d = new Date(startD);
        d.setDate(d.getDate() + i);
        dateList.push(d.toISOString().split('T')[0].slice(5)); // MM-DD
    }

    renderTable();
    updateStats();
    document.getElementById('resultSection').style.display = 'block';
    // é»˜è®¤åˆ‡åˆ°è¡¨æ ¼è§†å›¾
    switchTab('table');
}

// --- ç»“æœæ¸²æŸ“ ---
function renderTable() {
    const table = document.getElementById('dataTable');
    let h = `<thead><tr><th>æ—¥æœŸ</th>`;
    // è¡¨å¤´ï¼šå¯ç¼–è¾‘æˆ¿é—´å
    roomNames.forEach((name, i) => {
        h += `<th><input class="room-name-input" value="${name}" onchange="updateRoomName(${i}, this.value)"></th>`;
    });
    h += `</tr></thead><tbody>`;

    const rows = rawData.length;
    const cols = rawData[0].length;

    for(let r=0; r<rows; r++) {
        h += `<tr><td>${dateList[r]}</td>`;
        for(let c=0; c<cols; c++) {
            const isOcc = rawData[r][c] === 1;
            const cls = isOcc ? 'occupied' : '';
            const checked = isOcc ? 'checked' : '';
            // ä½¿ç”¨ checkbox å…è®¸æ‰‹åŠ¨ä¿®æ­£
            h += `<td class="${cls}" onclick="toggleCell(${r}, ${c}, this)">
                    <input type="checkbox" ${checked} class="cell-check" onclick="event.stopPropagation(); toggleCell(${r},${c}, this.parentElement)">
                  </td>`;
        }
        h += `</tr>`;
    }
    h += `</tbody>`;
    table.innerHTML = h;
}

// ä¿®æ­£æ•°æ®
function toggleCell(r, c, td) {
    // ç¿»è½¬çŠ¶æ€
    rawData[r][c] = rawData[r][c] === 1 ? 0 : 1;
    
    // æ›´æ–°UI
    const checkbox = td.querySelector('input');
    if(rawData[r][c] === 1) {
        td.classList.add('occupied');
        checkbox.checked = true;
    } else {
        td.classList.remove('occupied');
        checkbox.checked = false;
    }
    updateStats(); // å®æ—¶æ›´æ–°ç»Ÿè®¡
}

function updateRoomName(idx, val) {
    roomNames[idx] = val;
    updateStats(); // åˆ·æ–°å›¾è¡¨label
}

// --- ç»Ÿè®¡ä¸å›¾è¡¨ ---
function updateStats() {
    const rows = rawData.length;
    const cols = rawData[0].length;
    
    // 1. åˆ†æˆ¿å…¥ä½ç‡
    let roomOccRates = [];
    let roomOccDays = new Array(cols).fill(0);
    
    for(let c=0; c<cols; c++) {
        for(let r=0; r<rows; r++) {
            if(rawData[r][c] === 1) roomOccDays[c]++;
        }
        roomOccRates.push( (roomOccDays[c] / rows * 100).toFixed(1) );
    }

    // 2. æ¯æ—¥æ€»å…¥ä½ç‡
    let dailyRates = [];
    let totalOccupiedSlots = 0;
    
    for(let r=0; r<rows; r++) {
        let occCount = 0;
        for(let c=0; c<cols; c++) {
            if(rawData[r][c] === 1) occCount++;
        }
        dailyRates.push( (occCount / cols * 100).toFixed(1) );
        totalOccupiedSlots += occCount;
    }

    // 3. å…¨å±€ç»Ÿè®¡æ–‡æœ¬
    const totalSlots = rows * cols;
    const overallRate = (totalOccupiedSlots / totalSlots * 100).toFixed(1);
    
    document.getElementById('globalStats').innerHTML = `
        <div>æ€»å…¥ä½ç‡: <strong>${overallRate}%</strong></div>
        <div>æ€»å¯å”®æˆ¿æ™š: <strong>${totalSlots}</strong></div>
        <div>å®é™…å…¥ä½æˆ¿æ™š: <strong>${totalOccupiedSlots}</strong></div>
    `;

    // 4. æ›´æ–°å›¾è¡¨æ•°æ®å¯¹è±¡ (ä½†ä¸ä¸€å®šç«‹å³æ¸²æŸ“)
    window.chartData = {
        roomNames,
        roomOccRates,
        dateList,
        dailyRates
    };
    
    // å¦‚æœå½“å‰åœ¨çœ‹å›¾è¡¨ï¼Œåˆ·æ–°å®ƒ
    const chartDiv = document.getElementById('viewChart');
    if(chartDiv.style.display !== 'none') {
        renderChart(window.currentChartType || 'bar');
    }
}

// æ¸²æŸ“ ECharts
let myChart = null;
function renderChart(type) {
    window.currentChartType = type;
    if(myChart) myChart.dispose();
    myChart = echarts.init(document.getElementById('chartContainer'));
    
    const data = window.chartData;
    let option = {};

    if(type === 'bar') {
        option = {
            title: { text: 'å„æˆ¿é—´å…¥ä½ç‡ (%)', left: 'center' },
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: data.roomNames, axisLabel: {interval:0, rotate:30} },
            yAxis: { type: 'value', max: 100, name: '%' },
            series: [{
                data: data.roomOccRates,
                type: 'bar',
                itemStyle: { color: '#0071e3' },
                label: { show: true, position: 'top', formatter: '{c}%' }
            }]
        };
    } else {
        option = {
            title: { text: 'æ¯æ—¥æ€»ä½“å…¥ä½è¶‹åŠ¿ (%)', left: 'center' },
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: data.dateList },
            yAxis: { type: 'value', max: 100, name: '%' },
            series: [{
                data: data.dailyRates,
                type: 'line',
                smooth: true,
                itemStyle: { color: '#34c759' },
                areaStyle: { opacity: 0.1 }
            }]
        };
    }
    myChart.setOption(option);
}

// --- Tab åˆ‡æ¢ ---
function switchTab(view) {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    if(view === 'table') {
        document.getElementById('viewTable').style.display = 'block';
        document.getElementById('viewChart').style.display = 'none';
    } else {
        document.getElementById('viewTable').style.display = 'none';
        document.getElementById('viewChart').style.display = 'block';
        setTimeout(() => renderChart(view), 50); // å»¶æ—¶ä¸€ç‚¹ç¡®ä¿DOMå¯è§
    }
}

// --- å¯¼å‡º Excel ---
function exportExcel() {
    if(rawData.length === 0) return;
    
    // æ„é€  Excel æ•°æ®ç»“æ„
    const ws_data = [];
    
    // Header
    ws_data.push(["æ—¥æœŸ", ...roomNames, "æ¯æ—¥å…¥ä½ç‡"]);
    
    // Body
    for(let r=0; r<rawData.length; r++) {
        let row = [dateList[r]];
        let dailyOcc = 0;
        for(let c=0; c<rawData[0].length; c++) {
            const isOcc = rawData[r][c] === 1;
            row.push(isOcc ? "å…¥ä½" : "");
            if(isOcc) dailyOcc++;
        }
        row.push( (dailyOcc / rawData[0].length * 100).toFixed(2) + "%" );
        ws_data.push(row);
    }
    
    // Footer Stats
    let footer = ["å¹³å‡å…¥ä½ç‡"];
    for(let c=0; c<rawData[0].length; c++) {
        let colOcc = 0;
        for(let r=0; r<rawData.length; r++) if(rawData[r][c]===1) colOcc++;
        footer.push( (colOcc/rawData.length*100).toFixed(2) + "%" );
    }
    ws_data.push(footer);

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "å…¥ä½æ•°æ®");
    XLSX.writeFile(wb, "å…¥ä½ç‡ç»Ÿè®¡.xlsx");
}

window.addEventListener('resize', () => {
    if(myChart) myChart.resize();
});
</script>

</body>
</html>
