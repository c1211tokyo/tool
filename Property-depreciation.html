<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®— | è˜‡çš„å·¥å…·ç®±</title>
    <style>
        /* --- æ ¸å¿ƒæ ·å¼åº“ (æ¢å¤ V5.0 é«˜è´¨é‡è§†è§‰) --- */
        :root {
            --primary: #2563eb;       /* ä¸»è“ */
            --primary-dark: #1e40af;  /* æ·±è“ */
            --bg: #f8fafc;            /* èƒŒæ™¯ç° */
            --card: #ffffff;          /* å¡ç‰‡ç™½ */
            --text: #0f172a;          /* ä¸»é»‘ */
            --text-sub: #64748b;      /* æ¬¡ç° */
            --border: #e2e8f0;        /* è¾¹æ¡† */
            --accent: #f59e0b;        /* å¼ºè°ƒé»„ */
            --build-color: #059669;   /* å»ºç‰©ç»¿ */
            --land-color: #64748b;    /* åœŸåœ°ç° */
        }
        
        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 20px; 
            margin: 0;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container { max-width: 1024px; margin: 0 auto; width: 100%; flex: 1; }

        /* --- Header --- */
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 1.6rem; color: var(--primary); letter-spacing: -0.5px; }
        
        /* éœ€æ±‚ 3: é¦–é¡µè·³è½¬é“¾æ¥æ ·å¼ */
        .home-link { text-decoration: none; color: inherit; cursor: pointer; transition: opacity 0.2s; }
        .home-link:hover { opacity: 0.8; }
        
        p.subtitle { margin: 8px 0 0; font-size: 0.9rem; color: var(--text-sub); }

        /* --- å¸ƒå±€ç½‘æ ¼ --- */
        .grid-layout { display: grid; gap: 24px; grid-template-columns: 1fr; }
        @media(min-width: 850px) { .grid-layout { grid-template-columns: 420px 1fr; } }

        /* --- å¡ç‰‡ç»„ä»¶ --- */
        .card { 
            background: var(--card); 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); 
            margin-bottom: 24px; 
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        h2 { 
            font-size: 1rem; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 12px; 
            margin-top: 0; 
            margin-bottom: 20px;
            color: #334155; 
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* --- æ¨¡å¼åˆ‡æ¢ Tabs --- */
        .mode-tabs { display: flex; background: #f1f5f9; border-radius: 10px; padding: 4px; margin-bottom: 24px; }
        .tab-btn { 
            flex: 1; 
            border: none; 
            padding: 10px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
            color: var(--text-sub); 
            background: transparent; 
            transition: all 0.2s; 
        }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- è¡¨å•å…ƒç´  --- */
        .form-row { margin-bottom: 16px; }
        label { display: flex; align-items: center; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: #475569; }
        
        .input-group { position: relative; display: flex; align-items: center; }
        input, select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-size: 0.95rem; 
            background: #fff; 
            transition: border-color 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary); }
        .suffix { position: absolute; right: 12px; color: #94a3b8; font-size: 0.85rem; pointer-events: none; }

        /* è‡ªåŠ¨ä¼°ç®—é«˜äº®åŒº */
        .auto-box { 
            background: #eff6ff; 
            border: 1px dashed #bfdbfe; 
            padding: 16px; 
            border-radius: 10px; 
            margin-top: 12px; 
        }
        .auto-title { color: var(--primary); font-size: 0.8rem; font-weight: 700; margin-bottom: 12px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Tooltip --- */
        .tooltip-wrap { position: relative; display: inline-flex; margin-left: 6px; }
        .tooltip-icon { color: var(--info); cursor: help; font-size: 0.9rem; }
        .tooltip-text {
            visibility: hidden;
            width: 260px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 100;
            bottom: 140%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: normal;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        .tooltip-wrap:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* --- ç»“æœæ˜¾ç¤ºåŒº --- */
        .result-dashboard { 
            background: #1e293b; 
            color: white; 
            padding: 24px; 
            border-radius: 16px; 
            text-align: center; 
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .res-badge {
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 8px;
            text-align: center;
        }
        .res-badge .val { font-size: 1.8rem; font-weight: 700; color: #34d399; line-height: 1.2; }
        .res-badge .lbl { font-size: 0.75rem; opacity: 0.7; }

        .res-main { text-align: right; }
        .res-main .amount { font-size: 2rem; font-weight: 800; color: var(--accent); }
        .res-main .desc { font-size: 0.85rem; opacity: 0.8; }

        /* --- æ¯”ä¾‹å¯è§†åŒ–æ¡ --- */
        .ratio-bar-container { margin: 20px 0; }
        .ratio-bar { display: flex; height: 32px; border-radius: 8px; overflow: hidden; background: #f1f5f9; }
        .rb-seg { display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600; transition: width 0.4s ease; white-space: nowrap; overflow: hidden; }
        .rb-build { background: var(--build-color); }
        .rb-land { background: var(--land-color); }
        
        .ratio-legend { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 8px; color: var(--text-sub); }

        /* --- è¡¨æ ¼ --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--text-sub); font-weight: 500; padding: 12px 8px; border-bottom: 1px solid var(--border); }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; text-align: right; font-feature-settings: "tnum"; }
        td:first-child { text-align: left; }
        tr:last-child td { border-bottom: none; }
        .row-highlight { background-color: #fefce8; font-weight: 600; }

        /* --- Footer --- */
        footer {
            text-align: center;
            font-size: 0.8rem;
            color: #94a3b8;
            padding: 40px 0 20px;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>
            <a href="/" class="index.html">è˜‡çš„å·¥å…·ç®±</a>
        </h1>
        <p class="subtitle">æ—¥æœ¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®—å·¥å…· V6.0</p>
    </header>

    <div class="grid-layout">
        
        <div>
            <div class="card" style="padding: 10px;">
                <div class="mode-tabs">
                    <button id="btn-mode-manual" class="tab-btn active" onclick="app.switchMode('manual')">A: å·²çŸ¥æ‹†åˆ†</button>
                    <button id="btn-mode-auto" class="tab-btn" onclick="app.switchMode('auto')">B: ä¼°ç®—æ¯”ä¾‹</button>
                    <button id="btn-mode-fixed" class="tab-btn" onclick="app.switchMode('fixed')">C: å›ºéƒ½ç¨è¯„ä¼°</button>
                </div>
            </div>

            <div class="card">
                <h2>âš™ï¸ åŸºç¡€ç¨åŠ¡è®¾å®š</h2>
                
                <div class="form-row">
                    <label>å»ºç­‘æ„é€  (å†³å®šæ³•å®šå¯¿å‘½)</label>
                    <select id="s_structure">
                        <option value="wood">ğŸŒ² æœ¨é€  (æ³•å®š22å¹´)</option>
                        <option value="steel">ğŸ¢ è½»é’¢ (æ³•å®š27å¹´)</option>
                        <option value="rc" selected>ğŸ™ RC/SRC (æ³•å®š47å¹´)</option>
                    </select>
                </div>

                <div class="form-row">
                    <label>ç­‘å¹´æ•°
                        <div class="tooltip-wrap"><span class="tooltip-icon">â„¹ï¸</span><span class="tooltip-text">æˆ¿å±‹å»ºæˆè‡³ä»Šçš„å¹´æ•°ã€‚ä¸­å¤æˆ¿é€šè¿‡ç®€ä¾¿æ³•è®¡ç®—æŠ˜æ—§å¹´æ•°æ—¶ä»¥æ­¤ä¸ºå‡†ã€‚</span></div>
                    </label>
                    <div class="input-group">
                        <input type="number" id="s_age" value="25" min="0">
                        <span class="suffix">å¹´</span>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                    <div class="form-row">
                        <label>å†³ç®—æœˆ</label>
                        <select id="s_fiscalMonth">
                            <option value="3" selected>3æœˆ</option>
                            <option value="12">12æœˆ</option>
                            </select>
                    </div>
                    <div class="form-row">
                        <label>ä¹°å…¥æœˆ</label>
                        <select id="s_buyMonth">
                            <option value="4" selected>4æœˆ</option>
                            </select>
                    </div>
                </div>

                <div class="form-row">
                    <label>æ³•äººæœ‰æ•ˆç¨ç‡</label>
                    <div class="input-group">
                        <input type="number" id="s_taxRate" value="33.0" step="0.1">
                        <span class="suffix">%</span>
                    </div>
                </div>

                <div class="form-row">
                    <label>æŠ˜æ—§æ–¹æ³•
                        <div class="tooltip-wrap"><span class="tooltip-icon">â„¹ï¸</span><span class="tooltip-text">ä¸­å¤æˆ¿é€šå¸¸ä½¿ç”¨ã€Œç®€ä¾¿æ³•ã€ä»¥æœ€å¤§åŒ–å‰æœŸæŠ˜æ—§ã€‚æ–°æˆ¿æˆ–ç‰¹æ®Šæƒ…å†µå¯é€‰å®šç‡æ³•æˆ–ç›´çº¿æ³•ã€‚</span></div>
                    </label>
                    <div style="display:flex; gap:10px;">
                        <select id="s_method" style="flex:1;">
                            <option value="simplified">ç®€ä¾¿æ³• (æ¨è)</option>
                            <option value="straight">ç›´çº¿æ³•</option>
                            <option value="rate">å®šç‡æ³•</option>
                        </select>
                        <div class="input-group hidden" id="grp_depRate" style="width: 100px;">
                            <input type="number" id="s_depRate" value="0.043" step="0.001" placeholder="ç‡">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ’° ä»·æ ¼ä¸ä¼°å€¼</h2>

                <div id="panel-manual">
                    <div class="form-row">
                        <label>åœŸåœ°ä»·æ ¼ (åˆåŒ)</label>
                        <div class="input-group"><input type="number" id="m_landPrice" value="4500"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    <div class="form-row">
                        <label>å»ºç‰©ä»·æ ¼ (åˆåŒ/å¯æŠ˜æ—§)</label>
                        <div class="input-group"><input type="number" id="m_buildPrice" value="3500"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                </div>

                <div id="panel-auto" class="hidden">
                    <div class="form-row">
                        <label>äº¤æ˜“æ€»ä»·</label>
                        <div class="input-group"><input type="number" id="a_totalPrice" value="8000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    
                    <div class="auto-box">
                        <span class="auto-title">ğŸ“ åœŸåœ°å‚æ•°</span>
                        <div class="form-row">
                            <label>åœŸåœ°é¢ç§¯</label>
                            <div class="input-group"><input type="number" id="a_landArea" value="60"><span class="suffix">ã¡</span></div>
                        </div>
                        <div class="form-row">
                            <label>è·¯çº¿ä»· (åŸºå‡†åœ°ä»·)
                                <div class="tooltip-wrap"><span class="tooltip-icon">â„¹ï¸</span><span class="tooltip-text">ä»å›½ç¨å…è·¯çº¿ä»·å›¾æŸ¥åˆ°çš„å•ä»·ã€‚å·¥å…·ä¼šè‡ªåŠ¨ä¹˜ä»¥ç³»æ•°è¿˜åŸä¸ºå¸‚åœºä»·ã€‚</span></div>
                            </label>
                            <div class="input-group"><input type="number" id="a_rosenka" value="500000" step="1000"><span class="suffix">å††/ã¡</span></div>
                        </div>
                        <div class="form-row">
                            <label>å¸‚åœºä¿®æ­£ç³»æ•°</label>
                            <select id="a_factor">
                                <option value="1.25">1.25 (ä¿å®ˆ)</option>
                                <option value="1.40" selected>1.40 (æ ‡å‡†)</option>
                                <option value="1.60">1.60 (ç§¯æ)</option>
                            </select>
                        </div>
                    </div>

                    <div class="auto-box">
                        <span class="auto-title">ğŸ  å»ºç‰©å‚æ•°</span>
                        <div class="form-row">
                            <label>å»ºç‰©é¢ç§¯</label>
                            <div class="input-group"><input type="number" id="a_buildArea" value="120"><span class="suffix">ã¡</span></div>
                        </div>
                        <div class="form-row">
                            <label>å»ºé€ å•ä»· (2025å‚è€ƒ)</label>
                            <select id="a_unitCost">
                                <option value="250000">æœ¨é€  (25ä¸‡)</option>
                                <option value="320000">è½»é’¢ (32ä¸‡)</option>
                                <option value="430000" selected>RC (43ä¸‡)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="panel-fixed" class="hidden">
                    <div class="form-row">
                        <label>å›ºéƒ½ç¨è¯„ä¼°é¢ (åœŸåœ°)</label>
                        <div class="input-group"><input type="number" id="f_land" value="3000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    <div class="form-row">
                        <label>å›ºéƒ½ç¨è¯„ä¼°é¢ (å»ºç‰©)</label>
                        <div class="input-group"><input type="number" id="f_build" value="2000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    <div style="font-size:0.85rem; color:#64748b; margin-top:8px;">* ç³»ç»Ÿå°†æŒ‰å›ºéƒ½ç¨æ¯”ä¾‹æ‹†åˆ†ä¸Šæ–¹è¾“å…¥çš„äº¤æ˜“æ€»ä»·</div>
                    <div class="form-row" style="margin-top:8px;">
                        <label>å®é™…äº¤æ˜“æ€»ä»·</label>
                        <div class="input-group"><input type="number" id="f_totalPrice" value="8000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="result-dashboard">
                <div class="res-badge">
                    <div class="val" id="out_years">--</div>
                    <div class="lbl">æŠ˜æ—§å¹´æ•°</div>
                </div>
                <div class="res-main">
                    <div class="desc">5å¹´ç´¯è®¡èŠ‚ç¨ (ç°é‡‘æµ)</div>
                    <div class="amount" id="out_totalSave">--</div>
                    <div class="desc" style="margin-top:5px; color:#94a3b8;">é¦–å¹´æŠ˜æ—§: <span id="out_year1" style="color:#fbbf24; font-weight:bold;">--</span> ä¸‡</div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š æ‹†åˆ†è¯¦æƒ…</h2>
                
                <div class="ratio-bar-container">
                    <div class="ratio-bar">
                        <div id="bar_build" class="rb-seg rb-build" style="width: 50%">å»º</div>
                        <div id="bar_land" class="rb-seg rb-land" style="width: 50%">åœŸ</div>
                    </div>
                    <div class="ratio-legend">
                        <span id="txt_build_ratio">å»ºç‰©: --%</span>
                        <span id="txt_land_ratio">åœŸåœ°: --%</span>
                    </div>
                </div>

                <table>
                    <tr>
                        <th>å»ºç‰© (å¯æŠ˜æ—§)</th>
                        <td style="font-weight:700; color:var(--build-color);" id="out_buildPrice">--</td>
                    </tr>
                    <tr>
                        <th>åœŸåœ° (ä¸å¯æŠ˜æ—§)</th>
                        <td id="out_landPrice">--</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h2>ğŸ“… 5å¹´æ¨¡æ‹Ÿè¡¨</h2>
                <table>
                    <thead>
                        <tr>
                            <th>å¹´åº¦</th>
                            <th>æŠ˜æ—§ (æŸé‡‘)</th>
                            <th>èŠ‚ç¨ (ç°é‡‘)</th>
                        </tr>
                    </thead>
                    <tbody id="out_table_body">
                        </tbody>
                </table>
                <div style="font-size:0.75rem; color:#94a3b8; text-align:center; margin-top:15px;">
                    * é¦–å¹´æŒ‰æœˆå‰²è®¡ç®—ï¼ˆåŒ…å«è´­ä¹°æœˆï¼‰ã€‚ç»“æœä»…ä¾›æ¨¡æ‹Ÿå‚è€ƒã€‚
                </div>
            </div>
        </div>
    </div>

    <footer>
        è˜‡çš„å·¥å…·ç®± Â· SUYU.2025
    </footer>
</div>

<script>
/**
 * V6.0 æ ¸å¿ƒé€»è¾‘ - ç¨³å¥ç‰ˆ
 */
const app = {
    // åŸºç¡€é…ç½®
    config: {
        life: { wood: 22, steel: 27, rc: 47 },
    },
    state: {
        mode: 'manual'
    },

    init() {
        // å¡«å……æœˆä»½é€‰é¡¹ (1-12æœˆ)
        this.fillMonths();
        
        // ç»‘å®šäº‹ä»¶
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(el => {
            el.addEventListener('input', () => this.calc());
            el.addEventListener('change', () => this.calc());
        });

        // ç»‘å®šæŠ˜æ—§æ–¹æ³•æ˜¾éš
        document.getElementById('s_method').addEventListener('change', (e) => {
            const isRate = e.target.value === 'rate';
            document.getElementById('grp_depRate').classList.toggle('hidden', !isRate);
        });

        // åˆå§‹è®¡ç®—
        this.calc();
    },

    fillMonths() {
        const opts = Array.from({length: 12}, (_, i) => `<option value="${i+1}">${i+1}æœˆ</option>`).join('');
        const s1 = document.getElementById('s_fiscalMonth');
        const s2 = document.getElementById('s_buyMonth');
        // ä¿å­˜å½“å‰å€¼
        const v1 = s1.value, v2 = s2.value;
        s1.innerHTML = opts; s2.innerHTML = opts;
        // æ¢å¤é»˜è®¤ (3æœˆå†³ç®—, 4æœˆä¹°å…¥)
        s1.value = "3"; s2.value = "4"; 
    },

    switchMode(mode) {
        this.state.mode = mode;
        
        // UI åˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-mode-${mode}`).classList.add('active');

        document.getElementById('panel-manual').classList.add('hidden');
        document.getElementById('panel-auto').classList.add('hidden');
        document.getElementById('panel-fixed').classList.add('hidden');
        document.getElementById(`panel-${mode}`).classList.remove('hidden');

        this.calc();
    },

    // å®‰å…¨æµ®ç‚¹æ•°è§£æ
    val(id) {
        const el = document.getElementById(id);
        const v = parseFloat(el.value);
        return isNaN(v) ? 0 : v;
    },

    calc() {
        try {
            // 1. è·å–åŸºç¡€å‚æ•°
            const structure = document.getElementById('s_structure').value;
            const age = this.val('s_age');
            const method = document.getElementById('s_method').value;
            const taxRate = this.val('s_taxRate') / 100;
            const fiscalMonth = parseInt(document.getElementById('s_fiscalMonth').value);
            const buyMonth = parseInt(document.getElementById('s_buyMonth').value);

            let landPrice = 0, buildPrice = 0;

            // 2. è®¡ç®—æ‹†åˆ† (Land vs Build)
            if (this.state.mode === 'manual') {
                landPrice = this.val('m_landPrice');
                buildPrice = this.val('m_buildPrice');
            } 
            else if (this.state.mode === 'auto') {
                const total = this.val('a_totalPrice');
                const lArea = this.val('a_landArea');
                const rosenka = this.val('a_rosenka');
                const factor = this.val('a_factor');
                const bArea = this.val('a_buildArea');
                const unitCost = this.val('a_unitCost');

                // åœŸåœ°ä¼°å€¼ = é¢ç§¯ * è·¯çº¿ä»· * ç³»æ•° / 10000(æ¢ç®—ä¸ºä¸‡)
                const lVal = (lArea * rosenka * factor) / 10000;
                
                // å»ºç‰©ä¼°å€¼ = é¢ç§¯ * å•ä»· * æ®‹å€¼ç‡
                const statLife = this.config.life[structure];
                const physLife = statLife * 1.5;
                let rate = 1 - (age / physLife);
                if (rate < 0.1) rate = 0.1; // ä¿åº•10%
                const bVal = (bArea * unitCost * rate) / 10000;

                const sum = lVal + bVal;
                if (sum > 0) {
                    buildPrice = total * (bVal / sum);
                    landPrice = total * (lVal / sum);
                }
            } 
            else if (this.state.mode === 'fixed') {
                const fLand = this.val('f_land');
                const fBuild = this.val('f_build');
                const realTotal = this.val('f_totalPrice');
                const sum = fLand + fBuild;
                if (sum > 0) {
                    buildPrice = realTotal * (fBuild / sum);
                    landPrice = realTotal * (fLand / sum);
                }
            }

            // 3. æ›´æ–°æ‹†åˆ† UI
            this.updateSplitUI(landPrice, buildPrice);

            // 4. è®¡ç®—æŠ˜æ—§ (æ ¸å¿ƒ)
            this.calcDepreciation(buildPrice, structure, age, method, fiscalMonth, buyMonth, taxRate);

        } catch (e) {
            console.error("Calculation error:", e);
        }
    },

    updateSplitUI(land, build) {
        const total = land + build;
        const lPct = total > 0 ? (land/total)*100 : 0;
        const bPct = total > 0 ? (build/total)*100 : 0;

        // æ ¼å¼åŒ–æ•°å­—
        const fmt = (n) => Math.round(n).toLocaleString() + " ä¸‡";
        
        document.getElementById('out_landPrice').innerText = fmt(land);
        document.getElementById('out_buildPrice').innerText = fmt(build);

        // æ›´æ–°æ¡å½¢å›¾
        const barB = document.getElementById('bar_build');
        const barL = document.getElementById('bar_land');
        
        barB.style.width = bPct + "%";
        barB.innerText = bPct > 10 ? `å»º ${Math.round(bPct)}%` : "";
        
        barL.style.width = lPct + "%";
        barL.innerText = lPct > 10 ? `åœŸ ${Math.round(lPct)}%` : "";

        document.getElementById('txt_build_ratio').innerText = `å»ºç‰©: ${bPct.toFixed(1)}%`;
        document.getElementById('txt_land_ratio').innerText = `åœŸåœ°: ${lPct.toFixed(1)}%`;
    },

    calcDepreciation(price, structure, age, method, fMonth, bMonth, taxRate) {
        if (price <= 0) return;

        const statLife = this.config.life[structure];
        let years = statLife; // é»˜è®¤

        // --- A. ç¡®å®šæŠ˜æ—§å¹´æ•° ---
        if (method === 'simplified') {
            // ç®€ä¾¿æ³•: (æ³•å®š-ç»è¿‡) + ç»è¿‡*0.2
            if (age >= statLife) {
                years = Math.floor(statLife * 0.2);
            } else {
                years = Math.floor((statLife - age) + (age * 0.2));
            }
            if (years < 2) years = 2;
        }
        document.getElementById('out_years').innerText = years + " å¹´";

        // --- B. è®¡ç®—é¦–å¹´æŠ˜æ—§æœˆæ•° ---
        // ä¾‹å­: å†³ç®—3æœˆ, ä¹°å…¥4æœˆ -> 4,5,6...1,2,3 å…±12ä¸ªæœˆ
        // ä¾‹å­: å†³ç®—3æœˆ, ä¹°å…¥2æœˆ -> 2,3 å…±2ä¸ªæœˆ
        let months1 = 0;
        if (bMonth <= fMonth) {
            months1 = fMonth - bMonth + 1;
        } else {
            months1 = (12 - bMonth + 1) + fMonth;
        }

        // --- C. ç”Ÿæˆ5å¹´è¡¨ ---
        let html = "";
        let totalSave = 0;
        let year1Dep = 0;
        let accumulatedDep = 0;
        
        // ç°ä»£æ—¥æœ¬ç¨æ³•å…è®¸æŠ˜æ—§è‡³1å†† (å¤‡å¿˜ä»·é¢)
        // æ—§æ³•å¯èƒ½é™åˆ¶ä¸º95%ï¼Œè¿™é‡ŒæŒ‰ 100% - 1å†† å¤„ç†
        const maxDep = price - 1; 

        // å®šç‡æ³•éœ€è¦çš„æŠ˜æ—§ç‡ (ç®€å•å¤„ç†ï¼šè¯»å–è¾“å…¥æ¡†)
        const dbRate = this.val('s_depRate'); 

        // ä¸´æ—¶å˜é‡ç”¨äºå®šç‡æ³•
        let currentBookValue = price; 

        for (let i = 1; i <= 5; i++) {
            let dep = 0;

            if (method === 'rate') {
                // å®šç‡æ³• (ç®€åŒ–ç‰ˆ: è´¦é¢ * ç‡)
                // æ³¨æ„: å®é™…ç¨æ³•æœ‰"ä¿è¯ç‡"å’Œ"æ”¹å®šå¿å´ç‡"ï¼Œè¿™é‡Œåš Web æ¨¡æ‹Ÿç®€åŒ–
                dep = currentBookValue * dbRate;
            } else {
                // ç›´çº¿æ³• / ç®€ä¾¿æ³• (å®šé¢)
                // ç®€ä¾¿æ³•å…¶å®å°±æ˜¯ç¼©çŸ­äº†å¹´é™çš„å®šé¢æ³•
                dep = price / years;
            }

            // é¦–å¹´æŒ‰æœˆ
            if (i === 1) {
                dep = dep * (months1 / 12);
            }
            // ç®€ä¾¿æ³•/ç›´çº¿æ³•ï¼šè¶…è¿‡å¹´é™åœæ­¢
            if (method !== 'rate' && i > years && i > 1) { // i>1é˜²æ­¢é¦–å¹´å³è¿‡æœŸçš„æç«¯æƒ…å†µ
                 // éœ€è¦æ£€æŸ¥ä¸Šä¸€å¹´æ˜¯å¦æ²¡ææ»¡ï¼ˆå› æœˆå‰²ï¼‰ï¼Œè¡¥é½
                 // è¿™é‡Œç®€åŒ–ï¼šè¶…è¿‡å¹´é™å°±ä¸æäº†ï¼Œé™¤éæ€»é¢æœªæ»¡
                 if (accumulatedDep >= maxDep) dep = 0;
            }

            // è¾¹ç•Œæ£€æŸ¥ï¼šä¸èƒ½è¶…è¿‡æ€»æŠ˜æ—§é¢
            if (accumulatedDep + dep > maxDep) {
                dep = maxDep - accumulatedDep;
            }
            if (dep < 0) dep = 0;

            // æ›´æ–°çŠ¶æ€
            accumulatedDep += dep;
            currentBookValue -= dep;
            
            if (i === 1) year1Dep = dep;
            const save = dep * taxRate;
            totalSave += save;

            // æ¸²æŸ“è¡Œ
            html += `
                <tr class="${i===1?'row-highlight':''}">
                    <td>ç¬¬ ${i} å¹´</td>
                    <td>${Math.round(dep).toLocaleString()} ä¸‡</td>
                    <td style="color:#10b981">+${Math.round(save).toLocaleString()} ä¸‡</td>
                </tr>
            `;
        }

        document.getElementById('out_table_body').innerHTML = html;
        document.getElementById('out_totalSave').innerText = Math.round(totalSave).toLocaleString() + " ä¸‡";
        document.getElementById('out_year1').innerText = Math.round(year1Dep).toLocaleString();
    }
};

// å¯åŠ¨
document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>
