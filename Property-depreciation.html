<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®—å·¥å…· | è˜‡çš„å·¥å…·ç®±</title>
    <style>
        /* --- V7.5 é…è‰²ç³»ç»Ÿ --- */
        :root {
            --primary: #334155;
            --primary-light: #475569;
            --accent: #0284c7;        
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #059669;
            --neutral: #94a3b8;
        }
        
        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            padding: 20px; 
            margin: 0;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container { max-width: 1024px; margin: 0 auto; width: 100%; flex: 1; }

        /* --- Header --- */
        header { text-align: center; margin-bottom: 30px; padding-top: 10px; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 800; }
        .subtitle-link { 
            display: inline-block; margin-top: 6px; font-size: 0.9rem; color: var(--text-sub); 
            text-decoration: none; border-bottom: 1px dashed transparent; transition: all 0.2s;
        }
        .subtitle-link:hover { color: var(--accent); border-bottom-color: var(--accent); }

        /* --- å¸ƒå±€ --- */
        .grid-layout { display: grid; gap: 24px; grid-template-columns: 1fr; }
        @media(min-width: 850px) { .grid-layout { grid-template-columns: 420px 1fr; } }

        /* --- å¡ç‰‡ --- */
        .card { 
            background: var(--bg-card); 
            padding: 24px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            margin-bottom: 24px; 
            border: 1px solid var(--border);
        }
        h2 { 
            font-size: 0.95rem; border-bottom: 2px solid var(--bg-body); padding-bottom: 12px; 
            margin: 0 0 20px 0; color: var(--primary); font-weight: 700;
        }

        /* --- Tabs --- */
        .mode-tabs { display: flex; background: var(--bg-body); border-radius: 8px; padding: 4px; }
        .tab-btn { 
            flex: 1; border: none; padding: 8px; border-radius: 6px; cursor: pointer; 
            font-weight: 600; font-size: 0.85rem; color: var(--text-sub); background: transparent; transition: all 0.2s; 
        }
        .tab-btn.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* --- è¡¨å• --- */
        .form-row { margin-bottom: 18px; }
        label { display: flex; align-items: center; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--primary-light); }
        .input-group { position: relative; display: flex; align-items: center; }
        input, select { 
            width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; 
            font-size: 0.95rem; background: #fff; transition: border-color 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
        .suffix { position: absolute; right: 12px; color: #94a3b8; font-size: 0.85rem; pointer-events: none; }
        .auto-box { background: #f8fafc; border: 1px dashed var(--border); padding: 16px; border-radius: 8px; margin-top: 12px; }
        .auto-title { color: var(--accent); font-size: 0.75rem; font-weight: 700; margin-bottom: 12px; display: block; }

        /* --- V7.5 Tooltip (ç‚¹å‡»è§¦å‘å‹) --- */
        .tooltip-wrap { position: relative; display: inline-flex; margin-left: 6px; cursor: pointer; }
        .tooltip-icon { color: var(--accent); font-size: 0.9rem; opacity: 0.7; }
        .tooltip-wrap:hover .tooltip-icon { opacity: 1; }
        
        .tooltip-content {
            display: none; /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
            position: absolute;
            width: 280px;
            background-color: rgba(15, 23, 42, 0.98);
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 14px;
            z-index: 200;
            bottom: 150%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            line-height: 1.5;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            font-weight: normal;
        }
        .tooltip-content.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(5px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: rgba(15, 23, 42, 0.98) transparent transparent transparent;
        }
        .tooltip-content a { color: #38bdf8; font-weight: bold; text-decoration: none; border-bottom: 1px solid #38bdf8; }
        .tooltip-content b { color: var(--accent); color: #fbbf24; }

        /* --- ç»“æœåŒº --- */
        .result-dashboard { 
            background: var(--primary); color: white; padding: 24px; border-radius: 12px; 
            text-align: center; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;
        }
        .res-badge { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .res-badge .val { font-size: 1.8rem; font-weight: 700; color: #38bdf8; line-height: 1.2; }
        .res-badge .lbl { font-size: 0.75rem; opacity: 0.8; }
        .res-main { text-align: right; }
        .res-main .amount { font-size: 2rem; font-weight: 700; color: #fbbf24; }
        .res-main .desc { font-size: 0.85rem; opacity: 0.8; }

        /* --- V7.5 äº¤äº’å¼æ¯”ä¾‹æ¡ --- */
        .ratio-bar-container { margin: 20px 0; position: relative; user-select: none; }
        .ratio-bar { 
            display: flex; height: 36px; border-radius: 6px; overflow: hidden; background: var(--bg-body); 
            position: relative;
        }
        
        /* æ‹–æ‹½æ¨¡å¼ä¸‹çš„å…‰æ ‡ */
        .ratio-bar-container.draggable { cursor: col-resize; }
        .ratio-bar-container.draggable .ratio-bar { box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }

        .rb-seg { 
            display: flex; align-items: center; justify-content: center; color: white; 
            font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            /* å»é™¤ transition ä»¥ä¿è¯æ‹–æ‹½æµç•…æ€§ */
        }
        .rb-build { background: var(--success); }
        .rb-land { background: var(--neutral); }

        /* æ‹–æ‹½æ‰‹æŸ„ */
        .drag-handle {
            position: absolute;
            top: 0; bottom: 0; width: 14px; margin-left: -7px;
            background: white;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            cursor: col-resize;
            border-radius: 2px;
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
        }
        .drag-handle::after {
            content: ""; display: block; width: 2px; height: 16px; 
            border-left: 2px double #cbd5e1;
        }
        /* ä»…åœ¨ Manual æ¨¡å¼ä¸”æ€»ä»·>0 æ—¶æ˜¾ç¤ºæ‰‹æŸ„ */
        .ratio-bar-container.draggable .drag-handle { display: flex; }

        .ratio-legend { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 6px; font-weight: 500;}

        /* --- è¡¨æ ¼ --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--text-sub); font-weight: 600; padding: 12px 8px; border-bottom: 1px solid var(--border); font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 12px 8px; border-bottom: 1px solid var(--bg-body); text-align: right; }
        td:first-child { text-align: left; color: var(--text-sub); font-weight: 500; }
        .row-highlight { background-color: #f0fdf4; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.8); z-index: 1000; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content {
            background: white; width: 100%; max-width: 800px; max-height: 90vh;
            border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
        .modal-header h3 { margin: 0; color: var(--primary); }
        .close-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .btn-full-sim {
            width: 100%; padding: 12px; background: white; border: 1px solid var(--accent);
            color: var(--accent); font-weight: 600; border-radius: 8px; cursor: pointer; margin-top: 15px; transition: all 0.2s;
        }
        .btn-full-sim:hover { background: #f0f9ff; }

        footer { text-align: center; font-size: 0.8rem; color: var(--text-sub); padding: 40px 0 20px; border-top: 1px solid var(--border); margin-top: auto; opacity: 0.8; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>æ—¥æœ¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®—å·¥å…·</h1>
        <a href="https://c1211tokyo.github.io/tool/" class="subtitle-link">è˜‡çš„å·¥å…·ç®±</a>
    </header>

    <div class="grid-layout">
        <div>
            <div class="card" style="padding: 6px;">
                <div class="mode-tabs">
                    <button id="btn-mode-manual" class="tab-btn active" onclick="app.switchMode('manual')">A: å·²çŸ¥æ‹†åˆ†</button>
                    <button id="btn-mode-auto" class="tab-btn" onclick="app.switchMode('auto')">B: ä¼°ç®—æ¯”ä¾‹</button>
                    <button id="btn-mode-fixed" class="tab-btn" onclick="app.switchMode('fixed')">C: å›ºéƒ½ç¨è¯„ä¼°</button>
                </div>
            </div>

            <div class="card">
                <h2>âš™ï¸ åŸºç¡€ç¨åŠ¡è®¾å®š</h2>
                
                <div class="form-row">
                    <label>å»ºç­‘æ„é€ 
                        <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <div class="tooltip-content">
                                å†³å®š<b>æ³•å®šè€ç”¨å¹´æ•°</b>ã€‚<br>RC(é’¢ç­‹æ··å‡åœŸ)ä¸º47å¹´ï¼Œè½»é’¢ä¸º27å¹´ï¼Œæœ¨é€ ä¸º22å¹´ã€‚
                            </div>
                        </div>
                    </label>
                    <select id="s_structure">
                        <option value="wood">ğŸŒ² æœ¨é€  (æ³•å®š22å¹´)</option>
                        <option value="steel">ğŸ¢ è½»é’¢ (æ³•å®š27å¹´)</option>
                        <option value="rc" selected>ğŸ™ RC/SRC (æ³•å®š47å¹´)</option>
                    </select>
                </div>

                <div class="form-row">
                    <label>ç­‘å¹´æ•°
                        <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <div class="tooltip-content">
                                æˆ¿å±‹å»ºæˆè‡³ä»Šçš„å¹´æ•°ã€‚<br>ä¸­å¤æˆ¿æŠ˜æ—§å…¬å¼ï¼š<br><b>(æ³•å®šå¯¿å‘½ - ç­‘å¹´æ•°) + ç­‘å¹´æ•° Ã— 0.2</b>
                            </div>
                        </div>
                    </label>
                    <div class="input-group">
                        <input type="number" id="s_age" value="25" min="0">
                        <span class="suffix">å¹´</span>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                    <div class="form-row">
                        <label>å†³ç®—æœˆ</label>
                        <select id="s_fiscalMonth"></select>
                    </div>
                    <div class="form-row">
                        <label>ä¹°å…¥æœˆ</label>
                        <select id="s_buyMonth"></select>
                    </div>
                </div>

                <div class="form-row">
                    <label>æ³•äººæœ‰æ•ˆç¨ç‡
                        <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <div class="tooltip-content">ä¸œäº¬ä¸­å°ä¼ä¸šç»¼åˆç¨ç‡çº¦ <b>30% ~ 34%</b>ã€‚</div>
                        </div>
                    </label>
                    <div class="input-group">
                        <input type="number" id="s_taxRate" value="33.0" step="0.1">
                        <span class="suffix">%</span>
                    </div>
                </div>

                <div class="form-row">
                    <label>æŠ˜æ—§æ–¹æ³•</label>
                    <div style="display:flex; gap:10px;">
                        <select id="s_method" style="flex:1;">
                            <option value="simplified">ç®€ä¾¿æ³• (æ¨è)</option>
                            <option value="straight">ç›´çº¿æ³•</option>
                            <option value="rate">å®šç‡æ³•</option>
                        </select>
                        <div class="input-group hidden" id="grp_depRate" style="width: 100px;">
                            <input type="number" id="s_depRate" value="0.043" step="0.001" placeholder="ç‡">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ’° ä»·æ ¼ä¸ä¼°å€¼</h2>

                <div id="panel-manual">
                    <div class="form-row">
                        <label>åœŸåœ°ä»·æ ¼ (åˆåŒ)</label>
                        <div class="input-group"><input type="number" id="m_landPrice" value="4500"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    <div class="form-row">
                        <label>å»ºç‰©ä»·æ ¼ (åˆåŒ)</label>
                        <div class="input-group"><input type="number" id="m_buildPrice" value="3500"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                </div>

                <div id="panel-auto" class="hidden">
                    <div class="form-row">
                        <label>äº¤æ˜“æ€»ä»·</label>
                        <div class="input-group"><input type="number" id="a_totalPrice" value="8000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    
                    <div class="auto-box">
                        <span class="auto-title">ğŸ“ åœŸåœ°å‚æ•°</span>
                        <div class="form-row">
                            <label>åœŸåœ°é¢ç§¯</label>
                            <div class="input-group"><input type="number" id="a_landArea" value="60"><span class="suffix">ã¡</span></div>
                        </div>
                        <div class="form-row">
                            <label>è·¯çº¿ä»· (åŸºå‡†åœ°ä»·)
                                <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                                    <span class="tooltip-icon">â„¹ï¸</span>
                                    <div class="tooltip-content">
                                        <a href="https://www.rosenka.nta.go.jp/" target="_blank">ğŸ”— ç‚¹å‡»è·³è½¬å›½ç¨å…æŸ¥è¯¢</a><br><br>
                                        æ³¨æ„ï¼šè¯·è¾“å…¥<b>ä¸‡å††</b>ä¸ºå•ä½ã€‚<br>
                                        å¦‚åœ°å›¾æ˜¾ç¤º "500C"ï¼Œå³ 500åƒå†† = <b>50</b> ä¸‡å††ã€‚
                                    </div>
                                </div>
                            </label>
                            <div class="input-group"><input type="number" id="a_rosenka" value="50" step="1"><span class="suffix">ä¸‡å††/ã¡</span></div>
                        </div>
                        <div class="form-row">
                            <label>å¸‚åœºä¿®æ­£ç³»æ•°</label>
                            <select id="a_factor">
                                <option value="1.25">1.25 (ä¿å®ˆ)</option>
                                <option value="1.40" selected>1.40 (æ ‡å‡†)</option>
                                <option value="1.60">1.60 (ç§¯æ)</option>
                            </select>
                        </div>
                    </div>

                    <div class="auto-box">
                        <span class="auto-title">ğŸ  å»ºç‰©å‚æ•°</span>
                        <div class="form-row">
                            <label>å»ºç‰©é¢ç§¯</label>
                            <div class="input-group"><input type="number" id="a_buildArea" value="120"><span class="suffix">ã¡</span></div>
                        </div>
                        <div class="form-row">
                            <label>å»ºé€ å•ä»· (2025å‚è€ƒ)</label>
                            <select id="a_unitCost">
                                <option value="25">æœ¨é€  (25ä¸‡)</option>
                                <option value="32">è½»é’¢ (32ä¸‡)</option>
                                <option value="43" selected>RC (43ä¸‡)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="panel-fixed" class="hidden">
                    <div class="form-row">
                        <label>å›ºéƒ½ç¨è¯„ä¼°é¢ (åœŸåœ°)</label>
                        <div class="input-group"><input type="number" id="f_land" value="3000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    <div class="form-row">
                        <label>å›ºéƒ½ç¨è¯„ä¼°é¢ (å»ºç‰©)</label>
                        <div class="input-group"><input type="number" id="f_build" value="2000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    <div class="form-row" style="margin-top:8px;">
                        <label>å®é™…äº¤æ˜“æ€»ä»·</label>
                        <div class="input-group"><input type="number" id="f_totalPrice" value="8000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="result-dashboard">
                <div class="res-badge">
                    <div class="val" id="out_years">--</div>
                    <div class="lbl">æŠ˜æ—§å¹´æ•°</div>
                </div>
                <div class="res-main">
                    <div class="desc">å‰5å¹´ç´¯è®¡èŠ‚ç¨</div>
                    <div class="amount" id="out_totalSave">--</div>
                    <div class="desc" style="margin-top:5px; color:#e2e8f0;">é¦–å¹´æŠ˜æ—§: <span id="out_year1" style="color:#fbbf24; font-weight:bold;">--</span> ä¸‡</div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š æ‹†åˆ†è¯¦æƒ… (Mode A å¯æ‹–æ‹½è°ƒæ•´)</h2>
                
                <div class="ratio-bar-container" id="ratioContainer">
                    <div class="ratio-bar">
                        <div id="bar_build" class="rb-seg rb-build" style="width: 50%"></div>
                        <div id="bar_land" class="rb-seg rb-land" style="width: 50%"></div>
                    </div>
                    <div class="drag-handle" id="dragHandle"></div>
                    
                    <div class="ratio-legend">
                        <span id="txt_build_ratio" style="color:var(--success)">å»ºç‰©: --%</span>
                        <span id="txt_land_ratio" style="color:var(--neutral)">åœŸåœ°: --%</span>
                    </div>
                </div>

                <table>
                    <tr>
                        <th style="color:var(--success)">å»ºç‰© (å¯æŠ˜æ—§)</th>
                        <td style="font-weight:700; color:var(--success); font-size:1.1rem;" id="out_buildPrice">--</td>
                    </tr>
                    <tr>
                        <th>åœŸåœ° (ä¸å¯æŠ˜æ—§)</th>
                        <td id="out_landPrice">--</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h2>ğŸ“… 5å¹´æ¨¡æ‹Ÿè¡¨</h2>
                <table>
                    <thead>
                        <tr>
                            <th>å¹´åº¦</th>
                            <th>æŠ˜æ—§ (æŸé‡‘)</th>
                            <th>èŠ‚ç¨ (ç°é‡‘)</th>
                        </tr>
                    </thead>
                    <tbody id="out_table_body"></tbody>
                </table>
                <div style="font-size:0.75rem; color:var(--text-sub); text-align:center; margin-top:15px;">* é¦–å¹´æŒ‰æœˆå‰²è®¡ç®—</div>
                <button class="btn-full-sim" onclick="app.showFullModal()">ğŸ” æŸ¥çœ‹å®Œæ•´æŠ˜æ—§è¡¨ (å…¨å‘¨æœŸ)</button>
            </div>
        </div>
    </div>

    <footer>è˜‡çš„å·¥å…·ç®± Â· SUYU.2025</footer>
</div>

<div class="modal-overlay" id="fullModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å®Œæ•´æŠ˜æ—§è®¡åˆ’è¡¨</h3>
            <button class="close-btn" onclick="app.closeFullModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <table>
                <thead>
                    <tr>
                        <th>å¹´åº¦</th>
                        <th>æŠ˜æ—§é¢</th>
                        <th>èŠ‚ç¨é¢</th>
                        <th>æœŸæœ«è´¦é¢ä»·å€¼</th>
                    </tr>
                </thead>
                <tbody id="full_table_body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- V7.5 Tooltip Controller ---
const tooltip = {
    activeEl: null,
    
    toggle(wrapper) {
        const content = wrapper.querySelector('.tooltip-content');
        if (!content) return;

        // å¦‚æœç‚¹å‡»çš„æ˜¯å·²ç»æ‰“å¼€çš„ï¼Œåˆ™å…³é—­
        if (this.activeEl === content) {
            this.close();
            return;
        }

        // å…³é—­ä¹‹å‰çš„
        if (this.activeEl) this.activeEl.classList.remove('active');

        // æ‰“å¼€æ–°çš„
        content.classList.add('active');
        this.activeEl = content;
        
        // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘ document ç‚¹å‡»
        event.stopPropagation();
    },

    close() {
        if (this.activeEl) {
            this.activeEl.classList.remove('active');
            this.activeEl = null;
        }
    },

    init() {
        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­ Tooltip
        document.addEventListener('click', (e) => {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ tooltip å†…éƒ¨ï¼Œåˆ™å…³é—­
            if (this.activeEl && !e.target.closest('.tooltip-content')) {
                this.close();
            }
        });
        
        // å…è®¸ tooltip å†…éƒ¨é“¾æ¥ç‚¹å‡»
        const links = document.querySelectorAll('.tooltip-content a');
        links.forEach(l => l.addEventListener('click', (e) => e.stopPropagation()));
    }
};

// --- V7.5 Drag Controller ---
const dragger = {
    isDragging: false,
    container: null,
    
    init() {
        this.container = document.getElementById('ratioContainer');
        const handle = document.getElementById('dragHandle');
        
        handle.addEventListener('mousedown', (e) => this.start(e));
        document.addEventListener('mousemove', (e) => this.move(e));
        document.addEventListener('mouseup', () => this.end());
        
        // Mobile touch support
        handle.addEventListener('touchstart', (e) => this.start(e.touches[0]));
        document.addEventListener('touchmove', (e) => this.move(e.touches[0]));
        document.addEventListener('touchend', () => this.end());
    },

    start(e) {
        if (app.state.mode !== 'manual') return;
        this.isDragging = true;
        document.body.style.cursor = 'col-resize';
        e.preventDefault && e.preventDefault(); // Prevent text selection
    },

    move(e) {
        if (!this.isDragging) return;
        
        const rect = this.container.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        let pct = offsetX / rect.width;
        
        // Constrain
        if (pct < 0.05) pct = 0.05;
        if (pct > 0.95) pct = 0.95;

        // Calculate based on current Total Price in Manual Mode
        const currentLand = parseFloat(document.getElementById('m_landPrice').value) || 0;
        const currentBuild = parseFloat(document.getElementById('m_buildPrice').value) || 0;
        const total = currentLand + currentBuild;

        if (total > 0) {
            const newBuild = total * pct;
            const newLand = total - newBuild;
            
            // Update Inputs
            document.getElementById('m_buildPrice').value = Math.round(newBuild);
            document.getElementById('m_landPrice').value = Math.round(newLand);
            
            // Trigger Calc
            app.calc();
        }
    },

    end() {
        this.isDragging = false;
        document.body.style.cursor = 'default';
    }
};

// --- Main App ---
const app = {
    config: { life: { wood: 22, steel: 27, rc: 47 } },
    state: { mode: 'manual', fullData: [] },

    init() {
        this.fillMonths();
        tooltip.init();
        dragger.init();
        
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(el => {
            el.addEventListener('input', () => this.calc());
            el.addEventListener('change', () => this.calc());
        });

        document.getElementById('s_method').addEventListener('change', (e) => {
            const isRate = e.target.value === 'rate';
            document.getElementById('grp_depRate').classList.toggle('hidden', !isRate);
            this.calc();
        });

        document.getElementById('fullModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('fullModal')) this.closeFullModal();
        });

        this.calc();
    },

    fillMonths() {
        const opts = Array.from({length: 12}, (_, i) => `<option value="${i+1}">${i+1}æœˆ</option>`).join('');
        const s1 = document.getElementById('s_fiscalMonth');
        const s2 = document.getElementById('s_buyMonth');
        s1.innerHTML = opts; s2.innerHTML = opts;
        s1.value = "3"; s2.value = "4"; 
    },

    switchMode(mode) {
        this.state.mode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-mode-${mode}`).classList.add('active');
        document.getElementById('panel-manual').classList.add('hidden');
        document.getElementById('panel-auto').classList.add('hidden');
        document.getElementById('panel-fixed').classList.add('hidden');
        document.getElementById(`panel-${mode}`).classList.remove('hidden');
        
        // Toggle Draggable State
        const ratioContainer = document.getElementById('ratioContainer');
        if (mode === 'manual') ratioContainer.classList.add('draggable');
        else ratioContainer.classList.remove('draggable');

        this.calc();
    },

    val(id) {
        const el = document.getElementById(id);
        const v = parseFloat(el.value);
        return isNaN(v) ? 0 : v;
    },

    calc() {
        try {
            const structure = document.getElementById('s_structure').value;
            const age = this.val('s_age');
            const method = document.getElementById('s_method').value;
            const taxRate = this.val('s_taxRate') / 100;
            const fiscalMonth = parseInt(document.getElementById('s_fiscalMonth').value);
            const buyMonth = parseInt(document.getElementById('s_buyMonth').value);

            let landPrice = 0, buildPrice = 0;

            if (this.state.mode === 'manual') {
                landPrice = this.val('m_landPrice');
                buildPrice = this.val('m_buildPrice');
            } else if (this.state.mode === 'auto') {
                const total = this.val('a_totalPrice');
                const lArea = this.val('a_landArea');
                const rosenka = this.val('a_rosenka');
                const factor = this.val('a_factor');
                const bArea = this.val('a_buildArea');
                const unitCost = this.val('a_unitCost');
                const lVal = lArea * rosenka * factor;
                const statLife = this.config.life[structure];
                const physLife = statLife * 1.5;
                let rate = 1 - (age / physLife);
                if (rate < 0.1) rate = 0.1;
                const bVal = bArea * unitCost * rate;
                const sum = lVal + bVal;
                if (sum > 0) {
                    buildPrice = total * (bVal / sum);
                    landPrice = total * (lVal / sum);
                }
            } else if (this.state.mode === 'fixed') {
                const fLand = this.val('f_land');
                const fBuild = this.val('f_build');
                const realTotal = this.val('f_totalPrice');
                const sum = fLand + fBuild;
                if (sum > 0) {
                    buildPrice = realTotal * (fBuild / sum);
                    landPrice = realTotal * (fLand / sum);
                }
            }

            this.updateSplitUI(landPrice, buildPrice);
            this.generateData(buildPrice, structure, age, method, fiscalMonth, buyMonth, taxRate);
            this.renderSmallTable();

        } catch (e) { console.error(e); }
    },

    updateSplitUI(land, build) {
        const total = land + build;
        const lPct = total > 0 ? (land/total)*100 : 0;
        const bPct = total > 0 ? (build/total)*100 : 0;
        const fmt = (n) => Math.round(n).toLocaleString() + " ä¸‡";
        
        document.getElementById('out_landPrice').innerText = fmt(land);
        document.getElementById('out_buildPrice').innerText = fmt(build);

        const barB = document.getElementById('bar_build');
        const barL = document.getElementById('bar_land');
        
        // Update widths
        barB.style.width = bPct + "%";
        barL.style.width = lPct + "%";
        
        // Labels inside bar
        barB.innerText = bPct > 15 ? fmt(build) : "";
        barL.innerText = lPct > 15 ? fmt(land) : "";

        // Legend
        document.getElementById('txt_build_ratio').innerText = `å»ºç‰©: ${bPct.toFixed(1)}%`;
        document.getElementById('txt_land_ratio').innerText = `åœŸåœ°: ${lPct.toFixed(1)}%`;

        // Update Drag Handle Position
        const handle = document.getElementById('dragHandle');
        if (this.state.mode === 'manual' && total > 0) {
            handle.style.left = bPct + "%";
        }
    },

    generateData(price, structure, age, method, fMonth, bMonth, taxRate) {
        this.state.fullData = [];
        if (price <= 0) return;

        const statLife = this.config.life[structure];
        let years = statLife;

        if (method === 'simplified') {
            if (age >= statLife) years = Math.floor(statLife * 0.2);
            else years = Math.floor((statLife - age) + (age * 0.2));
            if (years < 2) years = 2;
        }
        document.getElementById('out_years').innerText = years + " å¹´";

        let months1 = 0;
        if (bMonth <= fMonth) months1 = fMonth - bMonth + 1;
        else months1 = (12 - bMonth + 1) + fMonth;

        const maxDep = price - 1; 
        const dbRate = this.val('s_depRate'); 
        let currentBook = price;
        let accDep = 0;
        let i = 1;

        while (currentBook > 1 && i <= 100) {
            let dep = 0;
            if (method === 'rate') dep = currentBook * dbRate;
            else dep = price / years;

            if (i === 1) dep = dep * (months1 / 12);
            if (method !== 'rate' && i > years && i > 1 && accDep < maxDep) {
                // optional cleanup for leftover due to monthly calc
            }

            if (accDep + dep > maxDep) dep = maxDep - accDep;
            if (dep < 0) dep = 0;

            accDep += dep;
            currentBook -= dep;
            
            this.state.fullData.push({
                year: i, dep: dep, save: dep * taxRate, book: currentBook
            });

            if (currentBook <= 1) break; 
            i++;
        }
    },

    renderSmallTable() {
        const data = this.state.fullData.slice(0, 5);
        let html = "";
        let totalSave = 0;
        data.forEach(d => {
            totalSave += d.save;
            html += `
                <tr class="${d.year===1?'row-highlight':''}">
                    <td>ç¬¬ ${d.year} å¹´</td>
                    <td>${Math.round(d.dep).toLocaleString()} ä¸‡</td>
                    <td style="color:var(--success)">+${Math.round(d.save).toLocaleString()} ä¸‡</td>
                </tr>
            `;
        });
        const y1 = this.state.fullData[0];
        document.getElementById('out_year1').innerText = y1 ? Math.round(y1.dep).toLocaleString() : 0;
        document.getElementById('out_totalSave').innerText = Math.round(totalSave).toLocaleString() + " ä¸‡";
        document.getElementById('out_table_body').innerHTML = html;
    },

    renderFullTable() {
        let html = "";
        this.state.fullData.forEach(d => {
            html += `
                <tr>
                    <td>ç¬¬ ${d.year} å¹´</td>
                    <td>${Math.round(d.dep).toLocaleString()} ä¸‡</td>
                    <td style="color:var(--success)">+${Math.round(d.save).toLocaleString()} ä¸‡</td>
                    <td style="color:var(--text-sub)">${Math.round(d.book).toLocaleString()} ä¸‡</td>
                </tr>
            `;
        });
        document.getElementById('full_table_body').innerHTML = html;
    },

    showFullModal() {
        this.renderFullTable();
        document.getElementById('fullModal').style.display = 'flex';
    },

    closeFullModal() {
        document.getElementById('fullModal').style.display = 'none';
    }
};

document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>
