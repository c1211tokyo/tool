<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸œäº¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®— V4.0 (æœ€ç»ˆä¼˜åŒ–ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --accent: #f59e0b;
            --info: #3b82f6;
        }
        
        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 20px; 
            margin: 0;
            line-height: 1.5;
        }

        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--primary); }
        p.subtitle { margin: 5px 0 0; font-size: 0.9rem; color: #64748b; }

        .grid-layout { display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media(min-width: 768px) { .grid-layout { grid-template-columns: 1fr 1fr; } }

        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        h2 { font-size: 1rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-top: 0; color: #334155; display: flex; align-items: center; justify-content: space-between; }
        
        .mode-tabs { display: flex; background: #e2e8f0; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .tab-btn { flex: 1; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: #64748b; background: transparent; transition: all 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .form-row { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #475569; }
        .input-wrapper { position: relative; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; background: #fff; }
        .suffix { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 0.85rem; pointer-events: none; }
        .hint { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }

        .auto-box { background: #eff6ff; border: 1px dashed #bfdbfe; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .auto-title { color: var(--primary); font-size: 0.85rem; font-weight: 700; margin-bottom: 10px; display: block; }
        
        /* æ ¸å¿ƒç»“æœ - çªå‡ºæ˜¾ç¤ºæŠ˜æ—§æœŸ */
        .result-header { 
            background: #1e293b; 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .big-number { font-size: 1.8rem; font-weight: 700; color: var(--accent); margin: 5px 0; }
        .dep-period-display { 
            background: var(--primary-dark); 
            padding: 10px 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-align: center;
        }
        .dep-period-display .val { font-size: 2rem; font-weight: 900; color: #10b981; line-height: 1; }
        .dep-period-display .label { font-size: 0.8rem; color: #e5e7eb; margin-top: 5px; }
        
        /* Tooltip æ ·å¼ */
        .tooltip-container { position: relative; display: inline-block; margin-left: 5px; }
        .tooltip-icon { color: var(--info); cursor: pointer; font-size: 0.9rem; font-weight: 700; }
        .tooltip-content {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 150%; /* Position the tooltip above the text */
            left: 50%;
            margin-left: -125px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ä¸œäº¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®— V4.0 (æœ€ç»ˆç‰ˆ)</h1>
        <p class="subtitle">åœŸåœ°ä»·æ ¼è®¡ç®—å›å½’â€œåŸå§‹åŸºç¡€ä»·â€è¾“å…¥ï¼Œè®¡ç®—é€»è¾‘ç”±å·¥å…·è‡ªåŠ¨å®Œæˆ</p>
    </header>

    <div class="grid-layout">
        
        <div>
            <div class="card" style="padding: 10px;">
                <div class="mode-tabs">
                    <button id="btn-mode-manual" class="tab-btn active" onclick="switchMode('manual')">æ¨¡å¼ A: å·²çŸ¥æ‹†åˆ†ä»·</button>
                    <button id="btn-mode-auto" class="tab-btn" onclick="switchMode('auto')">æ¨¡å¼ B: ä¼°ç®—æ¯”ä¾‹</button>
                </div>
            </div>

            <div class="card">
                <h2>1. åŸºç¡€ç¨åŠ¡è®¾å®š</h2>
                <div class="form-row">
                    <label>å»ºç­‘æ„é€  (å†³å®šæ³•å®šè€ç”¨å¹´æ•°)</label>
                    <select id="common_structure">
                        <option value="wood">ğŸŒ² æœ¨é€  (æ³•å®š22å¹´)</option>
                        <option value="steel">ğŸ¢ è½»é’¢ (æ³•å®š27å¹´)</option>
                        <option value="rc" selected>ğŸ™ RC/SRC (æ³•å®š47å¹´)</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>ç­‘å¹´æ•° (å·²ä½¿ç”¨å¹´æ•°)
                        <span class="tooltip-container">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <span class="tooltip-content">å¡«å†™æˆ¿å±‹å»ºæˆè‡³ä»Šçš„å¹´æ•°ã€‚å½±å“æŠ˜æ—§å¹´æ•°ï¼ˆç®€ä¾¿æ³•ï¼‰ã€‚</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="common_age" value="25" min="0">
                        <span class="suffix">å¹´</span>
                    </div>
                </div>
                <div class="form-row" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label>å…¬å¸å†³ç®—æœˆ
                            <span class="tooltip-container">
                                <span class="tooltip-icon">â„¹ï¸</span>
                                <span class="tooltip-content">æ‚¨å…¬å¸è´¢å¹´ç»“æŸçš„æœˆä»½ã€‚ç”¨äºè®¡ç®—è´­ä¹°å½“å¹´å¯æŠ˜æ—§çš„æœˆæ•°ã€‚</span>
                            </span>
                        </label>
                        <select id="common_fiscalMonth">
                            <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3" selected>3æœˆ</option>
                            <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div>
                        <label>ä¹°å…¥/äº¤ä»˜æœˆ
                            <span class="tooltip-container">
                                <span class="tooltip-icon">â„¹ï¸</span>
                                <span class="tooltip-content">æˆ¿å±‹æ­£å¼äº¤ä»˜å¹¶å¼€å§‹è®¡ææŠ˜æ—§çš„æœˆä»½ã€‚è´­ä¹°å½“æœˆè®¡å…¥æŠ˜æ—§ã€‚</span>
                            </span>
                        </label>
                        <select id="common_purchaseMonth">
                            <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
                            <option value="4" selected>4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <label>æ³•äººæœ‰æ•ˆç¨ç‡
                        <span class="tooltip-container">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <span class="tooltip-content">æ‚¨å…¬å¸é€‚ç”¨çš„æ³•äººç¨ã€äº‹ä¸šç¨å’Œä½æ°‘ç¨ç­‰åˆè®¡ç¨ç‡ã€‚é€šå¸¸åœ¨30%åˆ°34%ä¹‹é—´ã€‚</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="common_taxRate" value="33.0" step="0.1">
                        <span class="suffix">%</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>2. ä»·æ ¼ä¸é¢ç§¯</h2>

                <div id="panel-manual">
                    <div class="form-row">
                        <label>åœŸåœ°ä»·æ ¼</label>
                        <div class="input-wrapper">
                            <input type="number" id="man_landPrice" value="5000">
                            <span class="suffix">ä¸‡å††</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <label>å»ºç‰©ä»·æ ¼ (å¯æŠ˜æ—§åŸºæ•°)</label>
                        <div class="input-wrapper">
                            <input type="number" id="man_buildPrice" value="3000">
                            <span class="suffix">ä¸‡å††</span>
                        </div>
                    </div>
                    <div class="hint" style="text-align:right;">
                        æ€»ä»·: <strong id="man_total_display">8,000</strong> ä¸‡å††
                    </div>
                </div>

                <div id="panel-auto" class="hidden">
                    <div class="form-row">
                        <label>äº¤æ˜“æ€»ä»·</label>
                        <div class="input-wrapper">
                            <input type="number" id="auto_totalPrice" value="8000">
                            <span class="suffix">ä¸‡å††</span>
                        </div>
                    </div>

                    <div class="auto-box">
                        <span class="auto-title">ğŸ“ åœŸåœ°å‚æ•° (ä¼°ç®—æƒé‡)</span>
                        <div class="form-row">
                            <label>åœŸåœ°é¢ç§¯</label>
                            <div class="input-wrapper">
                                <input type="number" id="auto_landArea" value="60">
                                <span class="suffix">ã¡</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>åœŸåœ°å…¬å…è¯„ä¼°åŸºç¡€ä»·ï¼ˆå¦‚ï¼šè·¯çº¿ä»·ï¼‰
                                <span class="tooltip-container">
                                    <span class="tooltip-icon">â„¹ï¸</span>
                                    <span class="tooltip-content">è¯·å¡«å…¥ä»å›½ç¨å…è·¯çº¿ä»·å›¾ä¸ŠæŸ¥åˆ°çš„åœ°å—ä»·æ ¼ï¼ˆå††/ã¡ï¼‰ã€‚å·¥å…·å°†è‡ªåŠ¨ä»£å…¥å¸‚åœºä¿®æ­£ç³»æ•° (Ã—1.25) è¿›è¡Œä¼°ç®—ã€‚</span>
                                </span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" id="auto_landBasePrice" value="500000" step="1000">
                                <span class="suffix">å††/ã¡</span>
                            </div>
                        </div>
                    </div>

                    <div class="auto-box">
                        <span class="auto-title">ğŸ  å»ºç‰©å‚æ•° (ä¼°ç®—æƒé‡)</span>
                        <div class="form-row">
                            <label>å»ºç‰©é¢ç§¯</label>
                            <div class="input-wrapper">
                                <input type="number" id="auto_buildArea" value="120">
                                <span class="suffix">ã¡</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div>
            <div class="result-header">
                <div class="dep-period-display">
                    <div class="val" id="res_depYears">0</div>
                    <div class="label">ç®€ä¾¿æ³•æŠ˜æ—§æœŸ</div>
                </div>
                
                <div style="text-align:right;">
                    <div style="font-size:0.9rem; opacity:0.8;">å‰ 5 å¹´ç´¯è®¡èŠ‚ç¨é¢</div>
                    <div class="big-number" id="res_totalTaxSave">0 ä¸‡å††</div>
                    <div style="font-size:0.85rem; margin-top:5px;">
                        é¦–å¹´æŠ˜æ—§é¢: <span id="res_year1Dep" style="color:#fbbf24; font-weight:bold;">0</span> ä¸‡å††
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š èµ„äº§æ‹†åˆ†è¯¦æƒ…</h2>
                
                <div class="ratio-bar">
                    <div id="bar_land" class="rb-land" style="width:50%">åœŸåœ°</div>
                    <div id="bar_build" class="rb-build" style="width:50%">å»ºç‰©</div>
                </div>

                <table class="data-table">
                    <tr>
                        <th>å»ºç‰©ä»·æ ¼ (å¯æŠ˜æ—§)</th>
                        <td style="font-weight:bold; color:var(--primary);" id="res_buildPrice">0 ä¸‡å††</td>
                    </tr>
                    <tr>
                        <th>åœŸåœ°ä»·æ ¼ (ä¸å¯æŠ˜æ—§)</th>
                        <td id="res_landPrice">0 ä¸‡å††</td>
                    </tr>
                    <tr>
                        <th>ä»·å€¼å æ¯”</th>
                        <td id="res_ratio">--</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h2>ğŸ“… 5å¹´èŠ‚ç¨æ¨¡æ‹Ÿ</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="text-align:left;">å¹´åº¦</th>
                            <th>æŠ˜æ—§é¢ (æŸé‡‘)</th>
                            <th>èŠ‚ç¨ (ç°é‡‘æµ)</th>
                        </tr>
                    </thead>
                    <tbody id="schedule_body">
                        </tbody>
                </table>
                <div class="hint" style="margin-top:10px; text-align:center;">
                    * é¦–å¹´æŒ‰æœˆå‰²è®¡ç®—ã€‚å‡è®¾å…¬å¸åˆ©æ¶¦è¶³ä»¥æŠµæ‰£æŠ˜æ—§é¢ã€‚
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- é…ç½®ä¸å¸¸é‡ ---
    const CONFIG = {
        unitCost: { wood: 220000, steel: 280000, rc: 380000 }, // å»ºé€ æˆæœ¬ å††/m2
        life: { wood: 22, steel: 27, rc: 47 }, // æ³•å®šè€ç”¨å¹´æ•°
        LAND_MARKET_FACTOR: 1.25, // å¸‚åœºä¿®æ­£ç³»æ•° (è·¯çº¿ä»·é€šå¸¸æ˜¯å¸‚åœºä»·çš„80%, æ•…ä¹˜1/0.8=1.25)
    };

    let currentMode = 'manual';

    // --- 1. åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š ---
    document.addEventListener('DOMContentLoaded', () => {
        // ç»‘å®šæ‰€æœ‰è¾“å…¥æ¡†çš„ input/change äº‹ä»¶ï¼Œè§¦å‘å…¨å±€è®¡ç®—
        const allInputs = document.querySelectorAll('input, select');
        allInputs.forEach(el => {
            el.addEventListener('input', calculateAll);
            el.addEventListener('change', calculateAll);
        });
        calculateAll();
    });

    // --- 2. æ¨¡å¼åˆ‡æ¢ ---
    window.switchMode = function(mode) {
        currentMode = mode;
        
        document.getElementById('btn-mode-manual').className = mode === 'manual' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('btn-mode-auto').className = mode === 'auto' ? 'tab-btn active' : 'tab-btn';

        if (mode === 'manual') {
            document.getElementById('panel-manual').classList.remove('hidden');
            document.getElementById('panel-auto').classList.add('hidden');
        } else {
            document.getElementById('panel-manual').classList.add('hidden');
            document.getElementById('panel-auto').classList.remove('hidden');
        }

        calculateAll();
    }

    // --- 3. æ ¸å¿ƒè®¡ç®—é€»è¾‘ ---
    function calculateAll() {
        // A. è¯»å–å…¬å…±å‚æ•° (ä½¿ç”¨ safeFloat é˜²æ­¢ NaN)
        const structure = document.getElementById('common_structure').value;
        const age = safeFloat(document.getElementById('common_age').value);
        const fiscalMonth = parseInt(document.getElementById('common_fiscalMonth').value);
        const purchaseMonth = parseInt(document.getElementById('common_purchaseMonth').value);
        const taxRate = safeFloat(document.getElementById('common_taxRate').value) / 100;

        let finalLandPrice = 0;
        let finalBuildPrice = 0;

        // B. æ ¹æ®æ¨¡å¼ç¡®å®š Land/Build ä»·æ ¼
        if (currentMode === 'manual') {
            finalLandPrice = safeFloat(document.getElementById('man_landPrice').value);
            finalBuildPrice = safeFloat(document.getElementById('man_buildPrice').value);
            
            document.getElementById('man_total_display').innerText = (finalLandPrice + finalBuildPrice).toLocaleString();

        } else {
            // è‡ªåŠ¨æ¨¡å¼ï¼šä¼°ç®—é€»è¾‘
            const totalPrice = safeFloat(document.getElementById('auto_totalPrice').value);
            const landArea = safeFloat(document.getElementById('auto_landArea').value);
            const buildArea = safeFloat(document.getElementById('auto_buildArea').value);
            const landBasePrice = safeFloat(document.getElementById('auto_landBasePrice').value); // å††/m2

            // 1. åœŸåœ°ä¼°å€¼ (æŒ‰å¸‚åœºå…¬å…ä»·ä¼°ç®—)
            // (åŸºç¡€ä»· å††/m2 * åœŸåœ°é¢ç§¯ m2 * å¸‚åœºä¿®æ­£ç³»æ•°) / 10000 = ä¸‡å††
            const landVal = (landArea * landBasePrice * CONFIG.LAND_MARKET_FACTOR) / 10000; 

            // 2. å»ºç‰©ä¼°å€¼ (å†è°ƒè¾¾æˆæœ¬æ³•)
            const unitCost = CONFIG.unitCost[structure];
            const statLife = CONFIG.life[structure];
            const physLife = statLife * 1.5; 
            let remainRate = 1 - (age / physLife);
            if (remainRate < 0.1) remainRate = 0.1; // ä¿åº•10%
            
            const buildVal = (buildArea * unitCost * remainRate) / 10000; // ä¸‡å††

            // 3. è®¡ç®—æƒé‡æ¯”ä¾‹å¹¶åº”ç”¨åˆ°æ€»ä»·
            const totalVal = landVal + buildVal;
            let buildRatio = 0;
            if (totalVal > 0) {
                buildRatio = buildVal / totalVal;
            }

            finalBuildPrice = totalPrice * buildRatio;
            finalLandPrice = totalPrice * (1 - buildRatio);
        }

        // C. æ›´æ–°ç»“æœæ˜¾ç¤º (æ‹†åˆ†éƒ¨åˆ†)
        updateSplitResult(finalLandPrice, finalBuildPrice);

        // D. è®¡ç®—æŠ˜æ—§è¡¨
        calculateDepreciation(finalBuildPrice, structure, age, fiscalMonth, purchaseMonth, taxRate);
    }

    function updateSplitResult(land, build) {
        const total = land + build;
        const landPct = total > 0 ? (land / total * 100) : 0;
        const buildPct = total > 0 ? (build / total * 100) : 0;

        document.getElementById('res_landPrice').innerText = Math.round(land).toLocaleString() + " ä¸‡å††";
        document.getElementById('res_buildPrice').innerText = Math.round(build).toLocaleString() + " ä¸‡å††";
        document.getElementById('res_ratio').innerText = `åœŸåœ° ${landPct.toFixed(1)}% : å»ºç‰© ${buildPct.toFixed(1)}%`;

        document.getElementById('bar_land').style.width = landPct + "%";
        document.getElementById('bar_land').innerText = landPct > 10 ? `åœŸåœ° ${Math.round(landPct)}%` : "";
        
        document.getElementById('bar_build').style.width = buildPct + "%";
        document.getElementById('bar_build').innerText = buildPct > 10 ? `å»ºç‰© ${Math.round(buildPct)}%` : "";
    }

    function calculateDepreciation(price, structure, age, fiscalMonth, purchaseMonth, taxRate) {
        if (price <= 0 || taxRate <= 0) {
            clearTable();
            return;
        }

        // 1. ç¡®å®šè€ç”¨å¹´æ•° (ç®€ä¾¿æ³•)
        const statLife = CONFIG.life[structure];
        let depYears;
        if (age >= statLife) {
            depYears = Math.floor(statLife * 0.2);
        } else {
            depYears = Math.floor((statLife - age) + (age * 0.2));
        }
        if (depYears < 2) depYears = 2; // æœ€å°ä¸¤å¹´

        document.getElementById('res_depYears').innerText = depYears; // çªå‡ºæ˜¾ç¤º

        // 2. è®¡ç®—ç¬¬ä¸€å¹´æŠ˜æ—§æœˆæ•°
        let monthsYear1;
        if (purchaseMonth <= fiscalMonth) {
            monthsYear1 = fiscalMonth - purchaseMonth + 1;
        } else {
            monthsYear1 = (12 - purchaseMonth + 1) + fiscalMonth;
        }

        // 3. ç”Ÿæˆè¡¨æ•°æ®
        let html = "";
        let totalTaxSave = 0;
        let year1Dep = 0;
        const annualDep = price / depYears; // æ»¡é¢å¹´æŠ˜æ—§

        // æ¨¡æ‹Ÿ 5 å¹´
        for (let i = 1; i <= 5; i++) {
            let currentDep = 0;
            
            if (i === 1) {
                // ç¬¬ä¸€å¹´æŒ‰æœˆå‰²
                currentDep = annualDep * (monthsYear1 / 12);
                year1Dep = currentDep;
            } else if (i <= depYears) {
                // ä¸­é—´å¹´ä»½æ»¡é¢
                currentDep = annualDep;
            } else if (i === depYears + 1) {
                // è¡¥é½å‰©ä½™ (å¦‚æœç¬¬ä¸€å¹´æ²¡æœ‰ææ»¡ï¼Œæœ€åä¸€å¹´å¯èƒ½éœ€è¦è¡¥è¶³)
                const totalDepreciatedMonths = (i - 2) * 12 + monthsYear1;
                const totalMonthsAvailable = depYears * 12;
                
                if (totalDepreciatedMonths < totalMonthsAvailable) {
                    let remainMonths = totalMonthsAvailable - totalDepreciatedMonths;
                    if (remainMonths > 12) remainMonths = 12;
                    currentDep = annualDep * (remainMonths / 12);
                }
            }

            const taxSave = currentDep * taxRate;
            totalTaxSave += taxSave;

            html += `
                <tr class="${i===1 ? 'first-year-row' : ''}">
                    <td>ç¬¬ ${i} å¹´</td>
                    <td>${Math.round(currentDep).toLocaleString()} ä¸‡</td>
                    <td style="color:${taxSave>0 ? '#10b981' : 'inherit'}">+${Math.round(taxSave).toLocaleString()} ä¸‡</td>
                </tr>
            `;
        }

        document.getElementById('schedule_body').innerHTML = html;
        document.getElementById('res_totalTaxSave').innerText = Math.round(totalTaxSave).toLocaleString() + " ä¸‡å††";
        document.getElementById('res_year1Dep').innerText = Math.round(year1Dep).toLocaleString();
    }

    // --- è¾…åŠ©ï¼šå®‰å…¨è§£ææµ®ç‚¹æ•° ---
    function safeFloat(val) {
        const f = parseFloat(val);
        return isNaN(f) ? 0 : f;
    }

    function clearTable() {
        document.getElementById('schedule_body').innerHTML = "<tr><td colspan='3' style='text-align:center'>è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢æˆ–ç¨ç‡</td></tr>";
        document.getElementById('res_totalTaxSave').innerText = "0 ä¸‡å††";
        document.getElementById('res_year1Dep').innerText = "0";
        document.getElementById('res_depYears').innerText = "0";
    }
</script>

</body>
</html>
