<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®—å·¥å…· | è˜‡çš„å·¥å…·ç®±</title>
    <style>
        /* --- V8.0 é…è‰²ç³»ç»Ÿ (ä¿æŒ V7 çš„é«˜çº§æ„Ÿ) --- */
        :root {
            --primary: #334155; --primary-light: #475569; --accent: #0284c7;        
            --bg-body: #f1f5f9; --bg-card: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b; --border: #e2e8f0;
            --success: #059669; --neutral: #94a3b8; --warning: #d97706;
        }
        
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-body); color: var(--text-main); padding: 20px; margin: 0; line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 1024px; margin: 0 auto; width: 100%; flex: 1; }

        /* --- Header --- */
        header { text-align: center; margin-bottom: 30px; padding-top: 10px; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 800; }
        .subtitle-link { display: inline-block; margin-top: 6px; font-size: 0.9rem; color: var(--text-sub); text-decoration: none; border-bottom: 1px dashed transparent; transition: all 0.2s; }
        .subtitle-link:hover { color: var(--accent); border-bottom-color: var(--accent); }

        /* --- Layout --- */
        .grid-layout { display: grid; gap: 24px; grid-template-columns: 1fr; }
        @media(min-width: 850px) { .grid-layout { grid-template-columns: 420px 1fr; } }
        .card { background: var(--bg-card); padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid var(--border); }
        h2 { font-size: 0.95rem; border-bottom: 2px solid var(--bg-body); padding-bottom: 12px; margin: 0 0 20px 0; color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: space-between; }

        /* --- Tabs --- */
        .mode-tabs { display: flex; background: var(--bg-body); border-radius: 8px; padding: 4px; }
        .tab-btn { flex: 1; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: var(--text-sub); background: transparent; transition: all 0.2s; }
        .tab-btn.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* --- Forms --- */
        .form-row { margin-bottom: 18px; }
        label { display: flex; align-items: center; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--primary-light); }
        .input-group { position: relative; display: flex; align-items: center; flex: 1; }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; background: #fff; transition: border-color 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
        .suffix { position: absolute; right: 12px; color: #94a3b8; font-size: 0.85rem; pointer-events: none; }
        
        /* Auto Box & Custom Inputs */
        .auto-box { background: #f8fafc; border: 1px dashed var(--border); padding: 16px; border-radius: 8px; margin-top: 12px; }
        .auto-title { color: var(--accent); font-size: 0.75rem; font-weight: 700; margin-bottom: 12px; display: block; }
        
        /* éšè—çš„è‡ªå®šä¹‰è¾“å…¥æ¡†æ ·å¼ */
        .custom-input-row { margin-top: 8px; display: flex; align-items: center; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Tooltip (Click/Hover Hybrid) --- */
        .tooltip-wrap { position: relative; display: inline-flex; margin-left: 6px; cursor: pointer; }
        .tooltip-icon { color: var(--accent); font-size: 0.9rem; opacity: 0.7; transition: 0.2s; }
        .tooltip-wrap:hover .tooltip-icon, .tooltip-wrap.active .tooltip-icon { opacity: 1; scale: 1.1; }
        
        .tooltip-content {
            display: none; position: absolute; width: 280px; background-color: rgba(15, 23, 42, 0.98);
            color: #fff; text-align: left; border-radius: 8px; padding: 14px; z-index: 200;
            bottom: 150%; left: 50%; transform: translateX(-50%);
            font-size: 0.8rem; line-height: 1.5; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); font-weight: normal;
        }
        .tooltip-content.show { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(5px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: rgba(15, 23, 42, 0.98) transparent transparent transparent;
        }
        .tooltip-content a { color: #38bdf8; font-weight: bold; text-decoration: none; border-bottom: 1px solid #38bdf8; }

        /* --- Result Dashboard --- */
        .result-dashboard { background: var(--primary); color: white; padding: 24px; border-radius: 12px; text-align: center; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .res-badge { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .res-badge .val { font-size: 1.8rem; font-weight: 700; color: #38bdf8; line-height: 1.2; }
        .res-badge .lbl { font-size: 0.75rem; opacity: 0.8; }
        .res-main { text-align: right; }
        .res-main .amount { font-size: 2rem; font-weight: 700; color: #fbbf24; }
        .res-main .desc { font-size: 0.85rem; opacity: 0.8; }

        /* --- Draggable Ratio Bar --- */
        .ratio-bar-container { margin: 20px 0; position: relative; user-select: none; padding-top: 10px; padding-bottom: 10px; }
        .ratio-bar { display: flex; height: 36px; border-radius: 6px; overflow: hidden; background: var(--bg-body); position: relative; }
        
        /* æ‹–æ‹½æ‰‹æŸ„æ ·å¼å¢å¼º */
        .drag-handle {
            position: absolute; top: 10px; bottom: 10px; width: 20px; margin-left: -10px;
            cursor: col-resize; z-index: 10; display: none;
            align-items: center; justify-content: center;
        }
        /* ä»…åœ¨æ¿€æ´»æ¨¡å¼ä¸‹æ˜¾ç¤ºæ‰‹æŸ„ */
        .ratio-bar-container.draggable:hover .drag-handle, 
        .ratio-bar-container.draggable .drag-handle.dragging { display: flex; }
        
        .drag-line { width: 4px; height: 100%; background: white; border-radius: 2px; box-shadow: 0 0 4px rgba(0,0,0,0.3); border: 1px solid var(--text-sub); }

        .rb-seg { display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .rb-build { background: var(--success); }
        .rb-land { background: var(--neutral); }
        
        .ratio-legend { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 6px; font-weight: 500;}

        /* --- Table --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--text-sub); font-weight: 600; padding: 12px 8px; border-bottom: 1px solid var(--border); font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 12px 8px; border-bottom: 1px solid var(--bg-body); text-align: right; }
        td:first-child { text-align: left; color: var(--text-sub); font-weight: 500; }
        .row-highlight { background-color: #f0fdf4; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 900px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .close-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }
        .btn-full-sim { width: 100%; padding: 12px; background: white; border: 1px solid var(--accent); color: var(--accent); font-weight: 600; border-radius: 8px; cursor: pointer; margin-top: 15px; transition: all 0.2s; }
        .btn-full-sim:hover { background: #f0f9ff; }

        footer { text-align: center; font-size: 0.8rem; color: var(--text-sub); padding: 40px 0 20px; border-top: 1px solid var(--border); margin-top: auto; opacity: 0.8; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>æ—¥æœ¬ä¸åŠ¨äº§èŠ‚ç¨æµ‹ç®—å·¥å…·</h1>
        <a href="https://c1211tokyo.github.io/tool/" class="subtitle-link">è˜‡çš„å·¥å…·ç®±</a>
    </header>

    <div class="grid-layout">
        <div>
            <div class="card" style="padding: 6px;">
                <div class="mode-tabs">
                    <button id="btn-mode-manual" class="tab-btn active" onclick="app.switchMode('manual')">A: å·²çŸ¥æ‹†åˆ†</button>
                    <button id="btn-mode-auto" class="tab-btn" onclick="app.switchMode('auto')">B: ä¼°ç®—æ¯”ä¾‹</button>
                    <button id="btn-mode-fixed" class="tab-btn" onclick="app.switchMode('fixed')">C: å›ºéƒ½ç¨è¯„ä¼°</button>
                </div>
            </div>

            <div class="card">
                <h2>âš™ï¸ åŸºç¡€ç¨åŠ¡è®¾å®š</h2>
                
                <div class="form-row">
                    <label>å»ºç­‘æ„é€ 
                        <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <div class="tooltip-content">
                                <b>æ³•å®šè€ç”¨å¹´æ•°ï¼š</b><br>â€¢ RC(é’¢ç­‹æ··å‡åœŸ): 47å¹´<br>â€¢ è½»é’¢: 27å¹´<br>â€¢ æœ¨é€ : 22å¹´
                            </div>
                        </div>
                    </label>
                    <select id="s_structure">
                        <option value="wood">ğŸŒ² æœ¨é€  (æ³•å®š22å¹´)</option>
                        <option value="steel">ğŸ¢ è½»é’¢ (æ³•å®š27å¹´)</option>
                        <option value="rc" selected>ğŸ™ RC/SRC (æ³•å®š47å¹´)</option>
                    </select>
                </div>

                <div class="form-row">
                    <label>ç­‘å¹´æ•°
                        <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <div class="tooltip-content">
                                <b>ç®€ä¾¿æ³•æŠ˜æ—§å¹´æ•°è®¡ç®—ï¼š</b><br>1. ç­‘å¹´ â‰¥ æ³•å®š: æ³•å®š Ã— 0.2<br>2. ç­‘å¹´ < æ³•å®š: (æ³•å®š-ç­‘å¹´) + ç­‘å¹´Ã—0.2
                            </div>
                        </div>
                    </label>
                    <div class="input-group">
                        <input type="number" id="s_age" value="25" min="0">
                        <span class="suffix">å¹´</span>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                    <div class="form-row">
                        <label>å†³ç®—æœˆ / ä¹°å…¥æœˆ
                            <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                                <span class="tooltip-icon">â„¹ï¸</span>
                                <div class="tooltip-content">ç”¨äºç²¾ç¡®è®¡ç®—<b>ç¬¬ä¸€å¹´</b>å¯è®¡å…¥æŸé‡‘çš„æœˆæ•°ï¼ˆæŒ‰æœˆå‰²ï¼‰ã€‚</div>
                            </div>
                        </label>
                        <div style="display:flex; gap:10px;">
                            <select id="s_fiscalMonth"></select>
                            <select id="s_buyMonth"></select>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label>æ³•äººæœ‰æ•ˆç¨ç‡</label>
                    <div class="input-group">
                        <input type="number" id="s_taxRate" value="33.0" step="0.1">
                        <span class="suffix">%</span>
                    </div>
                </div>

                <div class="form-row">
                    <label>æŠ˜æ—§æ–¹æ³•
                        <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                            <span class="tooltip-icon">â„¹ï¸</span>
                            <div class="tooltip-content">
                                â€¢ <b>ç®€ä¾¿æ³•</b>: ä¸­å¤æˆ¿é¦–é€‰ï¼Œå›æ¬¾å¿«ã€‚<br>
                                â€¢ <b>å®šç‡æ³•</b>: å‰æœŸæŠ˜æ—§æé«˜ï¼Œé€‚åˆæ–°æˆ¿/è®¾å¤‡ã€‚<br>
                                â€¢ <b>ç›´çº¿æ³•</b>: æ¯å¹´å¹³æ‘Šã€‚
                            </div>
                        </div>
                    </label>
                    <div style="display:flex; gap:10px;">
                        <select id="s_method" style="flex:1;">
                            <option value="simplified">ç®€ä¾¿æ³• (æ¨è)</option>
                            <option value="straight">ç›´çº¿æ³•</option>
                            <option value="rate">å®šç‡æ³•</option>
                        </select>
                        <div class="input-group hidden" id="grp_depRate" style="width: 100px;">
                            <input type="number" id="s_depRate" value="0.043" step="0.001" placeholder="ç‡">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ’° ä»·æ ¼ä¸ä¼°å€¼</h2>

                <div id="panel-manual">
                    <div class="form-row">
                        <label>åœŸåœ°ä»·æ ¼ (åˆåŒ)</label>
                        <div class="input-group"><input type="number" id="m_landPrice" value="4500"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    <div class="form-row">
                        <label>å»ºç‰©ä»·æ ¼ (åˆåŒ)</label>
                        <div class="input-group"><input type="number" id="m_buildPrice" value="3500"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                </div>

                <div id="panel-auto" class="hidden">
                    <div class="form-row">
                        <label>äº¤æ˜“æ€»ä»·</label>
                        <div class="input-group"><input type="number" id="a_totalPrice" value="8000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                    
                    <div class="auto-box">
                        <span class="auto-title">ğŸ“ åœŸåœ°å‚æ•°</span>
                        <div class="form-row">
                            <label>åœŸåœ°é¢ç§¯ / è·¯çº¿ä»·
                                <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                                    <span class="tooltip-icon">â„¹ï¸</span>
                                    <div class="tooltip-content">
                                        <a href="https://www.rosenka.nta.go.jp/" target="_blank">ğŸ”— å›½ç¨å…è·¯çº¿ä»·æŸ¥è¯¢</a><br>
                                        æ³¨æ„ï¼šå•ä½ä¸º<b>ä¸‡å††</b> (ä¾‹: 500C = 50ä¸‡)
                                    </div>
                                </div>
                            </label>
                            <div style="display:flex; gap:10px;">
                                <div class="input-group"><input type="number" id="a_landArea" value="60"><span class="suffix">ã¡</span></div>
                                <div class="input-group"><input type="number" id="a_rosenka" value="50" step="1"><span class="suffix">ä¸‡/ã¡</span></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>å¸‚åœºä¿®æ­£ç³»æ•°
                                <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                                    <span class="tooltip-icon">â„¹ï¸</span>
                                    <div class="tooltip-content">è·¯çº¿ä»·è½¬å¸‚åœºä»·çš„å€ç‡ã€‚<br>æ ‡å‡†æ¨è 1.40ã€‚</div>
                                </div>
                            </label>
                            <select id="a_factor">
                                <option value="1.25">1.25 (ä¿å®ˆ)</option>
                                <option value="1.40" selected>1.40 (æ ‡å‡†)</option>
                                <option value="1.60">1.60 (ç§¯æ)</option>
                                <option value="custom">è‡ªå®šä¹‰...</option>
                            </select>
                            <div class="input-group hidden custom-input-row" id="grp_factor_custom">
                                <input type="number" id="a_factor_custom" value="1.50" step="0.01" placeholder="è¾“å…¥ç³»æ•° (å¦‚ 1.55)">
                            </div>
                        </div>
                    </div>

                    <div class="auto-box">
                        <span class="auto-title">ğŸ  å»ºç‰©å‚æ•°</span>
                        <div class="form-row">
                            <label>å»ºç‰©é¢ç§¯</label>
                            <div class="input-group"><input type="number" id="a_buildArea" value="120"><span class="suffix">ã¡</span></div>
                        </div>
                        <div class="form-row">
                            <label>å»ºé€ å•ä»· (2025å‚è€ƒ)
                                <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                                    <span class="tooltip-icon">â„¹ï¸</span>
                                    <div class="tooltip-content">å†è°ƒè¾¾æˆæœ¬å‚è€ƒã€‚<br>RCæ ‡å‡†: 43ä¸‡/ã¡</div>
                                </div>
                            </label>
                            <select id="a_unitCost">
                                <option value="25">æœ¨é€  (25ä¸‡)</option>
                                <option value="32">è½»é’¢ (32ä¸‡)</option>
                                <option value="43" selected>RC (43ä¸‡)</option>
                                <option value="custom">è‡ªå®šä¹‰...</option>
                            </select>
                            <div class="input-group hidden custom-input-row" id="grp_unitCost_custom">
                                <input type="number" id="a_unitCost_custom" value="45" step="1" placeholder="è¾“å…¥å•ä»· (ä¸‡å††/ã¡)">
                                <span class="suffix">ä¸‡/ã¡</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-fixed" class="hidden">
                    <div class="form-row">
                        <label>å›ºéƒ½ç¨è¯„ä¼°é¢ (åœŸåœ°/å»ºç‰©)
                            <div class="tooltip-wrap" onclick="tooltip.toggle(this)">
                                <span class="tooltip-icon">â„¹ï¸</span>
                                <div class="tooltip-content">å‚è€ƒæ¯å¹´çº³ç¨é€šçŸ¥ä¹¦ä¸Šçš„<b>å›ºå®šèµ„äº§è¯„ä»·é¢</b>ã€‚<br>æ­¤æ¨¡å¼ä¸‹ä¹Ÿ<b>æ”¯æŒæ‹–æ‹½è°ƒæ•´</b>æœ€ç»ˆæ¯”ä¾‹ï¼</div>
                            </div>
                        </label>
                        <div style="display:flex; gap:10px;">
                            <div class="input-group"><input type="number" id="f_land" value="3000"><span class="suffix">åœŸ(ä¸‡)</span></div>
                            <div class="input-group"><input type="number" id="f_build" value="2000"><span class="suffix">å»º(ä¸‡)</span></div>
                        </div>
                    </div>
                    <div class="form-row" style="margin-top:12px;">
                        <label>å®é™…äº¤æ˜“æ€»ä»·</label>
                        <div class="input-group"><input type="number" id="f_totalPrice" value="8000"><span class="suffix">ä¸‡å††</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="result-dashboard">
                <div class="res-badge">
                    <div class="val" id="out_years">--</div>
                    <div class="lbl">æŠ˜æ—§å¹´æ•°</div>
                </div>
                <div class="res-main">
                    <div class="desc">å‰5å¹´ç´¯è®¡èŠ‚ç¨</div>
                    <div class="amount" id="out_totalSave">--</div>
                    <div class="desc" style="margin-top:5px; color:#e2e8f0;">é¦–å¹´æŠ˜æ—§: <span id="out_year1" style="color:#fbbf24; font-weight:bold;">--</span> ä¸‡</div>
                </div>
            </div>

            <div class="card">
                <h2>
                    ğŸ“Š æ‹†åˆ†è¯¦æƒ…
                    <span style="font-size:0.75rem; font-weight:normal; color:var(--neutral); margin-left:10px;">
                        (å¯æ‹–æ‹½å¾®è°ƒ <span style="font-size:1rem">â†”</span>)
                    </span>
                </h2>
                
                <div class="ratio-bar-container draggable" id="ratioContainer">
                    <div class="ratio-bar">
                        <div id="bar_build" class="rb-seg rb-build" style="width: 50%"></div>
                        <div id="bar_land" class="rb-seg rb-land" style="width: 50%"></div>
                    </div>
                    <div class="drag-handle" id="dragHandle"><div class="drag-line"></div></div>
                    
                    <div class="ratio-legend">
                        <span id="txt_build_ratio" style="color:var(--success)">å»ºç‰©: --%</span>
                        <span id="txt_land_ratio" style="color:var(--text-sub)">åœŸåœ°: --%</span>
                    </div>
                </div>

                <table>
                    <tr>
                        <th style="color:var(--success)">å»ºç‰© (å¯æŠ˜æ—§)</th>
                        <td style="font-weight:700; color:var(--success); font-size:1.1rem;" id="out_buildPrice">--</td>
                    </tr>
                    <tr>
                        <th>åœŸåœ° (ä¸å¯æŠ˜æ—§)</th>
                        <td id="out_landPrice">--</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h2>ğŸ“… 5å¹´æ¨¡æ‹Ÿè¡¨</h2>
                <table>
                    <thead>
                        <tr>
                            <th>å¹´åº¦</th>
                            <th>æŠ˜æ—§ (æŸé‡‘)</th>
                            <th>èŠ‚ç¨ (ç°é‡‘)</th>
                        </tr>
                    </thead>
                    <tbody id="out_table_body"></tbody>
                </table>
                <button class="btn-full-sim" onclick="app.showFullModal()">ğŸ” æŸ¥çœ‹å®Œæ•´æŠ˜æ—§è¡¨ (å…¨å‘¨æœŸ)</button>
            </div>
        </div>
    </div>

    <footer>è˜‡çš„å·¥å…·ç®± Â· SUYU.2025</footer>
</div>

<div class="modal-overlay" id="fullModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å®Œæ•´æŠ˜æ—§è®¡åˆ’è¡¨</h3>
            <button class="close-btn" onclick="app.closeFullModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <table>
                <thead>
                    <tr>
                        <th>å¹´åº¦</th>
                        <th>æŠ˜æ—§é¢</th>
                        <th>èŠ‚ç¨é¢</th>
                        <th>æœŸæœ«è´¦é¢ä»·å€¼</th>
                    </tr>
                </thead>
                <tbody id="full_table_body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- V8.0 Controller ---

const tooltip = {
    active: null,
    toggle(el) {
        const content = el.querySelector('.tooltip-content');
        if (!content) return;
        if (this.active === content) { this.close(); return; }
        if (this.active) this.active.classList.remove('show');
        content.classList.add('show');
        this.active = content;
        event.stopPropagation();
    },
    close() {
        if (this.active) { this.active.classList.remove('show'); this.active = null; }
    },
    init() {
        document.addEventListener('click', (e) => {
            if (this.active && !e.target.closest('.tooltip-content')) this.close();
        });
        document.querySelectorAll('.tooltip-content').forEach(el => el.addEventListener('click', e => e.stopPropagation()));
    }
};

const dragger = {
    isDragging: false,
    init() {
        const c = document.getElementById('ratioContainer');
        const h = document.getElementById('dragHandle');
        
        const start = (e) => {
            // Mode B ä¸æ”¯æŒæ‹–æ‹½ (å› ä¸ºå®ƒæ˜¯çº¯ä¼°ç®—)
            if (app.state.mode === 'auto') return;
            this.isDragging = true; 
            h.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            e.preventDefault(); 
        };
        const move = (e) => {
            if (!this.isDragging) return;
            const rect = c.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let pct = (clientX - rect.left) / rect.width;
            if (pct < 0.05) pct = 0.05; if (pct > 0.95) pct = 0.95;
            app.handleDrag(pct);
        };
        const end = () => { 
            this.isDragging = false; 
            h.classList.remove('dragging');
            document.body.style.cursor = 'default'; 
        };

        h.addEventListener('mousedown', start);
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
        h.addEventListener('touchstart', start);
        document.addEventListener('touchmove', move);
        document.addEventListener('touchend', end);
    }
};

const app = {
    config: { life: { wood: 22, steel: 27, rc: 47 } },
    state: { mode: 'manual', fullData: [] },

    init() {
        this.fillMonths();
        tooltip.init();
        dragger.init();
        
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(el => {
            el.addEventListener('input', () => this.calc());
            el.addEventListener('change', () => this.calc());
        });

        // ç»‘å®š Custom æ˜¾ç¤ºé€»è¾‘
        document.getElementById('a_factor').addEventListener('change', (e) => {
            document.getElementById('grp_factor_custom').classList.toggle('hidden', e.target.value !== 'custom');
            this.calc();
        });
        document.getElementById('a_unitCost').addEventListener('change', (e) => {
            document.getElementById('grp_unitCost_custom').classList.toggle('hidden', e.target.value !== 'custom');
            this.calc();
        });
        document.getElementById('s_method').addEventListener('change', (e) => {
            document.getElementById('grp_depRate').classList.toggle('hidden', e.target.value !== 'rate');
            this.calc();
        });

        this.calc();
    },

    fillMonths() {
        const opts = Array.from({length: 12}, (_, i) => `<option value="${i+1}">${i+1}æœˆ</option>`).join('');
        document.getElementById('s_fiscalMonth').innerHTML = opts;
        document.getElementById('s_buyMonth').innerHTML = opts;
        document.getElementById('s_fiscalMonth').value = "3";
        document.getElementById('s_buyMonth').value = "4";
    },

    switchMode(mode) {
        this.state.mode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-mode-${mode}`).classList.add('active');
        ['manual','auto','fixed'].forEach(m => document.getElementById(`panel-${m}`).classList.add('hidden'));
        document.getElementById(`panel-${mode}`).classList.remove('hidden');
        
        // Mode B éšè—æ‰‹æŸ„
        const handle = document.getElementById('dragHandle');
        const container = document.getElementById('ratioContainer');
        if (mode === 'auto') { handle.style.display = 'none'; container.classList.remove('draggable'); }
        else { handle.style.display = 'flex'; container.classList.add('draggable'); }

        this.calc();
    },

    val(id) { const v = parseFloat(document.getElementById(id).value); return isNaN(v) ? 0 : v; },

    // æ‹–æ‹½å›è°ƒï¼šæ ¸å¿ƒé€»è¾‘
    handleDrag(pct) {
        let total = 0;
        if (this.state.mode === 'manual') {
            total = this.val('m_landPrice') + this.val('m_buildPrice');
            if (total <= 0) total = 8000; // default backup
        } else if (this.state.mode === 'fixed') {
            total = this.val('f_totalPrice');
        }

        const newBuild = Math.round(total * pct);
        const newLand = total - newBuild;

        // å¦‚æœæ˜¯ A æ¨¡å¼ï¼Œå›å†™ Input
        if (this.state.mode === 'manual') {
            document.getElementById('m_buildPrice').value = newBuild;
            document.getElementById('m_landPrice').value = newLand;
        } 
        
        // æ— è®º A è¿˜æ˜¯ Cï¼Œéƒ½å¼ºåˆ¶æ›´æ–°è®¡ç®— (Cæ¨¡å¼ä¸‹è¿™ç›¸å½“äºä¸´æ—¶è¦†ç›–äº†å›ºéƒ½ç¨æ¯”ä¾‹)
        this.runCalc(newLand, newBuild);
    },

    calc() {
        const structure = document.getElementById('s_structure').value;
        const age = this.val('s_age');
        
        let land = 0, build = 0;

        if (this.state.mode === 'manual') {
            land = this.val('m_landPrice');
            build = this.val('m_buildPrice');
        } 
        else if (this.state.mode === 'auto') {
            const total = this.val('a_totalPrice');
            // è·å–ç³»æ•° (Check custom)
            let factor = this.val('a_factor');
            if (document.getElementById('a_factor').value === 'custom') factor = this.val('a_factor_custom');
            // è·å–å•ä»· (Check custom)
            let unitCost = this.val('a_unitCost');
            if (document.getElementById('a_unitCost').value === 'custom') unitCost = this.val('a_unitCost_custom');

            const lVal = this.val('a_landArea') * this.val('a_rosenka') * factor;
            
            const statLife = this.config.life[structure];
            let rate = 1 - (age / (statLife * 1.5));
            if (rate < 0.1) rate = 0.1;
            const bVal = this.val('a_buildArea') * unitCost * rate;

            const sum = lVal + bVal;
            if (sum > 0) { build = total * (bVal/sum); land = total * (lVal/sum); }
        }
        else if (this.state.mode === 'fixed') {
            const fLand = this.val('f_land');
            const fBuild = this.val('f_build');
            const realTotal = this.val('f_totalPrice');
            const sum = fLand + fBuild;
            if (sum > 0) { build = realTotal * (fBuild/sum); land = realTotal * (fLand/sum); }
        }

        this.runCalc(land, build);
    },

    // æ ¸å¿ƒè®¡ç®—æ‰§è¡Œè€…
    runCalc(land, build) {
        const structure = document.getElementById('s_structure').value;
        const age = this.val('s_age');
        const method = document.getElementById('s_method').value;
        const taxRate = this.val('s_taxRate') / 100;
        
        this.updateSplitUI(land, build);
        this.generateData(build, structure, age, method, taxRate);
        this.renderTables();
    },

    updateSplitUI(land, build) {
        const total = land + build;
        const bPct = total > 0 ? (build/total)*100 : 0;
        const lPct = 100 - bPct;
        const fmt = (n) => Math.round(n).toLocaleString();

        document.getElementById('out_landPrice').innerText = fmt(land) + " ä¸‡";
        document.getElementById('out_buildPrice').innerText = fmt(build) + " ä¸‡";

        const barB = document.getElementById('bar_build');
        const barL = document.getElementById('bar_land');
        barB.style.width = bPct + "%";
        barL.style.width = lPct + "%";
        
        barB.innerText = bPct > 15 ? fmt(build) : "";
        barL.innerText = lPct > 15 ? fmt(land) : "";
        
        document.getElementById('txt_build_ratio').innerText = `å»ºç‰©: ${bPct.toFixed(1)}%`;
        document.getElementById('txt_land_ratio').innerText = `åœŸåœ°: ${lPct.toFixed(1)}%`;

        // Update handle position
        if (this.state.mode !== 'auto') {
            document.getElementById('dragHandle').style.left = bPct + "%";
        }
    },

    generateData(price, structure, age, method, taxRate) {
        this.state.fullData = [];
        if (price <= 0) return;

        const statLife = this.config.life[structure];
        let years = statLife;
        if (method === 'simplified') {
            years = (age >= statLife) ? Math.floor(statLife*0.2) : Math.floor((statLife-age) + age*0.2);
            if (years < 2) years = 2;
        }
        document.getElementById('out_years').innerText = years + " å¹´";

        const fMonth = parseInt(document.getElementById('s_fiscalMonth').value);
        const bMonth = parseInt(document.getElementById('s_buyMonth').value);
        let m1 = (bMonth <= fMonth) ? (fMonth - bMonth + 1) : ((12 - bMonth + 1) + fMonth);

        const maxDep = price - 1;
        const dbRate = this.val('s_depRate');
        let cur = price, acc = 0;
        
        for (let i = 1; i <= 60; i++) { // Max 60 years calc
            let dep = 0;
            if (method === 'rate') dep = cur * dbRate;
            else dep = price / years;

            if (i === 1) dep = dep * (m1 / 12);
            
            // ç®€ä¾¿/ç›´çº¿åˆ°æœŸåœæ­¢
            if (method !== 'rate' && i > years && i > 1 && acc < maxDep) {
                 // é€šå¸¸åˆ°è¿™é‡Œå·²æŠ˜å®Œï¼Œä½†å¦‚æœæœ‰å°¾æ•°ï¼Œæœ€åä¸€å¹´è¡¥é½? 
                 // ç®€åŒ–å¤„ç†ï¼šä¸å†è®¡æ
                 dep = 0;
            }
            
            if (acc + dep > maxDep) dep = maxDep - acc;
            if (dep < 0) dep = 0;

            acc += dep;
            cur -= dep;
            
            this.state.fullData.push({ y: i, dep: dep, save: dep*taxRate, book: cur });
            if (cur <= 1) break;
        }
    },

    renderTables() {
        const d = this.state.fullData;
        let htmlSmall = "";
        let totalSave = 0;
        
        // Small Table (5 years)
        d.slice(0, 5).forEach(r => {
            totalSave += r.save;
            htmlSmall += `
                <tr class="${r.y===1?'row-highlight':''}">
                    <td>ç¬¬ ${r.y} å¹´</td>
                    <td>${Math.round(r.dep).toLocaleString()} ä¸‡</td>
                    <td style="color:var(--success)">+${Math.round(r.save).toLocaleString()} ä¸‡</td>
                </tr>`;
        });
        document.getElementById('out_table_body').innerHTML = htmlSmall;
        document.getElementById('out_totalSave').innerText = Math.round(totalSave).toLocaleString() + " ä¸‡";
        document.getElementById('out_year1').innerText = d[0] ? Math.round(d[0].dep).toLocaleString() : 0;

        // Full Table
        let htmlFull = "";
        d.forEach(r => {
            htmlFull += `<tr>
                <td>ç¬¬ ${r.y} å¹´</td>
                <td>${Math.round(r.dep).toLocaleString()} ä¸‡</td>
                <td style="color:var(--success)">+${Math.round(r.save).toLocaleString()} ä¸‡</td>
                <td style="color:var(--text-sub)">${Math.round(r.book).toLocaleString()} ä¸‡</td>
            </tr>`;
        });
        document.getElementById('full_table_body').innerHTML = htmlFull;
    },

    showFullModal() { document.getElementById('fullModal').style.display = 'flex'; },
    closeFullModal() { document.getElementById('fullModal').style.display = 'none'; }
};

document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>
