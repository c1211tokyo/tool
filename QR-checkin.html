<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ°‘å®¿å…¥ä½æŒ‡å—</title>
  <style>
    :root { --bg: #111113; --card: #1a1a1d; --blue: #4a7bee; --text: #fff; --sub: #999; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); padding: 16px; line-height: 1.6; }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { text-align: center; font-size: 22px; margin-bottom: 20px; }
    .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid #333; margin-bottom: 16px; }
    label { display: block; color: var(--sub); font-size: 13px; font-weight: 600; margin-top: 16px; }
    label:first-child { margin-top: 0; }
    input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; background: #252528; border: 1px solid #444; border-radius: 10px; color: #fff; font-size: 15px; }
    textarea { resize: none; height: 80px; }
    .btn { width: 100%; padding: 14px; margin-top: 20px; background: var(--blue); border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn:disabled { background: #555; }
    .upload-area { margin-top: 8px; padding: 16px; background: #252528; border: 2px dashed #444; border-radius: 10px; text-align: center; color: var(--sub); cursor: pointer; }
    .upload-area:hover { border-color: var(--blue); }
    .img-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .img-preview .img-item { position: relative; }
    .img-preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    .img-preview .del { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: #e53935; border-radius: 50%; border: none; color: #fff; font-size: 14px; cursor: pointer; line-height: 18px; }
    #qr-result { display: none; background: #fff; border-radius: 16px; padding: 24px; text-align: center; margin-top: 20px; }
    #qr-result p { color: #333; margin: 0; }
    #qrcode { display: flex; justify-content: center; margin: 16px 0; }
    .url-box { background: #f0f0f0; padding: 10px; border-radius: 8px; margin-top: 12px; word-break: break-all; font-size: 12px; color: #666; }
    .copy-url { margin-top: 10px; padding: 10px 20px; background: var(--blue); border: none; border-radius: 8px; color: #fff; cursor: pointer; }
    /* è®¿å®¢æ¨¡å¼ */
    .guest-header { text-align: center; margin-bottom: 24px; }
    .guest-header h1 { margin-bottom: 6px; }
    .guest-header p { color: var(--sub); font-size: 14px; }
    .info-section { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; border: 1px solid #333; }
    .info-title { color: var(--blue); font-weight: 600; font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .info-content { color: #ddd; white-space: pre-wrap; font-size: 14px; }
    .copy-row { display: flex; justify-content: space-between; align-items: center; background: #252528; padding: 10px 14px; border-radius: 10px; margin-bottom: 8px; }
    .copy-row:last-child { margin-bottom: 0; }
    .copy-row span { color: #aaa; font-size: 14px; }
    .copy-row b { color: #fff; }
    .copy-btn { background: rgba(74,123,238,0.2); color: var(--blue); border: none; padding: 6px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .copy-btn.copied { background: #4caf50; color: #fff; }
    .img-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
    .img-grid img { width: 100%; border-radius: 10px; cursor: pointer; }
    .footer-link { text-align: center; margin-top: 30px; }
    .footer-link a { color: #666; font-size: 13px; text-decoration: none; }
    /* çŠ¶æ€é¡µ */
    .status-page { min-height: 80vh; display: flex; align-items: center; justify-content: center; }
    .status-box { background: var(--card); border-radius: 20px; padding: 40px; text-align: center; max-width: 320px; }
    .status-box .icon { font-size: 56px; margin-bottom: 16px; }
    .status-box h2 { font-size: 20px; margin-bottom: 8px; }
    .status-box p { color: var(--sub); margin-bottom: 24px; font-size: 14px; }
    /* å›¾ç‰‡é¢„è§ˆå¼¹çª— */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
    .modal img { max-width: 95%; max-height: 90%; border-radius: 8px; }
    .modal.show { display: flex; }
  </style>
</head>
<body>

<div class="container">
  <!-- ç¼–è¾‘æ¨¡å¼ -->
  <div id="editor-mode" style="display:none">
    <h1>ğŸ› ï¸ å…¥ä½å¡ç”Ÿæˆå™¨</h1>
    <div class="card">
      <label>ğŸ  æˆ¿æºåç§°</label>
      <input id="in_room" value="å®¿æ –æ–°å®¿A" placeholder="ä¾‹å¦‚ï¼šæµ·æ™¯å¤§åºŠæˆ¿ A01">

      <label>ğŸ“¶ WiFi åç§°</label>
      <input id="in_ssid" value="Su_Guest_Wifi">

      <label>ğŸ”‘ WiFi å¯†ç </label>
      <input id="in_pwd" value="88888888">

      <label>ğŸšª å…¥ä½/å¼€é—¨æ–¹å¼</label>
      <textarea id="in_checkin">å¤§é—¨å¯†ç ï¼š1234#
è¿›é—¨åå·¦è½¬ï¼Œé’¥åŒ™åœ¨é‹æŸœä¸Šçš„å¯†ç ç›’é‡Œï¼ˆå¯†ç 0000ï¼‰ã€‚</textarea>

      <label>ğŸ“· å›¾ç‰‡æŒ‡å¼•ï¼ˆæœ€å¤š5å¼ ï¼Œæ¯å¼ â‰¤500KBï¼‰</label>
      <div class="upload-area" onclick="document.getElementById('file-input').click()">+ ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
      <input type="file" id="file-input" accept="image/*" multiple style="display:none" onchange="handleUpload(this)">
      <div class="img-preview" id="img-preview"></div>

      <label>ğŸ“ å…¶ä»–æ³¨æ„äº‹é¡¹</label>
      <textarea id="in_extra">é€€æˆ¿æ—¶é—´ 12:00ã€‚
è¯·å‹¿åœ¨å®¤å†…å¸çƒŸã€‚</textarea>

      <label>â° æœ‰æ•ˆæœŸ</label>
      <select id="in_days">
        <option value="3">3å¤©</option>
        <option value="7" selected>7å¤©</option>
        <option value="14">14å¤©</option>
        <option value="30">30å¤©</option>
        <option value="90">90å¤©</option>
      </select>

      <button class="btn" id="gen-btn" onclick="generateCard()">ç”Ÿæˆå…¥ä½å¡äºŒç»´ç </button>
    </div>

    <div id="qr-result">
      <p><b>ğŸ“± æ‰«ç æŸ¥çœ‹å…¥ä½æŒ‡å—</b></p>
      <div id="qrcode"></div>
      <p style="font-size:12px;color:#888;margin-top:8px">æ”¯æŒï¼šæ‰‹æœºç›¸æœº / æ”¯ä»˜å® / æŠ–éŸ³ç­‰</p>
      <div class="url-box" id="url-box"></div>
      <button class="copy-url" onclick="copyUrl()">å¤åˆ¶é“¾æ¥</button>
    </div>
  </div>

  <!-- è®¿å®¢æ¨¡å¼ -->
  <div id="guest-mode" style="display:none">
    <div class="guest-header">
      <h1 id="v_room"></h1>
      <p>æ¬¢è¿å…¥ä½ï¼Œä»¥ä¸‹æ˜¯æ‚¨çš„å…¥ä½æŒ‡å—</p>
    </div>

    <div class="info-section">
      <div class="info-title">ğŸ“¶ WiFi è¿æ¥</div>
      <div class="copy-row">
        <span>åç§°: <b id="v_ssid"></b></span>
        <button class="copy-btn" onclick="copyText(this,'v_ssid')">å¤åˆ¶</button>
      </div>
      <div class="copy-row">
        <span>å¯†ç : <b id="v_pwd"></b></span>
        <button class="copy-btn" onclick="copyText(this,'v_pwd')">å¤åˆ¶</button>
      </div>
    </div>

    <div class="info-section">
      <div class="info-title">ğŸ”‘ å…¥ä½æ–¹å¼</div>
      <div class="info-content" id="v_checkin"></div>
    </div>

    <div class="info-section" id="img-section" style="display:none">
      <div class="info-title">ğŸ“· å›¾ç‰‡æŒ‡å¼•</div>
      <div class="img-grid" id="v_images"></div>
    </div>

    <div class="info-section">
      <div class="info-title">â„¹ï¸ å…¶ä»–äº‹é¡¹</div>
      <div class="info-content" id="v_extra"></div>
    </div>

    <div class="footer-link">
      <a href="?">æˆ‘ä¹Ÿè¦ç”Ÿæˆå…¥ä½å¡ â†’</a>
    </div>
  </div>

  <!-- è¿‡æœŸé¡µ -->
  <div id="expired-mode" style="display:none">
    <div class="status-page">
      <div class="status-box">
        <div class="icon">â°</div>
        <h2>å…¥ä½å¡å·²è¿‡æœŸ</h2>
        <p>æ­¤å…¥ä½æŒ‡å—å·²è¶…è¿‡æœ‰æ•ˆæœŸ</p>
        <button class="btn" onclick="location.href='?'">åˆ›å»ºæ–°å…¥ä½å¡</button>
      </div>
    </div>
  </div>

  <!-- æœªæ‰¾åˆ°é¡µ -->
  <div id="notfound-mode" style="display:none">
    <div class="status-page">
      <div class="status-box">
        <div class="icon">ğŸ”</div>
        <h2>æœªæ‰¾åˆ°å…¥ä½å¡</h2>
        <p>è¯¥å…¥ä½å¡ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</p>
        <button class="btn" onclick="location.href='?'">åˆ›å»ºæ–°å…¥ä½å¡</button>
      </div>
    </div>
  </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
<div class="modal" id="modal" onclick="this.classList.remove('show')">
  <img id="modal-img" src="">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// ========== é…ç½® ==========
const STORAGE_KEY = 'checkin_cards';
let uploadedImages = [];
let currentUrl = '';

// ========== åˆå§‹åŒ– ==========
window.onload = function() {
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  
  if (id) {
    loadCard(id);
  } else {
    document.getElementById('editor-mode').style.display = 'block';
  }
};

// ========== æœ¬åœ°å­˜å‚¨ ==========
function getStorage() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  } catch { return {}; }
}

function setStorage(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
}

// ========== å›¾ç‰‡ä¸Šä¼  ==========
function handleUpload(input) {
  const files = Array.from(input.files);
  if (uploadedImages.length + files.length > 5) {
    alert('æœ€å¤šä¸Šä¼ 5å¼ å›¾ç‰‡'); return;
  }
  
  files.forEach(file => {
    if (file.size > 500 * 1024) {
      alert('å›¾ç‰‡ ' + file.name + ' è¶…è¿‡500KB'); return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      uploadedImages.push({ name: file.name, data: e.target.result });
      renderPreview();
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function renderPreview() {
  const container = document.getElementById('img-preview');
  container.innerHTML = uploadedImages.map((img, i) => `
    <div class="img-item">
      <img src="${img.data}">
      <button class="del" onclick="removeImg(${i})">Ã—</button>
    </div>
  `).join('');
}

function removeImg(i) {
  uploadedImages.splice(i, 1);
  renderPreview();
}

// ========== ç”Ÿæˆå…¥ä½å¡ ==========
function generateCard() {
  const btn = document.getElementById('gen-btn');
  btn.disabled = true;
  btn.textContent = 'ç”Ÿæˆä¸­...';

  const data = {
    room: document.getElementById('in_room').value,
    ssid: document.getElementById('in_ssid').value,
    pwd: document.getElementById('in_pwd').value,
    checkin: document.getElementById('in_checkin').value,
    extra: document.getElementById('in_extra').value,
    images: uploadedImages,
    days: parseInt(document.getElementById('in_days').value),
    createdAt: Date.now(),
    expiresAt: Date.now() + parseInt(document.getElementById('in_days').value) * 24 * 60 * 60 * 1000
  };

  const id = generateId();
  const storage = getStorage();
  
  // æ¸…ç†è¿‡æœŸæ•°æ®
  Object.keys(storage).forEach(k => {
    if (storage[k].expiresAt && Date.now() > storage[k].expiresAt) {
      delete storage[k];
    }
  });
  
  storage[id] = data;
  setStorage(storage);

  const baseUrl = location.href.split('?')[0];
  currentUrl = baseUrl + '?id=' + id;

  // ç”ŸæˆäºŒç»´ç 
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: currentUrl,
    width: 180,
    height: 180,
    correctLevel: QRCode.CorrectLevel.M
  });

  document.getElementById('url-box').textContent = currentUrl;
  document.getElementById('qr-result').style.display = 'block';
  document.getElementById('qr-result').scrollIntoView({ behavior: 'smooth' });

  btn.disabled = false;
  btn.textContent = 'ç”Ÿæˆå…¥ä½å¡äºŒç»´ç ';
}

// ========== è¯»å–å…¥ä½å¡ ==========
function loadCard(id) {
  const storage = getStorage();
  const data = storage[id];

  if (!data) {
    document.getElementById('notfound-mode').style.display = 'block';
    return;
  }

  if (data.expiresAt && Date.now() > data.expiresAt) {
    document.getElementById('expired-mode').style.display = 'block';
    return;
  }

  document.title = data.room + ' - å…¥ä½æŒ‡å—';
  document.getElementById('v_room').textContent = data.room;
  document.getElementById('v_ssid').textContent = data.ssid;
  document.getElementById('v_pwd').textContent = data.pwd;
  document.getElementById('v_checkin').textContent = data.checkin;
  document.getElementById('v_extra').textContent = data.extra;

  if (data.images && data.images.length > 0) {
    document.getElementById('img-section').style.display = 'block';
    document.getElementById('v_images').innerHTML = data.images.map(img => 
      `<img src="${img.data}" onclick="showModal(this.src)">`
    ).join('');
  }

  document.getElementById('guest-mode').style.display = 'block';
}

// ========== å·¥å…·å‡½æ•° ==========
function copyText(btn, id) {
  const text = document.getElementById(id).textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'å·²å¤åˆ¶';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'å¤åˆ¶';
      btn.classList.remove('copied');
    }, 1500);
  });
}

function copyUrl() {
  navigator.clipboard.writeText(currentUrl).then(() => {
    alert('é“¾æ¥å·²å¤åˆ¶');
  });
}

function showModal(src) {
  document.getElementById('modal-img').src = src;
  document.getElementById('modal').classList.add('show');
}
</script>
</body>
</html>
