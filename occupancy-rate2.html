<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½å…¥ä½ç‡åˆ†æç³»ç»Ÿ Ultimate V3.0|è˜‡çš„å·¥å…·ç®±</title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
    :root { 
        --primary: #007aff; 
        --bg: #f2f2f7; 
        --card: #ffffff; 
        --text: #1c1c1e; 
        --border: #e5e5ea; 
        --success: #34c759; 
        --danger: #ff3b30;
        --warning: #ffcc00;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; box-sizing: border-box; }
    
    /* å¸ƒå±€å®¹å™¨ */
    .container { max-width: 1440px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 25px; }
    .card { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); margin-bottom: 20px; }
    
    /* å¯¼èˆªæ¨¡å¼åˆ‡æ¢ */
    .nav-tabs-main { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .nav-btn-main { 
        background: #e5e5ea; border: none; padding: 10px 25px; border-radius: 20px;
        font-size: 15px; font-weight: 600; cursor: pointer; color: #8e8e93; transition: 0.2s;
    }
    .nav-btn-main.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
    .nav-btn-main:hover:not(.active) { background: #d1d1d6; }
    
    /* æ¨¡å¼åŒºåŸŸæ˜¾éš */
    .mode-section { display: none; animation: fadeIn 0.3s; }
    .mode-section.active { display: block; }

    /* åŸæœ‰æ ·å¼ä¿ç•™ */
    .subtitle-link { text-decoration: none; color: #8e8e93; font-size: 14px; font-weight: 500; display: inline-block; margin-top: 5px; }
    .subtitle-link:hover { color: var(--primary); }
    
    /* 1. æ§åˆ¶åŒº */
    .controls-row { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; justify-content: space-between; }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-group label { font-size: 12px; font-weight: 600; color: #8e8e93; text-transform: uppercase; }
    .form-control { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: #fff; min-width: 100px; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
    
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #0062cc; }
    .btn-secondary { background: #e5e5ea; color: #1c1c1e; }
    .btn-secondary:hover { background: #d1d1d6; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    
    /* 2. ç”»å¸ƒåŒº */
    .canvas-wrapper { position: relative; background: #2c2c2e; border-radius: 12px; overflow: hidden; margin-top: 20px; text-align: center; padding: 20px; height: 65vh; display: flex; justify-content: center; align-items: center; }
    canvas { box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 100%; max-height: 100%; cursor: crosshair; }

    /* 3. ç»“æœè§†å›¾åˆ‡æ¢ Tabs */
    .view-tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
    .tab-btn { padding: 8px 16px; border-radius: 20px; border: none; background: #f2f2f7; color: #8e8e93; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(0,122,255,0.3); }
    .tab-btn:hover:not(.active) { background: #e5e5ea; }
    
    .view-content { display: none; animation: fadeIn 0.3s; }
    .view-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* 4. è¡¨æ ¼æ ·å¼ */
    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); max-height: 600px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
    th { background: #f9f9f9; padding: 8px; font-weight: 600; text-align: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; min-width: 100px; }
    td { padding: 10px; border: 1px solid #eee; text-align: center; }
    
    /* æ¯æ—¥æ’æœŸè¡¨ç‰¹æœ‰ */
    .date-cell { position: sticky; left: 0; background: #fff; z-index: 5; border-right: 2px solid #eee; font-weight: 600; }
    .cell-occupied { background-color: rgba(52, 199, 89, 0.3) !important; color: #004d1a; font-weight: bold; }
    .cell-blocked { background-color: #e5e5ea !important; color: #8e8e93; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px); cursor: not-allowed; }
    
    /* æ–°ç‰ˆè¡¨å¤´è¾“å…¥æ ·å¼ */
    .th-container { display: flex; flex-direction: column; gap: 4px; }
    .th-input-mini { border: 1px solid #ddd; background: #fff; text-align: center; font-size: 11px; padding: 2px; width: 90%; margin: 0 auto; border-radius: 4px; }
    .th-input-mini:focus { border-color: var(--primary); outline: none; }
    .th-label-preview { font-size: 12px; color: var(--primary); margin-bottom: 2px; height: 16px; overflow: hidden; text-overflow: ellipsis; }

    /* ç»Ÿè®¡æ‘˜è¦æ¡ */
    .summary-bar { display: flex; gap: 20px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; justify-content: space-around; }
    .summary-item strong { display: block; font-size: 24px; margin-top: 5px; }

    /* æ¨¡æ€æ¡† */
    .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none; justify-content:center; align-items:center; backdrop-filter: blur(4px); }
    .modal-box { background:#fff; padding:30px; border-radius:16px; width:500px; max-width:90%; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
    
    /* æˆ¿é—´æ•°æ®è¡¨æ ¼ç¾åŒ– */
    #statsTable th { background: #eef2f7; color: #333; height: 40px; }
    #statsTable tr:hover { background: #f5f5f7; }

    /* ============ æ–°å¢åˆ†ææ¨¡å¼ CSS ============ */
    .result-card { border-left: 6px solid #ccc; background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .result-card.danger { border-left-color: var(--danger); }
    .result-card.success { border-left-color: var(--success); }
    .result-card.warning { border-left-color: var(--warning); }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; color: #fff; margin-left: 10px; }
    .bg-red { background: var(--danger); }
    .bg-green { background: var(--success); }
    .diff-pos { color: var(--success); }
    .diff-neg { color: var(--danger); }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0;">æ™ºèƒ½å…¥ä½ç‡åˆ†æç³»ç»Ÿ<span style="font-size:14px; background:#000; color:#fff; padding:2px 8px; border-radius:6px; vertical-align:middle; margin-left: 5px;">Ultimate V3.0</span></h1>
        <a href="https://c1211tokyo.github.io/tool/" class="subtitle-link">è˜‡çš„å·¥å…·ç®±</a>
    </div>

    <div class="nav-tabs-main">
        <button class="nav-btn-main active" onclick="switchMainMode('calendar')">ğŸ“… å…¥ä½ç‡æ—¥å†æ¨¡å¼</button>
        <button class="nav-btn-main" onclick="switchMainMode('analysis')">ğŸ“Š ç»è¥æ™ºèƒ½è¯Šæ–­</button>
    </div>

    <div id="mode-calendar" class="mode-section active">
        <div class="card">
            <div class="controls-row">
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <div class="input-group">
                        <label>1. ä¸Šä¼ æ’æœŸæˆªå›¾</label>
                        <input type="file" id="imgInput" accept="image/*" class="form-control">
                    </div>
                    <div class="input-group">
                        <label>2. æˆ¿é—´æ•° (åˆ—)</label>
                        <input type="number" id="colCount" value="10" min="1" class="form-control" style="width:70px;" onchange="resetGrid()">
                    </div>
                    <div class="input-group">
                        <label>3. ç»Ÿè®¡å¤©æ•° (è¡Œ)</label>
                        <input type="number" id="rowCount" value="30" min="1" class="form-control" style="width:70px;">
                    </div>
                    <div class="input-group">
                        <label>4. èµ·å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-secondary" onclick="resetGrid()">ğŸ”„ é‡ç½®ç½‘æ ¼</button>
                    <button class="btn btn-primary" onclick="runAnalysis()">âš¡ å¼€å§‹åˆ†æ</button>
                </div>
            </div>

            <div style="margin-top:15px; font-size:13px; color:#666; background:#fffbe6; padding:8px 12px; border-radius:6px; border:1px solid #ffe58f;">
                ğŸ’¡ <strong>ä¿®å¤è¯´æ˜ï¼š</strong> çº¢æ¡†å·²è§£é”ã€‚è¯·æ‹–åŠ¨çº¢æ¡†é¡¶éƒ¨çš„ âšªï¸ <strong>å°ç™½ç‚¹</strong> å¯¹é½æ¯ä¸€åˆ—ã€‚å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼Œè¯·åœ¨æ¡†å†…æŒ‰ä½é¼ æ ‡å·¦é”®æ‹–åŠ¨æ•´ä¸ªçº¢æ¡†ã€‚
            </div>

            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>

        <div class="card" id="resultCard" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div class="view-tabs">
                    <button class="tab-btn active" onclick="switchTab('daily')">ğŸ“… æ¯æ—¥æ’æœŸè¡¨</button>
                    <button class="tab-btn" onclick="switchTab('stats')">ğŸ“‹ æˆ¿é—´æ•°æ®è¡¨</button>
                    <button class="tab-btn" onclick="switchTab('charts')">ğŸ“Š ç»Ÿè®¡å›¾è¡¨</button>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" onclick="openLinkModal()">ğŸ”— å…³è”ç»„åˆæˆ¿ (B+C)</button>
                    <button class="btn btn-secondary" onclick="exportImage()">ğŸ–¼ï¸ å¯¼å‡ºå›¾ç‰‡</button>
                    <button class="btn btn-secondary" onclick="exportExcel()">ğŸ“¥ å¯¼å‡º Excel</button>
                </div>
            </div>

            <div id="view-daily" class="view-content active">
                <div class="summary-bar">
                    <div class="summary-item">ç»¼åˆå…¥ä½ç‡ <strong id="valTotalRate" style="color:var(--primary)">0%</strong></div>
                    <div class="summary-item">æ€»æˆ¿æ™š (åŠ¨æ€) <strong id="valTotalSlots">0</strong></div>
                    <div class="summary-item">å®é™…å…¥ä½ <strong id="valTotalOcc" style="color:var(--success)">0</strong></div>
                </div>
                <div class="table-container">
                    <table id="dailyTable"></table>
                </div>
            </div>

            <div id="view-stats" class="view-content">
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th>æˆ¿é—´åç§°</th>
                                <th>ç»Ÿè®¡æ€»å¤©æ•°</th>
                                <th>è¢«å…³è”å ç”¨ (ä¸å¯å”®)</th>
                                <th>æœ‰æ•ˆå”®å–å¤©æ•°</th>
                                <th>å®é™…å…¥ä½å¤©æ•°</th>
                                <th>å…¥ä½ç‡ (åŸºäºæœ‰æ•ˆå¤©æ•°)</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-charts" class="view-content">
                <div style="display:grid; grid-template-columns: 1fr; gap:30px;">
                    <div style="background:#fff; border:1px solid #eee; border-radius:12px; padding:20px;">
                        <h3 style="margin:0 0 15px 0; text-align:center;">å„æˆ¿é—´å…¥ä½ç‡å¯¹æ¯” (æŸ±çŠ¶å›¾)</h3>
                        <div id="chartBar" style="width:100%; height:400px;"></div>
                    </div>
                    <div style="background:#fff; border:1px solid #eee; border-radius:12px; padding:20px;">
                        <h3 style="margin:0 0 15px 0; text-align:center;">æ¯æ—¥æ€»å…¥ä½è¶‹åŠ¿ (æŠ˜çº¿å›¾)</h3>
                        <div id="chartLine" style="width:100%; height:400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mode-analysis" class="mode-section">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“‚ ä¸Šä¼  CSV æ•°æ®</h3>
            <p style="font-size:13px; color:#888;">è¯·ä¸Šä¼ ä»åå°å¯¼å‡ºçš„ CSV è¡¨æ ¼ï¼Œç¬¬ä¸€ä»½ä¸ºå‚ç…§ç»„ï¼ˆå¦‚ä¸Šä¸ªæœˆï¼‰ï¼Œç¬¬äºŒä»½ä¸ºè¯Šæ–­ç»„ï¼ˆå¦‚æœªæ¥é¢„è®¢ï¼‰ã€‚</p>
            <div class="controls-row" style="align-items: flex-start;">
                <div class="input-group" style="flex:1; min-width:300px;">
                    <label>ğŸ“„ å†å²/å·²å®Œæˆæ•°æ® (å¦‚11æœˆ)</label>
                    <input type="file" id="csvPast" accept=".csv" class="form-control">
                </div>
                <div class="input-group" style="flex:1; min-width:300px;">
                    <label>ğŸ“… æœªæ¥/é¢„è®¢æ•°æ® (å¦‚12-1æœˆ)</label>
                    <input type="file" id="csvFuture" accept=".csv" class="form-control">
                </div>
            </div>
            <button class="btn btn-primary" style="margin-top:20px; width:100%; justify-content:center;" onclick="startDiagnosis()">ğŸš€ å¼€å§‹æ™ºèƒ½åˆ†æ</button>
        </div>

        <div id="analysisOutput" style="display:none;">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
                <div class="card" style="padding:15px; text-align:center; margin-bottom:0;">
                    <div style="color:#86868b; font-size:12px;">æœªæ¥æ€»è¥æ”¶é¢„æµ‹</div>
                    <div style="font-size:24px; font-weight:bold; color:var(--primary);" id="totalRevenue">--</div>
                </div>
                <div class="card" style="padding:15px; text-align:center; margin-bottom:0;">
                    <div style="color:#86868b; font-size:12px;">å¹³å‡å…¥ä½ç‡å˜åŒ–</div>
                    <div style="font-size:24px; font-weight:bold;" id="avgOccChange">--</div>
                </div>
                <div class="card" style="padding:15px; text-align:center; margin-bottom:0;">
                    <div style="color:#86868b; font-size:12px;">å¹³å‡æˆ¿ä»·(ADR)å˜åŒ–</div>
                    <div style="font-size:24px; font-weight:bold;" id="avgAdrChange">--</div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ ä»·æ ¼ä¸å…¥ä½ç‡ åŠ¨æ€å…³ç³»å›¾</h3>
                <p style="color:#666; font-size:12px; margin-bottom:10px;">æ¯ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªæˆ¿é—´ã€‚ç®­å¤´è¡¨ç¤ºä»â€œè¿‡å»â€åˆ°â€œæœªæ¥â€çš„å˜åŒ–è½¨è¿¹ã€‚<br>ğŸ”´ çº¢è‰²ï¼šæ¶¨ä»·ä¸”å…¥ä½ç‡ä¸‹è·Œ (è­¦ç¤º) | ğŸŸ¢ ç»¿è‰²ï¼šè¡¨ç°ä¼˜å¼‚</p>
                <div id="scatterChart" style="width:100%; height:500px;"></div>
            </div>

            <div class="card">
                <h3>ğŸ’° å‡€æ”¶å…¥å¯¹æ¯” (Top 10)</h3>
                <div id="barChartIncome" style="width:100%; height:400px;"></div>
            </div>

            <div class="card">
                <h3>ğŸ’¡ AI è¯Šæ–­å»ºè®®</h3>
                <div id="adviceContainer"></div>
            </div>

            <div class="card">
                <h3>ğŸ“‹ è¯¦ç»†æ•°æ®å¯¹æ¯”</h3>
                <div class="table-container">
                    <table style="width:100%;">
                        <thead>
                            <tr>
                                <th style="text-align:left;">æˆ¿æº</th>
                                <th>æœªæ¥ADR (å˜åŒ–)</th>
                                <th>æœªæ¥å…¥ä½ç‡ (å˜åŒ–)</th>
                                <th>å‡€æ”¶å…¥é¢„æµ‹</th>
                                <th>ä½£é‡‘ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal-mask" id="linkModal">
    <div class="modal-box">
        <h3 style="margin-top:0;">ğŸ”— ç»„åˆæˆ¿å…³è”è®¾ç½®</h3>
        <p style="font-size:13px; color:#666;">
            è®¾ç½®åï¼ˆåŒå‘é”å®šï¼‰ï¼š<br>
            1. å½“<strong>ä¸»æˆ¿æº</strong>(å¦‚B+C)å…¥ä½æ—¶ï¼Œå­æˆ¿æº(B,C)å°†è‡ªåŠ¨ä¸å¯å”®ã€‚<br>
            2. å½“<strong>ä»»ä¸€å­æˆ¿æº</strong>å…¥ä½æ—¶ï¼Œä¸»æˆ¿æºä¹Ÿå°†è‡ªåŠ¨ä¸å¯å”®ã€‚
        </p>
        <div id="linkContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn btn-secondary" onclick="addLinkRow()">+ æ·»åŠ ä¸€ç»„</button>
            <div>
                <button class="btn btn-secondary" onclick="closeLinkModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveLinks()">ä¿å­˜ç”Ÿæ•ˆ</button>
            </div>
        </div>
    </div>
</div>

<datalist id="prefix-list">
    <option value="æ¸‹è°·"></option>
    <option value="å…¥è°·"></option>
    <option value="æ± è¢‹"></option>
    <option value="å‘å³¶"></option>
    <option value="ä¸¡å›½"></option>
    <option value="å¤§ä¹…ä¿"></option>
    <option value="åŒ—æ–°å®¿"></option>
</datalist>

<datalist id="suffix-list">
    <option value="ä¸€æˆ·å»º"></option>
    <option value="101"></option>
    <option value="102"></option>
    <option value="103"></option>
    <option value="104"></option>
    <option value="105"></option>
    <option value="106"></option>
    <option value="107"></option>
    <option value="108"></option>
    <option value="201"></option>
    <option value="202"></option>
    <option value="203"></option>
    <option value="204"></option>
    <option value="205"></option>
    <option value="206"></option>
    <option value="207"></option>
    <option value="208"></option>
    <option value="301"></option>
    <option value="302"></option>
    <option value="A"></option>
    <option value="B"></option>
    <option value="C"></option>
</datalist>

<script>
// ==========================================
// PART 1: ä¸»å¯¼èˆªåˆ‡æ¢é€»è¾‘
// ==========================================
function switchMainMode(mode) {
    // æŒ‰é’®æ ·å¼
    document.querySelectorAll('.nav-btn-main').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // å†…å®¹æ˜¾éš
    document.querySelectorAll('.mode-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('mode-' + mode).classList.add('active');
}

// ==========================================
// PART 2: ç»è¥æ™ºèƒ½è¯Šæ–­é€»è¾‘ (æ–°åŠŸèƒ½)
// ==========================================
function startDiagnosis() {
    const filePast = document.getElementById('csvPast').files[0];
    const fileFuture = document.getElementById('csvFuture').files[0];

    if (!filePast || !fileFuture) {
        alert("è¯·ç¡®ä¿ä¸¤ä¸ªCSVæ–‡ä»¶éƒ½å·²ä¸Šä¼ ï¼");
        return;
    }

    Promise.all([parseCSV(filePast), parseCSV(fileFuture)]).then(results => {
        const dataPast = cleanBusinessData(results[0].data);
        const dataFuture = cleanBusinessData(results[1].data);
        
        if(Object.keys(dataFuture).length === 0) {
            alert("CSV è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚");
            return;
        }

        renderAnalysis(dataPast, dataFuture);
        document.getElementById('analysisOutput').style.display = 'block';
        // æ»šåŠ¨åˆ°åˆ†æç»“æœ
        setTimeout(() => {
            document.getElementById('analysisOutput').scrollIntoView({behavior:'smooth'});
        }, 100);
    });
}

function parseCSV(file) {
    return new Promise(resolve => {
        Papa.parse(file, {
            header: false,
            skipEmptyLines: true,
            complete: resolve
        });
    });
}

function cleanBusinessData(rawData) {
    let headerIndex = -1;
    let map = {};
    
    // å¯»æ‰¾è¡¨å¤´
    for (let i = 0; i < Math.min(10, rawData.length); i++) {
        if (rawData[i].includes('æˆ¿æº') && rawData[i].includes('å…¥ä½ç‡')) {
            headerIndex = i;
            break;
        }
    }

    if (headerIndex === -1) return {};

    const headers = rawData[headerIndex];
    const idxName = headers.indexOf('æˆ¿æº');
    const idxOcc = headers.indexOf('å…¥ä½ç‡');
    const idxPrice = headers.indexOf('æˆ¿è´¹.1'); // ADR
    const idxIncome = headers.indexOf('å‡€æ”¶å…¥');
    const idxComm = headers.indexOf('ä½£é‡‘');
    const idxRoomFee = headers.indexOf('æˆ¿è´¹');

    for (let i = headerIndex + 1; i < rawData.length; i++) {
        const row = rawData[i];
        const name = row[idxName];
        
        if (name && name !== 'æ€»è®¡' && name.trim() !== '') {
            const parseNum = (val) => {
                if (!val) return 0;
                return parseFloat(String(val).replace(/[Â¥,%\s]/g, ''));
            };

            const occ = parseNum(row[idxOcc]) / 100.0;
            const adr = parseNum(row[idxPrice]);
            const income = parseNum(row[idxIncome]);
            const commRaw = parseNum(row[idxComm]);
            const roomFee = parseNum(row[idxRoomFee]);
            const commRate = roomFee > 0 ? (commRaw / roomFee) : 0;

            map[name] = { name, occ, adr, income, commRate };
        }
    }
    return map;
}

function renderAnalysis(pastMap, futureMap) {
    const rooms = Object.keys(futureMap);
    let totalRevenue = 0;
    let totalOccDiff = 0;
    let totalAdrDiff = 0;
    let count = 0;

    const chartDataSeries = []; 
    const barDataNames = []; 
    const barDataPast = [];
    const barDataFuture = [];
    
    const adviceContainer = document.getElementById('adviceContainer');
    const tableBody = document.getElementById('detailTableBody');
    adviceContainer.innerHTML = '';
    tableBody.innerHTML = '';

    rooms.forEach(room => {
        const future = futureMap[room];
        const past = pastMap[room] || { occ: 0, adr: future.adr, income: 0 };

        totalRevenue += future.income;
        if(pastMap[room]) {
            totalOccDiff += (future.occ - past.occ);
            totalAdrDiff += (future.adr - past.adr);
            count++;
        }

        const priceChangePct = past.adr > 0 ? (future.adr - past.adr) / past.adr : 0;
        const occDiff = future.occ - past.occ;

        // è¡¨æ ¼è¡Œ
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:bold; text-align:left;">${room}</td>
            <td>Â¥${future.adr.toLocaleString()} <span class="${priceChangePct>0?'diff-pos':'diff-neg'}">(${priceChangePct>0?'+':''}${(priceChangePct*100).toFixed(1)}%)</span></td>
            <td>${(future.occ*100).toFixed(0)}% <span class="${occDiff>0?'diff-pos':'diff-neg'}">(${occDiff>0?'+':''}${(occDiff*100).toFixed(0)}%)</span></td>
            <td>Â¥${future.income.toLocaleString()}</td>
            <td style="${future.commRate>0.12?'color:red;font-weight:bold;':''}">${(future.commRate*100).toFixed(1)}%</td>
        `;
        tableBody.appendChild(tr);

        // è¯Šæ–­å»ºè®®
        let alertHtml = '';
        if (priceChangePct > 0.05 && future.occ < 0.3 && past.occ > 0.6) {
            alertHtml = `
            <div class="result-card danger">
                <div style="display:flex; justify-content:space-between;">
                    <strong>ğŸ”´ ${room} - æ¶¨ä»·å¤±è¯¯è­¦å‘Š</strong>
                    <span class="tag bg-red">éœ€é™ä»·</span>
                </div>
                <p style="margin:5px 0; color:#666;">å‡ä»·ä¸Šæ¶¨ <b>${(priceChangePct*100).toFixed(1)}%</b>ï¼Œå¯¼è‡´å…¥ä½ç‡ä» ${(past.occ*100).toFixed(0)}% è·Œè‡³ ${(future.occ*100).toFixed(0)}%ã€‚<br>å»ºè®®ç«‹å³å›è°ƒä»·æ ¼è‡³ Â¥${past.adr.toFixed(0)} å·¦å³ã€‚</p>
            </div>`;
        } else if (future.occ > 0.75 && priceChangePct < 0.05) {
            alertHtml = `
            <div class="result-card success">
                <div style="display:flex; justify-content:space-between;">
                    <strong>ğŸŸ¢ ${room} - æä»·æ½œåŠ›</strong>
                    <span class="tag bg-green">å¯æ¶¨ä»·</span>
                </div>
                <p style="margin:5px 0; color:#666;">è¡¨ç°ä¼˜å¼‚ï¼å…¥ä½ç‡ç»´æŒåœ¨ ${(future.occ*100).toFixed(0)}% ä¸”ä»·æ ¼æœªæ˜æ˜¾ä¸Šæ¶¨ã€‚<br>å»ºè®®å°è¯•æä»· 5%-10% ä»¥å¢åŠ çº¯åˆ©æ¶¦ã€‚</p>
            </div>`;
        } else if (future.commRate > 0.12) {
            alertHtml = `
            <div class="result-card warning">
                <strong>ğŸŸ¡ ${room} - æ¸ é“æˆæœ¬è¿‡é«˜</strong>
                <p style="margin:5px 0; color:#666;">å½“å‰ä½£é‡‘ç‡é«˜è¾¾ ${(future.commRate*100).toFixed(1)}% (å¹³å‡çº¦8%)ã€‚è¯·æ£€æŸ¥æ˜¯å¦å¼€å¯äº†é«˜é¢æ¨å¹¿ã€‚</p>
            </div>`;
        }
        if (alertHtml) adviceContainer.innerHTML += alertHtml;

        // å›¾è¡¨æ•°æ®
        chartDataSeries.push([
            priceChangePct * 100, // X: ä»·æ ¼å˜åŒ–%
            occDiff * 100,        // Y: å…¥ä½ç‡å˜åŒ–%
            future.income / 10000, // Size: æ”¶å…¥(ä¸‡)
            room,
            future.occ,
            future.adr
        ]);

        barDataNames.push(room);
        barDataPast.push(past.income);
        barDataFuture.push(future.income);
    });

    if (!adviceContainer.innerHTML) adviceContainer.innerHTML = '<div style="color:#888; text-align:center;">æš‚æ— æ¿€è¿›çš„è°ƒæ•´å»ºè®®ï¼Œæ•´ä½“ç»è¥å¹³ç¨³ã€‚</div>';

    document.getElementById('totalRevenue').innerText = 'Â¥' + totalRevenue.toLocaleString();
    document.getElementById('avgOccChange').innerText = (count > 0 ? (totalOccDiff/count*100).toFixed(1) : 0) + '%';
    document.getElementById('avgOccChange').style.color = totalOccDiff >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('avgAdrChange').innerText = 'Â¥' + (count > 0 ? (totalAdrDiff/count).toFixed(0) : 0);

    renderScatterChart(chartDataSeries);
    renderBarChart(barDataNames, barDataPast, barDataFuture);
}

function renderScatterChart(data) {
    const chart = echarts.init(document.getElementById('scatterChart'));
    const option = {
        tooltip: {
            formatter: function (param) {
                return `<b>${param.data[3]}</b><br/>ä»·æ ¼å˜åŒ–: ${param.data[0].toFixed(1)}%<br/>å…¥ä½ç‡å˜åŒ–: ${param.data[1].toFixed(1)}%<br/>å½“å‰é¢„æµ‹: Â¥${param.data[5]} (${(param.data[4]*100).toFixed(0)}%)`;
            }
        },
        xAxis: { name: 'ä»·æ ¼å˜åŒ– (%)', splitLine: { show: false } },
        yAxis: { name: 'å…¥ä½ç‡å˜åŒ– (%)', splitLine: { show: false } },
        series: [{
            type: 'scatter',
            data: data,
            symbolSize: function (data) { return Math.max(10, Math.sqrt(data[2]) * 8); },
            itemStyle: {
                color: function(param) {
                    if (param.data[0] > 5 && param.data[1] < -10) return '#ff3b30'; // æ¶¨ä»·ä¸”è·Œ
                    if (param.data[4] > 0.8) return '#34c759'; // é«˜å…¥ä½
                    return '#007aff';
                },
                opacity: 0.7
            }
        }]
    };
    chart.setOption(option);
}

function renderBarChart(names, past, future) {
    const indices = names.map((_, i) => i);
    indices.sort((a, b) => future[b] - future[a]);
    const topIndices = indices.slice(0, 10); // Top 10
    
    const chart = echarts.init(document.getElementById('barChartIncome'));
    const option = {
        tooltip: { trigger: 'axis' },
        legend: { data: ['ä¸Šæœˆå®æ”¶', 'æœ¬æœˆé¢„æµ‹'], bottom: 0 },
        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
        xAxis: { type: 'category', data: topIndices.map(i => names[i]), axisLabel: { interval: 0, rotate: 30 } },
        yAxis: { type: 'value' },
        series: [
            { name: 'ä¸Šæœˆå®æ”¶', type: 'bar', data: topIndices.map(i => past[i]), itemStyle: { color: '#ccc' } },
            { name: 'æœ¬æœˆé¢„æµ‹', type: 'bar', data: topIndices.map(i => future[i]), itemStyle: { color: '#007aff' } }
        ]
    };
    chart.setOption(option);
}

// ==========================================
// PART 3: åŸæœ‰æ—¥å†é€»è¾‘ (ä»æ‚¨çš„æºæ–‡ä»¶å®Œæ•´æ¢å¤)
// ==========================================
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
let img = new Image();

// å‡ ä½•æ•°æ®
let grid = { x: 50, y: 50, w: 100, h: 100 }; // çº¢æ¡†
let colDividers = []; // 0.0 ~ 1.0 çš„æ¯”ä¾‹
let isDragging = false;
let dragTarget = null; // {type: 'box'|'divider', handle: 'tl'|'br', index: 0}
let lastMouse = {x:0, y:0};

// ä¸šåŠ¡æ•°æ®
let rawData = []; // [row][col] => 0 or 1
let roomNames = []; // æœ€ç»ˆæ˜¾ç¤ºçš„åç§°
let roomParts = []; // å­˜å‚¨ {prefix, suffix}
let validCols = [];
let dateList = [];
let linkConfig = []; // [{parent: colIdx, children: [colIdx, colIdx]}]

// å›¾è¡¨å®ä¾‹å…¨å±€å˜é‡
let chartBarIns = null;
let chartLineIns = null;

// --- 1. åˆå§‹åŒ–ä¸äº¤äº’ ---

document.getElementById('startDate').valueAsDate = new Date();

document.getElementById('imgInput').addEventListener('change', e => {
    if(e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = evt => {
            img.src = evt.target.result;
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                grid.x = img.width * 0.05;
                grid.y = img.height * 0.15;
                grid.w = img.width * 0.9;
                grid.h = img.height * 0.75;
                resetGrid();
            };
        };
        reader.readAsDataURL(e.target.files[0]);
    }
});

function resetGrid() {
    const cols = parseInt(document.getElementById('colCount').value) || 1;
    colDividers = [];
    for(let i=1; i<cols; i++) colDividers.push(i/cols);
    draw();
}

// æ ¸å¿ƒç»˜å›¾
function draw() {
    if(!img.src) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);

    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0,0, canvas.width, grid.y);
    ctx.fillRect(0, grid.y+grid.h, canvas.width, canvas.height-(grid.y+grid.h));
    ctx.fillRect(0, grid.y, grid.x, grid.h);
    ctx.fillRect(grid.x+grid.w, grid.y, canvas.width-(grid.x+grid.w), grid.h);

    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 3;
    ctx.strokeRect(grid.x, grid.y, grid.w, grid.h);

    const rows = parseInt(document.getElementById('rowCount').value) || 1;
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255, 59, 48, 0.3)';
    ctx.lineWidth = 1;
    for(let i=1; i<rows; i++) {
        let y = grid.y + (grid.h/rows)*i;
        ctx.moveTo(grid.x, y);
        ctx.lineTo(grid.x+grid.w, y);
    }
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 2;
    colDividers.forEach(r => {
        let x = grid.x + r * grid.w;
        ctx.moveTo(x, grid.y);
        ctx.lineTo(x, grid.y+grid.h);
    });
    ctx.stroke();

    const handleR = img.width * 0.008; 
    const drawDot = (x,y, color) => {
        ctx.beginPath(); ctx.arc(x,y, handleR < 8 ? 8 : handleR, 0, Math.PI*2);
        ctx.fillStyle=color; ctx.fill(); ctx.strokeStyle='#fff'; ctx.stroke();
    };

    drawDot(grid.x, grid.y, '#007aff'); 
    drawDot(grid.x+grid.w, grid.y+grid.h, '#007aff'); 

    colDividers.forEach(r => {
        drawDot(grid.x + r * grid.w, grid.y, '#fff'); 
    });
}

function getMousePos(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

canvas.addEventListener('mousedown', e => {
    const {x, y} = getMousePos(e);
    const R = Math.max(20, img.width * 0.015); 

    for(let i=0; i<colDividers.length; i++) {
        let lineX = grid.x + colDividers[i] * grid.w;
        if(Math.hypot(x - lineX, y - grid.y) < R) {
            isDragging = true; dragTarget = {type:'divider', index:i}; return;
        }
    }
    if(Math.hypot(x - grid.x, y - grid.y) < R) { isDragging=true; dragTarget={type:'box', handle:'tl'}; return; }
    if(Math.hypot(x-(grid.x+grid.w), y-(grid.y+grid.h)) < R) { isDragging=true; dragTarget={type:'box', handle:'br'}; return; }

    if(x > grid.x && x < grid.x+grid.w && y > grid.y && y < grid.y+grid.h) {
        isDragging = true; dragTarget = {type:'move'}; lastMouse = {x,y};
    }
});

canvas.addEventListener('mousemove', e => {
    const {x, y} = getMousePos(e);
    if(!isDragging) {
        canvas.style.cursor = 'default';
        const R = Math.max(20, img.width * 0.015);
        for(let r of colDividers) if(Math.hypot(x-(grid.x+r*grid.w), y-grid.y) < R) canvas.style.cursor = 'col-resize';
        return;
    }

    if(dragTarget.type === 'move') {
        grid.x += x - lastMouse.x;
        grid.y += y - lastMouse.y;
        lastMouse = {x,y};
    } else if(dragTarget.type === 'box') {
        if(dragTarget.handle === 'tl') {
            let r = grid.x+grid.w, b = grid.y+grid.h;
            grid.x = x; grid.y = y; grid.w = r-x; grid.h = b-y;
        } else {
            grid.w = x-grid.x; grid.h = y-grid.y;
        }
    } else if(dragTarget.type === 'divider') {
        let i = dragTarget.index;
        let r = (x - grid.x) / grid.w;
        let min = (i===0) ? 0 : colDividers[i-1];
        let max = (i===colDividers.length-1) ? 1 : colDividers[i+1];
        if(r > min+0.01 && r < max-0.01) colDividers[i] = r;
    }
    draw();
});

canvas.addEventListener('mouseup', () => isDragging = false);

// --- 2. åˆ†æé€»è¾‘ ---

function runAnalysis() {
    if(!img.src) { alert("è¯·ä¸Šä¼ å›¾ç‰‡"); return; }
    
    const rows = parseInt(document.getElementById('rowCount').value);
    const cellH = grid.h / rows;
    const boundaries = [0, ...colDividers, 1.0];
    const cols = boundaries.length - 1;

    rawData = [];
    roomNames = [];
    roomParts = []; // é‡ç½®åç§°éƒ¨ä»¶
    validCols = [];
    dateList = [];

    const imgData = ctx.getImageData(0,0, canvas.width, canvas.height).data;

    for(let c=0; c<cols; c++) {
        const defaultName = String.fromCharCode(65+c);
        roomNames.push(defaultName); 
        roomParts.push({ prefix: '', suffix: '' });
        validCols.push(c);
    }
    
    const startD = new Date(document.getElementById('startDate').value);
    for(let r=0; r<rows; r++) {
        let d = new Date(startD); d.setDate(d.getDate()+r);
        dateList.push(`${d.getMonth()+1}/${d.getDate()}`);
        
        let rowArr = [];
        let rowY = grid.y + r*cellH;
        
        for(let c=0; c<cols; c++) {
            let r1 = boundaries[c], r2 = boundaries[c+1];
            let cellX = grid.x + r1 * grid.w;
            let cellW = (r2-r1) * grid.w;
            
            let sx = cellX + cellW*0.35, sy = rowY + cellH*0.35;
            let sw = cellW*0.3, sh = cellH*0.3;
            
            let count=0, total=0;
            for(let py=sy; py<sy+sh; py++) {
                for(let px=sx; px<sx+sw; px++) {
                    let i = (Math.floor(py)*canvas.width + Math.floor(px))*4;
                    if(imgData[i]<230 || imgData[i+1]<230 || imgData[i+2]<230) count++;
                    total++;
                }
            }
            rowArr.push( (count/total > 0.1) ? 1 : 0 );
        }
        rawData.push(rowArr);
    }

    document.getElementById('resultCard').style.display = 'block';
    refreshAllViews();
    switchTab('daily');
    document.getElementById('resultCard').scrollIntoView({behavior:'smooth'});
}

// --- æ ¸å¿ƒè¾…åŠ©å‡½æ•°: è®¡ç®—è¢«å ç”¨çš„æ ¼å­ ---
function getBlockedSet(r) {
    let blockedSet = new Set();
    
    linkConfig.forEach(cfg => {
        // 1. çˆ¶æˆ¿æœ‰å®¢ -> é”å®šæ‰€æœ‰å­æˆ¿
        if(rawData[r][cfg.parent] === 1) { 
            cfg.children.forEach(child => blockedSet.add(child));
        }
        
        // 2. ä»»æ„å­æˆ¿æœ‰å®¢ -> é”å®šçˆ¶æˆ¿
        let anyChildOccupied = cfg.children.some(childIdx => rawData[r][childIdx] === 1);
        if(anyChildOccupied) {
            blockedSet.add(cfg.parent);
        }
    });
    
    return blockedSet;
}

function updateRoomName(c) {
    const p = roomParts[c].prefix.trim();
    const s = roomParts[c].suffix.trim();
    if(p === '' && s === '') {
        roomNames[c] = String.fromCharCode(65+c);
    } else {
        roomNames[c] = p + s;
    }
    refreshAllViews();
}

// --- 3. è§†å›¾æ¸²æŸ“ä¸æ•°æ®è®¡ç®— (V2.1 ä¿®æ­£ä¼˜å…ˆçº§) ---

function refreshAllViews() {
    renderDailyTable();
    renderStatsTable();
    renderCharts();
}

function renderDailyTable() {
    const table = document.getElementById('dailyTable');
    table.innerHTML = '';
    
    let thead = document.createElement('thead');
    let tr = document.createElement('tr');
    
    let thDate = document.createElement('th');
    thDate.innerText = 'æ—¥æœŸ';
    thDate.style.zIndex = '11';
    thDate.style.left = '0';
    tr.appendChild(thDate);

    validCols.forEach(c => {
        let th = document.createElement('th');
        let container = document.createElement('div');
        container.className = 'th-container';
        
        let label = document.createElement('div');
        label.className = 'th-label-preview';
        label.innerText = roomNames[c];
        container.appendChild(label);
        
        let inpPrefix = document.createElement('input');
        inpPrefix.className = 'th-input-mini';
        inpPrefix.setAttribute('list', 'prefix-list');
        inpPrefix.placeholder = 'å‰ç¼€ (å¦‚:å‘å²›)';
        inpPrefix.value = roomParts[c].prefix;
        inpPrefix.onchange = (e) => { roomParts[c].prefix = e.target.value; updateRoomName(c); };
        container.appendChild(inpPrefix);
        
        let inpSuffix = document.createElement('input');
        inpSuffix.className = 'th-input-mini';
        inpSuffix.setAttribute('list', 'suffix-list');
        inpSuffix.placeholder = 'åç¼€ (å¦‚:101)';
        inpSuffix.value = roomParts[c].suffix;
        inpSuffix.onchange = (e) => { roomParts[c].suffix = e.target.value; updateRoomName(c); };
        container.appendChild(inpSuffix);
        
        let btnDel = document.createElement('div');
        btnDel.innerText = 'Ã— åˆ é™¤åˆ—';
        btnDel.style.cssText = 'color:red; cursor:pointer; font-size:10px; margin-top:2px;';
        btnDel.onclick = () => {
            if(confirm('åˆ é™¤æ­¤åˆ—ï¼Ÿ')) {
                validCols = validCols.filter(x => x!==c);
                linkConfig = linkConfig.filter(l => l.parent!==c && !l.children.includes(c));
                refreshAllViews();
            }
        };
        container.appendChild(btnDel);
        th.appendChild(container);
        tr.appendChild(th);
    });
    thead.appendChild(tr);
    table.appendChild(thead);

    let tbody = document.createElement('tbody');
    let totalSlots = 0, totalOcc = 0;

    for(let r=0; r<rawData.length; r++) {
        let tr = document.createElement('tr');
        let tdD = document.createElement('td'); 
        tdD.className = 'date-cell'; 
        tdD.innerText = dateList[r];
        tr.appendChild(tdD);

        let blockedCols = getBlockedSet(r);

        validCols.forEach(c => {
            let td = document.createElement('td');
            let isOcc = rawData[r][c] === 1;
            let isBlocked = blockedCols.has(c);

            // [FIX] ä¼˜å…ˆçº§è°ƒæ•´ï¼šå…ˆåˆ¤æ–­æ˜¯å¦å…¥ä½ (isOcc)ï¼Œå…¥ä½çŠ¶æ€é«˜äºé”å®šçŠ¶æ€ã€‚
            if(isOcc) {
                td.className = 'cell-occupied';
                td.innerText = 'ä½';
                totalOcc++;
                
                td.onclick = () => {
                    rawData[r][c] = 0;
                    refreshAllViews();
                };
                td.style.cursor = 'pointer';
            } else if(isBlocked) {
                td.className = 'cell-blocked';
                td.innerText = 'ğŸ”’'; 
                // é”å®šçŠ¶æ€ä¸å¯ç‚¹å‡»ä¿®æ”¹
            } else {
                totalSlots++; 
                td.onclick = () => {
                    rawData[r][c] = 1;
                    refreshAllViews();
                };
                td.style.cursor = 'pointer';
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);

    document.getElementById('valTotalSlots').innerText = totalSlots;
    document.getElementById('valTotalOcc').innerText = totalOcc;
    document.getElementById('valTotalRate').innerText = totalSlots ? (totalOcc/totalSlots*100).toFixed(1)+'%' : '0%';
}

function renderStatsTable() {
    const tbody = document.getElementById('statsTableBody');
    tbody.innerHTML = '';
    const totalDays = rawData.length;

    validCols.forEach(c => {
        let stats = { name: roomNames[c], total: totalDays, blocked: 0, valid: 0, occupied: 0 };

        for(let r=0; r<totalDays; r++) {
            let blockedCols = getBlockedSet(r);
            let isOcc = rawData[r][c] === 1;
            
            // [FIX] ç»Ÿè®¡ä¼˜å…ˆçº§ï¼šå¦‚æœå…¥ä½ï¼Œç®—Occupiedï¼›æœªå…¥ä½ä¸”è¢«é”ï¼Œç®—Blockedï¼›å¦åˆ™ç®—Valid
            if(isOcc) {
                stats.valid++;
                stats.occupied++;
            } else if(blockedCols.has(c)) {
                stats.blocked++;
            } else {
                stats.valid++;
            }
        }

        let rate = stats.valid > 0 ? (stats.occupied / stats.valid * 100).toFixed(1) : 0;
        
        let tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:bold;">${stats.name}</td>
            <td>${stats.total}</td>
            <td style="color:#8e8e93;">${stats.blocked}</td>
            <td style="font-weight:bold; color:#007aff;">${stats.valid}</td>
            <td style="color:#34c759;">${stats.occupied}</td>
            <td style="font-weight:bold; font-size:14px;">${rate}%</td>
        `;
        tbody.appendChild(tr);
    });
}

function renderCharts() {
    const markLines = {
        data: [
            { yAxis: 95, label: { position: 'end', formatter: '95%' }, lineStyle: { color: '#34c759', type: 'dashed' } },
            { yAxis: 70, label: { position: 'end', formatter: '70%' }, lineStyle: { color: '#ff9500', type: 'dashed' } },
            { yAxis: 50, label: { position: 'end', formatter: '50%' }, lineStyle: { color: '#ff3b30', type: 'dashed' } }
        ]
    };

    let barX = [], barY = [];
    validCols.forEach(c => {
        barX.push(roomNames[c]);
        let valid=0, occ=0;
        for(let r=0; r<rawData.length; r++) {
            let blockedCols = getBlockedSet(r);
            let isOcc = rawData[r][c] === 1;
            
            if(isOcc) { valid++; occ++; }
            else if(!blockedCols.has(c)) { valid++; }
        }
        barY.push(valid>0 ? (occ/valid*100).toFixed(1) : 0);
    });

    if (chartBarIns) chartBarIns.dispose();
    chartBarIns = echarts.init(document.getElementById('chartBar'));
    
    chartBarIns.setOption({
        tooltip: { trigger: 'axis', formatter: '{b}: {c}%' },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'category', data: barX, axisLabel: {rotate:45} },
        yAxis: { type: 'value', max:100, name:'å…¥ä½ç‡%' },
        series: [{ 
            type:'bar', 
            data:barY, 
            itemStyle:{color:'#007aff'}, 
            label:{show:true, position:'top', formatter:'{c}%'},
            markLine: markLines 
        }]
    });
    chartBarIns.resize();

    let lineX = dateList;
    let lineY = [];
    for(let r=0; r<rawData.length; r++) {
        let daySlots=0, dayOcc=0;
        let blockedCols = getBlockedSet(r);
        
        validCols.forEach(c => {
            let isOcc = rawData[r][c] === 1;
            if(isOcc) { daySlots++; dayOcc++; }
            else if(!blockedCols.has(c)) { daySlots++; }
        });
        lineY.push(daySlots>0 ? (dayOcc/daySlots*100).toFixed(1) : 0);
    }

    if (chartLineIns) chartLineIns.dispose();
    chartLineIns = echarts.init(document.getElementById('chartLine'));
    
    chartLineIns.setOption({
        tooltip: { trigger: 'axis', formatter: '{b}: {c}%' },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'category', data: lineX },
        yAxis: { type: 'value', max:100 },
        series: [{ 
            type:'line', 
            smooth:true, 
            data:lineY, 
            itemStyle:{color:'#34c759'}, 
            areaStyle:{opacity:0.2},
            markLine: markLines
        }]
    });
    chartLineIns.resize();
    
    window.addEventListener('resize', () => { 
        if(chartBarIns) chartBarIns.resize(); 
        if(chartLineIns) chartLineIns.resize(); 
    });
}

// --- 4. è¾…åŠ©åŠŸèƒ½ ---

function switchTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view-content').forEach(c => c.classList.remove('active'));
    
    const tabs = ['daily', 'stats', 'charts'];
    const idx = tabs.indexOf(name);
    document.querySelectorAll('.tab-btn')[idx].classList.add('active');
    document.getElementById('view-'+name).classList.add('active');
    
    if(name === 'charts') {
        setTimeout(renderCharts, 50); 
    }
}

function exportExcel() {
    let wb = XLSX.utils.book_new();
    
    // Sheet 1: æ¯æ—¥æ˜ç»†
    let ws1Data = [['æ—¥æœŸ']];
    validCols.forEach(c => ws1Data[0].push(roomNames[c]));
    ws1Data[0].push('å½“æ—¥å…¥ä½ç‡');
    
    for(let r=0; r<rawData.length; r++) {
        let row = [dateList[r]];
        let daySlots=0, dayOcc=0;
        let blockedCols = getBlockedSet(r);

        validCols.forEach(c => {
            let isOcc = rawData[r][c] === 1;
            if(isOcc) {
                row.push('1'); dayOcc++; daySlots++;
            } else if(blockedCols.has(c)) {
                row.push('ğŸ”’'); 
            } else {
                row.push('0'); daySlots++;
            }
        });
        row.push(daySlots>0 ? (dayOcc/daySlots*100).toFixed(1)+'%' : '0%');
        ws1Data.push(row);
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws1Data), "æ¯æ—¥æ’æœŸ");

    // Sheet 2: æˆ¿é—´ç»Ÿè®¡
    let ws2Data = [['æˆ¿é—´å', 'æ€»å¤©æ•°', 'è¢«å ç”¨(å…³è”)', 'æœ‰æ•ˆå¤©æ•°', 'å…¥ä½å¤©æ•°', 'å…¥ä½ç‡']];
    validCols.forEach(c => {
        let valid=0, occ=0, block=0;
        for(let r=0; r<rawData.length; r++) {
            let blockedCols = getBlockedSet(r);
            let isOcc = rawData[r][c] === 1;
            
            if(isOcc) { valid++; occ++; }
            else if(blockedCols.has(c)) block++;
            else valid++;
        }
        ws2Data.push([roomNames[c], rawData.length, block, valid, occ, (valid? (occ/valid*100).toFixed(1)+'%': '0%')]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws2Data), "æˆ¿é—´ç»Ÿè®¡");
    
    XLSX.writeFile(wb, "å…¥ä½åˆ†ææŠ¥è¡¨.xlsx");
}

function exportImage() {
    const card = document.getElementById('resultCard');
    const originalShadow = card.style.boxShadow;
    card.style.boxShadow = 'none';
    
    html2canvas(card, {
        backgroundColor: '#ffffff',
        scale: 2 
    }).then(canvas => {
        card.style.boxShadow = originalShadow;
        const link = document.createElement('a');
        link.download = 'å…¥ä½ç‡åˆ†æç»“æœ.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

// å…³è”æ¨¡æ€æ¡†é€»è¾‘
function openLinkModal() {
    document.getElementById('linkModal').style.display='flex';
    document.getElementById('linkContainer').innerHTML='';
    if(linkConfig.length===0) addLinkRow();
    else linkConfig.forEach(cfg => addLinkRow(cfg));
}
function closeLinkModal() { document.getElementById('linkModal').style.display='none'; }

function addLinkRow(data = null) {
    let div = document.createElement('div');
    div.style.cssText = 'background:#f2f2f7; padding:10px; border-radius:8px; margin-bottom:10px;';
    
    let html = `<div style="margin-bottom:5px; font-weight:600;">ä¸»æˆ¿æº (å¦‚B+C):</div><select class="link-parent" style="padding:5px; width:100%; margin-bottom:10px;">`;
    validCols.forEach(c => {
        html += `<option value="${c}" ${data && data.parent==c ? 'selected':''}>${roomNames[c]}</option>`;
    });
    html += `</select>`;
    
    html += `<div style="margin-bottom:5px; font-weight:600;">åŒ…å«å­æˆ¿ (å¦‚B, C):</div><div style="display:flex; flex-wrap:wrap; gap:10px;">`;
    validCols.forEach(c => {
        let checked = (data && data.children.includes(c)) ? 'checked' : '';
        html += `<label style="display:flex; align-items:center; background:#fff; padding:4px 8px; border-radius:4px;"><input type="checkbox" class="link-child" value="${c}" ${checked} style="margin-right:4px;"> ${roomNames[c]}</label>`;
    });
    html += `</div>`;
    
    html += `<div style="text-align:right; margin-top:5px;"><button class="btn btn-secondary" style="color:red; font-size:12px; padding:4px 10px;" onclick="this.parentElement.parentElement.remove()">åˆ é™¤æ­¤ç»„</button></div>`;
    
    div.innerHTML = html;
    document.getElementById('linkContainer').appendChild(div);
}

function saveLinks() {
    let newConfig = [];
    document.querySelectorAll('#linkContainer > div').forEach(div => {
        let p = parseInt(div.querySelector('.link-parent').value);
        let kids = [];
        div.querySelectorAll('.link-child:checked').forEach(cb => kids.push(parseInt(cb.value)));
        if(kids.length > 0 && !kids.includes(p)) { 
            newConfig.push({parent: p, children: kids});
        }
    });
    linkConfig = newConfig;
    closeLinkModal();
    refreshAllViews();
}
</script>
</body>
</html>
