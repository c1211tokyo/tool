<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°‘å®¿æ™ºèƒ½ç»è¥ç³»ç»Ÿ Ultimate V3.1 | è˜‡çš„å·¥å…·ç®±</title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
    :root { 
        --primary: #007aff; 
        --bg: #f5f5f7; 
        --card: #ffffff; 
        --text: #1d1d1f; 
        --border: #d2d2d7; 
        --success: #34c759; 
        --danger: #ff3b30;
        --warning: #ffcc00;
        --info: #5ac8fa;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; box-sizing: border-box; }
    
    /* å¸ƒå±€å®¹å™¨ */
    .container { max-width: 1440px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 25px; }
    .card { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
    
    /* å¯¼èˆªæ¨¡å¼åˆ‡æ¢ */
    .nav-tabs-main { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .nav-btn-main { 
        background: #e5e5ea; border: none; padding: 12px 30px; border-radius: 25px;
        font-size: 16px; font-weight: 600; cursor: pointer; color: #86868b; transition: all 0.2s;
    }
    .nav-btn-main.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); transform: translateY(-2px); }
    .nav-btn-main:hover:not(.active) { background: #d1d1d6; }
    
    /* æ¨¡å¼åŒºåŸŸæ˜¾éš */
    .mode-section { display: none; animation: fadeIn 0.4s ease-out; }
    .mode-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* åŸæœ‰æ ·å¼ä¿ç•™ */
    .subtitle-link { text-decoration: none; color: #8e8e93; font-size: 14px; font-weight: 500; display: inline-block; margin-top: 5px; }
    .subtitle-link:hover { color: var(--primary); }
    
    /* 1. æ§åˆ¶åŒº */
    .controls-row { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; justify-content: space-between; }
    .input-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
    .input-group label { font-size: 12px; font-weight: 700; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-control { padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; background: #fff; width: 100%; box-sizing: border-box; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
    
    .btn { padding: 12px 24px; border-radius: 10px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.2); }
    .btn-primary:hover { background: #0062cc; transform: translateY(-1px); }
    .btn-secondary { background: #e5e5ea; color: #1c1c1e; }
    .btn-secondary:hover { background: #d1d1d6; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    
    /* 2. ç”»å¸ƒåŒº */
    .canvas-wrapper { position: relative; background: #2c2c2e; border-radius: 12px; overflow: hidden; margin-top: 20px; text-align: center; padding: 20px; height: 65vh; display: flex; justify-content: center; align-items: center; }
    canvas { box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 100%; max-height: 100%; cursor: crosshair; }

    /* 3. ç»“æœè§†å›¾åˆ‡æ¢ Tabs */
    .view-tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
    .tab-btn { padding: 8px 16px; border-radius: 20px; border: none; background: #f2f2f7; color: #8e8e93; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(0,122,255,0.3); }
    .tab-btn:hover:not(.active) { background: #e5e5ea; }
    
    .view-content { display: none; animation: fadeIn 0.3s; }
    .view-content.active { display: block; }

    /* 4. è¡¨æ ¼æ ·å¼ */
    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); max-height: 600px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
    th { background: #f9f9f9; padding: 12px; font-weight: 600; text-align: left; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; color: #666; }
    td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    
    /* æ¯æ—¥æ’æœŸè¡¨ç‰¹æœ‰ */
    .date-cell { position: sticky; left: 0; background: #fff; z-index: 5; border-right: 2px solid #eee; font-weight: 600; color: var(--text); }
    .cell-occupied { background-color: rgba(52, 199, 89, 0.2) !important; color: #004d1a; font-weight: bold; }
    .cell-blocked { background-color: #e5e5ea !important; color: #8e8e93; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px); cursor: not-allowed; }
    
    /* ç»Ÿè®¡æ‘˜è¦æ¡ */
    .summary-bar { display: flex; gap: 20px; margin-bottom: 20px; background: #f9f9f9; padding: 20px; border-radius: 12px; border: 1px solid #eee; justify-content: space-around; flex-wrap: wrap; }
    .summary-item { text-align: center; }
    .summary-item div { font-size: 13px; color: #86868b; margin-bottom: 5px; }
    .summary-item strong { display: block; font-size: 28px; font-weight: 700; color: var(--text); }

    /* æ¨¡æ€æ¡† */
    .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none; justify-content:center; align-items:center; backdrop-filter: blur(4px); }
    .modal-box { background:#fff; padding:30px; border-radius:16px; width:500px; max-width:90%; box-shadow:0 10px 30px rgba(0,0,0,0.2); }

    /* ============ åˆ†ææ¨¡å¼å¢å¼º CSS ============ */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .kpi-card { background: #f9f9f9; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #eee; }
    .kpi-title { font-size: 13px; color: #86868b; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }
    .kpi-value { font-size: 28px; font-weight: 800; color: var(--text); }
    .kpi-sub { font-size: 13px; margin-top: 5px; font-weight: 500; }
    
    .action-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
    .action-card { padding: 15px 20px; border-radius: 12px; border-left: 5px solid #ccc; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
    .action-card.urgent { border-left-color: var(--danger); background: #fff5f5; }
    .action-card.up { border-left-color: var(--success); background: #f0fff4; }
    .action-card.watch { border-left-color: var(--warning); background: #fffdf0; }
    
    .action-content h4 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
    .action-content p { margin: 0; font-size: 13px; color: #666; }
    .action-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #fff; white-space: nowrap; margin-left: 10px;}
    
    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }
    
    /* ä¿®å¤å›¾è¡¨å®¹å™¨å®½åº¦é—®é¢˜ */
    .chart-box { width: 100%; min-height: 400px; position: relative; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0;">æ°‘å®¿æ™ºèƒ½ç»è¥ç³»ç»Ÿ <span style="font-size:14px; background:#000; color:#fff; padding:2px 8px; border-radius:6px; vertical-align:middle;">Ultimate V3.1</span></h1>
        <a href="https://c1211tokyo.github.io/tool/" class="subtitle-link">è˜‡çš„å·¥å…·ç®±</a>
    </div>

    <div class="nav-tabs-main">
        <button class="nav-btn-main active" onclick="switchMainMode('calendar')">ğŸ“… å…¥ä½ç‡æ—¥å†æ¨¡å¼</button>
        <button class="nav-btn-main" onclick="switchMainMode('analysis')">ğŸ“Š ç»è¥æ™ºèƒ½è¯Šæ–­</button>
    </div>

    <div id="mode-calendar" class="mode-section active">
        <div class="card">
            <div class="controls-row">
                <div class="input-group">
                    <label>1. ä¸Šä¼ æ’æœŸæˆªå›¾</label>
                    <input type="file" id="imgInput" accept="image/*" class="form-control">
                </div>
                <div class="input-group" style="max-width: 120px;">
                    <label>2. æˆ¿é—´æ•° (åˆ—)</label>
                    <input type="number" id="colCount" value="10" min="1" class="form-control" onchange="resetGrid()">
                </div>
                <div class="input-group" style="max-width: 120px;">
                    <label>3. ç»Ÿè®¡å¤©æ•° (è¡Œ)</label>
                    <input type="number" id="rowCount" value="30" min="1" class="form-control">
                </div>
                <div class="input-group" style="max-width: 160px;">
                    <label>4. èµ·å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                
                <div style="display:flex; gap:10px; align-self: flex-end;">
                    <button class="btn btn-secondary" onclick="resetGrid()">ğŸ”„ é‡ç½®</button>
                    <button class="btn btn-primary" onclick="runAnalysis()">âš¡ å¼€å§‹åˆ†æ</button>
                </div>
            </div>

            <div style="margin-top:15px; font-size:13px; color:#666; background:#fffbe6; padding:10px 15px; border-radius:8px; border:1px solid #ffe58f;">
                ğŸ’¡ <strong>æ“ä½œæç¤ºï¼š</strong> çº¢æ¡†å·²è§£é”ã€‚è¯·æ‹–åŠ¨çº¢æ¡†é¡¶éƒ¨çš„ âšªï¸ <strong>å°ç™½ç‚¹</strong> å¯¹é½æ¯ä¸€åˆ—ã€‚å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼Œè¯·åœ¨æ¡†å†…æŒ‰ä½é¼ æ ‡å·¦é”®æ‹–åŠ¨æ•´ä¸ªçº¢æ¡†ã€‚
            </div>

            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>

        <div class="card" id="resultCard" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:15px;">
                <div class="view-tabs">
                    <button class="tab-btn active" onclick="switchTab('daily')">ğŸ“… æ¯æ—¥æ’æœŸ</button>
                    <button class="tab-btn" onclick="switchTab('stats')">ğŸ“‹ æˆ¿é—´ç»Ÿè®¡</button>
                    <button class="tab-btn" onclick="switchTab('charts')">ğŸ“Š å¯è§†åŒ–</button>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" onclick="openLinkModal()">ğŸ”— å…³è”ç»„åˆæˆ¿</button>
                    <button class="btn btn-secondary" onclick="exportImage()">ğŸ–¼ï¸ å­˜å›¾</button>
                    <button class="btn btn-secondary" onclick="exportExcel()">ğŸ“¥ Excel</button>
                </div>
            </div>

            <div id="view-daily" class="view-content active">
                <div class="summary-bar">
                    <div class="summary-item"><div>ç»¼åˆå…¥ä½ç‡</div><strong id="valTotalRate" style="color:var(--primary)">0%</strong></div>
                    <div class="summary-item"><div>æ€»æˆ¿æ™š (åŠ¨æ€)</div><strong id="valTotalSlots">0</strong></div>
                    <div class="summary-item"><div>å®é™…å…¥ä½</div><strong id="valTotalOcc" style="color:var(--success)">0</strong></div>
                </div>
                <div class="table-container">
                    <table id="dailyTable"></table>
                </div>
            </div>

            <div id="view-stats" class="view-content">
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th>æˆ¿é—´åç§°</th>
                                <th>ç»Ÿè®¡æ€»å¤©æ•°</th>
                                <th>è¢«å…³è”å ç”¨ (ä¸å¯å”®)</th>
                                <th>æœ‰æ•ˆå”®å–å¤©æ•°</th>
                                <th>å®é™…å…¥ä½å¤©æ•°</th>
                                <th>å…¥ä½ç‡ (åŸºäºæœ‰æ•ˆå¤©æ•°)</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-charts" class="view-content">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:30px;">
                    <div class="card" style="box-shadow:none; border:1px solid #eee;">
                        <h3 style="margin:0 0 15px 0; text-align:center; font-size:16px;">å„æˆ¿é—´å…¥ä½ç‡æ’è¡Œ</h3>
                        <div id="chartBar" style="width:100%; height:400px;"></div>
                    </div>
                    <div class="card" style="box-shadow:none; border:1px solid #eee;">
                        <h3 style="margin:0 0 15px 0; text-align:center; font-size:16px;">æ¯æ—¥æ€»å…¥ä½è¶‹åŠ¿</h3>
                        <div id="chartLine" style="width:100%; height:400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mode-analysis" class="mode-section">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“‚ ä¸Šä¼ ç»è¥æ•°æ® (CSV)</h3>
            <p style="font-size:13px; color:#888;">è¯·ä¸Šä¼ åå°å¯¼å‡ºçš„æ ‡å‡†æ ¼å¼ CSV æ–‡ä»¶ã€‚</p>
            <div class="controls-row" style="align-items: flex-start;">
                <div class="input-group">
                    <label>ğŸ“„ å‚ç…§ç»„ (å¦‚11æœˆ/å·²å®Œæˆ)</label>
                    <input type="file" id="csvPast" accept=".csv" class="form-control">
                </div>
                <div class="input-group">
                    <label>ğŸ“… è¯Šæ–­ç»„ (å¦‚12æœˆ/æœªæ¥é¢„è®¢)</label>
                    <input type="file" id="csvFuture" accept=".csv" class="form-control">
                </div>
            </div>
            <button class="btn btn-primary" style="margin-top:20px; width:100%;" onclick="startDiagnosis()">ğŸš€ å¼€å§‹æ™ºèƒ½è¯Šæ–­</button>
        </div>

        <div id="analysisOutput" style="display:none;">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">æœªæ¥æ€»è¥æ”¶é¢„æµ‹</div>
                    <div class="kpi-value" style="color:var(--primary);" id="totalRevenue">--</div>
                    <div class="kpi-sub" id="revenueDiff">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">æ•´ä½“ RevPAR å˜åŒ–</div>
                    <div class="kpi-value" id="avgRevParChange">--</div>
                    <div class="kpi-sub">æ¯é—´å¯å”®æˆ¿æ”¶å…¥</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">å¹³å‡å…¥ä½ç‡</div>
                    <div class="kpi-value" id="avgOccFuture">--</div>
                    <div class="kpi-sub" id="avgOccDiff">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">å¹³å‡æˆ¿ä»· (ADR)</div>
                    <div class="kpi-value" id="avgAdrFuture">--</div>
                    <div class="kpi-sub" id="avgAdrDiff">--</div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ’¡ æ™ºèƒ½å®šä»·è¡ŒåŠ¨æ¸…å•</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">åŸºäº RevPAR (æ¯é—´å¯å”®æˆ¿æ”¶å…¥) è¶‹åŠ¿ç”Ÿæˆçš„å»ºè®®ã€‚çº¢å¡ä»£è¡¨æ¶¨ä»·ç­–ç•¥å¤±è´¥ï¼Œéœ€é™ä»·æŒ½å›æŸå¤±ã€‚</p>
                <div id="actionContainer" class="action-list"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ§© æˆ¿æºè¡¨ç°çŸ©é˜µ (å››è±¡é™åˆ†æ)</h3>
                <p style="font-size:13px; color:#666;">
                    <strong>æ˜æ˜Ÿæˆ¿æº (å³ä¸Š):</strong> é«˜ä»·é«˜ä½ï¼Œä¿æŒç°çŠ¶æˆ–å¾®æ¶¨ã€‚<br>
                    <strong>é—®é¢˜æˆ¿æº (å·¦ä¸Š):</strong> é«˜ä»·ä½ä½ï¼Œå¿…é¡»é™ä»·ï¼<br>
                    <strong>é‡‘ç‰›æˆ¿æº (å³ä¸‹):</strong> ä½ä»·é«˜ä½ï¼Œå¯ä»¥å°è¯•æ¶¨ä»·è·åˆ©ã€‚<br>
                    <strong>ç˜¦ç‹—æˆ¿æº (å·¦ä¸‹):</strong> ä½ä»·ä½ä½ï¼Œéœ€æ£€æŸ¥æˆ¿æºè´¨é‡æˆ–è¯„è®ºã€‚
                </p>
                <div id="scatterChart" class="chart-box"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ“‹ è¯¦ç»†æ•°æ®å¯¹æ¯”</h3>
                <div class="table-container">
                    <table style="width:100%;">
                        <thead>
                            <tr>
                                <th>æˆ¿æº</th>
                                <th>æœªæ¥ ADR (å˜åŒ–)</th>
                                <th>æœªæ¥å…¥ä½ç‡ (å˜åŒ–)</th>
                                <th>æœªæ¥ RevPAR (å˜åŒ–)</th>
                                <th>æ€»æ”¶å…¥é¢„æµ‹</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-mask" id="linkModal">
    <div class="modal-box">
        <h3 style="margin-top:0;">ğŸ”— ç»„åˆæˆ¿å…³è”è®¾ç½®</h3>
        <p style="font-size:13px; color:#666;">è®¾ç½®åï¼Œä¸»æˆ¿å…¥ä½é”å­æˆ¿ï¼Œå­æˆ¿å…¥ä½é”ä¸»æˆ¿ã€‚</p>
        <div id="linkContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn btn-secondary" onclick="addLinkRow()">+ æ·»åŠ ä¸€ç»„</button>
            <div>
                <button class="btn btn-secondary" onclick="closeLinkModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveLinks()">ä¿å­˜ç”Ÿæ•ˆ</button>
            </div>
        </div>
    </div>
</div>

<datalist id="prefix-list">
    <option value="æ¸‹è°·"></option><option value="å…¥è°·"></option><option value="æ± è¢‹"></option>
    <option value="å‘å³¶"></option><option value="ä¸¡å›½"></option><option value="å¤§ä¹…ä¿"></option><option value="åŒ—æ–°å®¿"></option>
</datalist>
<datalist id="suffix-list">
    <option value="101"></option><option value="102"></option><option value="201"></option><option value="202"></option>
    <option value="A"></option><option value="B"></option><option value="C"></option>
</datalist>

<script>
// ==========================================
// PART 1: ä¸»å¯¼èˆªåˆ‡æ¢
// ==========================================
function switchMainMode(mode) {
    document.querySelectorAll('.nav-btn-main').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.mode-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('mode-' + mode).classList.add('active');
    
    // ä¿®å¤åˆ‡æ¢æ—¶å›¾è¡¨å®½åº¦é—®é¢˜
    if(mode === 'analysis' && scatterChartIns) {
        setTimeout(() => scatterChartIns.resize(), 100);
    }
}

// ==========================================
// PART 2: ç»è¥æ™ºèƒ½è¯Šæ–­ (å¢å¼ºç‰ˆæ ¸å¿ƒé€»è¾‘)
// ==========================================
let scatterChartIns = null;

function startDiagnosis() {
    const filePast = document.getElementById('csvPast').files[0];
    const fileFuture = document.getElementById('csvFuture').files[0];

    if (!filePast || !fileFuture) {
        alert("è¯·ä¸Šä¼ ä¸¤ä»½ CSV æ–‡ä»¶è¿›è¡Œå¯¹æ¯”åˆ†æï¼");
        return;
    }

    Promise.all([parseCSV(filePast), parseCSV(fileFuture)]).then(results => {
        const dataPast = cleanBusinessData(results[0].data);
        const dataFuture = cleanBusinessData(results[1].data);
        
        if(Object.keys(dataFuture).length === 0) {
            alert("CSV è§£æå¤±è´¥ï¼Œæœªèƒ½æ‰¾åˆ°'æˆ¿æº'ã€'å…¥ä½ç‡'æˆ–'æˆ¿è´¹'ç›¸å…³åˆ—ã€‚");
            return;
        }

        // 1. å…ˆæ˜¾ç¤ºå®¹å™¨ï¼Œç¡®ä¿å›¾è¡¨èƒ½è·å–å®½åº¦
        document.getElementById('analysisOutput').style.display = 'block';
        
        // 2. å»¶è¿Ÿä¸€ç‚¹æ¸²æŸ“ï¼Œé˜²æ­¢ DOM æœªå®Œå…¨å±•å¼€
        setTimeout(() => {
            renderAnalysis(dataPast, dataFuture);
            document.getElementById('analysisOutput').scrollIntoView({behavior:'smooth'});
        }, 50);
    });
}

function parseCSV(file) {
    return new Promise(resolve => {
        Papa.parse(file, { header: false, skipEmptyLines: true, complete: resolve });
    });
}

function cleanBusinessData(rawData) {
    let headerIndex = -1;
    let map = {};
    
    // æ™ºèƒ½å¯»æ‰¾è¡¨å¤´
    for (let i = 0; i < Math.min(15, rawData.length); i++) {
        const rowStr = rawData[i].join(' ');
        if (rowStr.includes('æˆ¿æº') && rowStr.includes('å…¥ä½ç‡')) {
            headerIndex = i;
            break;
        }
    }

    if (headerIndex === -1) return {};

    const headers = rawData[headerIndex];
    // åŠ¨æ€æ˜ å°„åˆ—ç´¢å¼•
    const idxName = headers.findIndex(h => h.includes('æˆ¿æº'));
    const idxOcc = headers.findIndex(h => h.includes('å…¥ä½ç‡'));
    const idxPrice = headers.findIndex(h => h.includes('æˆ¿è´¹.1') || h === 'ADR'); // ADR
    const idxRevPar = headers.findIndex(h => h.includes('æˆ¿è´¹.2') || h.toLowerCase().includes('revpar')); // RevPAR
    const idxIncome = headers.findIndex(h => h.includes('å‡€æ”¶å…¥') || h.includes('æ”¶å…¥'));

    for (let i = headerIndex + 1; i < rawData.length; i++) {
        const row = rawData[i];
        const name = row[idxName];
        
        if (name && name !== 'æ€»è®¡' && name.trim() !== '') {
            const parseNum = (val) => {
                if (!val) return 0;
                return parseFloat(String(val).replace(/[Â¥,%\s]/g, ''));
            };

            const occ = parseNum(row[idxOcc]) / 100.0;
            const adr = parseNum(row[idxPrice]);
            const income = parseNum(row[idxIncome]);
            // å¦‚æœ CSV é‡Œæ²¡æœ‰ RevPAR åˆ—ï¼Œæ‰‹åŠ¨è®¡ç®—ï¼šRevPAR = ADR * Occupancy
            let revpar = (idxRevPar > -1) ? parseNum(row[idxRevPar]) : (adr * occ);
            
            map[name] = { name, occ, adr, income, revpar };
        }
    }
    return map;
}

function renderAnalysis(pastMap, futureMap) {
    const rooms = Object.keys(futureMap);
    let totalRevenueFuture = 0, totalRevenuePast = 0;
    let totalRevParChange = 0, count = 0;
    let totalOccFuture = 0, totalOccPast = 0;
    let totalAdrFuture = 0, totalAdrPast = 0;

    const actionContainer = document.getElementById('actionContainer');
    const tableBody = document.getElementById('detailTableBody');
    const scatterData = [];

    actionContainer.innerHTML = '';
    tableBody.innerHTML = '';

    rooms.forEach(room => {
        const future = futureMap[room];
        const past = pastMap[room] || { occ: 0, adr: future.adr, income: 0, revpar: 0 };

        totalRevenueFuture += future.income;
        totalRevenuePast += past.income;
        totalOccFuture += future.occ;
        totalOccPast += past.occ;
        totalAdrFuture += future.adr;
        totalAdrPast += past.adr;
        count++;

        // è®¡ç®—å…³é”®å˜åŒ–ç‡
        const adrChange = past.adr > 0 ? (future.adr - past.adr) / past.adr : 0;
        const occDiff = future.occ - past.occ;
        const revParChange = past.revpar > 0 ? (future.revpar - past.revpar) / past.revpar : 0;

        // --- ç”Ÿæˆè¡ŒåŠ¨å»ºè®® (åŸºäº RevPAR é€»è¾‘) ---
        let actionCard = '';
        
        // åœºæ™¯1: æ¶¨ä»·å¤±è´¥ (ADRæ¶¨, å…¥ä½è·Œ, RevPAR è·Œ) -> å¿…é¡»é™ä»·
        if (adrChange > 0.05 && occDiff < -0.15 && revParChange < -0.05) {
            actionCard = createActionCard('urgent', room, 'ğŸ“‰ å¿…é¡»é™ä»·', 
                `ç›²ç›®æ¶¨ä»· ${(adrChange*100).toFixed(0)}%ï¼Œå¯¼è‡´å…¥ä½ç‡æš´è·Œ ${(Math.abs(occDiff)*100).toFixed(0)}%ï¼Œæœ€ç»ˆæ”¶ç›ŠäºæŸã€‚`, 
                `å»ºè®®å›è°ƒè‡³ Â¥${past.adr.toFixed(0)}`);
        }
        // åœºæ™¯2: é™ä»·ä¹Ÿå–ä¸åŠ¨ (ADRè·Œ, å…¥ä½ä½) -> æ£€æŸ¥è´¨é‡
        else if (adrChange < -0.05 && future.occ < 0.3) {
            actionCard = createActionCard('watch', room, 'âš ï¸ æµé‡å¼‚å¸¸', 
                `é™ä»·äº†ä¹Ÿæ²¡äººä½(å…¥ä½ç‡${(future.occ*100).toFixed(0)}%)ã€‚ä¸æ˜¯ä»·æ ¼é—®é¢˜ã€‚`, 
                `æ£€æŸ¥å·®è¯„/é¦–å›¾/è®¾æ–½`);
        }
        // åœºæ™¯3: æä»·æˆåŠŸ/æ½œåŠ›è‚¡ (å…¥ä½é«˜, RevPAR æ¶¨) -> ä¿æŒæˆ–å¾®æ¶¨
        else if (future.occ > 0.8) {
            actionCard = createActionCard('up', room, 'ğŸ’° é€‚å½“æä»·', 
                `æå…¶æŠ¢æ‰‹(å…¥ä½ç‡${(future.occ*100).toFixed(0)}%)ã€‚`, 
                `è¯•æ¢æ€§æ¶¨ä»· 5-8%`);
        }
        // åœºæ™¯4: æ¶¨ä»·æˆåŠŸ (ADRæ¶¨, RevPARæ¶¨) -> æˆåŠŸç­–ç•¥
        else if (adrChange > 0.05 && revParChange > 0) {
            // è¿™æ˜¯å¥½äº‹ï¼Œä¸ä¸€å®šéè¦æ˜¾ç¤ºå¡ç‰‡ï¼Œæˆ–è€…æ˜¾ç¤ºä¸€ä¸ªèµ
        }

        if(actionCard) actionContainer.innerHTML += actionCard;

        // --- å¡«å……è¡¨æ ¼ ---
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:bold;">${room}</td>
            <td>Â¥${future.adr.toLocaleString()} <span class="${adrChange>0?'trend-up':'trend-down'}">(${adrChange>0?'+':''}${(adrChange*100).toFixed(1)}%)</span></td>
            <td>${(future.occ*100).toFixed(0)}% <span class="${occDiff>0?'trend-up':'trend-down'}">(${occDiff>0?'+':''}${(occDiff*100).toFixed(0)}%)</span></td>
            <td style="font-weight:bold;">Â¥${future.revpar.toFixed(0)} <span class="${revParChange>0?'trend-up':'trend-down'}">(${revParChange>0?'+':''}${(revParChange*100).toFixed(1)}%)</span></td>
            <td>Â¥${future.income.toLocaleString()}</td>
        `;
        tableBody.appendChild(tr);

        // --- å‡†å¤‡å››è±¡é™æ•£ç‚¹å›¾æ•°æ® ---
        // Xè½´: å…¥ä½ç‡, Yè½´: å‡ä»· (ç›¸å¯¹å¹³å‡å€¼çš„å€æ•°ï¼Œæ–¹ä¾¿å½’ä¸€åŒ–å±•ç¤º)
        scatterData.push([
            future.occ * 100, // X: å…¥ä½ç‡
            future.adr,       // Y: ä»·æ ¼
            future.revpar,    // æ°”æ³¡å¤§å°: RevPAR
            room,             // Name
            adrChange         // ç”¨äºé¢œè‰²åˆ¤æ–­: æ¶¨ä»·äº†è¿˜æ˜¯é™ä»·äº†
        ]);

        if(pastMap[room]) totalRevParChange += revParChange;
    });

    if(actionContainer.innerHTML === '') {
        actionContainer.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">âœ… æ‰€æœ‰æˆ¿æºè¡¨ç°ç¨³å¥ï¼Œæš‚æ— æ¿€è¿›è°ƒä»·å»ºè®®ã€‚</div>';
    }

    // æ›´æ–° KPI é¢æ¿
    document.getElementById('totalRevenue').innerText = 'Â¥' + totalRevenueFuture.toLocaleString();
    const revDiffVal = totalRevenueFuture - totalRevenuePast;
    document.getElementById('revenueDiff').innerHTML = `<span class="${revDiffVal>=0?'trend-up':'trend-down'}">${revDiffVal>=0?'+':''}${revDiffVal.toLocaleString()} vs ä¸ŠæœŸ</span>`;
    
    const avgRevChange = count > 0 ? (totalRevParChange / count * 100) : 0;
    document.getElementById('avgRevParChange').innerHTML = `<span class="${avgRevChange>=0?'trend-up':'trend-down'}">${avgRevChange>=0?'+':''}${avgRevChange.toFixed(1)}%</span>`;

    const avgOcc = count > 0 ? totalOccFuture/count : 0;
    const avgOccDiffVal = count > 0 ? (totalOccFuture - totalOccPast)/count : 0;
    document.getElementById('avgOccFuture').innerText = (avgOcc*100).toFixed(1) + '%';
    document.getElementById('avgOccDiff').innerHTML = `<span class="${avgOccDiffVal>=0?'trend-up':'trend-down'}">${avgOccDiffVal>=0?'+':''}${(avgOccDiffVal*100).toFixed(1)}%</span>`;

    const avgAdr = count > 0 ? totalAdrFuture/count : 0;
    const avgAdrDiffVal = count > 0 ? (totalAdrFuture - totalAdrPast)/count : 0;
    document.getElementById('avgAdrFuture').innerText = 'Â¥' + avgAdr.toFixed(0);
    document.getElementById('avgAdrDiff').innerHTML = `<span class="${avgAdrDiffVal>=0?'trend-up':'trend-down'}">${avgAdrDiffVal>=0?'+':''}${avgAdrDiffVal.toFixed(0)}</span>`;

    renderScatterChart(scatterData, avgAdr);
}

function createActionCard(type, room, title, reason, action) {
    let badgeClass = type === 'urgent' ? 'bg-red' : (type === 'up' ? 'bg-green' : 'bg-warning');
    return `
    <div class="action-card ${type}">
        <div class="action-content">
            <div style="display:flex; align-items:center; margin-bottom:5px;">
                <h4>${title}</h4>
                <span class="action-badge ${badgeClass}" style="${type==='watch'?'background:#f0ad4e;':''}">${room}</span>
            </div>
            <p><strong>åŸå› :</strong> ${reason}</p>
            <p style="margin-top:5px; color:#333;"><strong>ğŸ‘‰ å»ºè®®:</strong> ${action}</p>
        </div>
    </div>`;
}

function renderScatterChart(data, avgAdr) {
    if (scatterChartIns) scatterChartIns.dispose();
    scatterChartIns = echarts.init(document.getElementById('scatterChart'));
    
    const option = {
        grid: { left: '10%', right: '15%', top: '10%', bottom: '10%' },
        tooltip: {
            formatter: function (param) {
                return `<b>${param.data[3]}</b><br/>å…¥ä½ç‡: ${param.data[0].toFixed(0)}%<br/>å‡ä»·: Â¥${param.data[1]}<br/>RevPAR: Â¥${param.data[2].toFixed(0)}`;
            }
        },
        xAxis: { name: 'å…¥ä½ç‡ (%)', min: 0, max: 100, splitLine: { lineStyle: { type: 'dashed' } } },
        yAxis: { name: 'å‡ä»· (ADR)', splitLine: { lineStyle: { type: 'dashed' } }, scale:true },
        visualMap: {
            show: false,
            dimension: 2, // æ°”æ³¡å¤§å°åŸºäº RevPAR
            min: 0,
            max: 20000,
            inRange: { symbolSize: [15, 50] }
        },
        series: [{
            type: 'scatter',
            data: data,
            itemStyle: {
                color: function(param) {
                    const occ = param.data[0];
                    const price = param.data[1];
                    // ç®€å•å››è±¡é™ç€è‰²
                    if (occ > 60 && price > avgAdr) return '#ff3b30'; // æ˜æ˜Ÿ (çº¢)
                    if (occ < 40 && price > avgAdr) return '#5ac8fa'; // é—®é¢˜ (è“)
                    if (occ > 60 && price <= avgAdr) return '#34c759'; // é‡‘ç‰› (ç»¿)
                    return '#8e8e93'; // ç˜¦ç‹— (ç°)
                },
                shadowBlur: 10,
                shadowColor: 'rgba(0,0,0,0.2)'
            },
            label: { show: true, formatter: '{@3}', position: 'right', fontSize: 11, color: '#333' },
            markLine: {
                silent: true,
                data: [
                    { xAxis: 50, label: { formatter: 'å…¥ä½ç‡åˆ†ç•Œ' } },
                    { yAxis: avgAdr, label: { formatter: 'å¹³å‡å‡ä»·' } }
                ],
                lineStyle: { type: 'solid', color: '#ccc' }
            },
            markArea: {
                silent: true,
                itemStyle: { color: 'transparent', borderWidth: 0, borderType: 'dashed' },
                data: [
                    [{ name: 'é—®é¢˜åŒºåŸŸ\n(é«˜ä»·ä½ä½)', xAxis: 0, yAxis: avgAdr }, { xAxis: 50, yAxis: 100000 }],
                    [{ name: 'æ˜æ˜ŸåŒºåŸŸ\n(é«˜ä»·é«˜ä½)', xAxis: 50, yAxis: avgAdr }, { xAxis: 100, yAxis: 100000 }],
                    [{ name: 'ç˜¦ç‹—åŒºåŸŸ\n(ä½ä»·ä½ä½)', xAxis: 0, yAxis: 0 }, { xAxis: 50, yAxis: avgAdr }],
                    [{ name: 'é‡‘ç‰›åŒºåŸŸ\n(ä½ä»·é«˜ä½)', xAxis: 50, yAxis: 0 }, { xAxis: 100, yAxis: avgAdr }]
                ]
            }
        }]
    };
    scatterChartIns.setOption(option);
}

// ç›‘å¬çª—å£å¤§å°å˜åŒ–
window.addEventListener('resize', () => { 
    if(scatterChartIns) scatterChartIns.resize(); 
    if(chartBarIns) chartBarIns.resize();
    if(chartLineIns) chartLineIns.resize();
});

// ==========================================
// PART 3: åŸæœ‰æ—¥å†é€»è¾‘ (å®Œæ•´ä¿ç•™)
// ==========================================
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
let img = new Image();

// å‡ ä½•æ•°æ®
let grid = { x: 50, y: 50, w: 100, h: 100 }; 
let colDividers = []; 
let isDragging = false;
let dragTarget = null; 
let lastMouse = {x:0, y:0};

// ä¸šåŠ¡æ•°æ®
let rawData = []; 
let roomNames = []; 
let roomParts = []; 
let validCols = [];
let dateList = [];
let linkConfig = [];
let chartBarIns = null;
let chartLineIns = null;

document.getElementById('startDate').valueAsDate = new Date();

document.getElementById('imgInput').addEventListener('change', e => {
    if(e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = evt => {
            img.src = evt.target.result;
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                grid.x = img.width * 0.05;
                grid.y = img.height * 0.15;
                grid.w = img.width * 0.9;
                grid.h = img.height * 0.75;
                resetGrid();
            };
        };
        reader.readAsDataURL(e.target.files[0]);
    }
});

function resetGrid() {
    const cols = parseInt(document.getElementById('colCount').value) || 1;
    colDividers = [];
    for(let i=1; i<cols; i++) colDividers.push(i/cols);
    draw();
}

function draw() {
    if(!img.src) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);

    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0,0, canvas.width, grid.y);
    ctx.fillRect(0, grid.y+grid.h, canvas.width, canvas.height-(grid.y+grid.h));
    ctx.fillRect(0, grid.y, grid.x, grid.h);
    ctx.fillRect(grid.x+grid.w, grid.y, canvas.width-(grid.x+grid.w), grid.h);

    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 3;
    ctx.strokeRect(grid.x, grid.y, grid.w, grid.h);

    const rows = parseInt(document.getElementById('rowCount').value) || 1;
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255, 59, 48, 0.3)';
    ctx.lineWidth = 1;
    for(let i=1; i<rows; i++) {
        let y = grid.y + (grid.h/rows)*i;
        ctx.moveTo(grid.x, y);
        ctx.lineTo(grid.x+grid.w, y);
    }
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = '#ff3b30';
    ctx.lineWidth = 2;
    colDividers.forEach(r => {
        let x = grid.x + r * grid.w;
        ctx.moveTo(x, grid.y);
        ctx.lineTo(x, grid.y+grid.h);
    });
    ctx.stroke();

    const handleR = img.width * 0.008; 
    const drawDot = (x,y, color) => {
        ctx.beginPath(); ctx.arc(x,y, handleR < 8 ? 8 : handleR, 0, Math.PI*2);
        ctx.fillStyle=color; ctx.fill(); ctx.strokeStyle='#fff'; ctx.stroke();
    };
    drawDot(grid.x, grid.y, '#007aff'); 
    drawDot(grid.x+grid.w, grid.y+grid.h, '#007aff'); 
    colDividers.forEach(r => {
        drawDot(grid.x + r * grid.w, grid.y, '#fff'); 
    });
}

function getMousePos(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

canvas.addEventListener('mousedown', e => {
    const {x, y} = getMousePos(e);
    const R = Math.max(20, img.width * 0.015); 
    for(let i=0; i<colDividers.length; i++) {
        let lineX = grid.x + colDividers[i] * grid.w;
        if(Math.hypot(x - lineX, y - grid.y) < R) { isDragging = true; dragTarget = {type:'divider', index:i}; return; }
    }
    if(Math.hypot(x - grid.x, y - grid.y) < R) { isDragging=true; dragTarget={type:'box', handle:'tl'}; return; }
    if(Math.hypot(x-(grid.x+grid.w), y-(grid.y+grid.h)) < R) { isDragging=true; dragTarget={type:'box', handle:'br'}; return; }
    if(x > grid.x && x < grid.x+grid.w && y > grid.y && y < grid.y+grid.h) {
        isDragging = true; dragTarget = {type:'move'}; lastMouse = {x,y};
    }
});

canvas.addEventListener('mousemove', e => {
    const {x, y} = getMousePos(e);
    if(!isDragging) {
        canvas.style.cursor = 'default';
        const R = Math.max(20, img.width * 0.015);
        for(let r of colDividers) if(Math.hypot(x-(grid.x+r*grid.w), y-grid.y) < R) canvas.style.cursor = 'col-resize';
        return;
    }
    if(dragTarget.type === 'move') {
        grid.x += x - lastMouse.x; grid.y += y - lastMouse.y; lastMouse = {x,y};
    } else if(dragTarget.type === 'box') {
        if(dragTarget.handle === 'tl') {
            let r = grid.x+grid.w, b = grid.y+grid.h; grid.x = x; grid.y = y; grid.w = r-x; grid.h = b-y;
        } else { grid.w = x-grid.x; grid.h = y-grid.y; }
    } else if(dragTarget.type === 'divider') {
        let i = dragTarget.index;
        let r = (x - grid.x) / grid.w;
        let min = (i===0) ? 0 : colDividers[i-1];
        let max = (i===colDividers.length-1) ? 1 : colDividers[i+1];
        if(r > min+0.01 && r < max-0.01) colDividers[i] = r;
    }
    draw();
});

canvas.addEventListener('mouseup', () => isDragging = false);

function runAnalysis() {
    if(!img.src) { alert("è¯·ä¸Šä¼ å›¾ç‰‡"); return; }
    const rows = parseInt(document.getElementById('rowCount').value);
    const cellH = grid.h / rows;
    const boundaries = [0, ...colDividers, 1.0];
    const cols = boundaries.length - 1;

    rawData = []; roomNames = []; roomParts = []; validCols = []; dateList = [];
    const imgData = ctx.getImageData(0,0, canvas.width, canvas.height).data;

    for(let c=0; c<cols; c++) {
        roomNames.push(String.fromCharCode(65+c)); 
        roomParts.push({ prefix: '', suffix: '' });
        validCols.push(c);
    }
    
    const startD = new Date(document.getElementById('startDate').value);
    for(let r=0; r<rows; r++) {
        let d = new Date(startD); d.setDate(d.getDate()+r);
        dateList.push(`${d.getMonth()+1}/${d.getDate()}`);
        let rowArr = [];
        let rowY = grid.y + r*cellH;
        for(let c=0; c<cols; c++) {
            let r1 = boundaries[c], r2 = boundaries[c+1];
            let cellX = grid.x + r1 * grid.w;
            let cellW = (r2-r1) * grid.w;
            let sx = cellX + cellW*0.35, sy = rowY + cellH*0.35;
            let sw = cellW*0.3, sh = cellH*0.3;
            let count=0, total=0;
            for(let py=sy; py<sy+sh; py++) {
                for(let px=sx; px<sx+sw; px++) {
                    let i = (Math.floor(py)*canvas.width + Math.floor(px))*4;
                    if(imgData[i]<230 || imgData[i+1]<230 || imgData[i+2]<230) count++;
                    total++;
                }
            }
            rowArr.push( (count/total > 0.1) ? 1 : 0 );
        }
        rawData.push(rowArr);
    }
    document.getElementById('resultCard').style.display = 'block';
    refreshAllViews();
    switchTab('daily');
    document.getElementById('resultCard').scrollIntoView({behavior:'smooth'});
}

function getBlockedSet(r) {
    let blockedSet = new Set();
    linkConfig.forEach(cfg => {
        if(rawData[r][cfg.parent] === 1) cfg.children.forEach(child => blockedSet.add(child));
        let anyChildOccupied = cfg.children.some(childIdx => rawData[r][childIdx] === 1);
        if(anyChildOccupied) blockedSet.add(cfg.parent);
    });
    return blockedSet;
}

function updateRoomName(c) {
    const p = roomParts[c].prefix.trim(); const s = roomParts[c].suffix.trim();
    roomNames[c] = (p===''&&s==='') ? String.fromCharCode(65+c) : p+s;
    refreshAllViews();
}

function refreshAllViews() {
    renderDailyTable(); renderStatsTable(); renderCharts();
}

function renderDailyTable() {
    const table = document.getElementById('dailyTable'); table.innerHTML = '';
    let thead = document.createElement('thead'); let tr = document.createElement('tr');
    let thDate = document.createElement('th'); thDate.innerText = 'æ—¥æœŸ'; thDate.style.zIndex = '11'; thDate.style.left = '0'; tr.appendChild(thDate);
    validCols.forEach(c => {
        let th = document.createElement('th');
        let container = document.createElement('div');
        container.innerHTML = `<div class="th-label-preview">${roomNames[c]}</div>`;
        let inp1 = document.createElement('input'); inp1.className = 'th-input-mini'; inp1.setAttribute('list','prefix-list'); inp1.placeholder='å‰ç¼€'; inp1.value=roomParts[c].prefix; inp1.onchange=e=>{roomParts[c].prefix=e.target.value; updateRoomName(c)};
        let inp2 = document.createElement('input'); inp2.className = 'th-input-mini'; inp2.setAttribute('list','suffix-list'); inp2.placeholder='åç¼€'; inp2.value=roomParts[c].suffix; inp2.onchange=e=>{roomParts[c].suffix=e.target.value; updateRoomName(c)};
        container.append(inp1, inp2);
        let btnDel = document.createElement('div'); btnDel.innerText='Ã— åˆ é™¤'; btnDel.style.cssText='color:red;cursor:pointer;font-size:10px;margin-top:2px;'; btnDel.onclick=()=>{if(confirm('åˆ é™¤åˆ—?')){validCols=validCols.filter(x=>x!==c);linkConfig=linkConfig.filter(l=>l.parent!==c&&!l.children.includes(c));refreshAllViews();}};
        container.appendChild(btnDel); th.appendChild(container); tr.appendChild(th);
    });
    thead.appendChild(tr); table.appendChild(thead);

    let tbody = document.createElement('tbody'); let totalSlots=0, totalOcc=0;
    for(let r=0; r<rawData.length; r++) {
        let tr = document.createElement('tr');
        let tdD = document.createElement('td'); tdD.className='date-cell'; tdD.innerText=dateList[r]; tr.appendChild(tdD);
        let blockedCols = getBlockedSet(r);
        validCols.forEach(c => {
            let td = document.createElement('td'); let isOcc = rawData[r][c]===1; let isBlocked = blockedCols.has(c);
            if(isOcc) { td.className='cell-occupied'; td.innerText='ä½'; totalOcc++; td.onclick=()=>{rawData[r][c]=0;refreshAllViews();}; td.style.cursor='pointer'; }
            else if(isBlocked) { td.className='cell-blocked'; td.innerText='ğŸ”’'; }
            else { totalSlots++; td.onclick=()=>{rawData[r][c]=1;refreshAllViews();}; td.style.cursor='pointer'; }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    document.getElementById('valTotalSlots').innerText = totalSlots;
    document.getElementById('valTotalOcc').innerText = totalOcc;
    document.getElementById('valTotalRate').innerText = totalSlots ? (totalOcc/totalSlots*100).toFixed(1)+'%' : '0%';
}

function renderStatsTable() {
    const tbody = document.getElementById('statsTableBody'); tbody.innerHTML = '';
    const totalDays = rawData.length;
    validCols.forEach(c => {
        let stats = { name: roomNames[c], total: totalDays, blocked: 0, valid: 0, occupied: 0 };
        for(let r=0; r<totalDays; r++) {
            let blockedCols = getBlockedSet(r); let isOcc = rawData[r][c]===1;
            if(isOcc) { stats.valid++; stats.occupied++; } else if(blockedCols.has(c)) { stats.blocked++; } else { stats.valid++; }
        }
        let rate = stats.valid > 0 ? (stats.occupied / stats.valid * 100).toFixed(1) : 0;
        let tr = document.createElement('tr');
        tr.innerHTML = `<td><b>${stats.name}</b></td><td>${stats.total}</td><td style="color:#999">${stats.blocked}</td><td>${stats.valid}</td><td>${stats.occupied}</td><td><b>${rate}%</b></td>`;
        tbody.appendChild(tr);
    });
}

function renderCharts() {
    let barX = [], barY = [];
    validCols.forEach(c => {
        barX.push(roomNames[c]);
        let valid=0, occ=0;
        for(let r=0; r<rawData.length; r++) {
            let blockedCols = getBlockedSet(r); let isOcc = rawData[r][c]===1;
            if(isOcc) { valid++; occ++; } else if(!blockedCols.has(c)) { valid++; }
        }
        barY.push(valid>0 ? (occ/valid*100).toFixed(1) : 0);
    });

    if (chartBarIns) chartBarIns.dispose();
    chartBarIns = echarts.init(document.getElementById('chartBar'));
    chartBarIns.setOption({
        tooltip: { trigger: 'axis' }, grid: { top: 30, bottom: 30 },
        xAxis: { type: 'category', data: barX }, yAxis: { type: 'value', max:100 },
        series: [{ type:'bar', data:barY, itemStyle:{color:'#007aff'} }]
    });

    let lineX = dateList, lineY = [];
    for(let r=0; r<rawData.length; r++) {
        let daySlots=0, dayOcc=0; let blockedCols = getBlockedSet(r);
        validCols.forEach(c => {
            let isOcc = rawData[r][c]===1;
            if(isOcc) { daySlots++; dayOcc++; } else if(!blockedCols.has(c)) { daySlots++; }
        });
        lineY.push(daySlots>0 ? (dayOcc/daySlots*100).toFixed(1) : 0);
    }

    if (chartLineIns) chartLineIns.dispose();
    chartLineIns = echarts.init(document.getElementById('chartLine'));
    chartLineIns.setOption({
        tooltip: { trigger: 'axis' }, grid: { top: 30, bottom: 30 },
        xAxis: { type: 'category', data: lineX }, yAxis: { type: 'value', max:100 },
        series: [{ type:'line', smooth:true, data:lineY, itemStyle:{color:'#34c759'}, areaStyle:{opacity:0.2} }]
    });
}

function switchTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[['daily','stats','charts'].indexOf(name)].classList.add('active');
    document.getElementById('view-'+name).classList.add('active');
    if(name === 'charts') setTimeout(renderCharts, 50);
}

function exportExcel() {
    let wb = XLSX.utils.book_new();
    let ws1Data = [['æ—¥æœŸ']]; validCols.forEach(c => ws1Data[0].push(roomNames[c])); ws1Data[0].push('å½“æ—¥å…¥ä½ç‡');
    for(let r=0; r<rawData.length; r++) {
        let row = [dateList[r]]; let daySlots=0, dayOcc=0; let blockedCols = getBlockedSet(r);
        validCols.forEach(c => {
            let isOcc = rawData[r][c]===1;
            if(isOcc) { row.push('1'); dayOcc++; daySlots++; } else if(blockedCols.has(c)) { row.push('ğŸ”’'); } else { row.push('0'); daySlots++; }
        });
        row.push(daySlots>0 ? (dayOcc/daySlots*100).toFixed(1)+'%' : '0%');
        ws1Data.push(row);
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws1Data), "æ¯æ—¥æ’æœŸ");
    XLSX.writeFile(wb, "å…¥ä½åˆ†ææŠ¥è¡¨.xlsx");
}

function exportImage() {
    const card = document.getElementById('resultCard');
    html2canvas(card, {backgroundColor: '#ffffff', scale: 2}).then(canvas => {
        const link = document.createElement('a');
        link.download = 'å…¥ä½ç‡åˆ†æ.png'; link.href = canvas.toDataURL('image/png'); link.click();
    });
}

function openLinkModal() {
    document.getElementById('linkModal').style.display='flex'; document.getElementById('linkContainer').innerHTML='';
    if(linkConfig.length===0) addLinkRow(); else linkConfig.forEach(cfg => addLinkRow(cfg));
}
function closeLinkModal() { document.getElementById('linkModal').style.display='none'; }
function addLinkRow(data = null) {
    let div = document.createElement('div'); div.style.cssText = 'background:#f2f2f7; padding:10px; border-radius:8px; margin-bottom:10px;';
    let html = `<div style="margin-bottom:5px; font-weight:600;">ä¸»æˆ¿æº:</div><select class="link-parent" style="width:100%;margin-bottom:10px;">`;
    validCols.forEach(c => { html += `<option value="${c}" ${data&&data.parent==c?'selected':''}>${roomNames[c]}</option>`; });
    html += `</select><div style="margin-bottom:5px; font-weight:600;">åŒ…å«å­æˆ¿:</div><div style="display:flex; flex-wrap:wrap; gap:10px;">`;
    validCols.forEach(c => { let checked = (data&&data.children.includes(c))?'checked':''; html += `<label><input type="checkbox" class="link-child" value="${c}" ${checked}> ${roomNames[c]}</label>`; });
    html += `</div><div style="text-align:right;"><button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()" style="color:red;font-size:12px;">åˆ é™¤</button></div>`;
    div.innerHTML = html; document.getElementById('linkContainer').appendChild(div);
}
function saveLinks() {
    let newConfig = [];
    document.querySelectorAll('#linkContainer > div').forEach(div => {
        let p = parseInt(div.querySelector('.link-parent').value);
        let kids = []; div.querySelectorAll('.link-child:checked').forEach(cb => kids.push(parseInt(cb.value)));
        if(kids.length > 0 && !kids.includes(p)) newConfig.push({parent: p, children: kids});
    });
    linkConfig = newConfig; closeLinkModal(); refreshAllViews();
}
</script>
</body>
</html>
