<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°‘å®¿æ™ºèƒ½ç»è¥ç³»ç»Ÿ Ultimate V3.2 | è˜‡çš„å·¥å…·ç®±</title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
    :root { 
        --primary: #007aff; 
        --bg: #f5f5f7; 
        --card: #ffffff; 
        --text: #1d1d1f; 
        --border: #d2d2d7; 
        --success: #34c759; 
        --danger: #ff3b30;
        --warning: #ff9500;
        --info: #8e8e93;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; box-sizing: border-box; }
    
    /* å¸ƒå±€å®¹å™¨ */
    .container { max-width: 1440px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 25px; }
    .card { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
    
    /* å¯¼èˆªæ¨¡å¼åˆ‡æ¢ */
    .nav-tabs-main { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .nav-btn-main { 
        background: #e5e5ea; border: none; padding: 12px 30px; border-radius: 25px;
        font-size: 16px; font-weight: 600; cursor: pointer; color: #86868b; transition: all 0.2s;
    }
    .nav-btn-main.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); transform: translateY(-2px); }
    
    /* æ¨¡å¼åŒºåŸŸæ˜¾éš */
    .mode-section { display: none; animation: fadeIn 0.4s ease-out; }
    .mode-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .subtitle-link { text-decoration: none; color: #8e8e93; font-size: 14px; font-weight: 500; display: inline-block; margin-top: 5px; }
    
    /* æ§åˆ¶åŒºä¸è¾“å…¥æ¡† */
    .controls-row { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; }
    .input-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
    .input-group label { font-size: 12px; font-weight: 700; color: #86868b; text-transform: uppercase; }
    .form-control { padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; width: 100%; box-sizing: border-box; }
    
    .btn { padding: 12px 24px; border-radius: 10px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #e5e5ea; color: #1c1c1e; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    
    /* ç”»å¸ƒä¸å›¾è¡¨ */
    .canvas-wrapper { position: relative; background: #2c2c2e; border-radius: 12px; overflow: hidden; margin-top: 20px; text-align: center; padding: 20px; height: 65vh; display: flex; justify-content: center; align-items: center; }
    canvas { box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 100%; max-height: 100%; cursor: crosshair; }
    .chart-box { width: 100%; height: 500px; } /* ä¿®å¤å›¾è¡¨é«˜åº¦ */

    /* è¡¨æ ¼ */
    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); max-height: 600px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
    th { background: #f9f9f9; padding: 12px; font-weight: 600; text-align: left; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    
    /* æ—¥å†è¡¨ç‰¹æœ‰ */
    .date-cell { position: sticky; left: 0; background: #fff; z-index: 5; border-right: 2px solid #eee; font-weight: 600; }
    .cell-occupied { background-color: rgba(52, 199, 89, 0.2) !important; color: #004d1a; font-weight: bold; }
    .cell-blocked { background-color: #e5e5ea !important; color: #8e8e93; cursor: not-allowed; }

    /* è§†å›¾åˆ‡æ¢Tabs */
    .view-tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
    .tab-btn { padding: 8px 16px; border-radius: 20px; border: none; background: #f2f2f7; color: #8e8e93; font-weight: 600; cursor: pointer; }
    .tab-btn.active { background: var(--primary); color: white; }
    .view-content { display: none; }
    .view-content.active { display: block; }

    /* æ¨¡æ€æ¡† */
    .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none; justify-content:center; align-items:center; }
    .modal-box { background:#fff; padding:30px; border-radius:16px; width:500px; max-width:90%; }

    /* ============ åˆ†ææ¨¡å¼å¢å¼º CSS (Claude å»ºè®®ä¼˜åŒ–) ============ */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .kpi-card { background: #f9f9f9; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #eee; }
    .kpi-title { font-size: 13px; color: #86868b; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }
    .kpi-value { font-size: 24px; font-weight: 800; color: var(--text); }
    
    .action-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; }
    .action-card { border-left: 5px solid #ccc; background: #fff; border-radius: 8px; padding: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .action-content { padding: 15px; }
    
    /* æ™ºèƒ½è¯Šæ–­å¡ç‰‡é¢œè‰² */
    .action-card.urgent { border-left-color: var(--danger); } /* å¿…é¡»é™ä»· */
    .action-card.watch { border-left-color: var(--warning); } /* æ£€æŸ¥è´¨é‡ */
    .action-card.up { border-left-color: var(--success); }    /* å¯ä»¥æ¶¨ä»· */
    .action-card.info { border-left-color: var(--info); }     /* ç¨³å®š */

    .action-badge { padding: 2px 8px; border-radius: 4px; color: #fff; font-size: 12px; font-weight: bold; }
    .trend-up { color: var(--success); font-weight: bold; }
    .trend-down { color: var(--danger); font-weight: bold; }
    
    .global-insight { background:#fff3e0; border-left:5px solid #ff9800; padding:20px; border-radius:8px; margin-bottom:25px; animation: fadeIn 0.5s; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0;">æ°‘å®¿æ™ºèƒ½ç»è¥ç³»ç»Ÿ <span style="font-size:14px; background:#000; color:#fff; padding:2px 8px; border-radius:6px; vertical-align:middle;">Ultimate V3.2</span></h1>
        <a href="https://c1211tokyo.github.io/tool/" class="subtitle-link">è˜‡çš„å·¥å…·ç®±</a>
    </div>

    <div class="nav-tabs-main">
        <button class="nav-btn-main active" onclick="switchMainMode('calendar')">ğŸ“… å…¥ä½ç‡æ—¥å†æ¨¡å¼</button>
        <button class="nav-btn-main" onclick="switchMainMode('analysis')">ğŸ“Š ç»è¥æ™ºèƒ½è¯Šæ–­</button>
    </div>

    <div id="mode-calendar" class="mode-section active">
        <div class="card">
            <div class="controls-row">
                <div class="input-group">
                    <label>1. ä¸Šä¼ æ’æœŸæˆªå›¾</label>
                    <input type="file" id="imgInput" accept="image/*" class="form-control">
                </div>
                <div class="input-group" style="max-width: 120px;">
                    <label>2. æˆ¿é—´æ•° (åˆ—)</label>
                    <input type="number" id="colCount" value="10" min="1" class="form-control" onchange="resetGrid()">
                </div>
                <div class="input-group" style="max-width: 120px;">
                    <label>3. ç»Ÿè®¡å¤©æ•° (è¡Œ)</label>
                    <input type="number" id="rowCount" value="30" min="1" class="form-control">
                </div>
                <div class="input-group" style="max-width: 160px;">
                    <label>4. èµ·å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                
                <div style="display:flex; gap:10px; align-self: flex-end;">
                    <button class="btn btn-secondary" onclick="resetGrid()">ğŸ”„ é‡ç½®</button>
                    <button class="btn btn-primary" onclick="runAnalysis()">âš¡ å¼€å§‹åˆ†æ</button>
                </div>
            </div>

            <div style="margin-top:15px; font-size:13px; color:#666; background:#fffbe6; padding:10px 15px; border-radius:8px; border:1px solid #ffe58f;">
                ğŸ’¡ <strong>æ“ä½œæç¤ºï¼š</strong> çº¢æ¡†å·²è§£é”ã€‚è¯·æ‹–åŠ¨çº¢æ¡†é¡¶éƒ¨çš„ âšªï¸ <strong>å°ç™½ç‚¹</strong> å¯¹é½æ¯ä¸€åˆ—ã€‚å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼Œè¯·åœ¨æ¡†å†…æŒ‰ä½é¼ æ ‡å·¦é”®æ‹–åŠ¨æ•´ä¸ªçº¢æ¡†ã€‚
            </div>

            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>

        <div class="card" id="resultCard" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:15px;">
                <div class="view-tabs">
                    <button class="tab-btn active" onclick="switchTab('daily')">ğŸ“… æ¯æ—¥æ’æœŸ</button>
                    <button class="tab-btn" onclick="switchTab('stats')">ğŸ“‹ æˆ¿é—´ç»Ÿè®¡</button>
                    <button class="tab-btn" onclick="switchTab('charts')">ğŸ“Š å¯è§†åŒ–</button>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" onclick="openLinkModal()">ğŸ”— å…³è”ç»„åˆæˆ¿</button>
                    <button class="btn btn-secondary" onclick="exportImage()">ğŸ–¼ï¸ å­˜å›¾</button>
                    <button class="btn btn-secondary" onclick="exportExcel()">ğŸ“¥ Excel</button>
                </div>
            </div>

            <div id="view-daily" class="view-content active">
                <div style="display:flex; justify-content:space-around; background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <div style="text-align:center;"><div style="color:#888;font-size:12px;">ç»¼åˆå…¥ä½ç‡</div><strong id="valTotalRate" style="color:var(--primary);font-size:24px;">0%</strong></div>
                    <div style="text-align:center;"><div style="color:#888;font-size:12px;">æ€»æˆ¿æ™š</div><strong id="valTotalSlots" style="font-size:24px;">0</strong></div>
                    <div style="text-align:center;"><div style="color:#888;font-size:12px;">å®é™…å…¥ä½</div><strong id="valTotalOcc" style="color:var(--success);font-size:24px;">0</strong></div>
                </div>
                <div class="table-container">
                    <table id="dailyTable"></table>
                </div>
            </div>

            <div id="view-stats" class="view-content">
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th>æˆ¿é—´åç§°</th><th>ç»Ÿè®¡æ€»å¤©æ•°</th><th>è¢«å…³è”å ç”¨</th><th>æœ‰æ•ˆå”®å–å¤©æ•°</th><th>å®é™…å…¥ä½å¤©æ•°</th><th>å…¥ä½ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-charts" class="view-content">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:30px;">
                    <div style="border:1px solid #eee; border-radius:10px; padding:15px;">
                        <h4 style="margin:0; text-align:center;">å„æˆ¿é—´å…¥ä½ç‡</h4>
                        <div id="chartBar" style="width:100%; height:350px;"></div>
                    </div>
                    <div style="border:1px solid #eee; border-radius:10px; padding:15px;">
                        <h4 style="margin:0; text-align:center;">æ¯æ—¥è¶‹åŠ¿</h4>
                        <div id="chartLine" style="width:100%; height:350px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mode-analysis" class="mode-section">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“‚ ä¸Šä¼ ç»è¥æ•°æ® (CSV)</h3>
            <p style="font-size:13px; color:#888;">ä¸Šä¼ åå°å¯¼å‡ºçš„ CSVï¼Œç¬¬ä¸€ä»½ä¸ºã€å‚ç…§ç»„ã€‘ï¼ˆå¦‚11æœˆï¼‰ï¼Œç¬¬äºŒä»½ä¸ºã€è¯Šæ–­ç»„ã€‘ï¼ˆå¦‚12æœˆï¼‰ã€‚</p>
            <div class="controls-row" style="align-items: flex-start;">
                <div class="input-group">
                    <label>ğŸ“„ å‚ç…§ç»„ (å¦‚11æœˆ)</label>
                    <input type="file" id="csvPast" accept=".csv" class="form-control">
                </div>
                <div class="input-group">
                    <label>ğŸ“… è¯Šæ–­ç»„ (å¦‚12æœˆ)</label>
                    <input type="file" id="csvFuture" accept=".csv" class="form-control">
                </div>
            </div>
            <button class="btn btn-primary" style="margin-top:20px; width:100%;" onclick="startDiagnosis()">ğŸš€ å¼€å§‹æ™ºèƒ½è¯Šæ–­</button>
        </div>

        <div id="analysisOutput" style="display:none;">
            <div id="globalInsightContainer"></div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">æ€»è¥æ”¶é¢„æµ‹</div>
                    <div class="kpi-value" style="color:var(--primary);" id="totalRevenue">--</div>
                    <div style="font-size:12px; margin-top:5px;" id="revenueDiff">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">RevPAR (æ¯é—´æ”¶ç›Š)</div>
                    <div class="kpi-value" id="avgRevParFuture">--</div>
                    <div style="font-size:12px; margin-top:5px;" id="avgRevParDiff">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">å¹³å‡å…¥ä½ç‡</div>
                    <div class="kpi-value" id="avgOccFuture">--</div>
                    <div style="font-size:12px; margin-top:5px;" id="avgOccDiff">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">å¹³å‡æˆ¿ä»· (ADR)</div>
                    <div class="kpi-value" id="avgAdrFuture">--</div>
                    <div style="font-size:12px; margin-top:5px;" id="avgAdrDiff">--</div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ’¡ æ™ºèƒ½è¡ŒåŠ¨æ¸…å•</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">åŸºäºä»·æ ¼ã€å…¥ä½ç‡ä¸ RevPAR çš„å¤šç»´åˆ†æç”Ÿæˆã€‚</p>
                <div id="actionContainer" class="action-list"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ§© æˆ¿æºè¡¨ç°çŸ©é˜µ</h3>
                <p style="font-size:13px; color:#666;">
                    <strong>å³ä¸Š(æ˜æ˜Ÿ):</strong> é«˜ä»·é«˜ä½ (ä¿æŒ) | <strong>å·¦ä¸Š(é—®é¢˜):</strong> é«˜ä»·ä½ä½ (éœ€é™ä»·) | <strong>å³ä¸‹(é‡‘ç‰›):</strong> ä½ä»·é«˜ä½ (å¯æä»·)
                </p>
                <div id="scatterChart" class="chart-box"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ“‹ è¯¦ç»†æ•°æ®å¯¹æ¯”</h3>
                <div class="table-container">
                    <table style="width:100%;">
                        <thead>
                            <tr>
                                <th>æˆ¿æº</th>
                                <th>æœªæ¥ ADR (å˜åŒ–)</th>
                                <th>æœªæ¥å…¥ä½ç‡ (å˜åŒ–)</th>
                                <th>æœªæ¥ RevPAR (å˜åŒ–)</th>
                                <th>æ€»æ”¶å…¥</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-mask" id="linkModal">
    <div class="modal-box">
        <h3 style="margin-top:0;">ğŸ”— ç»„åˆæˆ¿å…³è”è®¾ç½®</h3>
        <div id="linkContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn btn-secondary" onclick="addLinkRow()">+ æ·»åŠ ä¸€ç»„</button>
            <div>
                <button class="btn btn-secondary" onclick="closeLinkModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveLinks()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<datalist id="prefix-list"><option value="æ¸‹è°·"></option><option value="å…¥è°·"></option><option value="ä¸¡å›½"></option></datalist>
<datalist id="suffix-list"><option value="101"></option><option value="102"></option><option value="A"></option><option value="B"></option></datalist>

<script>
// ==========================================
// PART 1: å¯¼èˆªåˆ‡æ¢ (ä¿®å¤å›¾è¡¨å®½åº¦ Bug)
// ==========================================
function switchMainMode(mode) {
    document.querySelectorAll('.nav-btn-main').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.mode-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('mode-' + mode).classList.add('active');
    
    // åˆ‡æ¢åˆ°åˆ†ææ¨¡å¼æ—¶ï¼Œå¼ºåˆ¶åˆ·æ–°å›¾è¡¨å¤§å°
    if(mode === 'analysis') {
        setTimeout(() => { if(scatterChartIns) scatterChartIns.resize(); }, 100);
    }
}

// ==========================================
// PART 2: ç»è¥æ™ºèƒ½è¯Šæ–­ (Claude ä¼˜åŒ–ç‰ˆé€»è¾‘)
// ==========================================
let scatterChartIns = null;

function startDiagnosis() {
    const filePast = document.getElementById('csvPast').files[0];
    const fileFuture = document.getElementById('csvFuture').files[0];

    if (!filePast || !fileFuture) { alert("è¯·ä¸Šä¼ ä¸¤ä»½ CSV æ–‡ä»¶ï¼"); return; }

    Promise.all([parseCSV(filePast), parseCSV(fileFuture)]).then(results => {
        const dataPast = parseYourCSV(results[0].data);
        const dataFuture = parseYourCSV(results[1].data);
        
        if(dataFuture.length === 0) { alert("CSVè§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚"); return; }

        document.getElementById('analysisOutput').style.display = 'block';
        setTimeout(() => {
            renderAnalysis(dataPast, dataFuture);
            document.getElementById('analysisOutput').scrollIntoView({behavior:'smooth'});
        }, 50);
    });
}

function parseCSV(file) {
    return new Promise(resolve => {
        Papa.parse(file, { header: false, skipEmptyLines: true, complete: resolve });
    });
}

// æ™ºèƒ½ CSV è§£æå™¨ (Claude æ¨è)
function parseYourCSV(rawData) {
    let headerIndex = -1;
    // å¯»æ‰¾åŒ…å«å…³é”®å­—æ®µçš„è¡Œ
    for (let i = 0; i < Math.min(20, rawData.length); i++) {
        const rowStr = rawData[i].join(' ');
        if (rowStr.includes('æˆ¿æº') && rowStr.includes('å…¥ä½ç‡')) {
            headerIndex = i;
            break;
        }
    }
    if (headerIndex === -1) return [];

    const headers = rawData[headerIndex];
    // æ¨¡ç³ŠåŒ¹é…åˆ—å
    const findIdx = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));
    
    const colMap = {
        name: findIdx(['æˆ¿æº', 'æˆ¿é—´']),
        occ: findIdx(['å…¥ä½ç‡']),
        adr: findIdx(['æˆ¿è´¹.1', 'å‡ä»·', 'ADR']), // ä¼˜å…ˆåŒ¹é… 'æˆ¿è´¹.1'
        revpar: findIdx(['æˆ¿è´¹.2', 'RevPAR']),   // ä¼˜å…ˆåŒ¹é… 'æˆ¿è´¹.2'
        income: findIdx(['å‡€æ”¶å…¥', 'æ”¶å…¥', 'æˆ¿è´¹']), // ä¼˜å…ˆåŒ¹é… 'å‡€æ”¶å…¥'
        sold: findIdx(['å·²å”®']),
        avail: findIdx(['å¯å”®'])
    };

    const data = [];
    for (let i = headerIndex + 1; i < rawData.length; i++) {
        const row = rawData[i];
        if (!row[colMap.name] || row[colMap.name] === 'æ€»è®¡') continue;

        const parseNum = (val) => {
            if (!val) return 0;
            return parseFloat(String(val).replace(/[Â¥,%\s]/g, ''));
        };

        const item = {
            name: row[colMap.name],
            occ: parseNum(row[colMap.occ]) / 100.0,
            adr: parseNum(row[colMap.adr]),
            income: parseNum(row[colMap.income]),
            revpar: 0, // ç¨åè®¡ç®—
            sold: parseNum(row[colMap.sold]),
            avail: parseNum(row[colMap.avail])
        };

        // å¦‚æœ CSV é‡Œæœ‰ RevPAR å°±ç”¨ï¼Œæ²¡æœ‰å°±è‡ªå·±ç®—
        if (colMap.revpar > -1 && row[colMap.revpar]) {
            item.revpar = parseNum(row[colMap.revpar]);
        } else {
            item.revpar = item.adr * item.occ;
        }

        data.push(item);
    }
    return data;
}

// æ ¸å¿ƒè¯Šæ–­å¼•æ“ (Claude æ¨è)
function diagnoseRoom(past, future) {
    const result = { room: future.name, issue: 'STABLE', reason: '', action: '', metrics: {} };
    
    const occChange = future.occ - past.occ;
    const adrChange = past.adr > 0 ? (future.adr - past.adr) / past.adr : 0;
    const revparChange = past.revpar > 0 ? (future.revpar - past.revpar) / past.revpar : 0;
    
    result.metrics = {
        occChange: (occChange * 100).toFixed(0) + '%',
        adrChange: (adrChange * 100).toFixed(0) + '%',
        revparChange: (revparChange * 100).toFixed(0) + '%'
    };

    // å†³ç­–æ ‘é€»è¾‘
    if (revparChange < -0.15) { // æ”¶ç›Šå¤§å¹…ä¸‹æ»‘
        if (adrChange > 0.05 && occChange < -0.15) {
            result.issue = 'PRICE_BACKFIRE';
            result.reason = `æ¶¨ä»·åå…¥ä½ç‡æš´è·Œï¼Œå¯¼è‡´ RevPAR æŸå¤±ä¸¥é‡ã€‚`;
            result.action = `å»ºè®®ç«‹å³å›è°ƒä»·æ ¼è‡³ Â¥${past.adr.toFixed(0)}ã€‚`;
        } else if (adrChange < -0.05 && occChange < 0.05) {
            result.issue = 'QUALITY_ISSUE';
            result.reason = `é™ä»·åå…¥ä½ç‡ä¾ç„¶ä½è¿·ï¼Œéä»·æ ¼é—®é¢˜ã€‚`;
            result.action = `æ£€æŸ¥æˆ¿æºé¦–å›¾ã€å·®è¯„æˆ–è®¾æ–½æè¿°ã€‚`;
        } else {
            result.issue = 'MARKET_DECLINE';
            result.reason = `ä»·æ ¼ä¸å…¥ä½ç‡åŒé™ï¼Œå¸‚åœºè¶‹å†·ã€‚`;
            result.action = `è§‚å¯Ÿç«å“ï¼Œæš‚ç¼“æ¶¨ä»·ã€‚`;
        }
    } else if (revparChange > 0.1) { // æ”¶ç›Šä¸Šæ¶¨
        if (future.occ > 0.8) {
            result.issue = 'UNDERPRICED';
            result.reason = `å…¥ä½ç‡æé«˜(${ (future.occ*100).toFixed(0) }%)ï¼Œä¾›ä¸åº”æ±‚ã€‚`;
            result.action = `å‘¨æœ«/èŠ‚å‡æ—¥è¯•æ¢æ€§æ¶¨ä»· 5-10%ã€‚`;
        } else if (adrChange > 0.05) {
            result.issue = 'SUCCESS';
            result.reason = `æ¶¨ä»·ç­–ç•¥æˆåŠŸï¼Œæ”¶ç›Šæå‡ã€‚`;
            result.action = `ä¿æŒç°çŠ¶ã€‚`;
        }
    }
    return result;
}

function renderAnalysis(pastList, futureList) {
    // è½¬æ¢ä¸º Map æ–¹ä¾¿æŸ¥æ‰¾
    const pastMap = {}; pastList.forEach(i => pastMap[i.name] = i);
    const futureMap = {}; futureList.forEach(i => futureMap[i.name] = i);
    const rooms = Object.keys(futureMap);

    // å…¨å±€ç»Ÿè®¡
    let totalRevPast=0, totalRevFuture=0;
    let totalOccPast=0, totalOccFuture=0;
    let count = 0;
    
    const actionContainer = document.getElementById('actionContainer');
    const tableBody = document.getElementById('detailTableBody');
    const scatterData = [];
    
    actionContainer.innerHTML = '';
    tableBody.innerHTML = '';

    // å…¨å±€æ´å¯Ÿ
    const avgOccPast = pastList.reduce((s,i)=>s+i.occ,0)/pastList.length;
    const avgOccFuture = futureList.reduce((s,i)=>s+i.occ,0)/futureList.length;
    const globalDiv = document.getElementById('globalInsightContainer');
    if ((avgOccFuture - avgOccPast) < -0.1) {
        globalDiv.innerHTML = `<div class="global-insight"><h4 style="margin:0;">ğŸŒ å¸‚åœºé¢„è­¦</h4><p>æ•´ä½“å…¥ä½ç‡ä¸‹æ»‘ <b>${((avgOccPast-avgOccFuture)*100).toFixed(0)}%</b>ï¼Œå¯èƒ½æ˜¯æ·¡å­£åˆ°æ¥ã€‚å»ºè®®æ£€æŸ¥ç«å“ä¿ƒé”€ï¼Œä¼˜å…ˆä¿å…¥ä½ç‡ã€‚</p></div>`;
    } else {
        globalDiv.innerHTML = '';
    }

    let totalIncome = 0;

    rooms.forEach(room => {
        const future = futureMap[room];
        const past = pastMap[room] || { occ: 0, adr: future.adr, income: 0, revpar: 0 };
        
        count++;
        totalRevPast += past.revpar; totalRevFuture += future.revpar;
        totalOccPast += past.occ; totalOccFuture += future.occ;
        totalIncome += future.income;

        // è¿è¡Œè¯Šæ–­
        const diag = diagnoseRoom(past, future);
        
        // ç”Ÿæˆå¡ç‰‡
        if (diag.issue !== 'STABLE' && diag.issue !== 'SUCCESS') {
            actionContainer.innerHTML += createSmartActionCard(diag);
        }

        // è¡¨æ ¼æ•°æ®
        const tr = document.createElement('tr');
        const adrDiff = past.adr ? (future.adr-past.adr)/past.adr : 0;
        const occDiff = future.occ - past.occ;
        const revDiff = past.revpar ? (future.revpar-past.revpar)/past.revpar : 0;
        
        tr.innerHTML = `
            <td style="font-weight:bold;">${room}</td>
            <td>Â¥${future.adr.toLocaleString()} <span class="${adrDiff>0?'trend-up':'trend-down'}">(${adrDiff>0?'+':''}${(adrDiff*100).toFixed(0)}%)</span></td>
            <td>${(future.occ*100).toFixed(0)}% <span class="${occDiff>0?'trend-up':'trend-down'}">(${occDiff>0?'+':''}${(occDiff*100).toFixed(0)}%)</span></td>
            <td>Â¥${future.revpar.toFixed(0)} <span class="${revDiff>0?'trend-up':'trend-down'}">(${revDiff>0?'+':''}${(revDiff*100).toFixed(0)}%)</span></td>
            <td>Â¥${future.income.toLocaleString()}</td>
        `;
        tableBody.appendChild(tr);

        // æ•£ç‚¹å›¾æ•°æ®
        scatterData.push([
            future.occ * 100, // X
            future.adr,       // Y
            future.revpar,    // Size
            room,
            diag.issue        // Type
        ]);
    });

    if(actionContainer.innerHTML === '') actionContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">âœ… è¿è¥çŠ¶å†µè‰¯å¥½ï¼Œæš‚æ— æ¿€è¿›å»ºè®®ã€‚</div>';

    // æ›´æ–° KPI
    document.getElementById('totalRevenue').innerText = 'Â¥' + totalIncome.toLocaleString();
    document.getElementById('avgRevParFuture').innerText = 'Â¥' + (totalRevFuture/count).toFixed(0);
    const revDiffPct = (totalRevFuture - totalRevPast)/totalRevPast;
    document.getElementById('avgRevParDiff').innerHTML = `<span class="${revDiffPct>=0?'trend-up':'trend-down'}">${revDiffPct>=0?'+':''}${(revDiffPct*100).toFixed(1)}%</span>`;
    
    document.getElementById('avgOccFuture').innerText = (avgOccFuture*100).toFixed(1) + '%';
    document.getElementById('avgAdrFuture').innerText = 'Â¥' + (futureList.reduce((s,i)=>s+i.adr,0)/count).toFixed(0);

    renderScatterChart(scatterData, futureList.reduce((s,i)=>s+i.adr,0)/count);
}

function createSmartActionCard(diag) {
    const styles = {
        'PRICE_BACKFIRE': { type: 'urgent', icon: 'ğŸš¨', title: 'æ¶¨ä»·å¤±è´¥', color: '#ff3b30' },
        'QUALITY_ISSUE': { type: 'watch', icon: 'âš ï¸', title: 'æ£€æŸ¥è´¨é‡', color: '#ff9500' },
        'MARKET_DECLINE': { type: 'watch', icon: 'ğŸ“‰', title: 'å¸‚åœºä¸‹æ»‘', color: '#ffcc00' },
        'UNDERPRICED': { type: 'up', icon: 'ğŸ’°', title: 'å¯æä»·', color: '#34c759' }
    };
    const s = styles[diag.issue] || { type:'info', icon:'â„¹ï¸', title:'æç¤º', color:'#888' };
    
    return `
    <div class="action-card ${s.type}" style="border-left-color:${s.color}">
        <div class="action-content">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h4 style="margin:0;">${s.icon} ${s.title}</h4>
                <span class="action-badge" style="background:${s.color}">${diag.room}</span>
            </div>
            <div style="margin:10px 0;padding:8px;background:#f5f5f5;border-radius:4px;font-size:12px;display:flex;justify-content:space-between;">
                <span>RevPAR: ${diag.metrics.revparChange}</span>
                <span>å…¥ä½: ${diag.metrics.occChange}</span>
            </div>
            <p style="margin:5px 0;font-size:13px;color:#666;">${diag.reason}</p>
            <p style="margin:5px 0;font-weight:bold;font-size:13px;">ğŸ‘‰ ${diag.action}</p>
        </div>
    </div>`;
}

function renderScatterChart(data, avgAdr) {
    if (scatterChartIns) scatterChartIns.dispose();
    scatterChartIns = echarts.init(document.getElementById('scatterChart'));
    
    scatterChartIns.setOption({
        grid: { left: '10%', right: '15%', top: '10%', bottom: '15%' },
        tooltip: { formatter: (p) => `<b>${p.data[3]}</b><br>å…¥ä½: ${p.data[0]}%<br>å‡ä»·: Â¥${p.data[1]}` },
        xAxis: { name: 'å…¥ä½ç‡(%)', min:0, max:100, splitLine:{lineStyle:{type:'dashed'}} },
        yAxis: { name: 'å‡ä»·(ADR)', splitLine:{lineStyle:{type:'dashed'}}, scale:true },
        series: [{
            type: 'scatter',
            data: data,
            symbolSize: (p) => Math.max(10, Math.sqrt(p[2])*0.8),
            itemStyle: {
                color: (p) => {
                    if (p.data[4] === 'PRICE_BACKFIRE') return '#ff3b30'; // çº¢
                    if (p.data[4] === 'UNDERPRICED') return '#34c759'; // ç»¿
                    if (p.data[0] < 40) return '#5ac8fa'; // è“ (ä½å…¥ä½)
                    return '#8e8e93'; // ç°
                },
                opacity: 0.8
            },
            markLine: {
                silent: true,
                data: [{xAxis: 50}, {yAxis: avgAdr}],
                lineStyle: { color: '#ccc' }
            }
        }]
    });
}
window.addEventListener('resize', () => { if(scatterChartIns) scatterChartIns.resize(); if(chartBarIns) chartBarIns.resize(); if(chartLineIns) chartLineIns.resize(); });

// ==========================================
// PART 3: åŸæœ‰æ—¥å†é€»è¾‘ (å®Œæ•´ä¿ç•™)
// ==========================================
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
let img = new Image();
let grid = { x: 50, y: 50, w: 100, h: 100 }; 
let colDividers = []; 
let isDragging = false, dragTarget = null, lastMouse = {x:0, y:0};
let rawData = [], roomNames = [], roomParts = [], validCols = [], dateList = [], linkConfig = [];
let chartBarIns = null, chartLineIns = null;

document.getElementById('startDate').valueAsDate = new Date();
document.getElementById('imgInput').addEventListener('change', e => {
    if(e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = evt => {
            img.src = evt.target.result;
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                grid.x = img.width*0.05; grid.y = img.height*0.15; grid.w = img.width*0.9; grid.h = img.height*0.75;
                resetGrid();
            };
        };
        reader.readAsDataURL(e.target.files[0]);
    }
});

function resetGrid() {
    const cols = parseInt(document.getElementById('colCount').value) || 1;
    colDividers = []; for(let i=1; i<cols; i++) colDividers.push(i/cols); draw();
}
function draw() {
    if(!img.src) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0);
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0,0,canvas.width,grid.y); ctx.fillRect(0,grid.y+grid.h,canvas.width,canvas.height-(grid.y+grid.h));
    ctx.fillRect(0,grid.y,grid.x,grid.h); ctx.fillRect(grid.x+grid.w,grid.y,canvas.width-(grid.x+grid.w),grid.h);
    ctx.strokeStyle = '#ff3b30'; ctx.lineWidth = 3; ctx.strokeRect(grid.x, grid.y, grid.w, grid.h);
    const rows = parseInt(document.getElementById('rowCount').value) || 1;
    ctx.beginPath(); ctx.strokeStyle = 'rgba(255, 59, 48, 0.3)'; ctx.lineWidth = 1;
    for(let i=1; i<rows; i++) { let y = grid.y + (grid.h/rows)*i; ctx.moveTo(grid.x, y); ctx.lineTo(grid.x+grid.w, y); }
    ctx.stroke();
    ctx.beginPath(); ctx.strokeStyle = '#ff3b30'; ctx.lineWidth = 2;
    colDividers.forEach(r => { let x = grid.x + r * grid.w; ctx.moveTo(x, grid.y); ctx.lineTo(x, grid.y+grid.h); });
    ctx.stroke();
    const handleR = img.width * 0.008; 
    const drawDot = (x,y,c) => { ctx.beginPath(); ctx.arc(x,y,handleR<8?8:handleR,0,Math.PI*2); ctx.fillStyle=c; ctx.fill(); ctx.strokeStyle='#fff'; ctx.stroke(); };
    drawDot(grid.x, grid.y, '#007aff'); drawDot(grid.x+grid.w, grid.y+grid.h, '#007aff'); 
    colDividers.forEach(r => drawDot(grid.x+r*grid.w, grid.y, '#fff'));
}

function getMousePos(e) {
    const rect = canvas.getBoundingClientRect();
    return { x: (e.clientX - rect.left)*(canvas.width/rect.width), y: (e.clientY - rect.top)*(canvas.height/rect.height) };
}
canvas.addEventListener('mousedown', e => {
    const {x, y} = getMousePos(e); const R = Math.max(20, img.width*0.015);
    for(let i=0; i<colDividers.length; i++) if(Math.hypot(x-(grid.x+colDividers[i]*grid.w), y-grid.y) < R) { isDragging=true; dragTarget={type:'divider', index:i}; return; }
    if(Math.hypot(x-grid.x, y-grid.y)<R) { isDragging=true; dragTarget={type:'box', handle:'tl'}; return; }
    if(Math.hypot(x-(grid.x+grid.w), y-(grid.y+grid.h))<R) { isDragging=true; dragTarget={type:'box', handle:'br'}; return; }
    if(x>grid.x && x<grid.x+grid.w && y>grid.y && y<grid.y+grid.h) { isDragging=true; dragTarget={type:'move'}; lastMouse={x,y}; }
});
canvas.addEventListener('mousemove', e => {
    const {x, y} = getMousePos(e);
    if(!isDragging) {
        canvas.style.cursor = 'default'; const R = Math.max(20, img.width*0.015);
        for(let r of colDividers) if(Math.hypot(x-(grid.x+r*grid.w), y-grid.y)<R) canvas.style.cursor='col-resize';
        return;
    }
    if(dragTarget.type === 'move') { grid.x+=x-lastMouse.x; grid.y+=y-lastMouse.y; lastMouse={x,y}; }
    else if(dragTarget.type === 'box') {
        if(dragTarget.handle === 'tl') { let r=grid.x+grid.w, b=grid.y+grid.h; grid.x=x; grid.y=y; grid.w=r-x; grid.h=b-y; }
        else { grid.w=x-grid.x; grid.h=y-grid.y; }
    } else if(dragTarget.type === 'divider') {
        let i=dragTarget.index, r=(x-grid.x)/grid.w;
        let min=(i===0)?0:colDividers[i-1], max=(i===colDividers.length-1)?1:colDividers[i+1];
        if(r>min+0.01 && r<max-0.01) colDividers[i]=r;
    }
    draw();
});
canvas.addEventListener('mouseup', () => isDragging=false);

function runAnalysis() {
    if(!img.src) { alert("è¯·ä¸Šä¼ å›¾ç‰‡"); return; }
    const rows = parseInt(document.getElementById('rowCount').value);
    const cellH = grid.h / rows;
    const boundaries = [0, ...colDividers, 1.0];
    const cols = boundaries.length - 1;
    rawData=[]; roomNames=[]; roomParts=[]; validCols=[]; dateList=[];
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    for(let c=0; c<cols; c++) { roomNames.push(String.fromCharCode(65+c)); roomParts.push({prefix:'',suffix:''}); validCols.push(c); }
    const startD = new Date(document.getElementById('startDate').value);
    for(let r=0; r<rows; r++) {
        let d = new Date(startD); d.setDate(d.getDate()+r); dateList.push(`${d.getMonth()+1}/${d.getDate()}`);
        let rowArr=[], rowY=grid.y+r*cellH;
        for(let c=0; c<cols; c++) {
            let r1=boundaries[c], r2=boundaries[c+1], cellX=grid.x+r1*grid.w, cellW=(r2-r1)*grid.w;
            let sx=cellX+cellW*0.35, sy=rowY+cellH*0.35, sw=cellW*0.3, sh=cellH*0.3;
            let count=0, total=0;
            for(let py=sy; py<sy+sh; py++) {
                for(let px=sx; px<sx+sw; px++) {
                    let i=(Math.floor(py)*canvas.width+Math.floor(px))*4;
                    if(imgData[i]<230||imgData[i+1]<230||imgData[i+2]<230) count++;
                    total++;
                }
            }
            rowArr.push((count/total>0.1)?1:0);
        }
        rawData.push(rowArr);
    }
    document.getElementById('resultCard').style.display = 'block';
    refreshAllViews(); switchTab('daily'); document.getElementById('resultCard').scrollIntoView({behavior:'smooth'});
}
function getBlockedSet(r) {
    let s = new Set();
    linkConfig.forEach(cfg => {
        if(rawData[r][cfg.parent]===1) cfg.children.forEach(c=>s.add(c));
        if(cfg.children.some(c=>rawData[r][c]===1)) s.add(cfg.parent);
    });
    return s;
}
function updateRoomName(c) {
    const p=roomParts[c].prefix.trim(), s=roomParts[c].suffix.trim();
    roomNames[c] = (p===''&&s==='')?String.fromCharCode(65+c):p+s;
    refreshAllViews();
}
function refreshAllViews() { renderDailyTable(); renderStatsTable(); renderChartsOriginal(); }
function renderDailyTable() {
    const t = document.getElementById('dailyTable'); t.innerHTML='';
    let thead=document.createElement('thead'), tr=document.createElement('tr');
    let th=document.createElement('th'); th.innerText='æ—¥æœŸ'; th.className='date-cell'; tr.appendChild(th);
    validCols.forEach(c => {
        let th=document.createElement('th');
        let d=document.createElement('div'); d.innerHTML=`<div style="font-size:12px;color:var(--primary);margin-bottom:2px;">${roomNames[c]}</div>`;
        let i1=document.createElement('input'); i1.style.width='80%'; i1.placeholder='å‰ç¼€'; i1.setAttribute('list','prefix-list'); i1.value=roomParts[c].prefix; i1.onchange=e=>{roomParts[c].prefix=e.target.value;updateRoomName(c)};
        let i2=document.createElement('input'); i2.style.width='80%'; i2.placeholder='åç¼€'; i2.setAttribute('list','suffix-list'); i2.value=roomParts[c].suffix; i2.onchange=e=>{roomParts[c].suffix=e.target.value;updateRoomName(c)};
        d.append(i1, document.createElement('br'), i2);
        let del=document.createElement('div'); del.innerText='Ã— åˆ é™¤'; del.style.cssText='color:red;cursor:pointer;font-size:10px;'; del.onclick=()=>{if(confirm('åˆ ?')){validCols=validCols.filter(x=>x!==c);refreshAllViews();}};
        d.appendChild(del); th.appendChild(d); tr.appendChild(th);
    });
    thead.appendChild(tr); t.appendChild(thead);
    let tbody=document.createElement('tbody'); let ts=0, to=0;
    for(let r=0; r<rawData.length; r++) {
        let tr=document.createElement('tr');
        let td=document.createElement('td'); td.className='date-cell'; td.innerText=dateList[r]; tr.appendChild(td);
        let bs=getBlockedSet(r);
        validCols.forEach(c => {
            let td=document.createElement('td'), isOcc=rawData[r][c]===1, isB=bs.has(c);
            if(isOcc) { td.className='cell-occupied'; td.innerText='ä½'; to++; td.onclick=()=>{rawData[r][c]=0;refreshAllViews();}; }
            else if(isB) { td.className='cell-blocked'; td.innerText='ğŸ”’'; }
            else { ts++; td.onclick=()=>{rawData[r][c]=1;refreshAllViews();}; }
            td.style.cursor=isB?'not-allowed':'pointer'; tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
    t.appendChild(tbody);
    document.getElementById('valTotalSlots').innerText=ts; document.getElementById('valTotalOcc').innerText=to;
    document.getElementById('valTotalRate').innerText=ts?(to/ts*100).toFixed(1)+'%':'0%';
}
function renderStatsTable() {
    const tb=document.getElementById('statsTableBody'); tb.innerHTML='';
    validCols.forEach(c => {
        let v=0, o=0, b=0;
        for(let r=0; r<rawData.length; r++) {
            let isOcc=rawData[r][c]===1, isB=getBlockedSet(r).has(c);
            if(isOcc){v++;o++;} else if(isB){b++;} else{v++;}
        }
        let tr=document.createElement('tr');
        tr.innerHTML=`<td><b>${roomNames[c]}</b></td><td>${rawData.length}</td><td style="color:#999">${b}</td><td>${v}</td><td>${o}</td><td><b>${v?(o/v*100).toFixed(1):0}%</b></td>`;
        tb.appendChild(tr);
    });
}
function renderChartsOriginal() {
    let x=[], y=[];
    validCols.forEach(c => {
        x.push(roomNames[c]); let v=0, o=0;
        for(let r=0; r<rawData.length; r++) {
            if(rawData[r][c]===1){v++;o++;} else if(!getBlockedSet(r).has(c)){v++;}
        }
        y.push(v?(o/v*100).toFixed(1):0);
    });
    if(chartBarIns) chartBarIns.dispose();
    chartBarIns = echarts.init(document.getElementById('chartBar'));
    chartBarIns.setOption({tooltip:{trigger:'axis'}, xAxis:{data:x}, yAxis:{max:100}, series:[{type:'bar',data:y,itemStyle:{color:'#007aff'}}]});

    let lx=dateList, ly=[];
    for(let r=0; r<rawData.length; r++) {
        let v=0, o=0, bs=getBlockedSet(r);
        validCols.forEach(c => { if(rawData[r][c]===1){v++;o++;} else if(!bs.has(c)){v++;} });
        ly.push(v?(o/v*100).toFixed(1):0);
    }
    if(chartLineIns) chartLineIns.dispose();
    chartLineIns = echarts.init(document.getElementById('chartLine'));
    chartLineIns.setOption({tooltip:{trigger:'axis'}, xAxis:{data:lx}, yAxis:{max:100}, series:[{type:'line',smooth:true,data:ly,itemStyle:{color:'#34c759'}}]});
}
function switchTab(n) {
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.view-content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[['daily','stats','charts'].indexOf(n)].classList.add('active');
    document.getElementById('view-'+n).classList.add('active');
    if(n==='charts') setTimeout(renderChartsOriginal, 50);
}
function exportExcel() {
    let wb=XLSX.utils.book_new(), data=[['æ—¥æœŸ',...validCols.map(c=>roomNames[c]),'å½“æ—¥å…¥ä½ç‡']];
    for(let r=0; r<rawData.length; r++) {
        let row=[dateList[r]], v=0, o=0, bs=getBlockedSet(r);
        validCols.forEach(c => {
            if(rawData[r][c]===1){row.push('1');v++;o++;} else if(bs.has(c)){row.push('ğŸ”’');} else{row.push('0');v++;}
        });
        row.push(v?(o/v*100).toFixed(1)+'%':'0%'); data.push(row);
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "æ¯æ—¥æ•°æ®");
    XLSX.writeFile(wb, "å…¥ä½è¡¨.xlsx");
}
function exportImage() { html2canvas(document.getElementById('resultCard')).then(c => { let a=document.createElement('a'); a.download='res.png'; a.href=c.toDataURL(); a.click(); }); }
function openLinkModal() { document.getElementById('linkModal').style.display='flex'; document.getElementById('linkContainer').innerHTML=''; if(!linkConfig.length)addLinkRow(); else linkConfig.forEach(addLinkRow); }
function closeLinkModal() { document.getElementById('linkModal').style.display='none'; }
function addLinkRow(d=null) {
    let div=document.createElement('div'); div.style.cssText='background:#f5f5f5;padding:10px;margin-bottom:10px;border-radius:8px;';
    let h=`ä¸»:<select class="lp" style="width:100%">`; validCols.forEach(c=>h+=`<option value="${c}" ${d&&d.parent==c?'selected':''}>${roomNames[c]}</option>`);
    h+=`</select>å­:<div style="display:flex;gap:10px;flex-wrap:wrap;">`; validCols.forEach(c=>h+=`<label><input type="checkbox" class="lc" value="${c}" ${d&&d.children.includes(c)?'checked':''}>${roomNames[c]}</label>`);
    h+=`</div><button onclick="this.parentElement.remove()" style="color:red;float:right;">åˆ </button>`;
    div.innerHTML=h; document.getElementById('linkContainer').appendChild(div);
}
function saveLinks() {
    linkConfig=[]; document.querySelectorAll('#linkContainer > div').forEach(d => {
        let p=parseInt(d.querySelector('.lp').value), k=[];
        d.querySelectorAll('.lc:checked').forEach(c=>k.push(parseInt(c.value)));
        if(k.length&&!k.includes(p)) linkConfig.push({parent:p, children:k});
    });
    closeLinkModal(); refreshAllViews();
}
</script>
</body>
</html>
